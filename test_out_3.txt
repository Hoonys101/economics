
tests/test_phase29_depression.py::TestPhase29Depression::test_crisis_monitor_logging 
-------------------------------- live log call --------------------------------
INFO     simulation.bank:bank.py:68 Bank 10 initialized. Assets: 1000000.00, Base Rate: 5.00%
INFO     simulation.agents.government:government.py:108 Government 11 initialized with assets: 0.0
INFO     simulation.agents.central_bank:central_bank.py:34 CENTRAL_BANK_INIT | Rate: 5.00%, Target Infl: 2.00%
INFO     Market_food:order_book_market.py:35 OrderBookMarket food initialized.
INFO     Market_electronics:order_book_market.py:35 OrderBookMarket electronics initialized.
INFO     Market_labor:order_book_market.py:35 OrderBookMarket labor initialized.
INFO     simulation.loan_market:loan_market.py:21 LoanMarket loan_market initialized with bank: 10
INFO     Market_housing:order_book_market.py:35 OrderBookMarket housing initialized.
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:18 AITrainingManager initialized.
INFO     simulation.systems.demographic_manager:demographic_manager.py:29 DemographicManager initialized.
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 100
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 101
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 102
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 103
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 104
INFO     simulation.systems.bootstrapper:bootstrapper.py:86 BOOTSTRAPPER | Injected resources into 0 firms.
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 5 workers to Firm 100
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 101
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 102
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 103
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 104
INFO     simulation.systems.bootstrapper:bootstrapper.py:42 BOOTSTRAPPER | Total force-assigned workers: 5
INFO     TestPhase29:initializer.py:288 Simulation run started with run_id: <MagicMock name='mock.save_simulation_run()' id='2144038358720'>
INFO     TestPhase29:initializer.py:293 Simulation fully initialized with run_id: <MagicMock name='mock.save_simulation_run()' id='2144038358720'>
INFO     TestPhase29:engine.py:158 MONEY_SUPPLY_BASELINE | Baseline Money Supply set to: 1505000.00
INFO     TestPhase29:engine.py:164 --- Starting Tick 1 ---
INFO     simulation.bank:bank.py:336 BANK_TICK_SUMMARY | Collected Loan Int: 0.00, Paid Deposit Int: 0.00, Net Profit: 0.00, Reserves: 1000000.00
INFO     TestPhase29:engine.py:286 DEBUG_WO057 | Tick 1 | Indicators: ['unemployment_rate', 'avg_wage', 'money_supply', 'total_labor_income', 'total_sales_volume', 'total_household_assets', 'total_firm_assets', 'food_avg_price', 'food_trade_volume', 'avg_goods_price', 'total_production', 'total_consumption', 'total_food_consumption', 'total_inventory', 'avg_survival_need', 'labor_share', 'velocity_of_money', 'inventory_turnover', 'avg_education_level', 'brain_waste_count']
INFO     TestPhase29:engine.py:290 DEBUG_WO057 | AvgPrice: 0.0000
INFO     TestPhase29:engine.py:296 DEBUG_WO057 | SensoryDTO: InfSMA=-1.0000, UnempSMA=100.0000, DebtRat=0.0000
INFO     simulation.utils.shadow_logger:shadow_logger.py:36 ShadowLogger initialized at logs/shadow_hand_stage1.csv
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 0
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 1
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 2
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 3
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 4
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 100
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 101
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 102
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 103
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 104
INFO     Market_food:order_book_market.py:93 No items to match in market food at tick 1
INFO     Market_electronics:order_book_market.py:93 No items to match in market electronics at tick 1
INFO     Market_labor:order_book_market.py:93 No items to match in market labor at tick 1
INFO     Market_housing:order_book_market.py:93 No items to match in market housing at tick 1
INFO     Market_housing:order_book_market.py:93 No items to match in market housing at tick 1
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 100
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 101
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 102
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 103
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 104
INFO     simulation.agents.government:government.py:446 INFRASTRUCTURE_INVESTED | Level 1 reached. Cost: 5000.0
INFO     TestPhase29:engine.py:522 GLOBAL_TFP_BOOST | All firms productivity increased by 5.0%
FAILED                                                                   [ 50%]
tests/test_phase29_depression.py::TestPhase29Depression::test_depression_scenario_triggers 
-------------------------------- live log call --------------------------------
INFO     simulation.bank:bank.py:68 Bank 10 initialized. Assets: 1000000.00, Base Rate: 5.00%
INFO     simulation.agents.government:government.py:108 Government 11 initialized with assets: 0.0
INFO     simulation.agents.central_bank:central_bank.py:34 CENTRAL_BANK_INIT | Rate: 5.00%, Target Infl: 2.00%
INFO     Market_food:order_book_market.py:35 OrderBookMarket food initialized.
INFO     Market_electronics:order_book_market.py:35 OrderBookMarket electronics initialized.
INFO     Market_labor:order_book_market.py:35 OrderBookMarket labor initialized.
INFO     simulation.loan_market:loan_market.py:21 LoanMarket loan_market initialized with bank: 10
INFO     Market_housing:order_book_market.py:35 OrderBookMarket housing initialized.
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:18 AITrainingManager initialized.
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 100
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 101
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 102
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 103
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 104
INFO     simulation.systems.bootstrapper:bootstrapper.py:86 BOOTSTRAPPER | Injected resources into 0 firms.
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 5 workers to Firm 100
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 101
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 102
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 103
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 104
INFO     simulation.systems.bootstrapper:bootstrapper.py:42 BOOTSTRAPPER | Total force-assigned workers: 5
INFO     TestPhase29:initializer.py:288 Simulation run started with run_id: <MagicMock name='mock.save_simulation_run()' id='2144060163136'>
INFO     TestPhase29:initializer.py:293 Simulation fully initialized with run_id: <MagicMock name='mock.save_simulation_run()' id='2144060163136'>
INFO     TestPhase29:engine.py:158 MONEY_SUPPLY_BASELINE | Baseline Money Supply set to: 1505000.00
INFO     TestPhase29:engine.py:164 --- Starting Tick 1 ---
INFO     simulation.bank:bank.py:336 BANK_TICK_SUMMARY | Collected Loan Int: 0.00, Paid Deposit Int: 0.00, Net Profit: 0.00, Reserves: 1000000.00
INFO     TestPhase29:engine.py:286 DEBUG_WO057 | Tick 1 | Indicators: ['unemployment_rate', 'avg_wage', 'money_supply', 'total_labor_income', 'total_sales_volume', 'total_household_assets', 'total_firm_assets', 'food_avg_price', 'food_trade_volume', 'avg_goods_price', 'total_production', 'total_consumption', 'total_food_consumption', 'total_inventory', 'avg_survival_need', 'labor_share', 'velocity_of_money', 'inventory_turnover', 'avg_education_level', 'brain_waste_count']
INFO     TestPhase29:engine.py:290 DEBUG_WO057 | AvgPrice: 0.0000
INFO     TestPhase29:engine.py:296 DEBUG_WO057 | SensoryDTO: InfSMA=-1.0000, UnempSMA=100.0000, DebtRat=0.0000
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 0
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 1
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 2
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 3
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 4
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 100
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 101
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 102
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 103
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 104
INFO     Market_food:order_book_market.py:93 No items to match in market food at tick 1
INFO     Market_electronics:order_book_market.py:93 No items to match in market electronics at tick 1
INFO     Market_labor:order_book_market.py:93 No items to match in market labor at tick 1
INFO     Market_housing:order_book_market.py:93 No items to match in market housing at tick 1
INFO     Market_housing:order_book_market.py:93 No items to match in market housing at tick 1
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 100
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 101
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 102
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 103
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 104
INFO     simulation.agents.government:government.py:446 INFRASTRUCTURE_INVESTED | Level 1 reached. Cost: 5000.0
INFO     TestPhase29:engine.py:522 GLOBAL_TFP_BOOST | All firms productivity increased by 5.0%
FAILED                                                                   [100%]

================================== FAILURES ===================================
______________ TestPhase29Depression.test_crisis_monitor_logging ______________

self = <test_phase29_depression.TestPhase29Depression testMethod=test_crisis_monitor_logging>

    def test_crisis_monitor_logging(self):
        """Test that crisis monitor logs data."""
>       self.sim.run_tick() # Tick 1
        ^^^^^^^^^^^^^^^^^^^

tests\test_phase29_depression.py:245: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\engine.py:593: in run_tick
    self.ma_manager.process_market_exits_and_entries(self.time)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.systems.ma_manager.MAManager object at 0x000001F332A0AA50>
current_tick = 1

    def process_market_exits_and_entries(self, current_tick: int):
        """
        Main entry point.
        1. Identify M&A (Predator vs Prey).
        2. Identify Bankruptcy (Capital < 0 or Consecutive Losses).
        """
        if not self.ma_enabled:
            return
    
        # 1. Identify Predators and Preys
        firms = self.simulation.firms
        if not firms:
            return
    
        # Calculate stats for relative thresholds
        avg_assets = sum(f.assets for f in firms) / len(firms)
    
        predators = []
        preys = []
        hostile_targets = [] # Phase 21
        bankrupts = []
    
        for firm in firms:
            # Update Valuation first
            firm.calculate_valuation()
    
            # Bankruptcy Criteria
            if firm.assets < 0:
                bankrupts.append(firm)
                continue
    
            # Standard Distress (Friendly M&A)
            if firm.consecutive_loss_turns >= self.bankruptcy_loss_threshold:
                 preys.append(firm)
            elif firm.assets < avg_assets * 0.2:
                preys.append(firm)
    
            # Phase 21: Hostile Takeover Criteria
            # Target if Market Cap < Intrinsic Value * Threshold
            intrinsic_value = firm.valuation # Based on calculate_valuation (Net Assets + Profit Premium)
            # Spec says: Market Cap < Intrinsic * 0.7
            # Note: firm.valuation might ALREADY be intrinsic value.
            # Market Cap is different. Market Cap = Stock Price * Shares.
            # Firm.get_market_cap uses book value if no stock price.
            # But let's assume we use 'stock_price' if available.
            # If firm is public.
    
            market_cap = firm.get_market_cap()
            # If market cap is low relative to assets...
            # Note: calculate_valuation uses profit premium.
            # Intrinsic Value here roughly equals 'valuation'.
    
            threshold = getattr(self.config, "HOSTILE_TAKEOVER_DISCOUNT_THRESHOLD", 0.7)
    
>           if market_cap < intrinsic_value * threshold:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           TypeError: '<' not supported between instances of 'MagicMock' and 'float'

simulation\systems\ma_manager.py:78: TypeError
---------------------------- Captured stdout call -----------------------------
WARNING: Scenario not loaded from file during test setup. Manually enabling.
------------------------------ Captured log call ------------------------------
INFO     simulation.bank:bank.py:68 Bank 10 initialized. Assets: 1000000.00, Base Rate: 5.00%
INFO     simulation.agents.government:government.py:108 Government 11 initialized with assets: 0.0
INFO     simulation.agents.central_bank:central_bank.py:34 CENTRAL_BANK_INIT | Rate: 5.00%, Target Infl: 2.00%
INFO     Market_food:order_book_market.py:35 OrderBookMarket food initialized.
INFO     Market_electronics:order_book_market.py:35 OrderBookMarket electronics initialized.
INFO     Market_labor:order_book_market.py:35 OrderBookMarket labor initialized.
INFO     simulation.loan_market:loan_market.py:21 LoanMarket loan_market initialized with bank: 10
INFO     Market_housing:order_book_market.py:35 OrderBookMarket housing initialized.
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:18 AITrainingManager initialized.
INFO     simulation.systems.demographic_manager:demographic_manager.py:29 DemographicManager initialized.
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 100
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 101
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 102
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 103
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 104
INFO     simulation.systems.bootstrapper:bootstrapper.py:86 BOOTSTRAPPER | Injected resources into 0 firms.
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 5 workers to Firm 100
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 101
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 102
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 103
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 104
INFO     simulation.systems.bootstrapper:bootstrapper.py:42 BOOTSTRAPPER | Total force-assigned workers: 5
INFO     TestPhase29:initializer.py:288 Simulation run started with run_id: <MagicMock name='mock.save_simulation_run()' id='2144038358720'>
INFO     TestPhase29:initializer.py:293 Simulation fully initialized with run_id: <MagicMock name='mock.save_simulation_run()' id='2144038358720'>
INFO     TestPhase29:engine.py:158 MONEY_SUPPLY_BASELINE | Baseline Money Supply set to: 1505000.00
INFO     TestPhase29:engine.py:164 --- Starting Tick 1 ---
INFO     simulation.bank:bank.py:336 BANK_TICK_SUMMARY | Collected Loan Int: 0.00, Paid Deposit Int: 0.00, Net Profit: 0.00, Reserves: 1000000.00
INFO     TestPhase29:engine.py:286 DEBUG_WO057 | Tick 1 | Indicators: ['unemployment_rate', 'avg_wage', 'money_supply', 'total_labor_income', 'total_sales_volume', 'total_household_assets', 'total_firm_assets', 'food_avg_price', 'food_trade_volume', 'avg_goods_price', 'total_production', 'total_consumption', 'total_food_consumption', 'total_inventory', 'avg_survival_need', 'labor_share', 'velocity_of_money', 'inventory_turnover', 'avg_education_level', 'brain_waste_count']
INFO     TestPhase29:engine.py:290 DEBUG_WO057 | AvgPrice: 0.0000
INFO     TestPhase29:engine.py:296 DEBUG_WO057 | SensoryDTO: InfSMA=-1.0000, UnempSMA=100.0000, DebtRat=0.0000
INFO     simulation.utils.shadow_logger:shadow_logger.py:36 ShadowLogger initialized at logs/shadow_hand_stage1.csv
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 0
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 1
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 2
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 3
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 4
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 100
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 101
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 102
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 103
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 104
INFO     Market_food:order_book_market.py:93 No items to match in market food at tick 1
INFO     Market_electronics:order_book_market.py:93 No items to match in market electronics at tick 1
INFO     Market_labor:order_book_market.py:93 No items to match in market labor at tick 1
INFO     Market_housing:order_book_market.py:93 No items to match in market housing at tick 1
INFO     Market_housing:order_book_market.py:93 No items to match in market housing at tick 1
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 100
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 101
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 102
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 103
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 104
INFO     simulation.agents.government:government.py:446 INFRASTRUCTURE_INVESTED | Level 1 reached. Cost: 5000.0
INFO     TestPhase29:engine.py:522 GLOBAL_TFP_BOOST | All firms productivity increased by 5.0%
___________ TestPhase29Depression.test_depression_scenario_triggers ___________

self = <test_phase29_depression.TestPhase29Depression testMethod=test_depression_scenario_triggers>

    def test_depression_scenario_triggers(self):
        """Test that shocks are applied at start_tick."""
    
        # Verify initial state
        initial_base_rate = self.sim.bank.base_rate
        initial_tax_rate = self.sim.government.corporate_tax_rate
        print(f"Initial State: Base Rate={initial_base_rate}, Tax Rate={initial_tax_rate}")
    
        # Run until before shock
        start_tick = self.sim.stress_scenario_config.start_tick
        print(f"Running until tick {start_tick}...")
    
        for _ in range(start_tick):
>           self.sim.run_tick()

tests\test_phase29_depression.py:232: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\engine.py:593: in run_tick
    self.ma_manager.process_market_exits_and_entries(self.time)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.systems.ma_manager.MAManager object at 0x000001F332923390>
current_tick = 1

    def process_market_exits_and_entries(self, current_tick: int):
        """
        Main entry point.
        1. Identify M&A (Predator vs Prey).
        2. Identify Bankruptcy (Capital < 0 or Consecutive Losses).
        """
        if not self.ma_enabled:
            return
    
        # 1. Identify Predators and Preys
        firms = self.simulation.firms
        if not firms:
            return
    
        # Calculate stats for relative thresholds
        avg_assets = sum(f.assets for f in firms) / len(firms)
    
        predators = []
        preys = []
        hostile_targets = [] # Phase 21
        bankrupts = []
    
        for firm in firms:
            # Update Valuation first
            firm.calculate_valuation()
    
            # Bankruptcy Criteria
            if firm.assets < 0:
                bankrupts.append(firm)
                continue
    
            # Standard Distress (Friendly M&A)
            if firm.consecutive_loss_turns >= self.bankruptcy_loss_threshold:
                 preys.append(firm)
            elif firm.assets < avg_assets * 0.2:
                preys.append(firm)
    
            # Phase 21: Hostile Takeover Criteria
            # Target if Market Cap < Intrinsic Value * Threshold
            intrinsic_value = firm.valuation # Based on calculate_valuation (Net Assets + Profit Premium)
            # Spec says: Market Cap < Intrinsic * 0.7
            # Note: firm.valuation might ALREADY be intrinsic value.
            # Market Cap is different. Market Cap = Stock Price * Shares.
            # Firm.get_market_cap uses book value if no stock price.
            # But let's assume we use 'stock_price' if available.
            # If firm is public.
    
            market_cap = firm.get_market_cap()
            # If market cap is low relative to assets...
            # Note: calculate_valuation uses profit premium.
            # Intrinsic Value here roughly equals 'valuation'.
    
            threshold = getattr(self.config, "HOSTILE_TAKEOVER_DISCOUNT_THRESHOLD", 0.7)
    
>           if market_cap < intrinsic_value * threshold:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           TypeError: '<' not supported between instances of 'MagicMock' and 'float'

simulation\systems\ma_manager.py:78: TypeError
---------------------------- Captured stdout call -----------------------------
WARNING: Scenario not loaded from file during test setup. Manually enabling.
Initial State: Base Rate=0.05, Tax Rate=0.2
Running until tick 50...
------------------------------ Captured log call ------------------------------
INFO     simulation.bank:bank.py:68 Bank 10 initialized. Assets: 1000000.00, Base Rate: 5.00%
INFO     simulation.agents.government:government.py:108 Government 11 initialized with assets: 0.0
INFO     simulation.agents.central_bank:central_bank.py:34 CENTRAL_BANK_INIT | Rate: 5.00%, Target Infl: 2.00%
INFO     Market_food:order_book_market.py:35 OrderBookMarket food initialized.
INFO     Market_electronics:order_book_market.py:35 OrderBookMarket electronics initialized.
INFO     Market_labor:order_book_market.py:35 OrderBookMarket labor initialized.
INFO     simulation.loan_market:loan_market.py:21 LoanMarket loan_market initialized with bank: 10
INFO     Market_housing:order_book_market.py:35 OrderBookMarket housing initialized.
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:18 AITrainingManager initialized.
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 100
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 101
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 102
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 103
INFO     simulation.systems.bootstrapper:bootstrapper.py:79 BOOTSTRAPPER | Injected 50.0 units to Firm 104
INFO     simulation.systems.bootstrapper:bootstrapper.py:86 BOOTSTRAPPER | Injected resources into 0 firms.
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 5 workers to Firm 100
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 101
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 102
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 103
INFO     simulation.systems.bootstrapper:bootstrapper.py:40 BOOTSTRAPPER | Force-assigned 0 workers to Firm 104
INFO     simulation.systems.bootstrapper:bootstrapper.py:42 BOOTSTRAPPER | Total force-assigned workers: 5
INFO     TestPhase29:initializer.py:288 Simulation run started with run_id: <MagicMock name='mock.save_simulation_run()' id='2144060163136'>
INFO     TestPhase29:initializer.py:293 Simulation fully initialized with run_id: <MagicMock name='mock.save_simulation_run()' id='2144060163136'>
INFO     TestPhase29:engine.py:158 MONEY_SUPPLY_BASELINE | Baseline Money Supply set to: 1505000.00
INFO     TestPhase29:engine.py:164 --- Starting Tick 1 ---
INFO     simulation.bank:bank.py:336 BANK_TICK_SUMMARY | Collected Loan Int: 0.00, Paid Deposit Int: 0.00, Net Profit: 0.00, Reserves: 1000000.00
INFO     TestPhase29:engine.py:286 DEBUG_WO057 | Tick 1 | Indicators: ['unemployment_rate', 'avg_wage', 'money_supply', 'total_labor_income', 'total_sales_volume', 'total_household_assets', 'total_firm_assets', 'food_avg_price', 'food_trade_volume', 'avg_goods_price', 'total_production', 'total_consumption', 'total_food_consumption', 'total_inventory', 'avg_survival_need', 'labor_share', 'velocity_of_money', 'inventory_turnover', 'avg_education_level', 'brain_waste_count']
INFO     TestPhase29:engine.py:290 DEBUG_WO057 | AvgPrice: 0.0000
INFO     TestPhase29:engine.py:296 DEBUG_WO057 | SensoryDTO: InfSMA=-1.0000, UnempSMA=100.0000, DebtRat=0.0000
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 0
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 1
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 2
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 3
INFO     simulation.agents.government:government.py:291 HOUSEHOLD_SUPPORT | Paid 8.00 to 4
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 100
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 101
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 102
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 103
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 10.00 as wealth_tax from 104
INFO     Market_food:order_book_market.py:93 No items to match in market food at tick 1
INFO     Market_electronics:order_book_market.py:93 No items to match in market electronics at tick 1
INFO     Market_labor:order_book_market.py:93 No items to match in market labor at tick 1
INFO     Market_housing:order_book_market.py:93 No items to match in market housing at tick 1
INFO     Market_housing:order_book_market.py:93 No items to match in market housing at tick 1
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 100
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 101
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 102
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 103
INFO     simulation.systems.tax_agency:tax_agency.py:63 TAX_COLLECTED | Collected 20.00 as corporate_tax from 104
INFO     simulation.agents.government:government.py:446 INFRASTRUCTURE_INVESTED | Level 1 reached. Cost: 5000.0
INFO     TestPhase29:engine.py:522 GLOBAL_TFP_BOOST | All firms productivity increased by 5.0%
=========================== short test summary info ===========================
FAILED tests/test_phase29_depression.py::TestPhase29Depression::test_crisis_monitor_logging
FAILED tests/test_phase29_depression.py::TestPhase29Depression::test_depression_scenario_triggers
============================== 2 failed in 3.91s ==============================
