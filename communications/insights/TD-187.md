# TD-187: Liquidation Waterfall Protocol Implementation Insights

## Overview
Implemented the Liquidation Waterfall Protocol to prioritize employee entitlements (Severance, Unpaid Wages) over other creditors during firm liquidation.

## Key Changes
1.  **LiquidationManager**: New system component (`simulation/systems/liquidation_manager.py`) managing the waterfall logic.
2.  **Claim Logic**:
    *   **Tier 1**: Employee Severance (based on tenure, capped at 3 years) & Unpaid Wages.
    *   **Tier 2**: Secured Debt (Bank Loans).
    *   **Tier 3**: Taxes (estimated current liability).
    *   **Tier 4**: General Unsecured Creditors.
    *   **Tier 5**: Equity (Shareholders).
3.  **Tenure Tracking**: Added `employment_start_tick` to `Household` (EconStateDTO) and initialized on hire in `HRDepartment`.
4.  **Unpaid Wage Tracking**: `HRDepartment` now tracks unpaid wages in `unpaid_wages` dictionary instead of just logging "Zombie" state.
5.  **Integration**: `AgentLifecycleManager` uses `LiquidationManager` before clearing employees/assets.

## Technical Debt & Observations
*   **Asset-Rich Cash-Poor Insolvency**: The current implementation only distributes *available cash* (`finance.balance`) via the waterfall. Non-cash assets (Inventory, Capital Stock) are seized by the `PublicManager` (via `process_bankruptcy_event`), but their value is **not** immediately liquidated or distributed to creditors. This means a firm with high inventory but zero cash will default on employee severance, effectively transferring that value to the state (PublicManager treasury) instead of creditors. This adheres to "Liquid Assets" valuation but may be inequitable.
*   **SettlementSystem dependency**: `LiquidationManager` relies on `SettlementSystem` which usually requires Agent objects. Handling "government" or external creditors purely by string ID might be fragile if `SettlementSystem` expects objects. Currently, we try to resolve string IDs to objects via `state.agents`.
*   **Government Agent**: The code assumes `state.government` exists. If not, tax payments might be skipped or fail.
*   **Shareholder Access**: Retrieving shareholders relies on iterating `state.households`. Ideally, `StockMarket` should expose a "get shareholders for firm" method that returns Agent objects, but `StockMarket` might only store IDs.
*   **Negative Ticks**: Tenure calculation ignores employment start ticks < 0. If pre-simulation history implies negative start ticks, they are currently excluded from severance.
*   **Tax Calculation**: We use a simplified tax calculation based on `current_profit`. It does not account for historical unpaid taxes (which are not explicitly tracked in a ledger currently).

## Verification
*   Unit tests in `tests/unit/systems/test_liquidation_manager.py` verify claim calculation and distribution logic.
*   Integration tests in `tests/integration/test_liquidation_waterfall.py` verify priority of employees over shareholders.
