# WO-165: Financial Integrity Tests & Insights

## 1. Overview
Implemented M2 (Broad Money) and M0 (Base Money) tracking in `WorldState` to verify financial integrity.
- `calculate_base_money()`: Tracks M0 = Currency in Circulation + Bank Reserves.
- `calculate_total_money()`: Tracks M2 = Currency in Circulation + Bank Deposits. (Excluding Central Bank assets which are irrelevant for M2).

## 2. Findings & Technical Debt

### A. Double Creation of Liquidity in LoanMarket
**Phenomenon:**
When a loan is granted via `LoanMarket`:
1. `Bank.grant_loan` creates a `Deposit` record for the borrower. (Correct M2 expansion).
2. `LoanMarket` then generates a `Transaction` of type `loan`.
3. `TransactionProcessor` executes this transaction as a generic transfer, moving `assets` (Reserves) from Bank to `assets` (Cash) of Borrower.

**Consequence:**
The borrower receives the loan amount **twice**:
- Once as a Bank Deposit.
- Once as Cash (via the transfer).
The Bank loses Reserves but retains the Deposit liability, causing a balance sheet mismatch (Assets decrease, Liabilities increase).

**Solution Recommendation:**
`LoanMarket` should **not** generate a `loan` transaction that triggers a cash transfer. The loan is already "delivered" via the creation of the Deposit. If the borrower needs cash, they should issue a separate `WITHDRAW` order, which correctly debits the Deposit and credits Cash.

### B. Ambiguity of `Agent.assets`
The simulation treats `Agent.assets` primarily as "Cash on Hand" (Currency), as it is distinct from `Bank.deposits`. However, `SettlementSystem` uses `Agent.assets` for all transfers, implying it acts as the sole liquidity pool. This dual role (Cash vs Bank Balance) causes confusion in accounting.
- **Clarification:** `Agent.assets` should be strictly defined as "Currency/Cash". Bank Deposits are claims on the bank and should only be usable via Bank interfaces (Checks/Transfers).

## 3. Implementation Details
- Added `tests/finance/test_m2_integrity.py` covering credit expansion, destruction, and settlement purity.
- Fixed regressions in `test_phase20_integration.py` related to `ImmigrationManager` signature and mock configuration.
- Patched `verify_m2_fix.py` to support new `Government` initialization requirements.

## 4. Verification
All new and regression tests pass. M0 is conserved during credit expansion (assuming the cash transfer bug is fixed or accounting for it as "Cash Withdrawal"), and M2 expands as expected.
