# WO-176: Atomic Taxation & Settlement System

## Status
- **Date**: 2024-05-22
- **Author**: Jules
- **Mission**: WO-176

## Technical Debt Identified
1.  **Lack of Atomicity**: Tax payments are processed in separate, sequential transactions after the primary trade. This creates a risk where the trade succeeds but the tax payment fails (e.g., due to insufficient funds after the trade), leading to money leaks or inconsistent states.
2.  **God Class (TransactionProcessor)**: `TransactionProcessor` handles financial settlement, tax calculation, inventory updates, and employment changes. This violates the Single Responsibility Principle (SRP).
3.  **Tight Coupling**: `TransactionProcessor` is tightly coupled to `Government`'s internal tax logic (calling `collect_tax`).
4.  **Government Responsibilities**: `Government` agent mixes policy-making with tax bookkeeping and direct collection logic.

## Solution Overview
We are implementing a "Saga-like" atomic settlement system.
-   **TaxationSystem**: A dedicated system for tax calculation and revenue recording (pure logic + ledger).
-   **SettlementSystem**: Enhanced with `settle_escrow` to handle multi-party atomic transfers (1 Debit -> N Credits) with rollback.
-   **TransactionProcessor**: Refactored to be a pure orchestrator that bundles payment intents and delegates execution.
-   **Government**: Simplified to be a policy decision maker and a passive payee.

## Risks
-   **Rollback Complexity**: Ensuring strict rollback in `SettlementSystem` is critical. If rollback fails, the system enters an inconsistent state.
-   **Backward Compatibility**: The `Government` agent is widely used. Removing methods like `collect_tax` requires careful verification that no other components rely on them (or they must be updated).
-   **State Management**: `TaxationSystem` now holds the tax revenue ledger. We must ensure that the `Government` agent can still access this data for its policy decisions (Taylor Rule, Fiscal Policy). We decided that `Government` will own the `TaxationSystem` instance, and `TransactionProcessor` will access it via `state.government.taxation_system`.
