# Insight Report: PIR Implementation in BubbleObservatory (Mission 150513)

## Technical Debt & Risks

### 1. Breaking API Change
The addition of the `pir` field to `HousingBubbleMetricsDTO` constitutes a breaking API change.
- **Details**: Any consumer of this DTO (including tests) that relies on strict typing or unpacking might fail if not updated.
- **Mitigation**: We are updating the DTO definition, but comprehensive grepping for usages is required (done, no direct usages found in tests, but implicit usages in `BubbleObservatory` itself).

### 2. God Class Dependency
The implementation requires iterating over all agents to calculate average income.
- **Details**: `self.simulation.agents` is accessed. This reinforces the dependency on the `Simulation` God Class.
- **Justification**: Necessary for accurate economy-wide PIR calculation. Using transaction-only data would be biased towards recent market participants.
- **Future Refactoring**: Consider an `EconomyStats` service that aggregates income data, or having agents report stats to a central registry.

### 3. SRP Violation
`BubbleObservatory` is responsible for metrics collection, calculation, and CSV logging.
- **Details**: Adding PIR calculation and alerting logic adds more responsibility to this class.
- **Impact**: Makes the class harder to test and maintain.
- **Future Refactoring**: Split into `MetricCollector`, `BubbleAnalyzer` (for alerts), and `MetricLogger`.

## Implementation Details
- **PIR Threshold**: 20.0 (Hardcoded as per spec).
- **Income Calculation**: `agent.current_wage * TICKS_PER_YEAR`.
