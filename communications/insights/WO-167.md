# Insight Report: WO-167 Grace Protocol

## 1. Phenomenon
The current bankruptcy logic is overly aggressive. Firms and households with valuable non-cash assets (inventory, stocks) are liquidated immediately upon running out of cash or reaching starvation thresholds, even if they could theoretically survive by selling those assets. This leads to premature economic destruction and breaks the realism of "distress sales".

## 2. Technical Debt & Structural Issues
*   **Order Generation in Lifecycle Manager:** The Grace Protocol requires `AgentLifecycleManager` (or `FinanceDepartment` called by it) to generate and place `Order` objects. Typically, orders are generated by `DecisionEngine`s in `Phase1_Decision`. Injecting orders in `Phase_Bankruptcy` (which runs between Decision and Matching) is a deviation from the standard flow but necessary for this emergency mechanism.
*   **Coupling:** `FinanceDepartment` needs to know about `Order` structures, which arguably belongs to `DecisionEngine`. However, creating a "DistressDecisionEngine" seems overkill. We will implement `trigger_emergency_liquidation` in `FinanceDepartment` to generate orders, acknowledging this minor coupling.
*   **Household Death Logic:** Household death logic is split between `BioComponent` (aging) and `SocialComponent` (starvation/needs). `AgentLifecycleManager` processes death *after* it happens (liquidation). To implement Grace Protocol, we must intervene *before* death (in `AgentLifecycleManager` or `update_needs`) to override the `is_active=False` flag if the agent is in a "grace period".
*   **Market Access:** `AgentLifecycleManager` needs access to `state.markets` to place emergency orders. This is available in `SimulationState` passed to `execute()`.

## 3. Solution Overview
We will implement a "Grace Protocol" (Distress Mode):
1.  **Firms:** Modify `FinanceDepartment` to detect "Cash Crunch". If crunched but solvent (has inventory), enter distress mode (5-tick timer). Automatically place 20% discounted sell orders. Prevent liquidation during this period.
2.  **Households:** Similar logic. If starving but asset-rich (stocks/inventory), sell assets and prevent starvation death for 5 ticks.
3.  **Phase Execution:** These checks run in `Phase_Bankruptcy`, which is ideally situated before `Phase2_Matching`, allowing emergency orders to be executed immediately in the same tick.

## 4. Lessons Learned (Pre-Implementation)
*   The "Sacred Sequence" of phases (`Decision -> Bankruptcy -> Matching`) is crucial. If `Bankruptcy` ran after `Matching`, the Grace Protocol would fail to save agents in the current tick. The current architecture supports this feature well.
*   "God Classes" like `Household` make it slightly harder to cleanly separate "Distress Logic" from "Core Logic", requiring modifications to the main class.
