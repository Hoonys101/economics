# TD-125 & TD-015: Watchtower Backend Refactoring & Metrics Centralization

## Overview
Refactored the Watchtower backend to align with the "Golden Sample v2" frontend contract (TD-125) and centralized key economic metrics into `EconomicIndicatorTracker` (TD-015).

## Changes Implemented
1.  **DTO Standardization (`simulation/dtos/watchtower.py`)**:
    - Replaced the previous DTO structure with `WatchtowerSnapshotDTO`, exactly matching the fields and nesting of `watchtower_full_mock_v2.json`.
    - Used nested dataclasses (`IntegrityDTO`, `MacroDTO`, `FinanceDTO`, `PoliticsDTO`, `PopulationDTO`) for strict typing.
    - Removed legacy DTOs (`DashboardSnapshotDTO`, etc.) from `simulation/dtos/api.py`.
    - Removed legacy `SnapshotViewModel` and its tests.

2.  **Metrics Centralization (`simulation/metrics/economic_tracker.py`)**:
    - Enhanced `EconomicIndicatorTracker` to calculate:
        - **Gini Coefficient**: Implemented directly.
        - **Social Cohesion**: Aggregated from `Household` political trust scores.
        - **Nominal GDP**: Explicitly tracked alongside production volume.
        - **Population Metrics**: Active population count and wealth quintile distribution.
        - **Total Wealth**: now calculates **Cash + Stock Portfolio Value** for accurate inequality tracking.
    - Updated `track()` method to calculate and store these metrics every tick.

3.  **Dashboard Integration (`simulation/orchestration/dashboard_service.py`)**:
    - Updated to populate `WatchtowerSnapshotDTO` using the centralized data from `EconomicIndicatorTracker`.
    - Ensures Single Source of Truth (SSoT) for dashboard metrics.

## Technical Debt & Observations

### Resolved
- **DTO Mismatch**: Backend now produces JSON structure identical to what the frontend expects.
- **Scattered Metrics**: Critical indicators (Gini, Cohesion) are no longer calculated ad-hoc.
- **Wealth Calculation**: Gini/Quintiles now correctly include stock portfolio value, resolving a regression risk.

### Remaining / New Debt
1.  **Logic Duplication**: `InequalityTracker` (`simulation/metrics/inequality_tracker.py`) still exists. Future work should consolidate it.
2.  **Political Granularity**: `DashboardService` populates low/mid/high approval with the total average.
3.  **Money Supply Definitions**: `M0` and `M1` are currently estimated heuristics.
4.  **Server Status**: The `status` field in the snapshot is hardcoded to `"RUNNING"`.

## Verification
- **DTO Structure**: Verified via script against `watchtower_full_mock_v2.json`.
- **Metrics Logic**: Verified via unit tests with mock agents for Gini, Cohesion, and Population quintiles (including stock value).
