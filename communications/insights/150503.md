# Mission 150503: Housing Transaction Saga Handler Refactoring

## 1. Overview
Refactored `HousingTransactionSagaHandler` from a monolithic atomic transaction to a 5-step State Machine (`INITIATED`, `CREDIT_CHECK`, `APPROVED`, `ESCROW_LOCKED`, `TRANSFER_TITLE`). This improves robustness, allows for multi-tick transactions, and supports graceful rollback/compensation.

## 2. Technical Decisions
- **Persistence**: `SettlementSystem` now maintains `active_sagas` (`Dict[UUID, HousingTransactionSagaStateDTO]`) and processes them each tick via `process_sagas`.
- **Registry & LoanMarket Updates**:
    - `IRealEstateRegistry` updated to support `set_under_contract`, `add_lien`, `remove_lien`.
    - `ILoanMarket` updated to support `stage_mortgage`, `check_status`, `convert_staged_to_loan`.
    - `Bank` service updated to include `terminate_loan` for compensation/rollback.
- **Dependency Handling**: `HousingTransactionSagaHandler` orchestrates the flow, calling `LoanMarket` and `Registry`. Calls to `Registry.add_lien` are handled within the Saga Handler after loan conversion, to keep `LoanMarket` focused on credit logic.

## 3. Technical Debt & Insights
- **Synchronous "Staging"**: `LoanMarket.stage_mortgage` currently creates the loan synchronously in the Bank (active state). "Staging" is effectively "Created but not funded". If the saga fails, the loan is terminated (`void_staged_application`). In a true async system, "Staged" might be a separate pending state in the Bank.
- **DTO Safety**: `HousingTransactionSagaStateDTO` is a `TypedDict`. Accessing optional keys (like `staged_loan_id` or `mortgage_approval`) requires care (using `.get()` or ensuring flow logic guarantees presence).
- **Agent Compensation**: `SettlementSystem.find_and_compensate_by_agent` was added to support cleaning up sagas if an agent goes bankrupt. It relies on passing a handler or context, which might require tighter integration with `Phase_Recovery`.

## 4. Verification
- Verified State Machine transitions and rollback logic via `scripts/verify_saga_state_machine.py` (custom script).
- Verified `LoanMarket` existing functionality via `tests/unit/markets/test_loan_market_mortgage.py`.
