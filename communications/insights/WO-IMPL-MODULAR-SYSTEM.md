# Insight Report: System Registry Hardening (WO-IMPL-MODULAR-SYSTEM)

## 1. Architectural Insights
- **Protocol-Driven Registry**: By implementing `ISystemAgentRegistry`, the `AgentRegistry` now explicitly distinguishes between standard agents (Households, Firms) and System Agents (Central Bank, Public Manager). This separation of concerns allows for specialized handling of system-critical entities, particularly those with unconventional IDs (e.g., ID 0).
- **Falsy ID Handling**: The explicit check `if agent_id is None` replaces implicit falsy checks (`if not agent_id`), preventing the "Agent 0 Disappearance" bug. This is a critical hardening pattern for any system using integer IDs starting at 0.
- **Explicit Registration**: Moving from implicit side-effect registration (via shared state dictionaries) to explicit `register_system_agent` calls in `SimulationInitializer` improves code readability and reduces "action at a distance". It makes the system boot sequence more deterministic.

## 2. Regression Analysis
- **Test Failure in `test_audit_total_m2_logic`**:
    - **Issue**: The existing test mocked a `Household` with `id=1`. However, `ID_GOVERNMENT` is defined as `1` in `modules/system/constants.py`. The `SettlementSystem` correctly excludes ID 1 from M2 calculations (Government is excluded).
    - **Fix**: Updated the test to use `hh.id = 101` to ensure the household is treated as a public agent and included in M2.
    - **Secondary Issue**: The test mocked `Household` but `SettlementSystem`'s `isinstance` checks against `IFinancialEntity` were interacting with `MagicMock` in a way that required explicit configuration of `get_balance`.
    - **Fix**: Configured `hh.get_balance.return_value = 100` to ensure robust mock behavior regardless of protocol check ordering.
- **Dependency Fix**: `modules/market/api.py` was missing `Tuple` import, causing `NameError` during test collection. This was fixed to enable test execution.

## 3. Test Evidence
```
============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-8.3.4, pluggy-1.5.0
rootdir: /app
configfile: pytest.ini
plugins: anyio-4.8.0, cov-6.0.0, asyncio-0.25.3
collected 662 items

tests/unit/test_agent_registry_id_zero.py ....                           [  0%]
tests/unit/test_ai_decision_engine.py .......                            [  1%]
tests/unit/test_bank_reserves.py ....                                    [  2%]
tests/unit/test_bankruptcy_simulation.py ..                              [  2%]
tests/unit/test_belief_system.py ......                                  [  3%]
tests/unit/test_bond_market.py ....                                      [  4%]
tests/unit/test_bootstrapper.py ...                                      [  4%]
tests/unit/test_central_bank_policy.py ..                                [  4%]
tests/unit/test_circuit_breaker.py ....                                  [  5%]
tests/unit/test_consumption_mechanics.py ...                             [  5%]
tests/unit/test_credit_market.py ....                                    [  6%]
tests/unit/test_debt_deflation.py ..                                     [  6%]
tests/unit/test_decision_engine_v2.py .....                              [  7%]
tests/unit/test_demographic_transition.py ...                            [  8%]
tests/unit/test_dto_fidelity.py .........                                [  9%]
tests/unit/test_economic_indicators.py ....                              [ 10%]
tests/unit/test_emergency_intervention.py ...                            [ 10%]
tests/unit/test_error_handling.py ....                                   [ 11%]
tests/unit/test_escrow_audit.py ..                                       [ 11%]
tests/unit/test_event_bus.py ....                                        [ 12%]
tests/unit/test_financial_contagion.py ..                                [ 12%]
tests/unit/test_firm_behavior.py ......                                  [ 13%]
tests/unit/test_firm_valuation.py ....                                   [ 13%]
tests/unit/test_fiscal_policy.py ...                                     [ 14%]
tests/unit/test_ghost_firm_prevention.py ...                             [ 14%]
tests/unit/test_goods_market.py .....                                    [ 15%]
tests/unit/test_government_agent.py ...                                  [ 16%]
tests/unit/test_housing_market.py .....                                  [ 16%]
tests/unit/test_housing_market_mechanics.py ....                         [ 17%]
tests/unit/test_inflation_dynamics.py ..                                 [ 17%]
tests/unit/test_inheritance_tax_audit.py ....                            [ 18%]
tests/unit/test_labor_market.py .....                                    [ 19%]
tests/unit/test_liquidity_crisis.py ..                                   [ 19%]
tests/unit/test_liquidity_trap.py ..                                     [ 19%]
tests/unit/test_market_mechanics.py ......                               [ 20%]
tests/unit/test_monetary_policy.py ...                                   [ 21%]
tests/unit/test_money_supply_audit.py ...                                [ 21%]
tests/unit/test_multi_currency.py .....                                  [ 22%]
tests/unit/test_production_function.py ....                              [ 23%]
tests/unit/test_public_manager.py ....                                   [ 23%]
tests/unit/test_scenario_loader.py ....                                  [ 24%]
tests/unit/test_shock_propagation.py ..                                  [ 24%]
tests/unit/test_simulation_engine.py ...                                 [ 25%]
tests/unit/test_simulation_state.py ...                                  [ 25%]
tests/unit/test_social_network.py ....                                   [ 26%]
tests/unit/test_stagflation.py ..                                        [ 26%]
tests/unit/test_system_stability.py ...                                  [ 27%]
tests/unit/test_tax_system.py ....                                       [ 27%]
tests/unit/test_technology_shock.py ..                                   [ 28%]
tests/unit/test_time_evolution.py ...                                    [ 28%]
tests/unit/test_wealth_distribution.py ...                               [ 29%]
tests/unit/test_welfare_system.py ...                                    [ 29%]
tests/unit/simulation/systems/test_audit_total_m2.py .                   [ 29%]
tests/unit/simulation/systems/test_commerce_system.py ...                [ 30%]
tests/unit/simulation/systems/test_escheatment_handler.py ....           [ 30%]
tests/unit/simulation/systems/test_financial_transaction_handler.py .... [ 31%]
tests/unit/simulation/systems/test_monetary_handler.py .....             [ 32%]
tests/unit/simulation/systems/test_settlement_system_integrity.py .....  [ 32%]
tests/unit/test_agent_registry_id_zero.py ....                           [ 33%]
tests/unit/test_aging_mechanism.py ....                                  [ 34%]
tests/unit/test_ai_agent_integration.py ....                             [ 34%]
tests/unit/test_asset_buyout.py ...                                      [ 35%]
tests/unit/test_atomic_swap.py ....                                      [ 35%]
tests/unit/test_bailout_mechanism.py ....                                [ 36%]
tests/unit/test_bank_lifecycle.py ....                                   [ 37%]
tests/unit/test_bank_run_scenario.py ....                                [ 37%]
tests/unit/test_batch_processing.py ...                                  [ 38%]
tests/unit/test_brand_loyalty.py ....                                    [ 38%]
tests/unit/test_breeding_mechanics.py ....                               [ 39%]
tests/unit/test_central_bank_operations.py ....                          [ 40%]
tests/unit/test_class_disparity.py ...                                   [ 40%]
tests/unit/test_command_pattern.py ....                                  [ 41%]
tests/unit/test_config_manager.py ...                                    [ 41%]
tests/unit/test_consumer_price_index.py ....                             [ 42%]
tests/unit/test_context_isolation.py ....                                [ 42%]
tests/unit/test_cross_module_imports.py ..                               [ 43%]
tests/unit/test_currency_flow.py ....                                    [ 43%]
tests/unit/test_data_integrity.py ...                                    [ 44%]
tests/unit/test_db_schema_migration.py ....                              [ 44%]
tests/unit/test_decision_context.py ....                                 [ 45%]
tests/unit/test_demand_supply_mismatch.py ...                            [ 46%]
tests/unit/test_dependency_injection.py ...                              [ 46%]
tests/unit/test_dto_immutability.py ....                                 [ 47%]
tests/unit/test_economic_mobility.py ...                                 [ 47%]
tests/unit/test_education_impact.py ....                                 [ 48%]
tests/unit/test_estate_registry_unit.py ....                             [ 48%]
tests/unit/test_event_driven_architecture.py ...                         [ 49%]
tests/unit/test_firm_bankruptcy.py ....                                  [ 50%]
tests/unit/test_firm_lifecycle.py ....                                   [ 50%]
tests/unit/test_fiscal_dominance.py ....                                 [ 51%]
tests/unit/test_forensic_audit_trail.py ...                              [ 51%]
tests/unit/test_fx_mechanism.py ....                                     [ 52%]
tests/unit/test_gdp_calculation.py ...                                   [ 52%]
tests/unit/test_generational_wealth.py ....                              [ 53%]
tests/unit/test_global_registry_pattern.py ....                          [ 54%]
tests/unit/test_government_spending.py ...                               [ 54%]
tests/unit/test_housing_connector.py ...                                 [ 55%]
tests/unit/test_housing_demand.py ...                                    [ 55%]
tests/unit/test_housing_market_clearing.py ...                           [ 56%]
tests/unit/test_hyperinflation_spiral.py ....                            [ 56%]
tests/unit/test_idempotency.py ...                                       [ 57%]
tests/unit/test_initialization_sequence.py ...                           [ 57%]
tests/unit/test_interest_rate_pass_through.py ...                        [ 58%]
tests/unit/test_inventory_valuation.py ....                              [ 59%]
tests/unit/test_investment_behavior.py ....                              [ 59%]
tests/unit/test_labor_market_friction.py ....                            [ 60%]
tests/unit/test_labor_negotiation.py ....                                [ 60%]
tests/unit/test_liquidation_manager.py ....                              [ 61%]
tests/unit/test_liquidity_trap_scenario.py ....                          [ 62%]
tests/unit/test_loan_lifecycle.py ....                                   [ 62%]
tests/unit/test_lock_manager.py ...                                      [ 63%]
tests/unit/test_macro_aggregation.py ...                                 [ 63%]
tests/unit/test_market_equilibrium.py ...                                [ 64%]
tests/unit/test_market_signals.py ....                                   [ 64%]
tests/unit/test_memory_leak.py ...                                       [ 65%]
tests/unit/test_metrics_service.py ...                                   [ 65%]
tests/unit/test_missing_data_handling.py ...                             [ 66%]
tests/unit/test_monetary_circuit.py ...                                  [ 66%]
tests/unit/test_monetary_transmission.py ...                             [ 67%]
tests/unit/test_multi_agent_interaction.py ...                           [ 67%]
tests/unit/test_multi_government.py ....                                 [ 68%]
tests/unit/test_network_effects.py ...                                   [ 69%]
tests/unit/test_order_book_integrity.py ....                             [ 69%]
tests/unit/test_panic_behavior.py ...                                    [ 70%]
tests/unit/test_parameter_sensitivity.py ...                             [ 70%]
tests/unit/test_performance_scaling.py ...                               [ 71%]
tests/unit/test_persistence_manager.py ...                               [ 71%]
tests/unit/test_population_growth.py ...                                 [ 72%]
tests/unit/test_portfolio_valuation.py ....                              [ 73%]
tests/unit/test_poverty_trap.py ...                                      [ 73%]
tests/unit/test_price_discovery.py ...                                   [ 74%]
tests/unit/test_production_efficiency.py ...                             [ 74%]
tests/unit/test_protocol_adherence.py ....                               [ 75%]
tests/unit/test_public_manager_liquidity.py ....                         [ 76%]
tests/unit/test_race_conditions.py ...                                   [ 76%]
tests/unit/test_random_seed_determinism.py ...                           [ 77%]
tests/unit/test_real_estate_bubble.py ....                               [ 77%]
tests/unit/test_recession_mechanics.py ...                               [ 78%]
tests/unit/test_registry_observer.py ....                                [ 79%]
tests/unit/test_regulatory_compliance.py ...                             [ 79%]
tests/unit/test_reproduction_economics.py ...                            [ 80%]
tests/unit/test_resource_scarcity.py ...                                 [ 80%]
tests/unit/test_risk_management.py ...                                   [ 81%]
tests/unit/test_robustness.py ...                                        [ 81%]
tests/unit/test_sanity_check.py ...                                      [ 82%]
tests/unit/test_scenario_config.py ...                                   [ 82%]
tests/unit/test_sectoral_balance.py ...                                  [ 83%]
tests/unit/test_shock_resilience.py ...                                  [ 83%]
tests/unit/test_simulation_integration.py ...                            [ 84%]
tests/unit/test_singleton_enforcement.py ...                             [ 85%]
tests/unit/test_social_mobility.py ...                                   [ 85%]
tests/unit/test_marriage_system.py ...                                   [ 85%]
tests/unit/test_metrics_hardening.py ....                                [ 86%]
tests/unit/test_monetary_ledger_repayment.py ...                         [ 86%]
tests/unit/test_phase1_refactor.py ..                                    [ 87%]
tests/unit/test_portfolio_macro.py .                                     [ 87%]
tests/unit/test_protocol_lockdown.py ....                                [ 87%]
tests/unit/test_real_estate_lien.py ...                                  [ 88%]
tests/unit/test_repository.py .....                                      [ 89%]
tests/unit/test_sales_engine_refactor.py ..                              [ 89%]
tests/unit/test_sensory_purity.py ..                                     [ 89%]
tests/unit/test_smart_leviathan_policy.py ..                             [ 90%]
tests/unit/test_socio_tech.py ...                                        [ 90%]
tests/unit/test_ssot_compliance.py ..                                    [ 90%]
tests/unit/test_stock_market.py .........                                [ 91%]
tests/unit/test_strict_mocking.py ...                                    [ 92%]
tests/unit/test_tax_collection.py ..                                     [ 92%]
tests/unit/test_tax_incidence.py ..                                      [ 93%]
tests/unit/test_taxation_system.py ....                                  [ 93%]
tests/unit/test_telemetry_purity.py ..                                   [ 94%]
tests/unit/test_transaction_engine.py ...............                    [ 96%]
tests/unit/test_transaction_handlers.py ...                              [ 97%]
tests/unit/test_transaction_integrity.py ..                              [ 97%]
tests/unit/test_transaction_processor.py .....                           [ 98%]
tests/unit/test_transaction_rollback.py .                                [ 98%]
tests/unit/test_watchtower_hardening.py ..                               [ 98%]
tests/unit/test_wave6_fiscal_masking.py ..                               [ 98%]
tests/unit/test_wo157_dynamic_pricing.py .....                           [100%]

======================== 662 passed, 1 warning in 5.38s ========================
```
