# Technical Report: Fix Protocol/Interface Mismatches in System Tests

## Overview
This report details the changes made to align system tests and components with the `IFinancialAgent` protocol, replacing legacy/deprecated patterns (such as direct `assets` property access and implicit currency handling).

## Changes

### 1. `simulation/bank.py`
*   **Refactor**: Updated `Bank.run_tick` fallback logic (used when `SettlementSystem` is not available or fails) to explicitly pass `currency=DEFAULT_CURRENCY` when calling `withdraw` and `deposit` on agents.
*   **Protocol Compliance**: The fallback logic now checks for `isinstance(borrower, IFinancialAgent)` and uses `get_balance(DEFAULT_CURRENCY)` before falling back to legacy `wallet` or `assets` attribute checks. This ensures newer agents implementing strict protocols are handled correctly.

### 2. `simulation/systems/handlers/goods_handler.py`
*   **Refactor**: Updated `GoodsTransactionHandler.handle` to prioritize `IFinancialAgent.get_balance(tx_currency)` for solvency checks.
*   **Deprecation Fix**: The handler previously accessed `buyer.assets` directly (a deprecated `IFinancialEntity` property). It now attempts to use the `IFinancialAgent` interface first, maintaining backward compatibility for legacy agents only as a fallback.

### 3. `tests/unit/test_bank.py`
*   **Mock Updates**: Updated `mock_borrower` and `mock_depositor` to use `MagicMock(spec=IFinancialAgent)`. Configured them to return balances via `get_balance()` instead of exposing `wallet` or `assets` attributes.
*   **Test Logic**: Replaced assertions using `bank_instance.assets` with `bank_instance.get_balance(DEFAULT_CURRENCY)`.
*   **Verification**: Added assertions to verify that `withdraw` calls on mocks include the `currency` argument, enforcing the updated protocol signature.

### 4. `tests/unit/test_transaction_processor.py`
*   **Mock Updates**: Updated `test_goods_handler_uses_atomic_settlement` to mock `buyer` with `spec=IFinancialAgent`.
*   **Logic Alignment**: Configured `buyer.get_balance.return_value` to satisfy the solvency check, aligning the test setup with the updated `GoodsTransactionHandler` logic.

### 5. `tests/unit/test_markets_v2.py`
*   **DTO Verification**: Added assertions to `TestOrderMatching` to verify that `Transaction` objects generated by the market matching engine correctly populate the `currency` field with `DEFAULT_CURRENCY`.

## Impact
These changes ensure that the system core (Bank, Transaction Processing) and their tests are robust against the deprecation of `IFinancialEntity` and strictly adhere to the `IFinancialAgent` protocol. This facilitates multi-currency support and cleaner agent interface definitions.

## Verification
All modified tests (`tests/unit/test_bank.py`, `tests/unit/test_transaction_processor.py`, `tests/unit/test_markets_v2.py`) pass successfully.
