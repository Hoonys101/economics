{
  "antigravity": {
    "project": "economics",
    "active_sessions": {
      "16457788477972542743": {
        "title": "TD-065 Household God Class Refactoring",
        "initial_mission": "# Work Order: TD-065 - Refactoring `Household` God Class\n\n**Phase:** 29 (Refinement)\n**Priority:** HIGH\n**Prerequisite:** None\n\n## 1. Problem Statement\nThe `Household` class in `simulation/core_agents.py` has become a \"God Class\" exceeding 1,000 lines of code (LoC). It violates the Single Responsibility Principle (SRP) by mixing biological/demographic concerns (reproduction, aging), economic logic (consumption, labor), and social behaviors (status-seeking, political opinion). This tight coupling makes the class difficult to maintain, test, and extend, as identified in technical debt item `TD-065`.\n\n## 2. Objective\nDecompose the `Household` class into a set of cohesive, modular components organized around the Bio-Econ-Social model. The `Household` class will be refactored into a **Facade**, orchestrating these components while preserving its public API to maintain backward compatibility with existing tests, particularly golden fixtures.\n\n## 3. Target Architecture\nThe `Household` class will delegate its responsibilities to three primary internal components. Existing sub-components will be re-homed under this new structure.\n\n*   **`Household` (The Facade)**:\n    *   Maintains the public API (`.assets`, `.age`, `clone()`, `make_decision()`).\n    *   Owns and initializes `BioComponent`, `EconComponent`, `SocialComponent`.\n    *   Orchestrates calls between components and the `DecisionEngine`.\n*   **`BioComponent` (Biological & Demographic State)**:\n    *   Owns: `DemographicsComponent`, `AgentLifecycleComponent`.\n    *   Responsibilities: Aging, death, reproduction (`clone`), and inheritance of biological traits.\n*   **`EconComponent` (Economic Activity & State)**:\n    *   Owns: `ConsumptionBehavior`, `LaborManager`, `EconomyManager`, `MarketComponent`, `Portfolio`.\n    *   Responsibilities: Asset/inventory management, consumption, labor decisions, housing decisions, market interactions.\n*   **`SocialComponent` (Social & Psychological State)**:\n    *   Owns: `PsychologyComponent`, `LeisureManager`.\n    *   Responsibilities: Social status calculation, political opinion, need updates, leisure effects.\n\n  <!-- Placeholder for diagram -->\n\n---\n\n## 4. Implementation Plan\n\n### Track A: DTO & Interface Definition (`api.py`)\n\n1.  **Create `modules/household/dtos.py`**:\n    *   Define `HouseholdStateDTO`: A comprehensive, read-only Pydantic model containing all primitive state from `Household` required by the `DecisionEngine` and other systems. This breaks the hard dependency.\n    *   Define `CloningRequestDTO`: Contains `new_id`, `initial_assets_from_parent`, `current_tick`.\n    *   Define `EconContextDTO`: Contains `markets`, `market_data`, `current_time`.\n    *   Define `SocialContextDTO`: Contains `current_time`.\n\n2.  **Create `modules/household/api.py`**:\n    *   Define `IBioComponent`, `IEconComponent`, `ISocialComponent` abstract base classes with method signatures for all public-facing actions.\n\n### Track B: Component Implementation\n\n1.  **Create `modules/household/bio_component.py`**:\n    *   Implement `BioComponent`.\n    *   Move the `clone()` method logic from `Household` here. It will only be responsible for creating a new `Household` instance with copied biological/demographic state. **It MUST NOT handle AI/Q-table inheritance.**\n    *   Move aging and death logic from `AgentLifecycleComponent`.\n\n2.  **Create `modules/household/econ_component.py`**:\n    *   Implement `EconComponent`.\n    *   This component will have methods like `get_assets()`, `adjust_assets()`, `get_inventory()`, etc.\n    *   Move the orchestration logic from `Household.make_decision()` (e.g., `decide_housing`, panic selling, targeted order refinement) into a new `orchestrate_economic_decisions` method.\n\n3.  **Create `modules/household/social_component.py`**:\n    *   Implement `SocialComponent`.\n    *   Move `calculate_social_status()`, `update_political_opinion()`, and `update_needs()` logic into this component.\n\n### Track C: `Household` Facade Refactoring\n\n1.  **Modify `simulation/core_agents.py` (`Household`)**:\n    *   In `__init__`, instantiate the new components.\n    *   Replace direct attribute access (e.g., `self.age`) with `@property` getters that delegate to the appropriate component (e.g., `return self.bio_component.age`).\n    *   Create setters (`@age.setter`) where necessary, which also delegate.\n    *   Refactor `make_decision()`: It will now first create the `HouseholdStateDTO`, then call the `DecisionEngine`, and finally call `self.econ_component.orchestrate_economic_decisions()` to apply results.\n    *   Refactor `clone()` to call `self.bio_component.clone()`.\n\n### Track D: Decouple `DecisionEngine`\n\n1.  **Modify `simulation/dtos.py` (`DecisionContext`)**:\n    *   Change the `household: \"Household\"` attribute to `state: HouseholdStateDTO`.\n2.  **Modify `simulation/decisions/ai_driven_household_engine.py`**:\n    *   Update `make_decisions` to read from the `context.state` DTO instead of the `context.household` object.\n\n---\n\n## 5. Verification Plan\n\n1.  **Component Unit Tests**: Create new test files for each component (`tests/modules/household/test_bio_component.py`, etc.) to test their logic in isolation using mocked DTOs.\n2.  **Preserve Existing Tests**: The Facade pattern ensures that `tests/verification/verify_mitosis.py` and other tests that rely on `golden_households` will continue to pass without modification. No changes to `conftest.py` are required.\n3.  **Integration Test**: The existing `make_decision` tests will now serve as integration tests for the `Household` facade and its underlying components.\n\n---\n\n## 6. ðŸš¨ Risk & Impact Audit (Mitigation Plan)\n\n*   **Risk: Golden Fixture and Test Incompatibility**\n    *   **Mitigation**: The `Household` class will be maintained as a **Facade**, preserving its public constructor and property API. Properties like `.age` and `.assets` will become getters/setters that delegate to the new internal components. This ensures 100% backward compatibility with `tests/conftest.py` and `verify_mitosis.py`.\n\n*   **Risk: Violation of AI/Biology Separation in `clone()`**\n    *   **Mitigation**: The new `BioComponent.clone()` method will be strictly responsible only for creating the new `Household` instance and copying biological/demographic attributes. It will have no knowledge of the AI engine. The external `AITrainingManager.inherit_brain()` process, as validated in `test_mitosis_brain_inheritance`, will remain responsible for all AI-related inheritance.\n\n*   **Risk: Misplacing Orchestration Logic**\n    *   **Mitigation**: The complex orchestration logic within `Household.make_decision()` will be explicitly preserved. The `Household` facade will remain the orchestrator, coordinating calls in a well-defined sequence:\n        1.  Create `HouseholdStateDTO`.\n        2.  Call `DecisionEngine` to get orders.\n        3.  Call `EconComponent` to refine and apply economic rules (e.g., panic selling).\n        4.  Call `SocialComponent` to update status based on outcomes.\n\n*   **Risk: Conflicting Component Hierarchies**\n    *   **Mitigation**: This specification establishes a clear ownership hierarchy. The new `Bio/Econ/Social` components will act as containers for the existing components (`DemographicsComponent`, `PsychologyComponent`, etc.), as outlined in the \"Target Architecture\" section. This avoids conflicts and clarifies responsibility.\n\n*   **Constraint: Strict Decoupling via DTOs**\n    *   **Mitigation**: This plan mandates the creation of a `HouseholdStateDTO`. The `DecisionContext` will be refactored to use this DTO, completely removing the direct dependency on the `Household` object and satisfying the decoupling requirement. Communication between the new components will also utilize DTOs where appropriate.\n\n---\n## 7. Mandatory Reporting (Jules's Guideline)\nDuring implementation, any unforeseen challenges, architectural friction, or potential improvements discovered must be logged as a new entry in `communications/insights/`. Any identified technical debt must be proposed for inclusion in `design/TECH_DEBT_LEDGER.md`.\n"
      }
    },
    "completed_sessions": {
      "8111922141870240162": "WO-083C-P1: Test Migration (LOW Risk) - MERGED 2026-01-20",
      "11202564815416347618": "WO-083C-P2: Test Migration (MEDIUM Risk) - MERGED 2026-01-20",
      "9067551690220486700": "WO-083C-P3: Test Migration (HIGH Risk) - MERGED 2026-01-20",
      "6338045545797855725": "WO-083A: Golden Fixture Generation - MERGED 2026-01-20",
      "11560612815746517359": "WO-083A: Golden Fixture Generation - MERGED 2026-01-20",
      "1503508227423661963": "WO-083B: Test Migration Phase 1 - MERGED 2026-01-20",
      "16754935071282510850": "WO-081: Bank Interface Segregation - MERGED 2026-01-19",
      "15965755950889487504": "WO-082: Golden Loader Infrastructure - MERGED 2026-01-19",
      "17536225839445736015": "Phase-29_The_Great_Depression - COMPLETED 2026-01-19",
      "5597989927571483094": "TD-043/044/045 God Class Refactoring - MERGED 2026-01-18",
      "14826170066369985962": "TD-008 Finance Upgrade - MERGED 2026-01-16",
      "2244231495852370011": "WO-079 Config Automation v2 - MERGED 2026-01-16",
      "12543922642187456551": "TD-045 Firm God Class - COMPLETED 2026-01-16",
      "4889257989211040620": "TD-044 Household God Class - COMPLETED 2026-01-16",
      "5283327958326335498": "TD-024 Post-Fix Test - COMPLETED 2026-01-16",
      "8465436477342866436": "WO-037 Simulation Cockpit - MERGED 2026-01-16",
      "15007179683109829611": "WO-060 - MERGED 2026-01-15",
      "7095675393629273222": "WO-064: Banking Credit Engine - MERGED 2026-01-15",
      "10296031762289509515": "WO-065: Monetary Integrity & Suture - MERGED 2026-01-15",
      "14018014647659914271": "WO-062: Macro-Linked Portfolio - MERGED 2026-01-15",
      "9343683714945509652": "WO-066: High-Fidelity Sensory Architecture - MERGED 2026-01-15",
      "9719318674264407147": "WO-067: High-Fidelity Reaction Test - MERGED 2026-01-15",
      "3778947626343557354": "WO-057-Refine Shock Therapy (Retry) - MERGED 2026-01-14",
      "11626928342509996952": "TD-014: Government SoC Refactoring - MERGED 2026-01-14",
      "10078451815509526740": "WO-058-Retry: Operation Defibrillator - MERGED 2026-01-14",
      "4444007150223365139": "WO-058 Economic CPR - MERGED 2026-01-14"
    }
  }
}