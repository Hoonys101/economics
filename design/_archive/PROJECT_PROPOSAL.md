# 경제 시뮬레이션 정상화 및 고도화 기획안

## 1. 기획 배경 및 문제 정의

현재 경제 시뮬레이션 모델은 핵심적인 시장 기능, 특히 **`food` 시장의 거래가 전혀 이루어지지 않는 심각한 문제**에 직면해 있습니다. 이로 인해 가계(Household) 에이전트는 생존에 필수적인 자원을 획득하지 못하고, 기업(Firm) 에이전트는 생산품을 판매하여 수익을 창출할 수 없습니다.

**주요 증상:**
- `analyze_results.py` 분석 결과, `Avg Food Price`, `Avg Food Volume`, `total_food_consumption` 등 `food` 관련 모든 지표가 `0` 또는 `NaN`으로 산출됩니다.
 시뮬레이션 로그(`simulation_results.csv`)에서 `food` 관련 거래 기록을 찾아볼 수 없습니다.
- 이 문제는 시뮬레이션의 동적 균형을 찾는다는 핵심 목표 달성을 원천적으로 불가능하게 만듭니다.

또한, 현재 코드는 에이전트(가계/기업)와 의사결정 로직(Decision Engine)이 강하게 결합되어 있고, 중복 코드가 많아 문제의 원인을 파악하고 수정하는 데 많은 시간이 소요됩니다. 이는 장기적인 기능 확장성과 유지보수성을 저해하는 요인입니다.

## 2. 프로젝트 목표

### 2.1. 단기 목표 (핵심 문제 해결)
- **`food` 시장 기능 정상화:** 시뮬레이션 내에서 가계와 기업 간의 `food` 거래가 유의미한 수준으로, 지속적으로 발생하도록 합니다.
- **정상적인 경제 지표 확보:** `food`의 평균 가격, 거래량, 총소비량 등 핵심 경제 지표가 정상적으로 측정되고 기록되도록 합니다.

### 2.2. 장기 목표 (시스템 고도화)
- **코드 품질 향상:** 에이전트, 의사결정, 시장 간의 결합도를 낮추고 응집도를 높이는 리팩토링을 통해 코드의 가독성, 재사용성, 테스트 용이성을 확보합니다.
- **안정적인 개발 기반 마련:** 향후 새로운 기능(예: 정부, 금융 시장)을 쉽게 추가하고 테스트할 수 있는 유연하고 확장 가능한 아키텍처를 구축합니다.
- **테스트 커버리지 확대:** 주요 로직에 대한 단위/통합 테스트를 강화하여 시스템의 안정성을 확보하고, 변경으로 인한 부작용(side effect)을 최소화합니다.

## 3. 세부 실행 계획 (Action Plan)

프로젝트는 두 단계로 나누어 진행합니다. **1단계 완료 전까지는 2단계로 넘어가지 않습니다.**

### **Phase 1: `food` 시장 기능 정상화 (1주)**

| 단계 | 작업 내용 | 상세 설명 | 검증 방법 |
| :--- | :--- | :--- | :--- |
| **1.1** | **원인 분석** | `simulation_results.csv`를 정밀 분석하여 **주문 생성, 주문 내용, 시장 매칭** 중 어느 단계에서 문제가 발생하는지 특정합니다. | - `search_file_content`를 활용한 로그 검색<br>- 디버깅 로그 추가 |
| **1.2** | **가설 수립 및 1차 수정** | 분석 결과에 따라 **가계의 지불의사(WTP) 문제**인지, **기업의 초기 가격 문제**인지, **시장 매칭 로직 오류**인지 가설을 세우고 관련 코드를 수정합니다. | - 코드 수정 (`household_decision_engine.py`, `firm_decision_engine.py`, `markets.py` 등) |
| **1.3** | **단위 테스트 작성** | 수정된 로직이 의도대로 작동하는지 검증하는 단위 테스트를 작성합니다. 예를 들어, '특정 조건 하에서 가계는 반드시 구매 주문을 생성해야 한다'와 같은 테스트를 추가합니다. | - `pytest`를 이용한 단위 테스트 실행 (`tests/` 폴더) |
| **1.4** | **통합 테스트 및 결과 검증** | `run_experiment.py`를 실행하여 전체 시뮬레이션에서 `food` 거래가 발생하는지 확인하고, `analyze_results.py`로 지표가 정상적으로 나오는지 최종 검증합니다. | - `analyze_results.py` 실행 결과 확인<br>- `simulation_results.csv` 데이터 확인 |

### **Phase 2: 코드 리팩토링 및 구조 개선 (2주)**

| 단계 | 작업 내용 | 상세 설명 | 검증 방법 |
| :--- | :--- | :--- | :--- |
| **2.1** | **`BaseAgent` 추상화** | `Household`와 `Firm`의 공통 로직(id, 자산, 욕구 관리 등)을 `simulation/base_agent.py`의 `BaseAgent` 클래스로 추출하고 상속 구조로 변경합니다. | - `tests/test_base_agent.py` 신규 작성 및 테스트 통과 |
| **2.2** | **의사결정 로직 분리** | 에이전트 클래스에 흩어져 있는 의사결정 로직을 `HouseholdDecisionEngine`, `FirmDecisionEngine`으로 완전히 분리하여 책임과 역할을 명확히 합니다. | - `tests/test_household_decision_engine.py`, `tests/test_firm_decision_engine.py` 테스트 통과 |
| **2.3** | **시장 API 개선** | 에이전트가 `market.place_order()` 와 같이 명확하고 일관된 API를 통해 시장과 상호작용하도록 인터페이스를 개선합니다. | - `tests/test_markets.py` 테스트 통과 |
| **2.4** | **전체 통합 테스트** | 리팩토링된 코드가 Phase 1에서 해결된 `food` 시장 문제를 포함하여 모든 기능이 정상적으로 작동하는지 다시 한번 검증합니다. | - `run_experiment.py` 실행<br>- `analyze_results.py` 결과 재확인 |

## 4. 기대 효과

- **시뮬레이션 신뢰도 확보:** 경제 모델이 현실적인 상호작용을 통해 의미 있는 데이터를 생성하게 되어, 시뮬레이션 결과의 신뢰도가 향상됩니다.
- **개발 효율성 증대:** 모듈화되고 잘 구조화된 코드는 새로운 기능 추가, 변경, 디버깅에 드는 시간을 획기적으로 단축시킵니다.
- **버그 발생률 감소:** 테스트 코드가 강화되어 코드 변경 시 발생할 수 있는 잠재적인 버그를 사전에 발견하고 예방할 수 있습니다.
- **프로젝트 확장성 확보:** 안정적인 기반 위에서 AI 모방 학습 고도화, 정부 정책 도입 등 복잡한 기능을 점진적으로 추가할 수 있는 토대를 마련합니다.

## 5. 예상 일정

| 기간 | 주요 과업 | 산출물 |
| :--- | :--- | :--- |
| **1주차** | **Phase 1:** `food` 시장 기능 정상화 | - 정상 작동하는 `food` 시장<br>- 수정된 코드 및 신규 단위 테스트 |
| **2주차** | **Phase 2:** 리팩토링 (BaseAgent, DecisionEngine) | - `BaseAgent` 및 `DecisionEngine` 구현<br>- 관련 테스트 코드 |
| **3주차** | **Phase 2:** 리팩토링 (Market API) 및 통합 테스트 | - 개선된 Market API<br>- 리팩토링 완료 및 전체 테스트 통과 |
| **4주차** | **문서화 및 최종 검토** | - 최신 코드 구조를 반영한 설계 문서 업데이트<br>- 프로젝트 최종 보고서 |

---
**참고 문서:**
- `design/경제시뮬레이션_가계_재능_역량_설계.md`
- `design/경제시뮬레이션_기업_재고_생산_개선_설계.md`
- `design/경제시뮬레이션_시장_및_상호작용_설계.md`
