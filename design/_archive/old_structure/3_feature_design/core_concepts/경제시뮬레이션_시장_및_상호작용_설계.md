# 경제 시뮬레이션 설계서: 시장 및 상호작용 모델

**버전**: v1.2
**작성일자**: 2025-07-05
**관련 문서**: `경제시뮬레이션_가계_재능_역량_설계.md`

---

## 1. 개요

이 문서는 `가계(Household)`와 `기업(Firm)` 주체가 **시장(Market)**을 통해 상호작용하는 방식을 정의한다. **추상화된 시장**, **모듈화된 의사결정 엔진**, 그리고 **경제 지표 계측기**를 도입하여, 미시적 행위로부터 거시 경제 현상이 창발되는 과정을 관찰하고 분석 가능한 시뮬레이션의 청사진을 제시한다.

---

## 2. 핵심 메커니즘 및 정책 상세 정의

### 2.1. 가계의 욕구(Needs) 모델 (v0.7 업데이트: 매슬로 계층 반영)
- **욕구 종류**: 가계는 다음 세 가지 주요 욕구를 가진다. 각 욕구는 `불만족도(Unsatisfied Level)` 수치를 가진다.
  1.  **생존 욕구 (`survival_need`)**: 생명 유지를 위한 필수적인 욕구 (예: 식량, 주거, 의류).
  2.  **인정 욕구 (`recognition_need`)**: 사회적 지위, 타인의 인정, 허영심 등을 충족시키기 위한 욕구 (예: 고급 식자재, 명품, 최신 전자기기).
  3.  **성장 욕구 (`growth_need`)**: 자기계발, 지식 습득, 문화적 향유 등 개인의 잠재력 실현을 위한 욕구 (예: 교육 서비스, 예술 작품, 여행).

- **욕구 증가 (v0.8 업데이트: 계층적 증가)**:
  - 매 턴(tick)마다 욕구의 `불만족도`는 다음과 같은 계층적 규칙에 따라 증가한다.
  - **생존 욕구 (`survival_need`)**: 항상 일정 비율(예: 5%)씩 증가한다.
  - **인정 욕구 (`recognition_need`)**: `survival_need`의 현재 불만족도 수준에 따라 증가율이 조절된다.
    - `survival_need`가 매우 높으면 (`> 80`): `recognition_need`는 증가하지 않거나 미미하게 감소한다.
    - `survival_need`가 중간 수준이면 (`20 ~ 80`): `recognition_need`는 낮은 비율로 증가한다.
    - `survival_need`가 낮으면 (`< 20`): `recognition_need`는 정상 비율로 증가한다.
  - **성장 욕구 (`growth_need`)**: `survival_need`와 `recognition_need`의 현재 불만족도 수준에 따라 증가율이 조절된다.
    - `survival_need` 또는 `recognition_need`가 높으면 (`> 80`): `growth_need`는 증가하지 않거나 미미하게 감소한다.
    - 두 욕구 모두 중간 수준이면 (`20 ~ 80`): `growth_need`는 낮은 비율로 증가한다.
    - 두 욕구 모두 낮으면 (`< 20`): `growth_need`는 정상 비율로 증가한다.
  - 이는 굶주린 사람이 타인의 인정이나 자기계발을 생각할 여력이 없다는 매슬로 욕구 단계의 핵심을 반영한다.

- **재화의 다층적 효용**: 
  - 모든 재화는 `data/goods.json` 파일에 정의되며, 각 재화는 `id`, `name`, `category` 외에 `utility_per_need` 속성을 가진다.
  - `utility_per_need`는 해당 재화 1단위가 각 욕구(`survival_need`, `recognition_need`, `growth_need`)에 대해 제공하는 효용의 양을 딕셔너리 형태로 명시한다. (예: `{"survival_need": 1.0, "recognition_need": 0.2, "growth_need": 0.05}`)

- **욕구 충족**: 
  - 재화 소비 시, 해당 재화의 `utility_per_need` 값에 따라 각 욕구의 `불만족도`가 감소한다. (`Need_t+1 = Need_t - Consumption_Utility_for_Each_Need`)
  - 욕구는 0 미만으로 떨어지지 않는다.

- **구매 의사결정**: 
  - 가계의 `DecisionEngine`은 현재 자신의 욕구 상태와 시장에 나와 있는 재화의 가격, 그리고 각 재화가 제공하는 `utility_per_need`를 종합적으로 고려하여 구매를 결정한다.
  - **효용 극대화**: 가계는 한정된 자산 내에서 자신의 `불만족도`를 가장 효율적으로 감소시킬 수 있는 재화를 우선적으로 구매하려 한다. 이는 '구매 전 욕구 총합'과 '구매 후 예상 욕구 총합'의 차이가 가장 큰 재화를 선택하는 방식으로 구현될 수 있다.
  - **계층적 우선순위 (초기 모델)**: 초기에는 매슬로의 계층을 단순화하여, `survival_need`가 일정 수준 이상일 경우 `recognition_need`나 `growth_need`보다 `survival_need`를 충족시키는 재화를 우선적으로 고려한다. 모든 `survival_need`가 일정 수준 이하로 관리될 때만 상위 욕구 충족을 위한 구매를 적극적으로 고려한다.

### 2.2. 시장의 거래 제안(Order) 규칙
- **원칙**: **"가계는 단순하게, 기업은 유연하게"**
- **가계**: 단순성을 위해, 한 턴에 특정 시장(예: `GoodsMarket`)에 대해 한 종류(BUY/SELL)의 주문을 1개만 제출한다.
- **기업**: 이윤 극대화 목표(예: 목표 생산량 달성을 위한 다수 인력 채용)를 위해, 의사결정 결과에 따라 특정 시장에 **다수의 동종 주문**을 제출할 수 있다. 이는 향후 기업의 복잡한 경영 활동을 모델링하기 위한 확장성을 제공한다.

### 2.3. 시장의 거래 성립(Matching) 알고리즘 및 결과 처리
- **방식**: **가격-시간 우선 원칙(Price-Time Priority)**에 기반한 **이산적 양방향 경매(Discrete Double Auction)**를 사용한다.
- **거래 성립 절차**:
  1. **정렬**: `BUY` 주문은 **높은 가격순**으로, `SELL` 주문은 **낮은 가격순**으로 정렬한다.
  2. **매칭**: 가장 높은 `BUY` 주문과 가장 낮은 `SELL` 주문을 비교하여, `구매 희망가 >= 판매 희망가`인 경우 거래를 성립시킨다.
  3. **가격 결정**: 거래 가격은 두 주문 가격의 평균 `(구매가 + 판매가) / 2`으로 결정한다.
  4. **반복**: 거래가 성립된 주문은 제거하고, 더 이상 성립 가능한 거래가 없을 때까지 반복한다.
- **거래 실패 로깅 강화**: 거래가 성립되지 않는 경우(예: 가격 불일치, 수량 부족)에는 그 원인을 명확히 파악할 수 있도록 상세한 로그를 기록해야 한다. 이는 시장의 비정상적인 동작을 디버깅하는 데 필수적이다.
- **거래 결과 처리 (State Update)**:
  - 성사된 각 거래(`Transaction`)에 대해, 시뮬레이션 엔진은 다음 절차에 따라 관련 주체들의 상태를 업데이트한다.
  - **판매자 (Seller)**:
    - `자산(assets) += 거래량 * 거래 가격`
    - `재고(inventory) -= 거래량`
  - **구매자 (Buyer)**:
    - `자산(assets) -= 거래량 * 거래 가격`
    - `보유 재화(inventory 또는 goods) += 거래량`
    - (가계의 경우) 해당 재화와 연결된 `욕구(Needs)`가 충족되어 `불만족도`가 감소한다.

### 2.4. 기업의 생산 및 재화의 효용(Utility) (v1.2 업데이트)
- **생산 함수**: 기업의 생산량은 고용한 직원들의 **총 역량 합계**에 비례한다. (`생산량 = 생산성계수 * sum(employee.skill.value)`) 
  - 생산성 계수(`productivity_factor`)는 기업마다 다르게 설정될 수 있다. (예: 1.0)
  - 생산되는 재화의 종류는 기업이 생산하는 품목에 따라 결정된다. (예: food 생산 기업, education_service 생산 기업)
- **생산 비용**: 생산에 필요한 비용은 고용한 노동자에게 지불하는 임금 외에, 원자재 비용(현재는 생략), 생산 시설 유지 비용 등이 포함될 수 있다. (현재는 임금만 고려)
- **재화의 품질과 효용**: 초기 모델에서는 **모든 재화는 동질적(Homogeneous)**이라고 가정한다. 따라서 재화 1단위가 제공하는 `효용(Utility)`은 모든 소비자에게 **1로 고정**된다. 이는 가계의 구매 결정을 단순화시킨다.

---

### 2.5. 시뮬레이션 초기 설정 및 주체 생성 (v0.9 업데이트)
- **주체 개수 설정**: 시뮬레이션 시작 시 `main.py`에서 가계(`num_households`)와 기업(`num_firms`)의 개수를 설정할 수 있다.
- **초기 자산 랜덤화**: 
  - 가계의 초기 `assets`는 `1000.0`을 기준으로 `±20%` 범위 내에서 랜덤하게 설정된다. (예: `800.0 ~ 1200.0`)
  - 기업의 초기 `assets`는 `10000.0`을 기준으로 `±20%` 범위 내에서 랜덤하게 설정된다. (예: `8000.0 ~ 12000.0`)
- **초기 욕구 랜덤화**: 
  - 가계의 초기 욕구(`survival_need`, `recognition_need`, `growth_need`)는 각각 `50.0`, `30.0`, `20.0`을 기준으로 `±10%` 범위 내에서 랜덤하게 설정된다.
- **초기 재고 랜덤화**: 
  - 기업의 초기 재고(`inventory`)는 `100.0`을 기준으로 `±20%` 범위 내에서 랜덤하게 설정된다. (모든 재화에 대해 적용)

### 2.5. 시뮬레이션 초기 설정 및 주체 생성 (v0.9 업데이트)
- **주체 개수 설정**: 시뮬레이션 시작 시 `main.py`에서 가계(`num_households`)와 기업(`num_firms`)의 개수를 설정할 수 있다.
- **초기 자산 랜덤화**: 
  - 가계의 초기 `assets`는 `1000.0`을 기준으로 `±20%` 범위 내에서 랜덤하게 설정된다. (예: `800.0 ~ 1200.0`)
  - 기업의 초기 `assets`는 `10000.0`을 기준으로 `±20%` 범위 내에서 랜덤하게 설정된다. (예: `8000.0 ~ 12000.0`)
- **초기 욕구 랜덤화**: 
  - 가계의 초기 욕구(`survival_need`, `recognition_need`, `growth_need`)는 각각 `50.0`, `30.0`, `20.0`을 기준으로 `±10%` 범위 내에서 랜덤하게 설정된다.
- **초기 재고 랜덤화**: 
  - 기업의 초기 재고(`inventory`)는 `100.0`을 기준으로 `±20%` 범위 내에서 랜덤하게 설정된다. (모든 재화에 대해 적용)

### 2.6. 주체 생멸 (Agent Lifecycle) (v1.2 업데이트)
- **가계의 사망**: 
  - 가계는 다음 조건 중 하나를 만족하면 사망한다:
    - `assets`가 0 이하로 떨어지는 경우.
    - `survival_need`가 일정 임계치(예: 100)를 초과한 상태가 `death_turns_threshold`(예: 5턴) 이상 지속되는 경우. (이를 추적하기 위한 내부 카운터 필요)
  - 사망한 가계는 시뮬레이션에서 제거되며, 모든 자산은 소멸된다.
- **가계의 출생**: 
  - 매 턴 `household_birth_probability`(예: 5%) 확률로 새로운 가계가 출생한다.
  - 출생한 가계는 초기 자산과 욕구(생존, 인정, 성장, 화폐 보유)를 랜덤하게 부여받아 시뮬레이션에 진입한다.
- **기업의 폐업**: 
  - 기업은 다음 조건 중 하나를 만족하면 폐업한다:
    - `assets`가 0 이하로 떨어지는 경우.
    - `current_profit`이 음수인 상태가 `closure_turns_threshold`(예: 10턴) 이상 연속으로 지속되는 경우. (이를 추적하기 위한 내부 카운터 `consecutive_loss_turns` 필요)
  - 폐업한 기업은 시뮬레이션에서 제거되며, 보유 자산과 재고는 시장에 청산된다.
- **기업의 창업**: 
  - 매 턴 `firm_founding_probability`(예: 2%) 확률로 새로운 기업이 창업한다.
  - 창업한 기업은 초기 자본과 재고를 랜덤하게 부여받아 시뮬레이션에 진입한다.

### 2.7. 노동 시장 (Labor Market) (v1.0 업데이트)
- **가계의 노동 공급**: 
  - **노동 공급 결정**: 가계는 `survival_need`가 일정 임계치(예: 20) 이상이거나 `assets`가 낮을 때 노동 시장에 참여하여 노동을 공급할 유인이 커진다.
  - **희망 임금 결정**: 가계는 자신의 `skill` 수준과 현재 `survival_need` 수준을 고려하여 희망 임금을 결정한다. `survival_need`가 높을수록 낮은 임금에도 노동을 공급할 의향이 커진다.
  - **노동력 수량**: 가계는 1단위의 노동력을 공급한다고 가정한다. (간단화를 위해)
  - 노동 공급은 `labor_market`에 `SELL` 주문(노동력, 희망 임금) 형태로 제출된다.
- **기업의 노동 수요**: 
  - **노동 수요 결정**: 기업은 현재 재고 수준과 생산 목표를 고려하여 노동력을 수요한다. 재고가 낮고 생산 목표가 높을수록 노동 수요가 증가한다.
  - **제시 임금 결정**: 기업은 목표 생산량과 예상 판매 가격, 그리고 현재 시장의 임금 수준을 고려하여 제시 임금을 결정한다.
  - **노동력 수량**: 기업은 필요한 만큼의 노동력을 수요한다.
  - 노동 수요는 `labor_market`에 `BUY` 주문(필요 노동력, 제시 임금) 형태로 제출된다.
- **임금 결정**: 
  - `labor_market`은 `GoodsMarket`과 유사한 양방향 경매 방식으로 임금을 결정한다.
  - 거래가 성사되면 가계는 임금을 받고, 기업은 노동력을 얻는다.

### 2.8. 화폐 보유 욕구 (Liquidity Preference) (v1.0 신규)
- **새로운 욕구 타입**: 가계와 기업 모두 `liquidity_need`라는 새로운 욕구를 가진다.
  - `liquidity_need`: 미래의 불확실성, 투자 기회, 비상 상황 등에 대비하여 화폐를 보유하려는 욕구.
- **욕구 증가**: `liquidity_need`는 매 턴 일정 비율(예: 2%)씩 증가한다.
- **욕구 충족**: 
  - 화폐를 보유함으로써 `liquidity_need`가 감소한다.
  - `assets`가 많을수록 `liquidity_need`가 감소하는 효과가 커진다.

### 2.9. 통합 의사결정 엔진 (Unified Decision Engine) (v1.0 신규)
- **공통 판단 알고리즘**: `DecisionEngine` 추상 클래스를 확장하여, `BaseDecisionEngine`과 같은 중간 추상 클래스를 도입한다.
- `BaseDecisionEngine`은 `consume_needs` (생존, 인정, 성장)와 `liquidity_need`를 동시에 고려하여 예산을 할당하고 행동을 결정하는 공통 로직을 포함한다.
- **예산 할당 (v1.1 업데이트)**: 
  - 가계/기업은 총 `assets`를 기반으로 `소비 예산`과 `화폐 보유 예산`으로 나눈다.
  - `liquidity_need`가 높을수록 `화폐 보유 예산`의 비중이 커진다. 구체적으로, `liquidity_need` 수준에 따라 `화폐 보유 비율(liquidity_ratio)`을 결정한다.
    - `liquidity_ratio = min(0.8, max(0.1, liquidity_need / 100.0))` (예시: `liquidity_need`가 10이면 10%, 80 이상이면 80%까지 화폐 보유)
  - `화폐 보유 예산 = total_assets * liquidity_ratio`
  - `소비 예산 = total_assets - 화폐 보유 예산`
  - `소비 예산`은 재화 구매 및 기타 소비 활동에 사용되며, `화폐 보유 예산`은 현금으로 보유하거나 금융 상품에 투자하는 데 사용된다.
- **소비 결정**: `소비 예산` 내에서 기존의 효용 극대화 로직을 사용하여 재화를 구매한다.
- **노동 공급/수요 결정**: `liquidity_need`와 `consume_needs`의 상태를 고려하여 노동 시장에서의 행동을 결정한다.

### 2.10. 금융 시장 (Financial Markets) (v1.0 신규 - 개념 도입)
- **주식/대출**: 
  - 초기 모델에서는 구체적인 구현은 생략하지만, 향후 주식 발행/매매, 대출/차입 등의 금융 활동을 위한 기반을 마련한다.
  - `assets`의 구성 요소에 `cash`, `stocks`, `debt` 등을 포함할 수 있다.

### 2.11. 기업의 동적 가격 결정 (v1.3 업데이트)
- **원칙**: 기업은 재고 수준에 따라 판매 가격을 동적으로 조정한다.
- **가격 결정 로직**: 
  - 기업의 재고가 목표 재고량보다 많으면 가격을 낮추고, 적으면 가격을 높인다.
  - `조정된 가격 = 기본 판매 가격 + (목표 재고 - 현재 재고) / 목표 재고 * 가격 조정 계수`
  - 가격은 `최소 판매 가격`과 `최대 판매 가격` 범위 내로 제한된다.
- **목적**: 시장의 수요와 공급 변화에 기업이 유연하게 반응하도록 하여, 재고 소진 및 이윤 극대화를 추구한다.

### 2.12. 경제 지표 계산 및 최적화

시뮬레이션의 거시 경제 지표(예: 평균 재화 가격, 평균 임금)를 계산할 때, 데이터 처리의 효율성과 정확성을 보장해야 한다. 특히, 동일한 지표를 여러 곳에서 중복으로 계산하는 것을 피하고, 단일 책임 원칙에 따라 지표 계산 로직을 중앙 집중화하여 관리해야 한다. 이는 코드의 간결성을 유지하고 잠재적인 불일치 오류를 방지하는 데 중요하다.

---

## 3. 구현을 위한 클래스 구조 (안)

(v0.3과 동일, 생략)

---

## 4. 업무 진행 관리 (체크리스트)

(v0.3과 동일, 생략)

---

## 5. 개발 현황 및 다음 단계 (v1.3 업데이트)

### 5.1. 현재까지의 구현 현황

*   `config.py` 파일이 생성되어 시뮬레이션의 주요 파라미터들이 중앙에서 관리됩니다.
*   가계(`Household`) 주체의 `Talent` 및 `Skill` 클래스에 `related_domains`와 `observability` 속성이 추가되었습니다.
*   가계(`Household`) 클래스에 `update_needs()` 메서드가 구현되어 매슬로 욕구 단계에 따른 계층적 욕구 증가 로직과 화폐 보유 욕구(`liquidity_need`) 증가 로직이 반영되었습니다. 또한, 가계의 생존 여부 판단 로직도 추가되었습니다.
*   기업(`Firm`) 클래스에 `update_needs()` 메서드가 구현되어 화폐 보유 욕구(`liquidity_need`) 증가 로직과 폐업 로직이 반영되었습니다.
*   시뮬레이션 엔진(`simulation/engine.py`)에서 각 주체(`Household`, `Firm`)의 `update_needs()` 메서드를 직접 호출하도록 변경되었습니다.
*   가계의 의사결정 엔진(`HouseholdDecisionEngine`)에서 노동 공급 결정 시 `labor_need`와 `assets` 수준을 비선형적으로 반영하여 희망 임금을 결정하도록 개선되었습니다. (`LABOR_NEED_WAGE_DECAY_RATE`, `LABOR_NEED_WAGE_DECAY_EXPONENT`, `ASSETS_CRITICAL_THRESHOLD`, `ASSETS_WAGE_REDUCTION_FACTOR` 활용)
*   기업의 의사결정 엔진(`FirmDecisionEngine`)에서 재고 수준에 따라 생산 목표(`production_targets`)를 동적으로 조절하고, 판매 가격 결정 시 `PRICE_ADJUSTMENT_EXPONENT`를 추가하여 비선형성을 부여했습니다.

### 5.2. 이전 시뮬레이션 결과 분석

이전 시뮬레이션 결과는 다음과 같은 문제점을 보였습니다.

*   **가계 자산 감소 및 높은 사망률**: 시뮬레이션 초반에 가계의 자산이 급격히 감소하고, 많은 가계가 `survival_need` 임계치 초과로 사망했습니다. 이는 가계가 재화를 구매하지 못해 욕구가 계속 증가하고, 결국 자산이 고갈되거나 생존 욕구가 임계치를 넘어서기 때문으로 분석됩니다.
*   **기업 자산 증가 및 재고 축적**: 기업의 총 자산은 꾸준히 증가하는 경향을 보였으나, 생산된 재화가 소비되지 않고 기업의 재고로 과도하게 쌓이는 현상이 나타났습니다. 이는 시장의 불균형을 시사합니다.
*   **실업률**: 초반에는 실업률이 높았으나 점차 감소하는 경향을 보였습니다.

이러한 문제점들은 가계의 구매력 부족, 노동 시장의 비효율성, 그리고 재화 가격 및 효용의 불균형에서 기인하는 것으로 판단됩니다.

### 5.3. 다음 개발 전략

현재까지 적용된 개선 사항들이 이전 시뮬레이션의 문제점들을 완화하는 데 기여할 것으로 예상됩니다.

*   **가계의 희망 임금 조정**: `labor_need`가 높을수록 희망 임금을 낮추는 경향이 강해지고, 자산이 낮을수록 더 낮은 임금도 수용하게 되어 가계의 고용될 확률이 높아질 수 있습니다. 이는 실업률 감소 및 가계 소득 증대에 긍정적인 영향을 미칠 수 있습니다.
*   **기업의 생산 목표 및 가격 조정**: 재고 수준에 따라 생산 목표를 조절하고 가격을 유연하게 조정함으로써, 시장 상황에 더 잘 반응하고 재고가 과도하게 쌓이는 것을 방지할 수 있습니다. 이는 기업의 수익성을 개선하고, 장기적으로 가계에 더 많은 임금을 지불할 수 있는 기반을 마련할 수 있습니다.

**계획**:

1.  **현재 변경 사항으로 시뮬레이션 재실행**: 현재 적용된 의사결정 로직 개선 사항들이 실제 시뮬레이션 결과에 어떤 영향을 미치는지 확인합니다.
2.  **결과 분석 및 추가 전략 수립**: 시뮬레이션 재실행 결과를 바탕으로, 여전히 문제가 지속된다면 추가적인 개선 전략을 수립합니다. 예를 들어, 가계의 소비 의사결정 로직을 더욱 정교하게 만들거나, 정부 주체 도입을 고려할 수 있습니다.