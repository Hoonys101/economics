# 시장 메커니즘 설계 (V2)

**작성일**: 2025-12-29
**분석 대상 코드**: `simulation/markets/order_book_market.py`, `simulation/markets/stock_market.py`

## 1. 개요

시뮬레이션의 모든 거래는 **중앙 집중식 호가창(Order Book)** 방식의 시장을 통해 이루어집니다. 상품(Goods), 노동(Labor), 주식(Stock) 시장 모두 공통된 `Market` 인터페이스를 따르거나 이를 확장하여 구현됩니다.

## 2. OrderBookMarket (상품 및 노동)

### 2.1. 구조
- **매수/매도 주문서**: `buy_orders`, `sell_orders` 리스트로 주문을 관리합니다.
- **매칭 방식**: 가격 우선, 시간 우선 원칙.
    - 매수: 높은 가격 우선
    - 매도: 낮은 가격 우선
- **가격 결정**: `(매수 최고가 + 매도 최저가) / 2` (Mid-price).
    - 단, 노동 시장(`labor`)은 기업(매수자)이 제시한 임금으로 체결됩니다.

### 2.2. 주기적 초기화
- 매 틱(`run_tick`)이 시작될 때 이전 틱의 미체결 주문은 모두 **초기화(Clear)**됩니다.
- 이는 시장의 변동성을 즉각 반영하고 고스트 주문(Ghost Orders)을 방지하기 위함입니다.

## 3. StockMarket (주식)

### 3.1. 특징
- `StockMarket`은 `Market` 클래스를 상속받아 구현되었습니다.
- 기업의 소유권(주식)을 거래하며, 가격 제한폭(상하한가)이 존재합니다.

### 3.2. 가격 메커니즘
- **기준가(Reference Price)**: 기업의 순자산가치(Book Value)를 기반으로 산출됩니다.
- **시장가**: 실제 거래가 발생하면 해당 가격이 시장가가 됩니다. 거래가 없으면 기준가를 따릅니다.
- **주문 유효기간**: 일반 상품 시장과 달리, 주식 주문은 `STOCK_ORDER_EXPIRY_TICKS` 동안 유지될 수 있습니다.

### 3.3. 거래 프로세스
1. 에이전트(가계/기업)가 `StockOrder`를 제출합니다.
2. 주문 가격이 상하한가 범위를 벗어나면 자동으로 조정됩니다.
3. 매 틱마다 매수/매도 호가를 매칭하여 거래(`Transaction`)를 생성합니다.
4. 거래 성사 시 소유권이 이전되고 자산이 정산됩니다.
