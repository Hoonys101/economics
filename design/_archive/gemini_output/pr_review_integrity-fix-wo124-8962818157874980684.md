🕵️  Reviewing Code with instruction: 'Analyze this PR.'...
📖 Attached context: C:\coding\economics\design\_archive\gemini_output\pr_diff_integrity-fix-wo124-8962818157874980684.txt
🚀 [GeminiWorker] Running task with manual: git_reviewer.md

📝 [Review Report]
============================================================
# PR Review: `integrity-fix-wo124`

## 🔍 Summary

본 변경 사항은 시스템의 회계 무결성을 강화하는 데 중점을 둡니다. 가계 소득 통계를 왜곡하고 기업의 현금 흐름 위기를 유발했던 핵심적인 제로섬(Zero-Sum) 위반 사항들을 수정합니다. 주요 변경 내용은 다음과 같습니다:
- 중앙 원장 시스템(`SettlementSystem`)을 우회하던 레거시 자금 이체 로직을 제거합니다.
- 노동 거래에서 발생하는 세금의 책임을 구매자(기업)와 판매자(가계)에게 명확히 분리하여 비용과 소득을 정확히 기록합니다.
- 상품 및 서비스 구매 시 기업의 비용이 누락되던 문제를 해결합니다.

## 🚨 Critical Issues

**없음.** 보안 및 하드코딩 관련 위반 사항이 발견되지 않았습니다. 오히려 이번 수정은 시스템의 재무적 안정성을 심각하게 위협할 수 있는 돈 복사/누수 버그를 해결합니다.

## ⚠️ Logic & Spec Gaps

**없음.** 제출된 인사이트 보고서(`mission_integrity_fix.md`)에 명시된 문제점들이 코드 상에서 정확하고 효과적으로 해결되었습니다.

- **`finance_department.py`**:
  - `pay_severance`: `SettlementSystem`이 없을 경우 직접 자산을 변경하던 위험한 폴백(fallback) 로직이 제거되고, 이제 명시적으로 실패 처리됩니다. 이는 모든 거래가 중앙 원장을 통해 이루어져야 한다는 "Sacred Sequence" 원칙을 강화합니다.
  - `pay_ad_hoc_tax`: 더 이상 사용되지 않는 `government.collect_tax` 대신 `SettlementSystem.transfer`를 직접 사용하도록 리팩토링되어 아키텍처 일관성을 높였습니다.

- **`transaction_processor.py`**:
  - `_handle_labor_transaction`: 기존에 `tax_amount`로 뭉뚱그려 처리하던 로직을 `seller_tax_paid`와 `buyer_tax_paid`로 분리하여, 판매자(가계)의 소득(`seller.labor_income_this_tick`)과 구매자(기업)의 비용(`buyer.finance.record_expense`)이 정확히 기록되도록 수정되었습니다. 이는 핵심적인 회계 왜곡 문제를 해결합니다.
  - `_handle_goods_transaction`: 상품 구매 시 누락되었던 기업의 비용(`buyer.finance.record_expense`) 기록 로직이 추가되어, 기업의 이익과 세금 계산이 정상화될 것으로 기대됩니다.

## 💡 Suggestions

- **변수명 일관성**: `transaction_processor.py`에서 `_handle_labor_transaction`을 호출할 때는 `seller_net_amount`라는 변수명을 사용하지만, 해당 함수의 파라미터는 `seller_net_income`으로 정의되어 있습니다. 기능적으로는 문제가 없으나, 추후 유지보수를 위해 변수명을 일치시키는 것을 고려해볼 수 있습니다. (`L304`, `L314`)

## 🧠 Manual Update Proposal

이번 수정에서 얻은 교훈은 시스템의 경제적 무결성을 유지하는 데 매우 중요하므로, 중앙 지식 베이스에 요약하여 기록할 것을 제안합니다.

- **Target File**: `design/2_operations/ledgers/ECONOMIC_INSIGHTS.md` (또는 유사한 중앙 원칙 문서)
- **Update Content**:
  ```markdown
  ## WO-124: 회계 무결성 강화 (Accounting Integrity Hardening)
  
  - **현상**: 기업들이 실제보다 이익이 부풀려져 보고되었고, 이로 인해 과도한 배당금 및 세금 지출 후 유동성 위기(Cash Crunch)를 겪는 현상이 관찰됨. 동시에 가계의 소득이 실제보다 낮게 집계되는 통계 왜곡이 발생함.
  - **원인**:
    1.  **비용 누락**: 기업이 상품을 구매하거나 급여 외 세금(예: 고용주 부담 사회보험료)을 납부할 때, 해당 금액이 비용으로 기록되지 않음.
    2.  **소득 왜곡**: 기업이 부담하는 세금까지 노동자의 소득에서 차감되는 것처럼 계산되어, 노동자의 순소득이 부정확하게 기록됨.
    3.  **원장 우회**: 일부 레거시 로직이 중앙 결제 시스템(Settlement System)을 거치지 않고 직접 자산을 변경하여 거래 추적을 불가능하게 만듦.
  - **교훈**:
    - **모든 경제 활동은 비용 또는 소득이다**: 시스템 내 모든 자산 이동은 거래의 양쪽 측면(구매자-판매자, 지출-수입)에서 반드시 기록되어야 한다. 한쪽이라도 누락되면 제로섬이 깨지고 시스템 전체의 재무 상태가 왜곡된다.
    - **세금 책임의 명확한 귀속**: 세금은 '누가 부담하는가(Payer)'가 명확해야 한다. 여러 세금이 하나의 거래에 묶일 경우, 각 세금의 부담 주체를 분리하여 비용과 소득을 계산해야 회계 왜곡을 막을 수 있다.
    - **중앙 원장 원칙 준수**: 어떠한 경우에도 자산 변경은 중앙 원장(Settlement System)을 통해서만 이루어져야 한다. 예외적인 폴백(fallback) 로직은 결국 데이터 정합성을 파괴하는 기술 부채로 이어진다.
  ```

## ✅ Verdict

**APPROVE**

매우 중요한 회계 무결성 버그를 정확히 진단하고 수정했습니다. 특히, 문제의 원인과 해결 과정을 상세히 기술한 `mission_integrity_fix.md` 파일을 함께 제출하여 프로젝트의 지식 자산을 풍부하게 만든 점이 훌륭합니다. 이는 다른 개발자들이 유사한 실수를 방지하는 데 큰 도움이 될 것입니다.

============================================================
