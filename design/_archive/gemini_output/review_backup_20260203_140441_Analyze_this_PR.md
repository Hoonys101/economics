# π” Git Diff Review: Atomic Housing Purchase Saga (V3)

## 1. π” Summary

λ³Έ λ³€κ²½ μ‚¬ν•­μ€ μ£Όνƒ κµ¬λ§¤ ν”„λ΅μ„Έμ¤λ¥Ό μ›μμ μΌλ΅ λ³΄μ¥ν•κΈ° μ„ν•΄ Saga ν¨ν„΄μ„ λ„μ…ν•©λ‹λ‹¤. `SettlementSystem`μ΄ Saga Coordinator μ—­ν• μ„ λ§΅μ•„ λ€μ¶ μ‹ μ²­, μΉμΈ, μμ‚° μ΄μ „μ μ „ κ³Όμ •μ„ κ΄€λ¦¬ν•λ©°, κ΄€λ ¨ λ΅μ§μ΄ `HousingSystem`, `LoanMarket`, `TickOrchestrator`μ— ν†µν•©λμ—μµλ‹λ‹¤. λν•, κ±°μ‹ κ±΄μ „μ„± κ·μ (LTV, DTI) μ μ© λ΅μ§μ΄ κ°•ν™”λμ—κ³ , λ°κ²¬λ κΈ°μ  λ¶€μ±„μ™€ μΈμ‚¬μ΄νΈκ°€ μƒμ„Έν κΈ°λ΅λ λ³΄κ³ μ„κ°€ ν•¨κ» μ μ¶λμ—μµλ‹λ‹¤.

## 2. π¨ Critical Issues

- **None**: λ³΄μ• μ·¨μ•½μ , λ―Όκ° μ •λ³΄ ν•λ“μ½”λ”©, μ‹μ¤ν… μ λ€ κ²½λ΅, μ™Έλ¶€ λ ν¬μ§€ν† λ¦¬ μμ΅΄μ„±κ³Ό κ°™μ€ μ‹¬κ°ν• λ¬Έμ λ” λ°κ²¬λμ§€ μ•μ•μµλ‹λ‹¤.

## 3. β οΈ Logic & Spec Gaps

- **None**: λ΅μ§μ ν•µμ‹¬μΈ λ‹¤μ¤‘ μ „μ†΅(`execute_multiparty_settlement`)μ—μ„ μκΈ νλ¦„(λ€μ¶κΈ, κ³„μ•½κΈ)μ΄ Zero-Sum μ›μΉ™μ„ μ„λ°°ν•μ§€ μ•μμ„ ν™•μΈν–μµλ‹λ‹¤. λ€μ¶ κ±°μ , Saga μ‹¤ν¨ μ‹ λ³΄μƒ νΈλμ­μ…(`_void_loan`) λ΅μ§μ΄ ν¬ν•¨λμ–΄ μμ–΄ μ•μ •μ„±μ΄ κ°•ν™”λμ—μµλ‹λ‹¤. κΈ°ν μλ„(μ›μμ  μ£Όνƒ κµ¬λ§¤)μ— λ¶€ν•©ν•κ² κµ¬ν„λμ—μµλ‹λ‹¤.

## 4. π’΅ Suggestions

- **DTO ν†µμΌ λ¦¬ν©ν† λ§**: `LoanMarket`μ—μ„ μ΄μ „ λ²„μ „μ `MortgageApplicationDTO`μ™€ μƒλ΅μ΄ DTOλ¥Ό ν•¨κ» μ²λ¦¬ν•κΈ° μ„ν• νΈν™μ„± λ μ΄μ–΄κ°€ μ¶”κ°€λμ—μµλ‹λ‹¤. μΈμ‚¬μ΄νΈ λ³΄κ³ μ„μ—μ„λ„ μ–ΈκΈ‰λμ—λ“―μ΄, μ΄ λ¶€λ¶„μ€ μ¶”ν›„ λ‹¨μΌ DTOλ¥Ό μ‚¬μ©ν•λ„λ΅ λ¦¬ν©ν† λ§ν•μ—¬ μ½”λ“ λ³µμ΅λ„λ¥Ό λ‚®μ¶”λ” κ²ƒμ„ κ¶μ¥ν•©λ‹λ‹¤.
- **μ±„λ¬΄ μƒν™μ•΅ κ³„μ‚° λ΅μ§**: `HousingSystem._submit_saga_to_settlement` λ‚΄λ¶€μ— κ°€κ³„μ κΈ°μ΅΄ μ›” μ±„λ¬΄ μƒν™μ•΅(`existing_debt_payments`)μ„ μ¶”μ •ν•λ” λ΅μ§μ΄ λ‹¤μ† λ³µμ΅ν•κ² κµ¬ν„λμ–΄ μμµλ‹λ‹¤. μ΄ λ΅μ§μ„ λ³„λ„μ μ ν‹Έλ¦¬ν‹° ν•¨μλ‚ `Bank` λ¨λ“μ μ„λΉ„μ¤λ΅ λ¶„λ¦¬ν•μ—¬ `HousingSystem`μ μ±…μ„ λ²”μ„λ¥Ό λ…ν™•ν ν•λ” κ²ƒμ„ κ³ λ ¤ν•΄λ³Ό μ μμµλ‹λ‹¤.
- **Agent νƒ€μ… μ²΄ν¬**: μΈμ‚¬μ΄νΈ λ³΄κ³ μ„μ—μ„ μ§€μ ν• λ€λ΅, `SettlementSystem`μ΄ `hasattr`μ„ μ‚¬μ©ν•μ—¬ μ—μ΄μ „νΈ νƒ€μ…μ„ κµ¬λ¶„ν•λ” κ²ƒμ€ μ μ¬μ μΈ ν…μ¤νΈ μ¤λ¥λ¥Ό μ λ°ν•  μ μμµλ‹λ‹¤. ν–¥ν›„ `isinstance`λ‚ μ—­ν•  κΈ°λ° μΈν„°νμ΄μ¤(Role-based Interface)λ¥Ό μ‚¬μ©ν• λ…μ‹μ μΈ νƒ€μ… μ²΄ν¬λ΅ μ „ν™ν•λ” λ¦¬ν©ν† λ§μ„ μ μ•ν•©λ‹λ‹¤.

## 5. π§  Manual Update Proposal

μ μ¶λ `communications/insights/H1-Housing-V3-Saga.md`μ λ‚΄μ©μ΄ λ§¤μ° κµ¬μ²΄μ μ΄κ³  μ μ©ν•μ—¬, ν”„λ΅μ νΈμ μ¤‘μ•™ κΈ°μ  λ¶€μ±„ μ›μ¥μ— μ”μ•½/ν†µν•©ν•  κ²ƒμ„ μ μ•ν•©λ‹λ‹¤.

- **Target File**: `design/2_operations/ledgers/TECH_DEBT_LEDGER.md`
- **Update Content**:
  ```markdown
  ---
  
  ### ID: TD-HOUSING-SAGA-V3
  - **ν„μƒ (Observation)**:
    1.  **ν…μ¤νΈ Mockμ μ·¨μ•½μ„±**: `SettlementSystem`μ—μ„ `hasattr`λ΅ μ—μ΄μ „νΈ νƒ€μ…μ„ κ²€μ‚¬ν•λ” λ΅μ§μ΄ `MagicMock`μ μλ™ μ†μ„± μƒμ„± κΈ°λ¥κ³Ό μ¶©λν•μ—¬ ν…μ¤νΈ μ‹ λ…Όλ¦¬ μ¤λ¥λ¥Ό μ λ°ν•¨.
    2.  **DTO λΉ„νΈν™μ„±**: `housing_planner_api`μ™€ `housing_purchase_api` κ°„ `MortgageApplicationDTO`μ ν•„λ“λ…μ΄ λ‹¬λΌ νΈν™μ„± λ μ΄μ–΄κ°€ ν•„μ”ν•΄μ§.
  - **μ›μΈ (Cause)**:
    1.  μ—„κ²©ν• μΈν„°νμ΄μ¤λ‚ νƒ€μ… μ²΄ν¬ λ€μ‹ , μ μ—°ν•μ§€λ§ λ¨νΈν• `hasattr` λ°©μ‹μ— μμ΅΄.
    2.  κΈ°λ¥ κ°λ° κ³Όμ •μ—μ„ API DTO λ…μ„Έκ°€ ννΈν™”λ¨.
  - **ν•΄κ²° (Resolution)**:
    1.  `unittest.mock.MagicMock` μƒμ„± μ‹ `spec` μΈμλ¥Ό μ‚¬μ©ν•μ—¬ Mock κ°μ²΄μ μ†μ„±μ„ λ…μ‹μ μΌλ΅ μ ν•ν•¨.
    2.  `LoanMarket`μ— μ„μ‹ νΈν™μ„± λ΅μ§μ„ μ¶”κ°€ν•μ—¬ λ‘ DTOλ¥Ό λ¨λ‘ μ²λ¦¬ν•¨.
  - **κµν› (Lesson Learned)**:
    - ν•µμ‹¬ λ΅μ§μ—μ„λ” `hasattr`λ³΄λ‹¤ `isinstance`λ‚ μΈν„°νμ΄μ¤ κΈ°λ°μ λ…μ‹μ  νƒ€μ… μ²΄ν¬λ¥Ό μ‚¬μ©ν•μ—¬ μμΈ΅ κ°€λ¥μ„±μ„ λ†’μ—¬μ•Ό ν•λ‹¤.
    - API DTOλ” ν”„λ΅μ νΈ μ „λ°μ— κ±Έμ³ μΌκ΄€μ„±μ„ μ μ§€ν•λ„λ΅ κ΄€λ¦¬ν•΄μ•Ό ν•λ©°, λ³€κ²½ μ‹ νκΈ‰ ν¨κ³Όλ¥Ό λ¶„μ„ν•κ³  ν†µν•© λ¦¬ν©ν† λ§ κ³„νμ„ μλ¦½ν•΄μ•Ό ν•λ‹¤.
  ```

## 6. β… Verdict

**APPROVE**

> μ΄λ² λ³€κ²½ μ‚¬ν•­μ€ λ³µμ΅ν• κΈμµ νΈλμ­μ…μ„ μ•μ •μ μΌλ΅ μ²λ¦¬ν•κΈ° μ„ν• ν›λ¥­ν• μ•„ν‚¤ν…μ²μ  κ°μ„ μ…λ‹λ‹¤. νΉν, κ°λ° κ³Όμ •μ—μ„ λ°κ²¬λ κΈ°μ  λ¶€μ±„μ™€ ν•΄κ²° κ³Όμ •μ„ μƒμ„Έν λ¬Έμ„ν™”ν• `H1-Housing-V3-Saga.md` λ³΄κ³ μ„λ¥Ό μ μ¶ν• μ μ€ λ§¤μ° λ¨λ²”μ μ…λ‹λ‹¤. μ μ•λ λ¦¬ν©ν† λ§ μ‚¬ν•­λ“¤μ„ ν–¥ν›„ κΈ°μ  λ¶€μ±„ κ΄€λ¦¬ ν•­λ©μΌλ΅ μ¶”κ°€ν•κ³ , λ³€κ²½ μ‚¬ν•­μ„ λ³‘ν•©ν•λ” κ²ƒμ„ μΉμΈν•©λ‹λ‹¤.
