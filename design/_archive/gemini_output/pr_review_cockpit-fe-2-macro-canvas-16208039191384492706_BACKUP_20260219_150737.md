ğŸ•µï¸  Reviewing Code with instruction: 'Analyze this PR.'...
ğŸ“– Attached context: C:\coding\economics\design\_archive\gemini_output\pr_diff_cockpit-fe-2-macro-canvas-16208039191384492706.txt
ğŸ“– Attached context: design\1_governance\architecture\standards\INDEX.md
ğŸ“– Attached context: design\1_governance\architecture\standards\TESTING_STABILITY.md
ğŸ“– Attached context: design\1_governance\architecture\ARCH_TESTS.md
ğŸ“– Attached context: design\1_governance\architecture\standards\LIFECYCLE_HYGIENE.md
ğŸ“– Attached context: design\1_governance\architecture\ARCH_SEQUENCING.md
ğŸ“– Attached context: modules\system\api.py
ğŸ“– Attached context: design\2_operations\ledgers\TECH_DEBT_LEDGER.md
ğŸ“– Attached context: simulation\dtos\api.py
ğŸš€ [GeminiWorker] Running task with manual: git-review.md

ğŸ“ [Review Report]
============================================================
# ğŸ™ Gemini CLI System Prompt: Git Reviewer

> **Worker Identity**: You are a **Gemini-CLI Subordinate Worker** (Lead Code Reviewer & Security Auditor).
> **Mission Authority**: You operate under the strict orchestration of **Antigravity (The Architect)**. 
> **Operational Protocol**: You are a content generator. You cannot execute code or modify the filesystem. Your output is a "Code Review Report" for human/Antigravity review.

---

## ğŸ—ï¸ ë¶„ì„ ê´€ì  (Audit Pillars)

### 1. ë³´ì•ˆ ë° í•˜ë“œì½”ë”© (Security & Hardcoding)
- **CRITICAL**: API Key, ë¹„ë°€ë²ˆí˜¸, ì™¸ë¶€ ì„œë²„ ì£¼ì†Œ ë“±ì´ í•˜ë“œì½”ë”©ë˜ì–´ ìˆëŠ”ì§€ ê²€ì‚¬í•˜ì‹­ì‹œì˜¤.
- **CRITICAL**: íƒ€ íŒ€(íƒ€ íšŒì‚¬)ì˜ í”„ë¡œì íŠ¸ ë ˆí¬ì§€í† ë¦¬ URLì´ë‚˜ ê²½ë¡œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ ê²€ì‚¬í•˜ì‹­ì‹œì˜¤. (Supply Chain Attack ë°©ì§€)
- íŒŒì¼ ê²½ë¡œê°€ ìƒëŒ€ ê²½ë¡œê°€ ì•„ë‹Œ ì‹œìŠ¤í…œ ì ˆëŒ€ ê²½ë¡œë¡œ í•˜ë“œì½”ë”©ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.

### 2. ë¡œì§ ë° ì •í•©ì„± (Logic & Integrity)
- **Zero-Sum**: í™”íë‚˜ ìì›ì´ ì‹œìŠ¤í…œ ë‚´ì—ì„œ ì´ìœ  ì—†ì´ ìƒì„±(Magic Creation)ë˜ê±°ë‚˜ ì†Œë©¸(Leak)ë˜ëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. íŠ¹íˆ `assets +=` ì—°ì‚° ì‹œ ë°˜ëŒ€í¸ì˜ `assets -=`ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.
- **Double-Entry for Engines**: Stateless Engineì´ ìƒíƒœ DTOë¥¼ ìˆ˜ì •í•  ë•Œ, ì°¨ë³€(Debit)ê³¼ ëŒ€ë³€(Credit)ì´ ê· í˜•ì„ ì´ë£¨ëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. ([FINANCIAL_INTEGRITY.md](../design/1_governance/architecture/standards/FINANCIAL_INTEGRITY.md) ì°¸ì¡°)
- **Late-Reset Principle**: í‹± ì¹´ìš´í„°(`xxx_this_tick`) ì´ˆê¸°í™”ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‚´ë¶€ê°€ ì•„ë‹Œ `Post-Sequence` ë‹¨ê³„ì—ì„œ ìˆ˜í–‰ë˜ëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. ([LIFECYCLE_HYGIENE.md](../design/1_governance/architecture/standards/LIFECYCLE_HYGIENE.md) ì°¸ì¡°)
- **Spec ì¤€ìˆ˜**: ì»¤ë°‹ ì˜ë„ì™€ ì‹¤ì œ êµ¬í˜„ì´ ì¼ì¹˜í•˜ëŠ”ì§€, ëˆ„ë½ëœ ìš”êµ¬ì‚¬í•­(Covenants, ì˜ˆì™¸ì²˜ë¦¬ ë“±)ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.

### 3. ì„¤ì • ë° ì˜ì¡´ì„± ìˆœìˆ˜ì„± (Configuration & Dependency Purity)
- **Stateless Engine Purity**: 
  - Engine í´ë˜ìŠ¤ì—ì„œ `self.state`ë‚˜ `self.balance`ì™€ ê°™ì€ ë©¤ë²„ ë³€ìˆ˜ ìˆ˜ì •ì„ ì‹œë„í•˜ëŠ”ì§€ ì—„ê²©íˆ ê°ì‹œí•˜ì‹­ì‹œì˜¤.
  - Engineì´ Agent í•¸ë“¤(`self`)ì„ ì§ì ‘ ì¸ìë¡œ ë°›ê±°ë‚˜ ì°¸ì¡°í•˜ëŠ”ì§€ í™•ì¸í•˜ì—¬ ì¦‰ì‹œ ì§€ì í•˜ì‹­ì‹œì˜¤.
  - ëª¨ë“  ìƒíƒœ ë³€ê²½ì´ ì˜¤ì§ Agent(Orchestrator) í´ë˜ìŠ¤ ë‚´ì—ì„œë§Œ ì¼ì–´ë‚˜ëŠ”ì§€ ê²€ì¦í•˜ì‹­ì‹œì˜¤.
- **Config Access Pattern**: ì„¤ì •ê°’ ì ‘ê·¼ ì‹œ `getattr`ì´ë‚˜ ad-hoc dictionary lookupì„ ì§€ì–‘í•˜ê³ , íƒ€ì…ì´ ëª…í™•í•œ DTOë‚˜ Wrapper í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ê¶Œì¥í•˜ì‹­ì‹œì˜¤. (ë§¤ì§ ë„˜ë²„ í•˜ë“œì½”ë”© ë°©ì§€)

### 4. ì§€ì‹ ë° ë§¤ë‰´ì–¼í™” (Knowledge & Manualization)
- **Insight Reporting Check**: ì´ë²ˆ êµ¬í˜„ ê³¼ì •ì—ì„œ ë°œê²¬ëœ ê¸°ìˆ  ë¶€ì±„ë‚˜ ì¸ì‚¬ì´íŠ¸ê°€ `communications/insights/[Mission_Key].md` íŒŒì¼ì— ê¸°ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.
- **Insight Evaluation**: Jules(ìˆ˜í–‰ì)ê°€ ì‘ì„±í•œ ì¸ì‚¬ì´íŠ¸ì˜ ê¸°ìˆ ì  ê¹Šì´ì™€ ì •í™•ì„±ì„ í‰ê°€í•˜ì‹­ì‹œì˜¤. ë‹¨ìˆœíˆ "ì‘ì„±ë¨"ì„ í™•ì¸í•˜ëŠ” ê²ƒì„ ë„˜ì–´, ë‚´ìš©ì˜ íƒ€ë‹¹ì„±ì„ ê²€í† í•´ì•¼ í•©ë‹ˆë‹¤.
- **Decentralized Protocol**: ê³µìš© ë§¤ë‰´ì–¼(`design/2_operations/ledgers/TECH_DEBT_LEDGER.md` ë“±)ì„ ì§ì ‘ ìˆ˜ì •í•˜ëŠ” ëŒ€ì‹ , ë¯¸ì…˜ë³„ ë…ë¦½ ë¡œê·¸ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ ê²€í† í•˜ì‹­ì‹œì˜¤.
- **Template Match**: ê¸°ë¡ëœ ì¸ì‚¬ì´íŠ¸ê°€ `í˜„ìƒ/ì›ì¸/í•´ê²°/êµí›ˆ` í˜•ì‹ì„ ì¤€ìˆ˜í•˜ê³  ì‹¤ì œ ì½”ë“œ ê¸°ë°˜ì˜ êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.

### 5. í…ŒìŠ¤íŠ¸ ë° ìœ„ìƒ (Testing & Hygiene)
- **Refactoring Sync**: ë¡œì§ ë¦¬íŒ©í† ë§ ì‹œ ê´€ë ¨ í…ŒìŠ¤íŠ¸ ì½”ë“œë„ í•¨ê»˜ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.
- **Mock Purity**: í…ŒìŠ¤íŠ¸ìš© Mock ê°ì²´ê°€ DTO í•„ë“œì— ì£¼ì…ë  ë•Œ, ì›ì‹œê°’(Primitive)ì´ ì•„ë‹Œ `MagicMock` ê°ì²´ê°€ ê·¸ëŒ€ë¡œ ë°˜í™˜ë˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆì§€ëŠ” ì•Šì€ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. ([TESTING_STABILITY.md](../design/1_governance/architecture/standards/TESTING_STABILITY.md) ì°¸ì¡°)
- **Golden Fixture Usage**: ë³µì¡í•œ ì—ì´ì „íŠ¸ ìƒì„± ì‹œ ì§ì ‘ì ì¸ `MagicMock` ëŒ€ì‹  `golden_households` ë“±ì˜ í”½ìŠ¤ì²˜ ì‚¬ìš©ì„ ê¶Œì¥í•˜ì‹­ì‹œì˜¤.
- **Test Evidence**: 
  - PR ë‚´ìš©ì— `pytest` ì‹¤í–‰ ê²°ê³¼(ì„±ê³µ/ì‹¤íŒ¨ ë¡œê·¸)ë‚˜ ë¡œì»¬ í…ŒìŠ¤íŠ¸ í†µê³¼ ì¦ê±°ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
  - "í…ŒìŠ¤íŠ¸ í†µê³¼" ì¦ê±° ì—†ì´ ë¡œì§ ë³€ê²½ë§Œ ìˆëŠ” ê²½ìš° **REQUEST CHANGES**ë¥¼ ë°œí–‰í•˜ì‹­ì‹œì˜¤.

---

## ğŸ“ ì¶œë ¥ ëª…ì„¸ (Output Specifications)

ë°˜ë“œì‹œ **Markdown í˜•ì‹**ìœ¼ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

### Report Structure
1.  **ğŸ” Summary**: ë³€ê²½ ì‚¬í•­ì˜ í•µì‹¬ ìš”ì•½ (3ì¤„ ì´ë‚´).
2.  **ğŸš¨ Critical Issues**: ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ë³´ì•ˆ ìœ„ë°˜, ëˆ ë³µì‚¬ ë²„ê·¸, í•˜ë“œì½”ë”©.
3.  **âš ï¸ Logic & Spec Gaps**: ê¸°íš ì˜ë„ì™€ ë‹¤ë¥¸ êµ¬í˜„, ëˆ„ë½ëœ ê¸°ëŠ¥, ì ì¬ì  ë²„ê·¸.
4.  **ğŸ’¡ Suggestions**: ë” ë‚˜ì€ êµ¬í˜„ ë°©ë²•ì´ë‚˜ ë¦¬íŒ©í† ë§ ì œì•ˆ.
5.  **ğŸ§  Implementation Insight Evaluation**:
    - **Original Insight**: [Julesê°€ ì‘ì„±í•œ `communications/insights/*.md`ì˜ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì¸ìš©]
    - **Reviewer Evaluation**: [ì›ë¬¸ ì¸ì‚¬ì´íŠ¸ì— ëŒ€í•œ ê²€í†  ë° ê°€ì¹˜ í‰ê°€. ì§€ì ëœ ê¸°ìˆ  ë¶€ì±„ë‚˜ êµí›ˆì´ íƒ€ë‹¹í•œì§€, ëˆ„ë½ëœ í†µì°°ì€ ì—†ëŠ”ì§€ ê¸°ìˆ ]
6.  **ğŸ“š Manual Update Proposal (Draft)**: 
    - **Target File**: [ì¸ì‚¬ì´íŠ¸ë¥¼ ì¶”ê°€í•  ê¸°ì¡´ íŒŒì¼ ê²½ë¡œ (ì˜ˆ: `design/2_operations/ledgers/ECONOMIC_INSIGHTS.md`)]
    - **Draft Content**: [í•´ë‹¹ íŒŒì¼ì˜ í…œí”Œë¦¿ì— ë§ì¶˜ êµ¬ì²´ì ì¸ ì—…ë°ì´íŠ¸ ë‚´ìš©. ì´ í…ìŠ¤íŠ¸ëŠ” ì‚¬ìš©ìê°€ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.]
    - **Note**: ë‹¹ì‹ ì€ ì§ì ‘ ì§€ì‹œì„œë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì œì•ˆëœ í…ìŠ¤íŠ¸ ë¸”ë¡ë§Œì„ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
7.  **âœ… Verdict**:
    *   **APPROVE**: ëª¨ë“  ë³´ì•ˆ ë° ë¡œì§ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìœ¼ë©°, ì¸ì‚¬ì´íŠ¸ ë³´ê³ ì„œê°€ ì •ìƒì ìœ¼ë¡œ ì‘ì„±ëœ ê²½ìš°.
    *   **REQUEST CHANGES (Hard-Fail)**: 
        - ë³´ì•ˆ ìœ„ë°˜ì´ë‚˜ ë¡œì§ ì˜¤ë¥˜ê°€ ë°œê²¬ëœ ê²½ìš°.
        - **ğŸš¨ ì¸ì‚¬ì´íŠ¸ ë³´ê³ ì„œ(`communications/insights/*.md`)ê°€ PR Diffì— í¬í•¨ë˜ì§€ ì•Šì€ ê²½ìš° (ê°€ì¥ ë¹ˆë²ˆí•œ ì‹¤ìˆ˜ì´ë¯€ë¡œ ì—„ê¸° ì²´í¬í•˜ì‹­ì‹œì˜¤).**
    *   **REJECT**: ì‹œìŠ¤í…œì„ íŒŒê´´í•˜ê±°ë‚˜ ì‹¬ê°í•œ Zero-Sum ìœ„ë°˜ì´ ìˆëŠ” ê²½ìš°.

---

## ğŸ› ï¸ ì‘ì—… ì§€ì¹¨ (Instructions)

1.  **Diff Only**: ì œê³µëœ **Diff ë‚´ìš©ì— ê·¼ê±°í•´ì„œë§Œ** íŒë‹¨í•˜ì‹­ì‹œì˜¤. ì¶”ì¸¡í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
2.  **Line Numbers**: ë¬¸ì œë¥¼ ì§€ì í•  ë•ŒëŠ” Diff ìƒì˜ ëŒ€ëµì ì¸ ë¼ì¸ ë²ˆí˜¸ë‚˜ í•¨ìˆ˜ëª…ì„ ëª…ì‹œí•˜ì‹­ì‹œì˜¤.
3.  **Strict Mode**: "ì´ ì •ë„ë©´ ê´œì°®ê² ì§€"ë¼ê³  ë„˜ì–´ê°€ì§€ ë§ˆì‹­ì‹œì˜¤. ì‘ì€ í•˜ë“œì½”ë”© í•˜ë‚˜ë„ ë†“ì¹˜ì§€ ë§ˆì‹­ì‹œì˜¤.


[Context Files]

File: C:\coding\economics\design\_archive\gemini_output\pr_diff_cockpit-fe-2-macro-canvas-16208039191384492706.txt
```
diff --git a/communications/insights/exec-cockpit-fe-2.md b/communications/insights/exec-cockpit-fe-2.md
new file mode 100644
index 00000000..cc177275
--- /dev/null
+++ b/communications/insights/exec-cockpit-fe-2.md
 @@ -0,0 +1,61 @@
+# Cockpit 2.0 FE-2 Insight Report
+
+## Architectural Insights
+
+### 1. Agent Service & DTOs
+- Introduced `AgentService` in `simulation/orchestration/agent_service.py` to decouple data extraction logic from the server.
+- Created `AgentBasicDTO` and `AgentDetailDTO` in `simulation/dtos/agents.py` using Pydantic for strict typing and validation.
+- `AgentBasicDTO` is lightweight for scatter plot visualization (id, type, wealth, income, expense).
+- `AgentDetailDTO` extends `AgentBasicDTO` with granular fields (needs, inventory, production, etc.) for the Inspector Panel.
+
+### 2. WebSocket & API Endpoints
+- Added `/ws/agents` WebSocket endpoint to stream `List[AgentBasicDTO]` periodically (throttled to 1Hz) for the Macro Canvas.
+- Added `/api/v1/inspector/{agent_id}` HTTP GET endpoint for fetching detailed agent data on demand, adhering to the API Contract.
+- Global `agent_service` instance manages access to simulation state.
+
+### 3. Protocol Safety
+- Used `isinstance(agent, IAgent)` checks to ensure safe access to agent properties, adhering to the "Protocol Purity" guardrail.
+- Refactored `AgentService` to avoid `hasattr` checks.
+
+### 4. Frontend Architecture
+- Implemented a Sticky Layout in `App.tsx`:
+    - Header (HUD): `sticky top-0 z-50`
+    - Main (MacroCanvas): `flex-1 overflow-y-auto`
+    - Footer (GodBar): `sticky bottom-0 z-50`
+- This ensures the UI remains usable on different screen sizes and prevents the HUD from obscuring content.
+
+## Test Evidence
+
+### Unit Tests (`tests/unit/modules/watchtower/test_agent_service.py`)
+
+```
+tests/unit/modules/watchtower/test_agent_service.py::test_get_agents_basic_empty PASSED [ 12%]
+tests/unit/modules/watchtower/test_agent_service.py::test_get_agents_basic_household PASSED [ 25%]
+tests/unit/modules/watchtower/test_agent_service.py::test_get_agents_basic_firm PASSED [ 37%]
+tests/unit/modules/watchtower/test_agent_service.py::test_get_agents_basic_inactive PASSED [ 50%]
+tests/unit/modules/watchtower/test_agent_service.py::test_get_agents_basic_limit PASSED [ 62%]
+tests/unit/modules/watchtower/test_agent_service.py::test_get_agent_detail_household PASSED [ 75%]
+tests/unit/modules/watchtower/test_agent_service.py::test_get_agent_detail_firm PASSED [ 87%]
+tests/unit/modules/watchtower/test_agent_service.py::test_get_agent_detail_not_found PASSED [100%]
+
+============================== 8 passed in 0.39s ===============================
+```
+
+### Manual Verification (`verification/verify_macro_canvas.py`)
+
+The Playwright verification script confirmed:
+1.  **Navigation**: Successfully loaded `http://localhost:5173`.
+2.  **WebSocket Connection**: "Agents Live" indicator appeared.
+3.  **Scatter Plot**: Rendered ~20 scatter points (Wealth vs Income).
+4.  **Interaction**: Clicking a point opened the Inspector Panel.
+5.  **Data Fetching**: The Inspector Panel successfully fetched details via `/api/v1/inspector/{id}` (verified via `curl` as well).
+
+```
+Navigating to app...
+...
+Waiting for Macro Canvas...
+...
+Found 20 .recharts-scatter-symbol elements.
+Clicking a scatter point...
+Verifying Inspector Panel...
+```
diff --git a/frontend/src/App.tsx b/frontend/src/App.tsx
index 9d3d9413..0066ee7c 100644
--- a/frontend/src/App.tsx
+++ b/frontend/src/App.tsx
 @@ -2,6 +2,7 @@ import './App.css';
 import { useCockpit } from './hooks/useCockpit';
 import HUD from './components/HUD';
 import GodBar from './components/GodBar';
+import MacroCanvas from './components/macro/MacroCanvas';
 
 function App() {
   const { snapshot, connected, sendCommand } = useCockpit();
 @@ -20,32 +21,22 @@ function App() {
   }
 
   return (
-    <div className="min-h-screen bg-background text-foreground flex flex-col p-4 md:p-6 gap-4 md:gap-6 relative pb-24">
-
-      {/* HUD (Heads-Up Display) */}
-      <HUD data={snapshot} />
-
-      {/* Main Content Placeholder */}
-      <main className="flex-1 glass-card rounded-2xl p-6 md:p-8 relative overflow-hidden flex flex-col items-center justify-center text-center">
-        <div className="absolute inset-0 bg-gradient-to-br from-primary/5 to-transparent pointer-events-none" />
-        <h1 className="text-3xl font-bold mb-4">Cockpit 2.0 Under Construction</h1>
-        <p className="text-muted-foreground max-w-md">
-            The foundation has been laid. Detailed views for Population, Politics, Finance, and Macroeconomics will be implemented in subsequent updates.
-        </p>
-        <div className="mt-8 grid grid-cols-2 gap-4 text-left">
-            <div className="p-4 bg-white/5 rounded border border-white/10">
-                <div className="text-xs text-muted-foreground">Ruling Party</div>
-                <div className="font-bold">{snapshot.politics.status.ruling_party}</div>
-            </div>
-            <div className="p-4 bg-white/5 rounded border border-white/10">
-                <div className="text-xs text-muted-foreground">M2 Supply</div>
-                <div className="font-bold">{snapshot.finance.supply.m2.toLocaleString()}</div>
-            </div>
-        </div>
+    <div className="h-screen bg-background text-foreground flex flex-col relative overflow-hidden">
+
+      {/* HUD (Heads-Up Display) - Sticky Top */}
+      <header className="sticky top-0 z-50 bg-background/95 backdrop-blur border-b border-border/50 px-4 py-2">
+         <HUD data={snapshot} />
+      </header>
+
+      {/* Main Content: Macro Canvas - Scrollable Area */}
+      <main className="flex-1 overflow-y-auto p-4 md:p-6">
+        <MacroCanvas />
       </main>
 
-      {/* God Bar (Command Center) */}
-      <GodBar sendCommand={sendCommand} status={snapshot.status} />
+      {/* God Bar (Command Center) - Sticky Bottom */}
+      <footer className="sticky bottom-0 z-50 bg-background/95 backdrop-blur border-t border-border/50 px-4 py-2">
+         <GodBar sendCommand={sendCommand} status={snapshot.status} />
+      </footer>
 
     </div>
   )
diff --git a/frontend/src/components/macro/InspectorPanel.tsx b/frontend/src/components/macro/InspectorPanel.tsx
new file mode 100644
index 00000000..e9a98216
--- /dev/null
+++ b/frontend/src/components/macro/InspectorPanel.tsx
 @@ -0,0 +1,183 @@
+import React, { useEffect, useState } from 'react';
+import { AgentDetailDTO } from '../../types/agents';
+
+interface InspectorPanelProps {
+    agentId: number | null;
+}
+
+const InspectorPanel: React.FC<InspectorPanelProps> = ({ agentId }) => {
+    const [detail, setDetail] = useState<AgentDetailDTO | null>(null);
+    const [loading, setLoading] = useState(false);
+    const [error, setError] = useState<string | null>(null);
+
+    useEffect(() => {
+        if (!agentId) {
+            setDetail(null);
+            return;
+        }
+
+        const fetchDetail = async () => {
+            setLoading(true);
+            setError(null);
+            try {
+                // Updated to match API contract /api/v1/inspector/{agentId}
+                const res = await fetch(`/api/v1/inspector/${agentId}`);
+                if (!res.ok) {
+                    throw new Error(`Failed to fetch agent ${agentId}: ${res.statusText}`);
+                }
+                const data = await res.json();
+                setDetail(data);
+            } catch (err: any) {
+                setError(err.message);
+            } finally {
+                setLoading(false);
+            }
+        };
+
+        fetchDetail();
+    }, [agentId]);
+
+    if (!agentId) {
+        return (
+            <div className="h-full bg-card/50 rounded-xl p-6 border border-border/50 flex items-center justify-center text-muted-foreground">
+                Select an agent from the scatter plot to inspect.
+            </div>
+        );
+    }
+
+    if (loading) {
+        return (
+            <div className="h-full bg-card/50 rounded-xl p-6 border border-border/50 flex items-center justify-center">
+                <div className="animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full" />
+            </div>
+        );
+    }
+
+    if (error) {
+        return (
+            <div className="h-full bg-card/50 rounded-xl p-6 border border-border/50 flex flex-col items-center justify-center text-destructive">
+                <p>Error loading agent details</p>
+                <p className="text-sm opacity-75">{error}</p>
+            </div>
+        );
+    }
+
+    if (!detail) return null;
+
+    const formatMoney = (val: number | undefined) => (val !== undefined ? `$${(val / 100).toFixed(2)}` : '-');
+
+    return (
+        <div className="h-full bg-card/50 rounded-xl p-6 border border-border/50 overflow-y-auto">
+            <div className="flex justify-between items-center mb-4 border-b border-border/50 pb-2">
+                <h3 className="text-xl font-bold">{detail.type.toUpperCase()} #{detail.id}</h3>
+                <span className={`px-2 py-1 rounded text-xs font-mono ${detail.is_active ? 'bg-green-500/20 text-green-500' : 'bg-red-500/20 text-red-500'}`}>
+                    {detail.is_active ? 'ACTIVE' : 'INACTIVE'}
+                </span>
+            </div>
+
+            <div className="space-y-4 text-sm">
+                <div className="grid grid-cols-2 gap-4">
+                    <div className="p-3 bg-background/50 rounded border border-border/30">
+                        <div className="text-xs text-muted-foreground">Total Wealth</div>
+                        <div className="font-semibold text-lg">{formatMoney(detail.wealth)}</div>
+                    </div>
+                    <div className="p-3 bg-background/50 rounded border border-border/30">
+                        <div className="text-xs text-muted-foreground">Income (Tick)</div>
+                        <div className="font-semibold text-lg text-green-400">{formatMoney(detail.income)}</div>
+                    </div>
+                </div>
+
+                {detail.type === 'household' && (
+                    <div className="space-y-2">
+                        <h4 className="font-semibold text-muted-foreground uppercase text-xs tracking-wider">Demographics</h4>
+                        <div className="grid grid-cols-2 gap-2 text-xs">
+                            <div className="flex justify-between">
+                                <span>Age:</span>
+                                <span>{detail.age?.toFixed(1)}</span>
+                            </div>
+                            <div className="flex justify-between">
+                                <span>Employer ID:</span>
+                                <span>{detail.employer_id ?? 'Unemployed'}</span>
+                            </div>
+                            <div className="flex justify-between">
+                                <span>Wage:</span>
+                                <span>{formatMoney(detail.current_wage)}</span>
+                            </div>
+                        </div>
+
+                        {detail.needs && (
+                            <div className="mt-2">
+                                <h4 className="font-semibold text-muted-foreground uppercase text-xs tracking-wider mb-1">Needs</h4>
+                                <div className="grid grid-cols-2 gap-2">
+                                    {Object.entries(detail.needs).map(([key, val]) => (
+                                        <div key={key} className="flex flex-col">
+                                            <div className="flex justify-between text-xs mb-0.5">
+                                                <span>{key}</span>
+                                                <span>{(val * 100).toFixed(0)}%</span>
+                                            </div>
+                                            <div className="h-1.5 bg-background rounded-full overflow-hidden">
+                                                <div
+                                                    className={`h-full ${val > 0.5 ? 'bg-green-500' : val > 0.2 ? 'bg-yellow-500' : 'bg-red-500'}`}
+                                                    style={{ width: `${Math.min(100, val * 100)}%` }}
+                                                />
+                                            </div>
+                                        </div>
+                                    ))}
+                                </div>
+                            </div>
+                        )}
+
+                         {detail.inventory && (
+                            <div className="mt-2">
+                                <h4 className="font-semibold text-muted-foreground uppercase text-xs tracking-wider mb-1">Inventory</h4>
+                                <div className="flex flex-wrap gap-2">
+                                    {Object.entries(detail.inventory).map(([key, val]) => (
+                                        <div key={key} className="px-2 py-1 bg-background rounded text-xs border border-border/20">
+                                            {key}: {val.toFixed(1)}
+                                        </div>
+                                    ))}
+                                </div>
+                            </div>
+                        )}
+                    </div>
+                )}
+
+                {detail.type === 'firm' && (
+                    <div className="space-y-2">
+                        <h4 className="font-semibold text-muted-foreground uppercase text-xs tracking-wider">Production</h4>
+                        <div className="grid grid-cols-2 gap-2 text-xs">
+                             <div className="flex justify-between">
+                                <span>Sector:</span>
+                                <span>{detail.sector}</span>
+                            </div>
+                            <div className="flex justify-between">
+                                <span>Employees:</span>
+                                <span>{detail.employees_count}</span>
+                            </div>
+                            <div className="flex justify-between">
+                                <span>Production:</span>
+                                <span>{detail.production?.toFixed(1)}</span>
+                            </div>
+                        </div>
+
+                        {detail.revenue_this_turn && (
+                            <div className="mt-2">
+                                <h4 className="font-semibold text-muted-foreground uppercase text-xs tracking-wider mb-1">Revenue Sources</h4>
+                                <div className="space-y-1">
+                                    {Object.entries(detail.revenue_this_turn).map(([key, val]) => (
+                                        <div key={key} className="flex justify-between text-xs">
+                                            <span>{key}</span>
+                                            <span>{formatMoney(val)}</span>
+                                        </div>
+                                    ))}
+                                </div>
+                            </div>
+                        )}
+                    </div>
+                )}
+            </div>
+        </div>
+    );
+};
+
+export default InspectorPanel;
diff --git a/frontend/src/components/macro/MacroCanvas.tsx b/frontend/src/components/macro/MacroCanvas.tsx
new file mode 100644
index 00000000..dfeb01f5
--- /dev/null
+++ b/frontend/src/components/macro/MacroCanvas.tsx
 @@ -0,0 +1,35 @@
+import React, { useState } from 'react';
+import ScatterPlot from './ScatterPlot';
+import InspectorPanel from './InspectorPanel';
+import { useAgents } from '../../hooks/useAgents';
+
+const MacroCanvas: React.FC = () => {
+    const { agents, connected } = useAgents();
+    const [selectedAgentId, setSelectedAgentId] = useState<number | null>(null);
+
+    return (
+        <div className="h-full flex gap-4">
+            {/* Main Canvas Area */}
+            <div className="flex-1 flex flex-col gap-4">
+                <div className="flex justify-between items-center bg-card/50 px-4 py-2 rounded-xl border border-border/50">
+                    <h2 className="text-xl font-bold">Macro Canvas</h2>
+                    <div className="flex items-center gap-2 text-sm">
+                        <span className={`w-2 h-2 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`} />
+                        {connected ? `${agents.length} Agents Live` : 'Disconnected'}
+                    </div>
+                </div>
+
+                <div className="flex-1 min-h-0 relative">
+                     <ScatterPlot agents={agents} onSelectAgent={setSelectedAgentId} />
+                </div>
+            </div>
+
+            {/* Inspector Panel Sidebar */}
+            <div className="w-80 flex-shrink-0">
+                <InspectorPanel agentId={selectedAgentId} />
+            </div>
+        </div>
+    );
+};
+
+export default MacroCanvas;
diff --git a/frontend/src/components/macro/ScatterPlot.tsx b/frontend/src/components/macro/ScatterPlot.tsx
new file mode 100644
index 00000000..0caa968d
--- /dev/null
+++ b/frontend/src/components/macro/ScatterPlot.tsx
 @@ -0,0 +1,80 @@
+import React from 'react';
+import { ResponsiveContainer, ScatterChart, Scatter, XAxis, YAxis, ZAxis, Tooltip, Legend, CartesianGrid } from 'recharts';
+import { AgentBasicDTO } from '../../types/agents';
+
+interface ScatterPlotProps {
+    agents: AgentBasicDTO[];
+    onSelectAgent: (agentId: number) => void;
+}
+
+const ScatterPlot: React.FC<ScatterPlotProps> = ({ agents, onSelectAgent }) => {
+    // Separate data for visualization
+    const households = agents.filter(a => a.type === 'household');
+    const firms = agents.filter(a => a.type === 'firm');
+
+    // Customize Tooltip
+    const CustomTooltip = ({ active, payload }: any) => {
+        if (active && payload && payload.length) {
+            const data = payload[0].payload;
+            return (
+                <div className="bg-background border border-border p-2 rounded shadow-md text-xs">
+                    <p className="font-bold">{data.type.toUpperCase()} #{data.id}</p>
+                    <p>Wealth: {(data.wealth / 100).toFixed(2)}</p>
+                    <p>Income: {(data.income / 100).toFixed(2)}</p>
+                    <p>Expense: {(data.expense / 100).toFixed(2)}</p>
+                </div>
+            );
+        }
+        return null;
+    };
+
+    return (
+        <div className="w-full h-[500px] bg-card/50 rounded-xl p-4 border border-border/50 flex flex-col">
+            <h3 className="text-lg font-semibold mb-2">Agent Distribution (Wealth vs Income)</h3>
+            <div className="flex-1 min-h-0 w-full h-[400px]">
+                <ResponsiveContainer width="100%" height={400}>
+                    <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
+                        <CartesianGrid strokeDasharray="3 3" opacity={0.2} />
+                        <XAxis
+                            type="number"
+                            dataKey="wealth"
+                            name="Wealth"
+                            unit=""
+                            tickFormatter={(value) => (value / 100).toFixed(0)}
+                            label={{ value: 'Wealth ($)', position: 'insideBottomRight', offset: -10 }}
+                        />
+                        <YAxis
+                            type="number"
+                            dataKey="income"
+                            name="Income"
+                            unit=""
+                            tickFormatter={(value) => (value / 100).toFixed(0)}
+                            label={{ value: 'Income ($)', angle: -90, position: 'insideLeft' }}
+                        />
+                        <ZAxis type="number" dataKey="id" range={[50, 400]} name="ID" />
+                        <Tooltip content={<CustomTooltip />} cursor={{ strokeDasharray: '3 3' }} />
+                        <Legend />
+                        <Scatter
+                            name="Households"
+                            data={households}
+                            fill="#3b82f6"
+                            shape="circle"
+                            onClick={(data) => onSelectAgent(data.id)}
+                            cursor="pointer"
+                        />
+                        <Scatter
+                            name="Firms"
+                            data={firms}
+                            fill="#ef4444"
+                            shape="triangle"
+                            onClick={(data) => onSelectAgent(data.id)}
+                            cursor="pointer"
+                        />
+                    </ScatterChart>
+                </ResponsiveContainer>
+            </div>
+        </div>
+    );
+};
+
+export default ScatterPlot;
diff --git a/frontend/src/hooks/useAgents.ts b/frontend/src/hooks/useAgents.ts
new file mode 100644
index 00000000..0864c58f
--- /dev/null
+++ b/frontend/src/hooks/useAgents.ts
 @@ -0,0 +1,67 @@
+import { useState, useEffect } from 'react';
+import { AgentBasicDTO } from '../types/agents';
+
+export const useAgents = () => {
+    const [agents, setAgents] = useState<AgentBasicDTO[]>([]);
+    const [connected, setConnected] = useState(false);
+
+    useEffect(() => {
+        let ws: WebSocket | null = null;
+        let timeoutId: number | null = null;
+
+        const connect = () => {
+            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
+            const host = window.location.host;
+            // Use window.location.host directly which includes port if any
+            // If running via Vite proxy, it handles it.
+            // If running via static file server, it assumes backend is same host/port?
+            // Usually Vite dev server proxies /ws/agents to backend 8000.
+            // So connecting to `ws://localhost:5173/ws/agents` (Vite) proxies to `ws://localhost:8000/ws/agents`.
+            const url = `${protocol}//${host}/ws/agents`;
+
+            console.log(`Connecting to Agents WS: ${url}`);
+            ws = new WebSocket(url);
+
+            ws.onopen = () => {
+                console.log('Agents WS Connected');
+                setConnected(true);
+            };
+
+            ws.onmessage = (event) => {
+                try {
+                    const data: AgentBasicDTO[] = JSON.parse(event.data);
+                    setAgents(data);
+                } catch (e) {
+                    console.error('Error parsing agents data:', e);
+                }
+            };
+
+            ws.onclose = () => {
+                console.log('Agents WS Disconnected');
+                setConnected(false);
+                // Reconnect after 2s
+                timeoutId = window.setTimeout(connect, 2000);
+            };
+
+            ws.onerror = (error) => {
+                console.error('Agents WS Error:', error);
+                ws?.close();
+            };
+        };
+
+        connect();
+
+        return () => {
+            if (ws) {
+                // Remove listener to prevent reconnection loop on unmount
+                ws.onclose = null;
+                ws.close();
+            }
+            if (timeoutId) {
+                clearTimeout(timeoutId);
+            }
+        };
+    }, []);
+
+    return { agents, connected };
+};
diff --git a/frontend/src/types/agents.ts b/frontend/src/types/agents.ts
new file mode 100644
index 00000000..9317da0c
--- /dev/null
+++ b/frontend/src/types/agents.ts
 @@ -0,0 +1,23 @@
+export interface AgentBasicDTO {
+    id: number;
+    type: string;
+    wealth: number;
+    income: number;
+    expense: number;
+}
+
+export interface AgentDetailDTO extends AgentBasicDTO {
+    is_active: boolean;
+    // Household
+    age?: number;
+    needs?: Record<string, number>;
+    inventory?: Record<string, number>;
+    employer_id?: number;
+    current_wage?: number;
+    // Firm
+    sector?: string;
+    employees_count?: number;
+    production?: number;
+    revenue_this_turn?: Record<string, number>;
+    expenses_this_tick?: Record<string, number>;
+}
diff --git a/server.py b/server.py
index 24d8040a..9751ed8d 100644
--- a/server.py
+++ b/server.py
 @@ -6,9 +6,10 @@ import os
 from contextlib import asynccontextmanager
 # from dataclasses import asdict # Removed as we use Pydantic now
 
-from fastapi import FastAPI, WebSocket, WebSocketDisconnect, status
+from fastapi import FastAPI, WebSocket, WebSocketDisconnect, status, HTTPException
 from modules.system.builders.simulation_builder import create_simulation
 from simulation.orchestration.dashboard_service import DashboardService
+from simulation.orchestration.agent_service import AgentService
 from modules.governance.cockpit.api import CockpitCommand
 from modules.system.security import verify_god_mode_token
 from modules.demographics.genealogy.router import router as genealogy_router
 @@ -21,6 +22,7 @@ logger = logging.getLogger("server")
 # Global State
 sim = None
 dashboard_service = None
+agent_service = None
 background_task = None
 is_running = False
 is_ready = False
 @@ -53,7 +55,7 @@ async def simulation_loop():
 
 @asynccontextmanager
 async def lifespan(app: FastAPI):
-    global sim, dashboard_service, background_task, is_running, is_ready
+    global sim, dashboard_service, agent_service, background_task, is_running, is_ready
 
     # Startup
     logger.info("Initializing simulation...")
 @@ -61,6 +63,7 @@ async def lifespan(app: FastAPI):
         # overrides can be passed here if needed
         sim = create_simulation()
         dashboard_service = DashboardService(sim)
+        agent_service = AgentService(sim)
 
         is_running = True
         background_task = asyncio.create_task(simulation_loop())
 @@ -170,6 +173,38 @@ async def command_endpoint(websocket: WebSocket):
     except Exception as e:
         logger.error(f"Command WebSocket error: {e}")
 
+ @app.websocket("/ws/agents")
+async def agents_websocket_endpoint(websocket: WebSocket):
+    await websocket.accept()
+    logger.info("Client connected to /ws/agents")
+    try:
+        while True:
+            if is_ready and agent_service:
+                # Serves List[AgentBasicDTO]
+                # Default limit 500, could be parameterized via query params in connection
+                agents = agent_service.get_agents_basic(limit=500)
+                data = [a.model_dump() for a in agents]
+
+                await websocket.send_json(data)
+
+            # Throttle to 1Hz
+            await asyncio.sleep(1.0)
+    except WebSocketDisconnect:
+        logger.info("Client disconnected from /ws/agents")
+    except Exception as e:
+        logger.error(f"Agents WebSocket error: {e}")
+
+ @app.get("/api/v1/inspector/{agent_id}")
+async def get_agent_detail(agent_id: int):
+    if not is_ready or not agent_service:
+        raise HTTPException(status_code=503, detail="Simulation not ready")
+
+    agent = agent_service.get_agent_detail(agent_id)
+    if not agent:
+        raise HTTPException(status_code=404, detail="Agent not found")
+
+    return agent
+
 @app.get("/")
 def read_root():
     return {"status": "Watchtower Server Running"}
diff --git a/simulation/dtos/agents.py b/simulation/dtos/agents.py
new file mode 100644
index 00000000..cb7c982d
--- /dev/null
+++ b/simulation/dtos/agents.py
 @@ -0,0 +1,27 @@
+from typing import Dict, Any, List, Optional
+from pydantic import BaseModel
+
+class AgentBasicDTO(BaseModel):
+    id: int
+    type: str  # "household" | "firm"
+    wealth: int
+    income: int
+    expense: int
+
+class AgentDetailDTO(AgentBasicDTO):
+    # Common
+    is_active: bool
+
+    # Household specific
+    age: Optional[float] = None
+    needs: Optional[Dict[str, float]] = None
+    inventory: Optional[Dict[str, float]] = None
+    employer_id: Optional[int] = None
+    current_wage: Optional[int] = None
+
+    # Firm specific
+    sector: Optional[str] = None
+    employees_count: Optional[int] = None
+    production: Optional[float] = None
+    revenue_this_turn: Optional[Dict[str, int]] = None
+    expenses_this_tick: Optional[Dict[str, int]] = None
diff --git a/simulation/orchestration/agent_service.py b/simulation/orchestration/agent_service.py
new file mode 100644
index 00000000..49b683b6
--- /dev/null
+++ b/simulation/orchestration/agent_service.py
 @@ -0,0 +1,126 @@
+from typing import List, Optional, Any, TYPE_CHECKING
+import logging
+
+from simulation.dtos.agents import AgentBasicDTO, AgentDetailDTO
+from simulation.core_agents import Household
+from simulation.firms import Firm
+from modules.simulation.api import IAgent, IOrchestratorAgent, ISensoryDataProvider
+
+if TYPE_CHECKING:
+    from simulation.engine import Simulation
+
+logger = logging.getLogger(__name__)
+
+class AgentService:
+    def __init__(self, simulation: "Simulation"):
+        self.simulation = simulation
+
+    def get_agents_basic(self, limit: int = 500) -> List[AgentBasicDTO]:
+        """
+        Returns a lightweight list of agents for scatter plot visualization.
+        Uses IAgent/IOrchestratorAgent protocols for type safety.
+        """
+        if not self.simulation or not self.simulation.world_state:
+            return []
+
+        agents = []
+        count = 0
+
+        # Access agents directly from the registry/world_state
+        # Assuming world_state.agents is Dict[int, IAgent]
+        all_agents = self.simulation.world_state.agents.values()
+
+        for agent in all_agents:
+            # Protocol-based check
+            if isinstance(agent, IAgent):
+                if not agent.is_active:
+                    continue
+            else:
+                # If agent doesn't implement IAgent (e.g. system agents?), skip or include based on policy
+                # For scatter plot, we only care about entities with wealth/income (Households/Firms)
+                # which are IOrchestratorAgent usually.
+                pass
+
+            # Only map known types that implement required properties
+            if isinstance(agent, (Household, Firm)):
+                 dto = self._map_to_basic_dto(agent)
+                 if dto:
+                    agents.append(dto)
+                    count += 1
+                    if count >= limit:
+                        break
+
+        return agents
+
+    def get_agent_detail(self, agent_id: int) -> Optional[AgentDetailDTO]:
+        """
+        Returns detailed information for a specific agent.
+        """
+        if not self.simulation or not self.simulation.world_state:
+            return None
+
+        agent = self.simulation.world_state.agents.get(agent_id)
+        if not agent:
+            return None
+
+        return self._map_to_detail_dto(agent)
+
+    def _map_to_basic_dto(self, agent: Any) -> Optional[AgentBasicDTO]:
+        try:
+            if isinstance(agent, Household):
+                return AgentBasicDTO(
+                    id=agent.id,
+                    type="household",
+                    wealth=agent.total_wealth,
+                    income=agent.labor_income_this_tick,
+                    expense=agent._econ_state.consumption_expenditure_this_tick_pennies
+                )
+            elif isinstance(agent, Firm):
+                # Calculate total expense for this tick across all currencies (simplified sum for visualization)
+                expense = sum(agent.finance_state.expenses_this_tick.values())
+                # Calculate total revenue for this turn
+                income = sum(agent.finance_state.revenue_this_turn.values())
+
+                return AgentBasicDTO(
+                    id=agent.id,
+                    type="firm",
+                    wealth=agent.total_wealth,
+                    income=int(income),
+                    expense=int(expense)
+                )
+        except Exception as e:
+            logger.warning(f"Failed to map agent {agent.id} to basic DTO: {e}")
+            return None
+        return None
+
+    def _map_to_detail_dto(self, agent: Any) -> Optional[AgentDetailDTO]:
+        basic = self._map_to_basic_dto(agent)
+        if not basic:
+            return None
+
+        try:
+            if isinstance(agent, Household):
+                return AgentDetailDTO(
+                    **basic.model_dump(),
+                    is_active=agent.is_active,
+                    age=agent.age,
+                    needs=agent._bio_state.needs,
+                    inventory=agent.inventory,
+                    employer_id=agent.employer_id,
+                    current_wage=agent.current_wage
+                )
+            elif isinstance(agent, Firm):
+                return AgentDetailDTO(
+                    **basic.model_dump(),
+                    is_active=agent.is_active,
+                    sector=agent.sector,
+                    employees_count=len(agent.hr_state.employees),
+                    production=agent.current_production,
+                    revenue_this_turn=agent.finance_state.revenue_this_turn,
+                    expenses_this_tick=agent.finance_state.expenses_this_tick
+                )
+        except Exception as e:
+            logger.warning(f"Failed to map agent {agent.id} to detail DTO: {e}")
+            return None
+
+        return None
diff --git a/tests/unit/modules/watchtower/test_agent_service.py b/tests/unit/modules/watchtower/test_agent_service.py
new file mode 100644
index 00000000..b222bb54
--- /dev/null
+++ b/tests/unit/modules/watchtower/test_agent_service.py
 @@ -0,0 +1,138 @@
+import pytest
+from unittest.mock import MagicMock
+from simulation.orchestration.agent_service import AgentService
+from simulation.core_agents import Household
+from simulation.firms import Firm
+from modules.simulation.api import IAgent
+
+# Helper to attach attributes to mock since spec=Class prevents setting new attributes
+def create_mock_household(id):
+    h = MagicMock(spec=Household)
+    h.id = id
+    h.is_active = True
+    h.total_wealth = 5000
+    h.labor_income_this_tick = 200
+
+    # Mocking internal state objects
+    econ = MagicMock()
+    econ.consumption_expenditure_this_tick_pennies = 150
+    h._econ_state = econ
+
+    bio = MagicMock()
+    bio.needs = {"food": 0.5}
+    h._bio_state = bio
+
+    h.inventory = {"apple": 2}
+    h.employer_id = 201
+    h.current_wage = 1000
+    h.age = 30
+
+    return h
+
+def create_mock_firm(id):
+    f = MagicMock(spec=Firm)
+    f.id = id
+    f.is_active = True
+    f.total_wealth = 10000
+
+    fin = MagicMock()
+    fin.revenue_this_turn = {"USD": 500}
+    fin.expenses_this_tick = {"USD": 300}
+    f.finance_state = fin
+
+    hr = MagicMock()
+    hr.employees = [MagicMock(), MagicMock()]
+    f.hr_state = hr
+
+    f.sector = "FOOD"
+    f.current_production = 50.0
+
+    return f
+
+ @pytest.fixture
+def mock_simulation():
+    sim = MagicMock()
+    sim.world_state = MagicMock()
+    return sim
+
+ @pytest.fixture
+def agent_service(mock_simulation):
+    return AgentService(mock_simulation)
+
+def test_get_agents_basic_empty(agent_service, mock_simulation):
+    mock_simulation.world_state.agents = {}
+    result = agent_service.get_agents_basic()
+    assert result == []
+
+def test_get_agents_basic_household(agent_service, mock_simulation):
+    household = create_mock_household(101)
+    mock_simulation.world_state.agents = {101: household}
+
+    result = agent_service.get_agents_basic()
+    assert len(result) == 1
+    dto = result[0]
+    assert dto.id == 101
+    assert dto.type == "household"
+    assert dto.wealth == 5000
+    assert dto.income == 200
+    assert dto.expense == 150
+
+def test_get_agents_basic_firm(agent_service, mock_simulation):
+    firm = create_mock_firm(201)
+    mock_simulation.world_state.agents = {201: firm}
+
+    result = agent_service.get_agents_basic()
+    assert len(result) == 1
+    dto = result[0]
+    assert dto.id == 201
+    assert dto.type == "firm"
+    assert dto.wealth == 10000
+    assert dto.income == 500
+    assert dto.expense == 300
+
+def test_get_agents_basic_inactive(agent_service, mock_simulation):
+    agent = create_mock_household(101)
+    agent.is_active = False
+
+    mock_simulation.world_state.agents = {101: agent}
+
+    result = agent_service.get_agents_basic()
+    assert len(result) == 0
+
+def test_get_agents_basic_limit(agent_service, mock_simulation):
+    agents = {}
+    for i in range(10):
+        agents[i] = create_mock_household(i)
+
+    mock_simulation.world_state.agents = agents
+
+    result = agent_service.get_agents_basic(limit=5)
+    assert len(result) == 5
+
+def test_get_agent_detail_household(agent_service, mock_simulation):
+    household = create_mock_household(101)
+    mock_simulation.world_state.agents = {101: household}
+
+    result = agent_service.get_agent_detail(101)
+    assert result is not None
+    assert result.id == 101
+    assert result.age == 30
+    assert result.needs == {"food": 0.5}
+    assert result.inventory == {"apple": 2}
+    assert result.current_wage == 1000
+
+def test_get_agent_detail_firm(agent_service, mock_simulation):
+    firm = create_mock_firm(201)
+    mock_simulation.world_state.agents = {201: firm}
+
+    result = agent_service.get_agent_detail(201)
+    assert result is not None
+    assert result.id == 201
+    assert result.sector == "FOOD"
+    assert result.employees_count == 2
+    assert result.production == 50.0
+
+def test_get_agent_detail_not_found(agent_service, mock_simulation):
+    mock_simulation.world_state.agents = {}
+    result = agent_service.get_agent_detail(999)
+    assert result is None
diff --git a/tests/verify_agents_api.py b/tests/verify_agents_api.py
new file mode 100644
index 00000000..91616d40
--- /dev/null
+++ b/tests/verify_agents_api.py
 @@ -0,0 +1,86 @@
+import sys
+import os
+import time
+import subprocess
+import requests
+import websocket
+import json
+import signal
+
+def main():
+    # Start server
+    print("Starting server...")
+    server_process = subprocess.Popen(
+        [sys.executable, "server.py"],
+        stdout=subprocess.PIPE,
+        stderr=subprocess.PIPE,
+        text=True
+    )
+
+    try:
+        # Wait for server to be ready
+        print("Waiting for server to be ready...")
+        max_retries = 30
+        server_ready = False
+        for i in range(max_retries):
+            try:
+                resp = requests.get("http://localhost:8000/")
+                if resp.status_code == 200:
+                    server_ready = True
+                    break
+            except requests.exceptions.ConnectionError:
+                pass
+            time.sleep(1)
+            print(f"Retrying connection... {i+1}/{max_retries}")
+
+        if not server_ready:
+            print("Server failed to start.")
+            stdout, stderr = server_process.communicate(timeout=5)
+            print("STDOUT:", stdout)
+            print("STDERR:", stderr)
+            sys.exit(1)
+
+        print("Server is ready.")
+
+        # Test WebSocket
+        print("Testing WebSocket /ws/agents...")
+        ws = websocket.create_connection("ws://localhost:8000/ws/agents")
+        result = ws.recv()
+        data = json.loads(result)
+        ws.close()
+
+        print(f"Received {len(data)} agents from WebSocket.")
+        if len(data) == 0:
+            print("Warning: No agents received. Simulation might be empty or initializing.")
+        else:
+            first_agent = data[0]
+            print("First Agent Basic DTO:", first_agent)
+
+            # Test API
+            agent_id = first_agent['id']
+            print(f"Testing API /api/agents/{agent_id}...")
+            resp = requests.get(f"http://localhost:8000/api/agents/{agent_id}")
+            if resp.status_code == 200:
+                detail = resp.json()
+                print("Agent Detail DTO received successfully.")
+                print("Keys:", detail.keys())
+            else:
+                print(f"Failed to fetch agent details. Status: {resp.status_code}")
+                print(resp.text)
+                sys.exit(1)
+
+    except Exception as e:
+        print(f"Verification failed: {e}")
+        # Print server logs if possible
+        # server_process.terminate()
+        # stdout, stderr = server_process.communicate()
+        # print("Server Output:\n", stdout)
+        # print("Server Error:\n", stderr)
+        sys.exit(1)
+    finally:
+        print("Stopping server...")
+        server_process.terminate()
+        server_process.wait()
+
+if __name__ == "__main__":
+    main()
diff --git a/verification/debug.png b/verification/debug.png
new file mode 100644
index 00000000..8325df71
Binary files /dev/null and b/verification/debug.png differ
diff --git a/verification/debug_v3.png b/verification/debug_v3.png
new file mode 100644
index 00000000..fb8dd71f
Binary files /dev/null and b/verification/debug_v3.png differ
diff --git a/verification/failure.png b/verification/failure.png
new file mode 100644
index 00000000..0c058650
Binary files /dev/null and b/verification/failure.png differ
diff --git a/verification/failure_v2.png b/verification/failure_v2.png
new file mode 100644
index 00000000..e0a6b790
Binary files /dev/null and b/verification/failure_v2.png differ
diff --git a/verification/verify_macro_canvas.py b/verification/verify_macro_canvas.py
new file mode 100644
index 00000000..58769f2b
--- /dev/null
+++ b/verification/verify_macro_canvas.py
 @@ -0,0 +1,71 @@
+import os
+import time
+from playwright.sync_api import sync_playwright, expect
+
+def test_macro_canvas(page):
+    # Capture console logs
+    page.on("console", lambda msg: print(f"BROWSER CONSOLE: {msg.text}"))
+
+    print("Navigating to app...")
+    page.goto("http://localhost:5173")
+
+    # Wait for Macro Canvas to load
+    print("Waiting for Macro Canvas...")
+    expect(page.get_by_text("Macro Canvas")).to_be_visible(timeout=10000)
+
+    # Wait for connection indicator
+    print("Waiting for connection...")
+    expect(page.get_by_text("Agents Live")).to_be_visible(timeout=30000)
+
+    # Wait for scatter plot to render points
+    print("Waiting for scatter points...")
+    time.sleep(5) # Give some time for rendering
+
+    # Count svg elements
+    svgs = page.locator("svg")
+    print(f"Found {svgs.count()} SVGs.")
+
+    # Count paths and circles
+    paths = page.locator("path")
+    circles = page.locator("circle")
+    print(f"Found {paths.count()} paths.")
+    print(f"Found {circles.count()} circles.")
+
+    # Try to find symbols
+    symbols = page.locator(".recharts-scatter-symbol")
+    count = symbols.count()
+    print(f"Found {count} .recharts-scatter-symbol elements.")
+
+    if count == 0:
+        # Dump HTML of chart area
+        chart = page.locator(".recharts-responsive-container")
+        if chart.count() > 0:
+            print("Chart HTML:", chart.inner_html())
+        else:
+            print("Chart container not found.")
+
+    # Take debug screenshot
+    os.makedirs("verification", exist_ok=True)
+    page.screenshot(path="verification/debug_v3.png")
+
+    if count > 0:
+        print("Clicking a scatter point...")
+        symbols.first.click()
+
+        # Verify Inspector Panel
+        print("Verifying Inspector Panel...")
+        expect(page.locator("h3").filter(has_text="#")).to_be_visible()
+    else:
+        print("No points found to click!")
+        raise Exception("No scatter points found")
+
+if __name__ == "__main__":
+    with sync_playwright() as p:
+        browser = p.chromium.launch(headless=True)
+        page = browser.new_page()
+        try:
+            test_macro_canvas(page)
+        except Exception as e:
+            print(f"Test failed: {e}")
+        finally:
+            browser.close()

```

File: design\1_governance\architecture\standards\INDEX.md
```
# âš–ï¸ Architectural Standards Index

Welcome to the central repository of architectural rules and coding patterns for the Economics simulation. These standards ensure the integrity, testability, and scalability of our "Living Digital Economy".

---

## ğŸ›ï¸ 1. Design Patterns
- **[SEO_PATTERN.md](./SEO_PATTERN.md)**: Stateless Engine & Orchestrator. The foundational logic/state separation.
- **[FINANCIAL_INTEGRITY.md](./FINANCIAL_INTEGRITY.md)**: The Penny Standard, Double-Entry rules, and Zero-Sum enforcement.

## ğŸ”Œ 2. Infrastructure & Lifecycle
- **[LIFECYCLE_HYGIENE.md](./LIFECYCLE_HYGIENE.md)**: Tick sequencing, Late-Reset principle, and state transition safety.
- **[TESTING_STABILITY.md](./TESTING_STABILITY.md)**: Mock Purity, Golden Fixtures, and library-less environment stability.

## âš¡ 3. Performance Optimization
- **Iterator Efficiency**: When combining large sequences (e.g., `Transaction` lists), prefer `itertools.chain` over list concatenation (`+`) to save memory/CPU.

---

## ğŸš€ How to use these Standards
1. **In Specs**: Reference the specific standard file (e.g., "Must follow [SEO_PATTERN.md]") in the design principles section.
2. **In Reviews**: Use these files as criteria for checking `Hard-Fail` violations.
3. **In Audits**: Map violations back to the specific standard IDs defined in these documents.
```

File: design\1_governance\architecture\standards\TESTING_STABILITY.md
```
# ğŸ§ª Testing Standard: Integrity & Stability

## ğŸ” Context
Test failures in isolated/lean environments often stem from brittle mocks and library dependencies that drift from production code.

---

## ğŸ›¡ï¸ Hard Rules

### 1. Mock Purity (Preventing MagicMock Poisoning)
- **Primitive Injection is Mandatory**: When mocking objects or their sub-states (e.g., `agent.social_state`), you MUST configure the mock to return primitive values (int, float, bool, str) for any attributes that will be accessed. By default, a `MagicMock` returns another `MagicMock`, which is not serializable.
  - **WRONG (CRITICAL VIOLATION)**: `h = MagicMock()` -> `h.social_state.conformity` returns another `MagicMock`. This will crash any system that creates a DTO from this agent.
  - **RIGHT**: `h.social_state.conformity = 0.5`.
- **Serialization Check**: Any mock that will be passed into a `get_state_dto()` call, logged, or persisted MUST be configured to respond with serializable types for all accessed attributes.

### 2. Golden Fixture Priority
- **Prefer Real State**: Test logic MUST prefer loading a "Golden Sample" (a serialized snapshot of a real agent state) over manual `MagicMock` construction for complex objects like `Firm` or `Household`. Manual mocks are brittle and cause "Test Mock Drift" as production code evolves.
- **Standard Fixtures**: Use the pre-defined fixtures `golden_households`, `golden_firms`, and `golden_ledger` from `conftest.py` whenever possible.
- **Mock Factories**: If a custom mock is unavoidable, it should be generated via a dedicated Factory function that ensures all necessary attributes and DTO-related fields are populated with correct primitive types.

### 3. External Dependency Faking
- **Fake Objects**: For complex libraries like `numpy` or `yaml`, use specialized "Fake" classes (e.g., `FakeNumpy`) that implement the minimal interface with primitive return values.

### 4. Protocol Compliance
- **Strict Mocking**: Always create mocks with `spec=IProtocol` (e.g., `MagicMock(spec=IFinancialEntity)`) to ensure the mock fails immediately if the underlying interface changes. This prevents "Mock Drift" where tests pass against an outdated API.

### 5. Test Collection & Packaging
- **Explicit Packages**: All subdirectories within `tests/` MUST contain an `__init__.py` file to be recognized as proper Python packages. This prevents `import file mismatch` errors and namespace collisions during test collection.
- **Unique Test Filenames**: Test files should be named uniquely across the entire project (e.g., `test_service_unit.py` vs `test_service_int.py`) to avoid conflicts when `pytest` collects tests from multiple directories.
- **Absolute Path Resolution**: Code that loads configuration files or resources (e.g., `SchemaLoader`) MUST resolve paths relative to `__file__` using `pathlib.Path`, rather than relying on `os.getcwd()` or relative paths. This ensures tests run correctly regardless of the execution context.

---

## ğŸš¨ Violations
- **Severity: High**: Tests failing with `MagicMock is not JSON serializable`.
- **Severity: Medium**: Over-mocking that hides real logic drift between Agents and DTOs.

```

File: design\1_governance\architecture\ARCH_TESTS.md
```
# Unit Test Architecture & Cleanup Campaign Reference

## Executive Summary
This document provides a comprehensive and up-to-date overview of the unit test architecture within the `tests/unit/` directory. The test suite is extensive, but its structure has grown organically, leading to many misplaced files and inconsistent testing patterns. This analysis serves as a master reference to guide the ongoing effort to clean up, restructure, and improve the unit tests for better maintainability and clarity.

## 1. Structural Analysis of Test Failures
Recent test failures (e.g., `TypeError`, `AttributeError`, `Dataclass` issues) are primarily symptoms of a large-scale architectural refactoring. The core reasons are:

- **Constructor Mismatches**: The most common failure is a `TypeError` on `Household.__init__()` and `Firm.__init__()`. Tests are using outdated constructor signatures (e.g., passing `id=...`). The new architecture requires `core_config: AgentCoreConfigDTO` and `engine: IDecisionEngine` arguments, which are missing in dozens of test setups.
- **DTO/State Object Transition**: The codebase has migrated from direct object attribute manipulation (e.g., `agent.assets = 100`) to using nested, often immutable, Data Transfer Objects (DTOs) (e.g., `EconStateDTO`). Tests written for the old architecture fail with `AttributeError` when they try to access or set attributes that now reside within a DTO (e.g., `context.state.econ_state.wallet`).
- **Inconsistent/Incomplete Mocking**: Mocks are frequently not updated to reflect new realities. This leads to `AttributeError` when a test tries to access a newly added attribute on an old mock (e.g., a mock `config` object missing `profit_history_ticks`). It also causes `TypeError` when a `MagicMock` returns another mock instead of a primitive value (e.g., comparing a mock to an `int`).
- **Component-Based Refactoring**: Logic is being moved from large agent classes (e.g., `Household`) into smaller, focused components or managers (e.g., `ConsumptionManager`, `LifecycleComponent`). Tests targeting the old agent methods are now obsolete or fail because the logic has moved.
- **API and Protocol Drift**: Method signatures in interfaces (Protocols) have changed (e.g., `withdraw()` now requires a `currency` keyword argument), but test mocks have not been updated, causing `TypeError` on keyword arguments.
- **SSoT Balance Verification (Critical)**: Following "Dual-Write Elimination," tests MUST NOT assert against `Agent.assets`. All balance checks must query the `SettlementSystem` SSoT (e.g., `settlement_system.get_balance(agent.id)`). Failure to do so leads to `TD-TEST-SSOT-SYNC` debt.

## 2. Module-to-Source Mapping & Relocation Plan

The following table maps each unit test file to its source module and provides a **Target Path** for the recommended restructuring. Files in the `tests/unit` root are the highest priority for relocation.

| Current Test Path | Source Module Tested | Recommended Target Path |
| :--- | :--- | :--- |
| `tests/unit/factories.py` | _Test Helper/Factory_ | `tests/unit/helpers/factories.py` |
| `tests/unit/test_ai_driven_firm_engine.py` | `simulation/decisions/ai_driven_firm_engine.py` | `tests/unit/simulation/decisions/test_ai_driven_firm_engine.py` |
| `tests/unit/test_ai_training_manager.py` | `simulation/ai/ai_training_manager.py` | `tests/unit/simulation/ai/test_ai_training_manager.py` |
| `tests/unit/test_api_extensions.py` | `simulation/viewmodels/economic_indicators_viewmodel.py` | `tests/unit/simulation/viewmodels/test_economic_indicators_viewmodel.py` |
| `tests/unit/test_api_history.py` | _N/A (Placeholder)_ | _(Remove or Implement)_ |
| `tests/unit/test_bank.py` | `simulation/bank.py` | `tests/unit/simulation/test_bank.py` |
| `tests/unit/test_bank_decomposition.py` | `simulation/bank.py` | `tests/unit/simulation/test_bank.py` (Merge) |
| `tests/unit/test_config_parity.py` | `config.py`, `simulation/utils/config_factory.py` | `tests/unit/utils/test_config_parity.py` |
| `tests/unit/test_consumption_manager_survival.py` | `simulation/decisions/household/consumption_manager.py` | `tests/unit/modules/household/test_consumption_manager.py` (Merge) |
| `tests/unit/test_diagnostics.py` | `simulation/world_state.py` | `tests/unit/simulation/test_world_state_diagnostics.py` |
| `tests/unit/test_factories.py` | `simulation/orchestration/factories.py` | `tests/unit/simulation/orchestration/test_factories.py` |
| `tests/unit/test_firms.py` | `simulation/firms.py` | `tests/unit/simulation/agents/test_firm.py` |
| `tests/unit/test_firm_profit.py` | `simulation/firms.py` | `tests/unit/simulation/agents/test_firm.py` (Merge) |
| `tests/unit/test_handlers_fix.py` | `simulation/systems/handlers/*` | `tests/unit/simulation/systems/handlers/` (Distribute) |
| `tests/unit/test_household_ai.py` | `simulation/ai/household_ai.py` | `tests/unit/simulation/ai/test_household_ai.py` |
| `tests/unit/test_household_decision_engine_new.py`| `simulation/decisions/ai_driven_household_engine.py` | `tests/unit/simulation/decisions/household/test_ai_driven_household_engine.py` (Merge) |
| `tests/unit/test_household_refactor.py` | `simulation/core_agents.py` (`Household`) | `tests/unit/simulation/agents/test_household.py` |
| `tests/unit/test_household_system2.py` | `simulation/ai/household_system2.py` | `tests/unit/simulation/ai/test_household_system2.py` |
| `tests/unit/test_learning_tracker.py` | `simulation/ai/learning_tracker.py` | `tests/unit/simulation/ai/test_learning_tracker.py` |
| `tests/unit/test_ledger_manager.py` | `scripts/ledger_manager.py` | `tests/unit/scripts/test_ledger_manager.py` |
| `tests/unit/test_logger.py` | `utils/logger.py` | `tests/unit/utils/test_logger.py` |
| `tests/unit/test_market_adapter.py` | `modules/market/api.py` | `tests/unit/modules/market/test_api.py` |
| `tests/unit/test_marketing_roi.py` | `simulation/firms.py` (Marketing Logic) | `tests/unit/simulation/agents/test_firm.py` (Merge) |
| `tests/unit/test_markets_v2.py` | `simulation/markets/order_book_market.py` | `tests/unit/simulation/markets/test_order_book_market.py` (Merge) |
| `tests/unit/test_monetary_ledger_repayment.py` | `modules/government/components/monetary_ledger.py` | `tests/unit/modules/government/components/test_monetary_ledger.py` |
| `tests/unit/test_phase1_refactor.py` | `simulation/orchestration/phases.py` | `tests/unit/simulation/orchestration/test_phases.py` |
| `tests/unit/test_portfolio_macro.py` | `simulation/decisions/portfolio_manager.py` | `tests/unit/simulation/decisions/test_portfolio_manager.py` |
| `tests/unit/test_real_estate_lien.py` | `simulation/models.py` | `tests/unit/simulation/test_models.py` |
| `tests/unit/test_repository.py` | `simulation/db/repository.py` | `tests/unit/simulation/db/test_repository.py` |
| `tests/unit/test_sensory_purity.py` | `simulation/systems/sensory_system.py` | `tests/unit/simulation/systems/test_sensory_system.py` |
| `tests/unit/test_socio_tech.py` | `simulation/ai/household_ai.py` | `tests/unit/simulation/ai/test_household_ai.py` (Merge) |
| `tests/unit/test_stock_market.py` | `simulation/markets/stock_market.py` | `tests/unit/simulation/markets/test_stock_market.py` |
| `tests/unit/test_taxation_system.py` | `modules/government/taxation/system.py` | `tests/unit/modules/government/taxation/test_system.py` |
| `tests/unit/test_tax_collection.py` | `simulation/agents/government.py` | `tests/unit/simulation/agents/test_government.py` (Merge) |
| `tests/unit/test_tax_incidence.py` | `simulation/engine.py` (Integration) | `tests/unit/simulation/test_engine_integrations.py` |
| `tests/unit/test_transaction_engine.py` | `modules/finance/transaction/engine.py` | `tests/unit/modules/finance/transaction/test_engine.py` |
| `tests/unit/test_transaction_processor.py` | `simulation/systems/transaction_processor.py` | `tests/unit/simulation/systems/test_transaction_processor.py` |
| `tests/unit/test_watchtower_hardening.py` | `simulation/metrics/economic_tracker.py`, `...` | `tests/unit/simulation/metrics/test_economic_tracker.py` |
| `tests/unit/test_wo157_dynamic_pricing.py`| `simulation/components/engines/sales_engine.py` | `tests/unit/simulation/components/engines/test_sales_engine.py` |
| `tests/unit/agents/test_government.py` | `simulation/agents/government.py` | `tests/unit/simulation/agents/test_government.py` (Merge) |
| `tests/unit/components/test_agent_lifecycle.py`| `simulation/components/agent_lifecycle.py` | `tests/unit/simulation/components/test_agent_lifecycle.py` |
| `tests/unit/components/test_demographics_component.py`| `simulation/components/demographics_component.py` | `tests/unit/simulation/components/test_demographics_component.py` |
| `tests/unit/components/test_market_component.py`| `simulation/components/market_component.py` | `tests/unit/simulation/components/test_market_component.py` |
| `tests/unit/corporate/*` | `simulation/decisions/firm/*` | `tests/unit/simulation/decisions/firm/` (Relocate files) |
| `tests/unit/decisions/*` | `simulation/decisions/*` | `tests/unit/simulation/decisions/` (Relocate files) |
| `tests/unit/finance/call_market/test_service.py`| `modules/finance/call_market/service.py` | `tests/unit/modules/finance/call_market/test_service.py` |
| `tests/unit/finance/test_bank_service_interface.py`| `simulation/bank.py`, `modules/finance/api.py` | `tests/unit/modules/finance/test_bank_service_interface.py` |
| `tests/unit/finance/test_credit_scoring.py` | `modules/finance/credit_scoring.py` | `tests/unit/modules/finance/test_credit_scoring.py` |
| `tests/unit/finance/test_finance_system_refactor.py`| `modules/finance/system.py` | `tests/unit/modules/finance/test_system.py` (Merge) |
| `tests/unit/governance/test_judicial_system.py` | `modules/governance/judicial/system.py` | `tests/unit/modules/governance/judicial/test_system.py` |
| `tests/unit/household/engines/*` | `modules/household/engines/*` | `tests/unit/modules/household/engines/` (Relocate files) |
| `tests/unit/household/test_snapshot_assembler.py`| `modules/household/services.py` | `tests/unit/modules/household/test_services.py` |
| `tests/unit/markets/*` | `simulation/markets/*`, `modules/market/*` | `tests/unit/simulation/markets/` & `tests/unit/modules/market/` |
| `tests/unit/modules/analysis/test_bubble_observatory.py`| `modules/analysis/bubble_observatory.py` | (No change) |
| `tests/unit/modules/common/config/test_impl.py` | `modules/common/config/impl.py` | (No change) |
| `tests/unit/modules/common/config_manager/test_config_manager.py` | `modules/common/config_manager/impl.py` | (No change) |
| `tests/unit/modules/finance/central_bank/test_cb_service.py` | `modules/finance/central_bank/service.py` | (No change) |
| `tests/unit/modules/finance/*` | `modules/finance/*` | (Distribute files) |
| `tests/unit/modules/government/components/*` | `modules/government/components/*` | (No change) |
| `tests/unit/modules/government/*` | `modules/government/*` | (Distribute files) |
| `tests/unit/modules/household/*` | `modules/household/*` | (No change) |
| `tests/unit/modules/memory/test_memory_v2.py` | `modules/memory/V2/*` | (No change) |
| `tests/unit/modules/system/execution/*` | `modules/system/execution/*` | (No change) |
| `tests/unit/orchestration/*` | `simulation/orchestration/*` | `tests/unit/simulation/orchestration/` (Relocate files) |
| `tests/unit/sagas/test_orchestrator.py` | `modules/finance/sagas/orchestrator.py` | `tests/unit/modules/finance/sagas/test_orchestrator.py` |
| `tests/unit/systems/handlers/*` | `simulation/systems/handlers/*`, `modules/market/handlers/*`| (Distribute files) |
| `tests/unit/systems/*` | `simulation/systems/*` | `tests/unit/simulation/systems/` (Relocate files) |
| `tests/unit/utils/test_config_factory.py` | `simulation/utils/config_factory.py` | `tests/unit/simulation/utils/test_config_factory.py` |

## 3. Coverage Gaps
Based on the comprehensive file review, the following source modules still appear to be **untested or undertested**:

- **`modules/analytics/`**: Core analytics logic and services.
- **`modules/events/`**: DTOs and event definitions.
- **`modules/hr/`**: The main HR service and components.
- **`modules/housing/`**: The `modules/housing` directory exists but has no tests.
- **`modules/inventory/`**: The core inventory management logic.
- **`modules/memory/`**: V1 of the memory system.
- **`modules/simulation/`**: The API/DTOs module itself lacks specific validation tests.
- **`scripts/`**: Most scripts are untested, with the exception of `ledger_manager.py`.

## 4. Test File Count by Domain
The test suite is heavily focused on `systems`, `decisions`, `agents`, and `finance`.

| Domain | Test File Count | Notes |
| :--- | :--- | :--- |
| **Agents & Core (`simulation`)** | ~10 | `test_firms`, `test_household_refactor`, `test_bank`, etc. |
| **AI & Decisions (`simulation`)** | ~25 | `test_ai_*`, `decisions/*`, `corporate/*`. High volume, needs consolidation. |
| **Finance (`modules`)** | ~11 | `finance/*`, `modules/finance/*`, `sagas/*`. |
| **Government (`modules`)** | ~6 | `test_government`, `modules/government/*`, etc. |
| **Household (`modules`)** | ~10 | `household/*`, `modules/household/*`. |
| **Systems (`simulation`/`modules`)** | ~30+ | `systems/*`, `test_transaction_processor`, etc. Largest category. |
| **Markets (`simulation`/`modules`)** | ~7 | `test_markets*`, `test_stock_market`, etc. |
| **Framework/Utils** | ~10 | `test_logger`, `test_repository`, `factories.py`, `mocks`, etc. |
| **Total** | **~100+** | Some files test multiple domains. |

## 5. Recommended Restructuring
The current structure, with a majority of files in the `tests/unit` root, is difficult to navigate. The presence of subdirectories like `agents/` and `modules/` is a good start, but this organization must be completed to mirror the source code.

**Recommendation:** Strictly mirror the `modules/` and `simulation/` source code structure within `tests/unit/`.

### Proposed `tests/unit/` Structure:
```
tests/unit/
â”œâ”€â”€ simulation/
â”‚   â”œâ”€â”€ ai/
â”‚   â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ decisions/
â”‚   â”‚   â”œâ”€â”€ household/
â”‚   â”‚   â””â”€â”€ firm/
â”‚   â”œâ”€â”€ markets/
â”‚   â”œâ”€â”€ orchestration/
â”‚   â”œâ”€â”€ systems/
â”‚   â”‚   â””â”€â”€ handlers/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ analysis/
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ config_manager/
â”‚   â”œâ”€â”€ finance/
â”‚   â”‚   â”œâ”€â”€ call_market/
â”‚   â”‚   â”œâ”€â”€ central_bank/
â”‚   â”‚   â””â”€â”€ sagas/
â”‚   â”œâ”€â”€ governance/
â”‚   â”œâ”€â”€ household/
â”‚   â”‚   â””â”€â”€ engines/
â”‚   â”œâ”€â”€ market/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ scripts/
â””â”€â”€ utils/
```

### Action Items for Cleanup Campaign:

1.  **Create New Directory Structure:** Implement the proposed directory structure in `tests/unit/`.
2.  **Move Existing Tests:** Relocate each test file from its current location to its new **Target Path** as specified in the table above.
3.  **Update Imports:** Adjust relative and absolute imports within the moved test files to ensure they can still find their source modules and helpers.
4.  **Consolidate Duplicates:** Merge tests for the same module into a single, comprehensive file. For example, `test_ai_training_manager.py` and `test_ai_training_manager_new.py` should become one file at `tests/unit/simulation/ai/test_ai_training_manager.py`.
5.  **Address Gaps:** Begin creating new test files for the untested modules identified in the "Coverage Gaps" section, placing them in the correct new directory from the start.
6.  **Review Skipped Tests:** Systematically review tests marked with ` @pytest.mark.skip` or ` @unittest.skip`. Determine if they are obsolete and can be deleted, or if they need to be updated to test the new DTO-based, component-driven architecture.
```

```

File: design\1_governance\architecture\standards\LIFECYCLE_HYGIENE.md
```
# â±ï¸ Infrastructure Standard: Lifecycle Hygiene

## ğŸ” Context
Deterministic outcomes rely on strict sequencing of events within a simulation tick.

---

## ğŸ›¡ï¸ Hard Rules

### 1. The Late-Reset Principle
- **Counter Persistence**: "Tick-Level" metrics (e.g., `revenue_this_tick`, `expenses_this_tick`) MUST persist through all active simulation phases (transaction generation, learning, etc.) until the end of the tick.
- **Designated Reset Phase**: Resetting of tick-level counters MUST only occur in a designated final phase, such as `Post-Sequence` or `EndOfTick`.
- **Anti-Pattern (Forbidden)**: Resetting counters inside the `generate_transactions` phase or any mid-tick agent logic is a CRITICAL violation. This leads to data loss for analytics, logging, and learning systems operating in later phases of the same tick.

### 2. Birth/Death Atomicity
- **Registry Sync**: When an agent is born or dies, the `AgentRepository`, `SettlementSystem`, and `DemographicManager` MUST be updated atomically within the same transaction or sequence.
- **Inheritance Cleanup**: Dying agents MUST have their assets completely liquidated or transferred via `InheritanceManager` before the object is purged to prevent monetary leaks.

---

## ğŸš¨ Violations
- **Severity: Medium**: Resetting state counters too early, leading to blind spots in analytics.
- **Severity: High**: "Ghost Agents" remaining in the Registry after death.

```

File: design\1_governance\architecture\ARCH_SEQUENCING.md
```
# Architecture Detail: Phased Orchestration (The Implemented Sequence)

## 1. ê°œìš” (Overview)
ë³¸ ì‹œë®¬ë ˆì´ì…˜ì˜ ëª¨ë“  ìƒíƒœ ë³€ê²½ì€ **êµ¬í˜„ëœ ì‹œí€€ìŠ¤(The Implemented Sequence)**ë¼ ë¶ˆë¦¬ëŠ” ë‹¤ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤ë¥¼ ì—„ê²©íˆ ì¤€ìˆ˜í•©ë‹ˆë‹¤. ì´ëŠ” `tick_orchestrator.py`ì— ì •ì˜ëœ ì‹¤ì œ ì‹¤í–‰ ìˆœì„œë¡œ, ê¸°ì¡´ ì„¤ê³„('The Sacred Sequence')ì—ì„œ ì§„í™”í•œ í˜•íƒœì…ë‹ˆë‹¤. í•µì‹¬ì ì¸ ë³€í™”ëŠ” ê° í˜ì´ì¦ˆ(Phase) ì‹¤í–‰ ì§í›„ ìƒíƒœë¥¼ ì¦‰ì‹œ ë™ê¸°í™”í•˜ëŠ” **"ì‹¤í–‰-ë™ê¸°í™”(Execute-Sync)"** ë£¨í”„ë¥¼ ë„ì…í•˜ì—¬, ìƒíƒœ ë³€ê²½ì˜ ì›ìì„±ê³¼ ì˜ˆì¸¡ ê°€ëŠ¥ì„±ì„ ìƒˆë¡œìš´ ë°©ì‹ìœ¼ë¡œ ë³´ì¥í•©ë‹ˆë‹¤.

## 2. ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ (Sequence Diagram)
```mermaid
graph TD
    subgraph TickOrchestrator [The Conductor: Execute-Sync Loop]
        direction LR
        
        Start[Tick Start] --> P0[Pre-Sequence]
        P0 --> P_PROD[Production]
        P_PROD --> P1[Decision]
        P1 --> P4_BANKRUPTCY[Lifecycle: Bankruptcy]
        P4_BANKRUPTCY --> P4_HOUSING[Lifecycle: Housing Saga]
        P4_HOUSING --> P4_LIQUIDATION[Lifecycle: Systemic Liquidation]
        P4_LIQUIDATION --> P2[Matching]
        P2 --> P3_SUB_DEBT[Tx-Decomposition: Bank & Debt]
        P3_SUB_DEBT --> P3_SUB_PROD[Tx-Decomposition: Firm Prod & Salaries]
        P3_SUB_PROD --> P3_SUB_GOV[Tx-Decomposition: Gov Programs]
        P3_SUB_GOV --> P3_SUB_TAX[Tx-Decomposition: Taxation Intents]
        P3_SUB_TAX --> P3_SUB_MONETARY[Tx-Decomposition: Monetary Processing]
        P3_SUB_MONETARY --> P3_FINAL[Transaction: Final Settlement]
        P3_FINAL --> P_CONSUMPTION[Lifecycle: Consumption]
        P_CONSUMPTION --> P5[Post-Sequence]
        P5 --> End[Tick End]
        
        %% Styling
        style Start fill:#f9f,stroke:#333,stroke-width:2px
        style P4_BANKRUPTCY fill:#ff9,stroke:#333,stroke-width:4px
        style P2 fill:#ccf,stroke:#333,stroke-width:2px
        style End fill:#f9f,stroke:#333,stroke-width:2px
    end
```

## 3. ìƒì„¸ ë‹¨ê³„ ì„¤ëª… (Detailed Phase Descriptions)

**í•µì‹¬ ë³€ê²½ì **: ê° í˜ì´ì¦ˆëŠ” `SimulationState` DTOë¥¼ ìˆ˜ì •í•˜ë©°, í˜ì´ì¦ˆ ì¢…ë£Œ ì§í›„ `_drain_and_sync_state` ë©”ì„œë“œê°€ í˜¸ì¶œë˜ì–´ ë³€ê²½ ì‚¬í•­(`effects_queue`, `transactions` ë“±)ì„ ì¦‰ì‹œ `WorldState`ì— ë°˜ì˜í•©ë‹ˆë‹¤. í˜ì´ì¦ˆëŠ” ë” ì´ìƒ ìˆœìˆ˜ í•¨ìˆ˜(Pure Function)ê°€ ì•„ë‹ˆë©°, ì‹¤í–‰ ì¦‰ì‹œ ì „ì—­ ìƒíƒœì— ì˜í–¥ì„ ë¯¸ì¹©ë‹ˆë‹¤.

### Phase 0: ì „ì²˜ë¦¬ (Preprocessing)
- **Actor**: `Phase0_PreSequence`
- **Action**: ì‹œìŠ¤í…œ ì•ˆì •í™”, ì˜ˆì •ëœ ì´ë²¤íŠ¸ ì‹¤í–‰, ì´ˆê¸° ìƒíƒœ ìŠ¤ëƒ…ìƒ· ì €ì¥.

### Phase 0.5: ìƒì‚° (Production)
- **Actor**: `Phase_Production`
- **Action**: ì‹¤ë¬¼ ì¬í™” ìƒì‚°ëŸ‰ì„ ê²°ì •í•©ë‹ˆë‹¤. ì´ëŠ” ì—ì´ì „íŠ¸ë“¤ì´ ì˜ì‚¬ê²°ì •ì„ ë‚´ë¦¬ê¸° ì „ì— ì‹œì¥ì˜ ì´ ê³µê¸‰ëŸ‰ì„ í™•ì •í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.

### Phase 1: ê²°ì • (Decisions)
- **Actor**: `Phase1_Decision`
- **Action**: ëª¨ë“  ì—ì´ì „íŠ¸(ê°€ê³„, ê¸°ì—… ë“±)ê°€ í˜„ì¬ ì‹œì¥ ìƒíƒœë¥¼ ê¸°ë°˜ìœ¼ë¡œ í–‰ë™(`Order`, `Intent`)ì„ ê²°ì •í•©ë‹ˆë‹¤.

### Phase 4 (Reordered): ë¼ì´í”„ì‚¬ì´í´ Part 1 (Lifecycle)
- **Actor**: `Phase_Bankruptcy`, `Phase_HousingSaga`, `Phase_SystemicLiquidation`
- **Action**: íŒŒì‚°, ì£¼íƒë‹´ë³´ëŒ€ì¶œ ì—°ì²´ ì²˜ë¦¬ ë“± ì—ì´ì „íŠ¸ì˜ ìƒì¡´ê³¼ ê´€ë ¨ëœ êµ¬ì¡°ì  ë³€ê²½ì„ **ì‹œì¥ ë§¤ì¹­ ì „ì—** ì²˜ë¦¬í•©ë‹ˆë‹¤.
- **Rationale (Critical)**: ì´ëŠ” ê²½ì œì  í˜„ì‹¤ì„ ë°˜ì˜í•œ ì¤‘ëŒ€í•œ ë³€ê²½ì…ë‹ˆë‹¤. íŒŒì‚°í•œ ì—ì´ì „íŠ¸ëŠ” ì‹œì¥ì— ì°¸ì—¬í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ê·¸ë“¤ì˜ ì£¼ë¬¸(Order)ì€ ë§¤ì¹­ ë‹¨ê³„ ì´ì „ì— ì‹œìŠ¤í…œì—ì„œ ì œê±°ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ê¸°ì¡´ì˜ "ì¸ì§€-ê³„ì•½-ì§‘í–‰" ìˆœì„œëŠ” "ì¸ì§€-**ì •ë¦¬(ì„ ì œì )**-ê³„ì•½-ì§‘í–‰"ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.

### Phase 2: ë§¤ì¹­ (Matching)
- **Actor**: `Phase2_Matching`
- **Action**: ì‚´ì•„ë‚¨ì€ ì—ì´ì „íŠ¸ë“¤ì˜ `Order`ë“¤ì„ ë§¤ì¹­í•˜ì—¬ `Transaction` ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

### Phase 3 (Decomposed): ê±°ë˜ ì²˜ë¦¬ (Transaction Processing)
- **Actors**: `Phase_BankAndDebt`, `Phase_FirmProductionAndSalaries`, `Phase_GovernmentPrograms`, `Phase_TaxationIntents`, `Phase_MonetaryProcessing`, `Phase3_Transaction`
- **Action**: ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP)ì— ë”°ë¼, ê¸°ì¡´ì˜ ê±°ëŒ€í•œ ê±°ë˜(Transaction) í˜ì´ì¦ˆê°€ ì—¬ëŸ¬ ê°œì˜ ì„¸ë¶„í™”ëœ ë‹¨ê³„ë¡œ ë¶„í•´ë˜ì—ˆìŠµë‹ˆë‹¤. ë¶€ì±„ ì²˜ë¦¬, ì„ê¸ˆ ì§€ê¸‰, ì •ë¶€ ì§€ì¶œ, ì„¸ê¸ˆ ì˜í–¥ ìƒì„±, í†µí™” ì •ì±… ë°˜ì˜ ë“±ì´ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ëœ í›„, ë§ˆì§€ë§‰ `Phase3_Transaction`ì—ì„œ ëª¨ë“  ê±°ë˜ê°€ ìµœì¢… ì •ì‚°ë©ë‹ˆë‹¤. ì´ êµ¬ì¡°ëŠ” í™”í ê³µê¸‰ëŸ‰ ê²€ì¦(`MONEY_SUPPLY_CHECK`)ì˜ ì •í™•ì„±ì„ ë³´ì¥í•˜ëŠ” ë° í•„ìˆ˜ì ì…ë‹ˆë‹¤.

### Phase (Late Lifecycle): ì†Œë¹„ (Consumption)
- **Actor**: `Phase_Consumption`
- **Action**: ëª¨ë“  ì†Œë“ê³¼ ì´ì „ì´ í™•ì •ëœ í›„, ìµœì¢…ì ì¸ ì¬í™” ì†Œë¹„ í™œë™ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

### Phase 5: í›„ì²˜ë¦¬ (Post-Sequence)
- **Actor**: `Phase5_PostSequence`
- **Action**: í•™ìŠµ ë³´ìƒ ê³„ì‚°, í†µê³„ ì§€í‘œ ì§‘ê³„, ë‹¤ìŒ í‹±ì„ ìœ„í•œ ë°ì´í„° ì •ë¦¬ ë° ë²„í¼ í”ŒëŸ¬ì‹œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

## 4. ì•„í‚¤í…ì²˜ì  ì˜ì˜ (Architectural Significance)

### 4.1. God Objectì™€ "ì‹¤í–‰-ë™ê¸°í™”" ë£¨í”„ (God Object & The "Execute-Sync" Loop)
ì´ì „ì˜ "DTO í­í¬ìˆ˜" ëª¨ë¸ì€ íê¸°ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì•„í‚¤í…ì²˜ëŠ” `WorldState`ë¼ëŠ” ì¤‘ì•™ ì§‘ì¤‘ì  "God Object"ì™€, ê° í˜ì´ì¦ˆê°€ ìˆ˜ì •í•˜ëŠ” ê°€ë³€ì ì¸ `SimulationState` "God DTO"ì— ì˜ì¡´í•©ë‹ˆë‹¤.

ê°€ì¥ ì¤‘ìš”í•œ ì•„í‚¤í…ì²˜ì  ì œì•½ì€ **`_drain_and_sync_state`** ë©”ì„œë“œì…ë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ” **ëª¨ë“  í˜ì´ì¦ˆ ì‹¤í–‰ ì§í›„ í˜¸ì¶œ**ë˜ì–´, í˜ì´ì¦ˆê°€ ìƒì„±í•œ ì„ì‹œ ë°ì´í„°(ex: `effects_queue`, `transactions`)ë¥¼ `WorldState`ì— ì¦‰ì‹œ ë³‘í•©í•˜ê³  DTOì˜ íë¥¼ ë¹„ì›ë‹ˆë‹¤. ì´ "ì‹¤í–‰-ë™ê¸°í™”" ë£¨í”„ëŠ” í˜ì´ì¦ˆ ê°„ ìƒíƒœ ê³µìœ ì˜ ìƒˆë¡œìš´ 'ê¸°ë³¸ ì§„ì‹¤(Ground Truth)'ì´ë©°, ë” ì´ìƒ ìƒíƒœê°€ í‹±ì˜ ë§ˆì§€ë§‰ì—ë§Œ ì—…ë°ì´íŠ¸ëœë‹¤ê³  ê°€ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

### 4.2. ê²½ì œì  ì¸ê³¼ê´€ê³„ì˜ ì¬ì •ì˜ (Redefined Economic Causality)
'ì‹ ì„±í•œ ì‹œí€€ìŠ¤'ì˜ "ì¸ì§€ â†’ ê³„ì•½ â†’ ì§‘í–‰ â†’ ì •ë¦¬" ì›ì¹™ì€ ë‹¤ìŒê³¼ ê°™ì´ ì¬ì •ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.
**"ì¸ì§€ â†’ ì„ ì œì  ì •ë¦¬(íŒŒì‚°) â†’ ê³„ì•½(ë§¤ì¹­) â†’ ë¶„í•´ëœ ì§‘í–‰(ì„¸ë¶€ ê±°ë˜) â†’ ìµœì¢… ì •ë¦¬(ì†Œë¹„ ë° í›„ì²˜ë¦¬)"**
íŠ¹íˆ, **íŒŒì‚° ì²˜ë¦¬(`Phase_Bankruptcy`)ê°€ ì‹œì¥ ë§¤ì¹­(`Phase2_Matching`)ë³´ë‹¤ ë¨¼ì €** ì˜¤ëŠ” ê²ƒì€ ì‹œìŠ¤í…œì˜ ê²½ì œì  ë…¼ë¦¬ì— ê·¼ë³¸ì ì¸ ë³€í™”ë¥¼ ì˜ë¯¸í•˜ë©°, ëª¨ë“  í…ŒìŠ¤íŠ¸ì™€ ë¶„ì„ì€ ì´ ìƒˆë¡œìš´ ì¸ê³¼ê´€ê³„ë¥¼ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.

### 4.3. "ìˆœê²°ì„± ê²Œì´íŠ¸" ì›ì¹™ì˜ íê¸° (Deprecation of the "Purity Gate")
"Phase 1ì—ì„œëŠ” ìƒíƒœë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ì§€ ì•ŠëŠ”ë‹¤"ëŠ” ê¸°ì¡´ ì›ì¹™ì€ ë” ì´ìƒ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëª¨ë“  í˜ì´ì¦ˆëŠ” `SimulationState` DTOë¥¼ í†µí•´ `WorldState`ì— ì¦‰ì‹œ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ë¶€ìˆ˜ íš¨ê³¼(Side-effect)ë¥¼ ê°€ì§‘ë‹ˆë‹¤. ê° í˜ì´ì¦ˆëŠ” ë…ë¦½ì ì´ê³  ìˆœìˆ˜í•œ í•¨ìˆ˜ê°€ ì•„ë‹ˆë¼, í•˜ë‚˜ì˜ ê±°ëŒ€í•œ íŠ¸ëœì­ì…˜ ë‚´ì˜ ìƒí˜¸ ì˜ì¡´ì ì¸ ë‹¨ê³„ë“¤ë¡œ ì´í•´ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

```

File: modules\system\api.py
```
from __future__ import annotations
from abc import ABC, abstractmethod
from typing import Any, Dict, List, Optional, Protocol, Union, runtime_checkable, TYPE_CHECKING, TypedDict
from dataclasses import dataclass, field
from enum import IntEnum, auto
from pydantic import BaseModel, Field

# Define Currency Code (Usually String "USD")
CurrencyCode = str
DEFAULT_CURRENCY: CurrencyCode = "USD"
AgentID = int

 @dataclass
class MarketContextDTO:
    """
    Context object passed to agents for making decisions.
    Contains strictly external market data (prices, rates, signals).
    """
    market_data: Dict[str, Any]
    market_signals: Dict[str, int]
    tick: int
    # Represents currency exchange rates relative to base currency
    exchange_rates: Optional[Dict[str, float]] = None

 @dataclass(frozen=True)
class MarketSignalDTO:
    market_id: str
    item_id: str
    best_bid: Optional[int]
    best_ask: Optional[int]
    last_traded_price: Optional[int]
    last_trade_tick: int
    price_history_7d: List[int]
    volatility_7d: float
    order_book_depth_buy: int
    order_book_depth_sell: int
    total_bid_quantity: float
    total_ask_quantity: float
    is_frozen: bool

 @dataclass(frozen=True)
class HousingMarketUnitDTO:
    unit_id: str
    price: int
    quality: float
    rent_price: Optional[int] = None

 @dataclass(frozen=True)
class HousingMarketSnapshotDTO:
    for_sale_units: List[HousingMarketUnitDTO]
    units_for_rent: List[HousingMarketUnitDTO]
    avg_rent_price: float
    avg_sale_price: float

 @dataclass(frozen=True)
class LoanMarketSnapshotDTO:
    interest_rate: float

 @dataclass(frozen=True)
class LaborMarketSnapshotDTO:
    avg_wage: float

 @dataclass(frozen=True)
class MarketSnapshotDTO:
    """
    A pure-data snapshot of the state of all markets at a point in time.
    """
    tick: int
    market_signals: Dict[str, MarketSignalDTO]
    market_data: Dict[str, Any]
    housing: Optional[HousingMarketSnapshotDTO] = None
    loan: Optional[LoanMarketSnapshotDTO] = None
    labor: Optional[LaborMarketSnapshotDTO] = None

class AgentBankruptcyEventDTO(TypedDict):
    agent_id: int
    tick: int
    inventory: Dict[str, float]

 @dataclass(frozen=True)
class PublicManagerReportDTO:
    tick: int
    newly_recovered_assets: Dict[str, float]
    liquidation_revenue: Dict[str, int]
    managed_inventory_count: float
    system_treasury_balance: Dict[str, int]

class OriginType(IntEnum):
    """
    Priority Level for Parameter Updates.
    Higher value = Higher Priority.
    """
    SYSTEM = 0          # Internal logic (Hardcoded defaults)
    CONFIG = 10         # Loaded from file (User Configuration)
    USER = 50           # Dashboard/UI manual override
    GOD_MODE = 100      # Absolute override (Scenario Injection)

class RegistryValueDTO(BaseModel):
    """
    Data Transfer Object for Registry Values.
    Replaces the legacy RegistryEntry dataclass.
    """
    key: str
    value: Any
    domain: str = "global"
    origin: OriginType
    is_locked: bool = False
    last_updated_tick: int = 0
    metadata: Dict[str, Any] = Field(default_factory=dict)

# Alias for backward compatibility if needed, but we prefer RegistryValueDTO
RegistryEntry = RegistryValueDTO

class RegistryObserver(Protocol):
    def on_registry_update(self, key: str, value: Any, origin: OriginType) -> None:
        ...

 @runtime_checkable
class IConfigurationRegistry(Protocol):
    """
    Interface for the Global Registry acting as the Single Source of Truth (SSoT)
    for all simulation parameters.
    """

    def get(self, key: str, default: Any = None) -> Any:
        """
        Retrieves a configuration value.
        Must support dynamic resolution (always fetch current value).
        """
        ...

    def set(self, key: str, value: Any, origin: OriginType = OriginType.USER) -> None:
        """
        Updates a configuration value with a specified origin.
        Should trigger any registered listeners for this key.
        """
        ...

    def snapshot(self) -> Dict[str, Any]:
        """
        Returns a complete snapshot of the current configuration state.
        Useful for serialization or debugging.
        """
        ...

    def reset_to_defaults(self) -> None:
        """
        Resets all configuration values to their SYSTEM or CONFIG defaults,
        clearing USER overrides.
        """
        ...

 @runtime_checkable
class IGlobalRegistry(Protocol):
    """
    Interface for the Global Parameter Registry.
    FOUND-01: Centralized Configuration Management.
    """
    def get(self, key: str, default: Any = None) -> Any:
        ...

    def set(self, key: str, value: Any, origin: OriginType = OriginType.CONFIG) -> bool:
        ...

    def lock(self, key: str) -> None:
        ...

    def unlock(self, key: str) -> None:
        ...

    def subscribe(self, observer: RegistryObserver, keys: Optional[List[str]] = None) -> None:
        ...

    def snapshot(self) -> Dict[str, RegistryValueDTO]:
        ...

    def get_metadata(self, key: str) -> Any:
        ...

    def get_entry(self, key: str) -> Optional[RegistryValueDTO]:
        ...

 @runtime_checkable
class IRestorableRegistry(IGlobalRegistry, Protocol):
    """
    Extended interface for Registries that support state restoration/undo operations.
    Required for CommandService rollback functionality.
    """
    def delete_entry(self, key: str) -> bool:
        """
        Removes an entry completely. Used when rolling back a creation.
        Returns True if successful.
        """
        ...

    def restore_entry(self, key: str, entry: RegistryValueDTO) -> bool:
        """
        Restores a specific entry state (value + origin + lock).
        Used when rolling back a modification.
        Returns True if successful.
        """
        ...

 @runtime_checkable
class IProtocolEnforcer(Protocol):
    """
    Interface for test utilities that enforce strict protocol adherence.
    """

    def assert_implements_protocol(self, instance: Any, protocol: Any) -> None:
        """
        Verifies that an instance implements all methods and attributes
        defined in the protocol. Raises AssertionError if not.
        """
        ...

class IAgentRegistry(Protocol):
    def get_agent(self, agent_id: Any) -> Any:
        ...

    def get_all_financial_agents(self) -> List[Any]:
        ...

    def set_state(self, state: Any) -> None:
        ...

 @runtime_checkable
class ICurrencyHolder(Protocol):
    """
    Protocol for agents/systems that hold currency.
    Used for M2 Money Supply calculation.
    """
    def get_balance(self, currency: CurrencyCode = DEFAULT_CURRENCY) -> int:
        ...

    def get_assets_by_currency(self) -> Dict[CurrencyCode, int]:
        ...

class IAssetRecoverySystem(Protocol):
    """
    Interface for the Public Manager acting as a receiver of assets.
    """
    def process_bankruptcy_event(self, event: AgentBankruptcyEventDTO) -> None:
        """
        Ingests assets from a bankrupt agent.
        """
        ...

    def receive_liquidated_assets(self, inventory: Dict[str, float]) -> None:
        """
        Receives inventory from a firm undergoing liquidation (Asset Buyout).
        """
        ...

    def generate_liquidation_orders(self, market_signals: Dict[str, MarketSignalDTO], core_config: Any = None, engine: Any = None) -> List[Any]:
        """
        Generates SELL orders to liquidate managed assets into the market.
        """
        ...

```

File: design\2_operations\ledgers\TECH_DEBT_LEDGER.md
```
# Technical Debt Ledger (TECH_DEBT_LEDGER.md)

| ID | Module / Component | Description | Priority / Impact | Status |
| :--- | :--- | :--- | :--- | :--- |
| **TD-CONF-GHOST-BIND** | Config | **Ghost Constants**: Modules bind config values at import time, preventing runtime hot-swap. | **Medium**: Dynamic Tuning. | **Identified** |
| **TD-TEST-TX-MOCK-LAG** | Testing | **Transaction Test Lag**: `test_transaction_engine.py` mocks are out of sync with `ITransactionParticipant` (overdraft support). | **Low**: Test Flakiness. | **Identified** |
| **TD-INT-BANK-ROLLBACK** | Finance | **Rollback Coupling**: Bank rollback logic dependent on `hasattr` implementation details. | **Low**: Abstraction Leak. | Open |
| **TD-ARCH-DI-SETTLE** | Architecture | **DI Timing**: `AgentRegistry` injection into `SettlementSystem` happens post-initialization. | **Low**: Initialization fragility. | Open |
| **TD-UI-DTO-PURITY** | Cockpit | **Manual Deserialization**: UI uses raw dicts/manual mapping for Telemetry. Needs `pydantic`. | **Medium**: Code Quality. | Open |
| **TD-PROC-TRANS-DUP** | Logic | **Handler Redundancy**: Logic overlap between legacy `TransactionManager` and new `TransactionProcessor`. | **Medium**: Maintenance. | **Resolved** |
| **TD-TRANS-INT-SCHEMA** | Transaction | **Schema Lag**: `Transaction` model (simulation/models.py) still uses `float` price. | **High**: Persistence Drift. | **Resolved** |
| **TD-DEPR-GOV-TAX** | Government | **Legacy API**: `Government.collect_tax` is deprecated. Use `settle_atomic`. | **Low**: Technical Debt. | Open |
| **TD-DEPR-FACTORY** | Factory | **Stale Path**: `agent_factory.HouseholdFactory` is stale. Use `household_factory`. | **Low**: Technical Debt. | Open |
| **TD-DEPR-STOCK-DTO** | Market | **Legacy DTO**: `StockOrder` is deprecated. Use `CanonicalOrderDTO`. | **Low**: Technical Debt. | Open |

---
> [!NOTE]
> âœ… **Resolved Debt History**: For clarity, all resolved technical debt items and historical lessons have been moved to [TECH_DEBT_HISTORY.md](./TECH_DEBT_HISTORY.md).

---

## ğŸ““ Implementation Lessons & Detailed Debt (Open)

---
### ID: TD-CONF-GHOST-BIND
### Title: Ghost Constant Binding (Import Time)
- **Symptom**: `from config import MIN_WAGE` locks the value of `MIN_WAGE` at the moment of import.
- **Risk**: Changing the value in `GlobalRegistry` at runtime (e.g., God Mode) has no effect on modules that already imported the constant.
- **Solution**: Use a `ConfigProxy` or `DynamicConfig` object that resolves values at access time (`config.MIN_WAGE`).

---
### ID: TD-PROC-TRANS-DUP
### Title: Transaction Logic Duplication
- **Symptom**: Similar transaction processing logic exists in `TransactionManager` (Legacy) and `TransactionProcessor` (New).
- **Risk**: Fixes applied to one might not apply to the other, leading to divergent behavior.
- **Solution**: Deprecate `TransactionManager` and route all traffic through `TransactionProcessor`.

```

File: simulation\dtos\api.py
```
from __future__ import annotations
from dataclasses import dataclass, field
from typing import Dict, Any, Optional, List, TYPE_CHECKING, Union, TypedDict
from modules.simulation.dtos.api import FirmStateDTO, HouseholdConfigDTO, FirmConfigDTO
from simulation.models import Order
from simulation.dtos.decision_dtos import DecisionOutputDTO
from modules.finance.api import IFinancialAgent
from modules.simulation.api import AgentID
from modules.governance.api import SystemCommand
from simulation.dtos.commands import GodCommandDTO

# Alias for standardization
OrderDTO = Order


if TYPE_CHECKING:
    from simulation.core_agents import Household
    from simulation.firms import Firm
    from simulation.dtos.scenario import StressScenarioConfig
    from modules.household.dtos import HouseholdStateDTO

 @dataclass
class TransactionData:
    run_id: int
    time: int
    buyer_id: AgentID
    seller_id: AgentID
    item_id: str
    quantity: float
    price: float
    total_pennies: int # Added for Reporting DTO Hardening
    currency: CurrencyCode  # Added for Phase 33
    market_id: str
    transaction_type: str

 @dataclass
class AgentStateData:
    run_id: int
    time: int
    agent_id: AgentID
    agent_type: str
    assets: Dict[CurrencyCode, int] # Changed for Phase 33 (Hardened to int)
    is_active: bool
    is_employed: Optional[bool] = None
    employer_id: Optional[AgentID] = None
    needs_survival: Optional[float] = None
    needs_labor: Optional[float] = None
    inventory_food: Optional[float] = None
    current_production: Optional[float] = None
    num_employees: Optional[int] = None
    education_xp: Optional[float] = None
    generation: Optional[int] = 0
    # Experiment: Time Allocation Tracking
    time_worked: Optional[float] = None
    time_leisure: Optional[float] = None

 @dataclass
class EconomicIndicatorData:
    run_id: int
    time: int
    unemployment_rate: Optional[float] = None
    avg_wage: Optional[float] = None
    food_avg_price: Optional[float] = None
    food_trade_volume: Optional[float] = None
    avg_goods_price: Optional[float] = None
    total_production: Optional[float] = None
    total_consumption: Optional[int] = None
    total_household_assets: Optional[int] = None # Changed for Reporting DTO Hardening (Pennies)
    total_firm_assets: Optional[int] = None # Changed for Reporting DTO Hardening (Pennies)
    total_food_consumption: Optional[int] = None
    total_inventory: Optional[float] = None
    avg_survival_need: Optional[float] = None
    total_labor_income: Optional[int] = None # Changed for Reporting DTO Hardening (Pennies)
    total_capital_income: Optional[int] = None # Changed for Reporting DTO Hardening (Pennies)
    # Phase 23: Education & Opportunity Metrics
    avg_education_level: Optional[float] = None
    education_spending: Optional[float] = None
    education_coverage: Optional[float] = None
    brain_waste_count: Optional[int] = None

 @dataclass
class MarketHistoryData:
    time: int
    market_id: str
    item_id: Optional[str] = None
    avg_price: Optional[float] = None
    trade_volume: Optional[float] = None
    best_ask: Optional[float] = None
    best_bid: Optional[float] = None
    avg_ask: Optional[float] = None
    avg_bid: Optional[float] = None
    worst_ask: Optional[float] = None
    worst_bid: Optional[float] = None

 @dataclass
class AIDecisionData:
    run_id: int
    tick: int
    agent_id: AgentID
    decision_type: str
    decision_details: Optional[Dict[str, Any]] = None
    predicted_reward: Optional[float] = None
    actual_reward: Optional[float] = None

class GoodsDTO(TypedDict, total=False):
    id: str
    name: str
    category: str
    is_durable: bool
    is_essential: bool
    initial_price: int
    base_need_satisfaction: float
    quality_modifier: float
    # Fields from goods.json
    type: str
    satiety: float
    decay_rate: float

class MarketHistoryDTO(TypedDict, total=False):
    avg_price: float
    trade_volume: float
    best_ask: int
    best_bid: int
    avg_ask: float
    avg_bid: float
    worst_ask: int
    worst_bid: int

# Phase 1: MarketSnapshotDTO moved to modules.system.api
from modules.system.api import (
    CurrencyCode, # Added for Phase 33
    MarketSnapshotDTO,
    HousingMarketSnapshotDTO,
    LoanMarketSnapshotDTO,
    LaborMarketSnapshotDTO,
    HousingMarketUnitDTO,
    MarketContextDTO # Refactored to TypedDict in modules.system.api
)
# Phase 1: EconomicIndicatorsDTO from modules.simulation.api
from modules.simulation.api import EconomicIndicatorsDTO

 @dataclass
class GovernmentPolicyDTO:
    """A pure-data snapshot of current government policies affecting agent decisions."""
    income_tax_rate: float
    sales_tax_rate: float
    corporate_tax_rate: float
    base_interest_rate: float

 @dataclass
class DecisionInputDTO:
    """
    Standardized input DTO for agent decision-making.
    Encapsulates all external system inputs passed to make_decision.
    """
    market_snapshot: MarketSnapshotDTO
    goods_data: List[Dict[str, Any]]
    market_data: Dict[str, Any]
    current_time: int
    fiscal_context: Optional[FiscalContext] = None
    macro_context: Optional[MacroFinancialContext] = None
    stress_scenario_config: Optional[Any] = None # Avoid circular import with StressScenarioConfig if possible, or use forward ref
    government_policy: Optional[GovernmentPolicyDTO] = None
    agent_registry: Optional[Dict[str, int]] = None
    housing_system: Optional[Any] = None # Added for Saga initiation
    market_context: Optional[MarketContextDTO] = None


 @dataclass
class DecisionContext:
    """
    A pure data container for decision-making.
    Direct agent instance access is strictly forbidden (Enforced by Purity Gate).
    """
    goods_data: List[GoodsDTO]
    market_data: Dict[str, MarketHistoryDTO]
    current_time: int
    
    # State DTO representing the agent's current condition
    state: Union[HouseholdStateDTO, FirmStateDTO]
    
    # Static configuration values relevant to the agent type
    config: Union[HouseholdConfigDTO, FirmConfigDTO]

    # New DTOs
    market_snapshot: Optional[MarketSnapshotDTO] = None
    government_policy: Optional[GovernmentPolicyDTO] = None

    stress_scenario_config: Optional[StressScenarioConfig] = None # Phase 28

    # Agent Discovery Registry (WO-138)
    agent_registry: Dict[str, AgentID] = field(default_factory=dict)

    # Tick-Snapshot Injection
    market_context: Optional[MarketContextDTO] = None


 @dataclass
class FiscalContext:
    """
    Context providing access to fiscal entities (Government) in a restricted manner.
    Used by agents to interact with the government (e.g., paying taxes, receiving subsidies)
    without direct access to the full Government agent object.
    """
    government: IFinancialAgent


 @dataclass
class SimulationState:
    """
    WO-103: Simulation State DTO to reduce coupling.
    Passes all necessary data from the Simulation object to system services.
    """
    time: int
    households: List[Household]
    firms: List[Firm]
    agents: Dict[AgentID, Any]
    markets: Dict[str, Any]
    government: Any  # Government
    bank: Any        # Bank
    central_bank: Any # CentralBank
    escrow_agent: Optional[Any] # EscrowAgent
    stock_market: Optional[Any] # StockMarket
    stock_tracker: Optional[Any] # Added for WO-133 Fix
    goods_data: Dict[str, Any]
    market_data: Dict[str, Any] # Added for WO-103
    config_module: Any
    tracker: Any
    logger: Any # logging.Logger
    ai_training_manager: Optional[Any]
    ai_trainer: Optional[Any] # Added for WO-103
    settlement_system: Optional[Any] = None # WO-112: Settlement System
    next_agent_id: int = 0 # Added for WO-103
    real_estate_units: List[Any] = field(default_factory=list) # Added for WO-103
    # Mutable state for the tick
    transactions: List[Any] = None # List[Transaction]
    inter_tick_queue: List[Any] = None # List[Transaction]
    effects_queue: List[Dict[str, Any]] = None # WO-109: Queue for side-effects
    inactive_agents: Dict[AgentID, Any] = None # WO-109: Store inactive agents
    taxation_system: Optional[Any] = None # WO-116: Taxation System
    currency_holders: List[Any] = None # Added for M2 tracking (Phase 33/5)
    stress_scenario_config: Optional[StressScenarioConfig] = None # Phase 28
    transaction_processor: Optional[Any] = None # Added for system delegation compatibility
    shareholder_registry: Optional[Any] = None # TD-275 Shareholder Registry

    # Phase 4.1: Saga Orchestration & Monetary Ledger (TD-253)
    saga_orchestrator: Optional[Any] = None
    monetary_ledger: Optional[Any] = None

    # TD-255: System Command Pipeline
    system_commands: List[SystemCommand] = field(default_factory=list)
    god_commands: List[GodCommandDTO] = field(default_factory=list) # FOUND-03: Phase 0 Intercept

    # --- NEW TRANSIENT FIELDS ---
    # From Phase 1 (Decisions)
    firm_pre_states: Dict[AgentID, Any] = None
    household_pre_states: Dict[AgentID, Any] = None
    household_time_allocation: Dict[AgentID, float] = None

    # From Commerce System (planned in Phase 1, used in PostSequence)
    planned_consumption: Optional[Dict[AgentID, Dict[str, Any]]] = None # TD-118

    # From Lifecycle (used in PostSequence for Learning)
    household_leisure_effects: Dict[AgentID, float] = None

    # Injection
    injectable_sensory_dto: Optional[Any] = None # GovernmentStateDTO
    currency_registry_handler: Optional[Any] = None # WorldState injection for strict registry

    def register_currency_holder(self, holder: Any) -> None:
        if self.currency_registry_handler:
            self.currency_registry_handler.register_currency_holder(holder)
        elif self.currency_holders is not None:
             self.currency_holders.append(holder) # Fallback

    def unregister_currency_holder(self, holder: Any) -> None:
        if self.currency_registry_handler:
            self.currency_registry_handler.unregister_currency_holder(holder)
        elif self.currency_holders is not None:
             if holder in self.currency_holders:
                 self.currency_holders.remove(holder) # Fallback

    def __post_init__(self):
        if self.transactions is None:
            self.transactions = []
        if self.system_commands is None:
            self.system_commands = []
        if self.god_commands is None:
            self.god_commands = []
        if self.inter_tick_queue is None:
            self.inter_tick_queue = []
        if self.effects_queue is None:
            self.effects_queue = []
        if self.inactive_agents is None:
            self.inactive_agents = {}
        if self.currency_holders is None:
            self.currency_holders = []
        if self.firm_pre_states is None:
            self.firm_pre_states = {}
        if self.household_pre_states is None:
            self.household_pre_states = {}
        if self.household_time_allocation is None:
            self.household_time_allocation =
============================================================
âœ… Review Saved: C:\coding\economics\design\_archive\gemini_output\review_backup_20260219_150607_Analyze_this_PR.md
