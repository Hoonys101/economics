# 경제 시뮬레이션: 오더북 시장 모델 설계 (v1)

## 1. 개요 (Overview)
이 문서는 기존 시장 모델의 근본적인 문제인 '거래 교착 상태(deadlock)'를 해결하고, 보다 현실적인 가격 발견(Price Discovery) 메커니즘을 도입하기 위해 **오더북(Order Book) 기반 연속 이중 경매(Continuous Double Auction)** 시장 모델을 새로 설계하고 도입하는 것을 목표로 한다.

---

## 2. 핵심 문제점 (Core Problem)
- **의존성 교착**: 현재 모델에서 가계(구매자)는 시장에 형성된 '현재가'를 알아야 구매 주문을 생성할 수 있다. 하지만 시장 가격은 거래가 발생해야 형성되므로, 어느 쪽도 먼저 행동하지 못하는 딜레마에 빠져 거래가 전혀 발생하지 않는다.
- **비현실적인 정보**: 에이전트가 시장의 모든 정보를 완벽하게 안다고 가정하여, 가격 결정 과정이 비현실적이다.

---

## 3. 제안 모델: 오더북 기반 연속 이중 경매
주식 시장과 같이, 모든 매수/매도 희망 주문을 '오더북'이라는 중앙 원장에 기록하고, 조건이 맞는 주문이 들어오는 즉시 거래를 체결시키는 방식을 도입한다.

- **오더북 (Order Book)**: 모든 매수/매도 주문을 각각의 목록에 기록 및 관리.
  - **매수 오더북 (Buy Book)**: 높은 가격을 제시한 주문이 우선순위 (Price-Time Priority).
  - **매도 오더북 (Sell Book)**: 낮은 가격을 제시한 주문이 우선순위 (Price-Time Priority).
- **연속 이중 경매 (Continuous Double Auction)**: 주문이 시장에 도착하는 즉시, 거래 가능한 상대 주문이 있는지 확인하고 조건이 맞으면 즉시 거래를 체결.

---

## 4. 신규 Market API 설계

### 클래스: `OrderBookMarket` (in `simulation/markets_v2.py`)

```python
from typing import List, Dict, Optional
from simulation.models import Order, Transaction

class OrderBookMarket:
    def __init__(self, market_id: str, logger: Logger):
        """
        오더북 기반 시장을 초기화합니다.
        - self.buy_book: {item_id: [Order, ...]}
        - self.sell_book: {item_id: [Order, ...]}
        """
        pass

    def place_order(self, order: Order, current_time: int) -> List[Transaction]:
        """
        새로운 주문을 받아 오더북에 추가하고, 즉시 매칭을 시도합니다.
        매칭이 성공하면 거래(Transaction) 리스트를 반환하고,
        실패하면 빈 리스트를 반환합니다.
        """
        pass

    def get_best_bid(self, item_id: str) -> Optional[float]:
        """해당 상품의 최고 매수 호가(가장 높은 구매 희망가)를 반환합니다."""
        pass

    def get_best_ask(self, item_id: str) -> Optional[float]:
        """해당 상품의 최저 매도 호가(가장 낮은 판매 희망가)를 반환합니다."""
        pass

    def get_last_traded_price(self, item_id: str) -> Optional[float]:
        """해당 상품의 가장 최근 체결가를 반환합니다."""
        pass

    def get_spread(self, item_id: str) -> Optional[float]:
        """최고 매수 호가와 최저 매도 호가의 차이(스프레드)를 반환합니다."""
        pass

    def get_market_depth(self, item_id: str) -> Dict[str, int]:
        """오더북에 쌓여있는 매수/매도 주문의 수를 반환합니다. (예: {'buy_orders': 10, 'sell_orders': 15})"""
        pass
```

---

## 5. 에이전트-시장 상호작용 시나리오
1.  **의사결정**: 가계/기업 에이전트가 자신의 상태와 전략에 따라 특정 상품을 구매/판매하기로 결정한다.
2.  **희망가 계산**: 에이전트는 자체 로직(`_calculate_reservation_price` 등)을 통해 지불/수령 희망 가격을 계산한다.
3.  **주문 생성**: 계산된 희망 가격과 수량을 담아 `Order` 객체를 생성한다.
4.  **주문 제출**: 에이전트는 `market.place_order(order)`를 호출하여 시장에 주문을 제출한다.
5.  **거래 체결/대기**:
    - **성공**: 시장이 즉시 거래 가능한 상대 주문을 찾아 `Transaction` 객체를 생성하여 반환한다.
    - **실패**: 시장은 해당 주문을 오더북에 추가하고 빈 리스트를 반환한다.
6.  **상태 업데이트**: 시뮬레이션 엔진은 반환된 `Transaction` 리스트를 기반으로 관련 에이전트들의 자산과 재고를 업데이트한다.

---

## 6. TODO 리스트 (Implementation Plan)

### Phase 1: 시장 기반 구축 (Market Foundation)
- [ ] **(설계)** `simulation/markets_v2.py` 파일 생성 및 `OrderBookMarket` 클래스 기본 구조 작성.
- [ ] **(구현)** 오더북 데이터 구조 구현 (`dict`와 `list` 활용, 가격/시간 순으로 정렬 유지).
- [ ] **(구현)** `place_order` 메서드의 핵심 로직(오더북 추가 및 매칭 시도) 구현.
- [ ] **(테스트)** `tests/test_markets_v2.py` 생성 및 `place_order`, 거래 체결 로직에 대한 단위 테스트 작성 (다양한 시나리오 포함: 완전 체결, 부분 체결, 미체결).

### Phase 2: API 구현 및 에이전트 연동 (API & Agent Integration)
- [ ] **(구현)** `get_best_bid`, `get_best_ask`, `get_last_traded_price` 등 정보 제공 API 메서드 구현.
- [ ] **(리팩토링)** `simulation/decisions/household_decision_engine.py`가 `current_market_price` 대신 자신의 `reservation_price`로 `BUY` 주문을 생성하고 `market.place_order()`를 호출하도록 수정.
- [ ] **(리팩토링)** `simulation/decisions/firm_decision_engine.py`가 자신의 판매가로 `SELL` 주문을 생성하고 `market.place_order()`를 호출하도록 수정.
- [ ] **(테스트)** 수정된 의사결정 엔진과 새로운 시장의 통합 테스트 케이스 작성.

### Phase 3: 엔진 통합 및 전체 검증 (Engine Integration & Verification)
- [ ] **(리팩토링)** `simulation/engine.py`의 메인 루프가 `markets.py` 대신 `markets_v2.py`의 `OrderBookMarket`을 생성하고 사용하도록 수정. (주문 수집 후 일괄 매칭 -> 주문 발생 시 즉시 처리 방식으로 변경)
- [ ] **(실행)** `run_experiment.py`를 실행하여 새로운 시장 모델에서 `food`를 포함한 모든 재화 거래가 정상적으로 발생하는지 검증.
- [ ] **(분석)** `analyze_results.py`를 통해 주요 경제 지표(물가, 거래량, GDP 등)가 안정적으로 나타나는지 확인.
- [ ] **(정리)** 기존 `simulation/markets.py`를 `legacy` 폴더로 이동 또는 삭제.
