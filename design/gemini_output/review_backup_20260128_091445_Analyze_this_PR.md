# ğŸ” Git Diff Review: Scheduler Decomposition & Lifecycle Refactor

---

### 1. ğŸ” Summary
ì´ ë³€ê²½ ì‚¬í•­ì€ ê¸°ì¡´ì˜ ê±°ëŒ€í–ˆë˜ `TickScheduler`ë¥¼ ëª…í™•í•œ ì±…ì„ì„ ê°€ì§„ ì—¬ëŸ¬ ë‹¨ê³„(Phase)ë¡œ ë¶„ë¦¬í•˜ëŠ” ëŒ€ê·œëª¨ ì•„í‚¤í…ì²˜ ë¦¬íŒ©í† ë§ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ `TickOrchestrator`ëŠ” `Phase0`ë¶€í„° `Phase5`ê¹Œì§€ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•˜ë©°, ê° ë‹¨ê³„ ì‚¬ì´ì˜ ë°ì´í„°ëŠ” `SimulationState` DTOë¥¼ í†µí•´ ì „ë‹¬ë©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ì½”ë“œì˜ ì±…ì„ ë¶„ë¦¬(SoC)ê°€ í¬ê²Œ í–¥ìƒë˜ì—ˆìœ¼ë©°, íŠ¹íˆ Firmì˜ ìƒëª…ì£¼ê¸° ë¡œì§ì´ `AgentLifecycleManager`ë¡œ ì´ì „ë˜ëŠ” ë“± êµ¬ì¡°ê°€ ëª…í™•í•´ì¡ŒìŠµë‹ˆë‹¤.

### 2. ğŸš¨ Critical Issues
- **ì—†ìŒ**: ë³´ì•ˆ ìœ„ë°˜, ë¯¼ê° ì •ë³´ í•˜ë“œì½”ë”©, ì™¸ë¶€ ë ˆí¬ì§€í† ë¦¬ ê²½ë¡œ ë“± ì¦‰ê°ì ì¸ ìˆ˜ì •ì´ í•„ìš”í•œ ì‹¬ê°í•œ ë¬¸ì œëŠ” ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

### 3. âš ï¸ Logic & Spec Gaps
- **[Major] AI í•™ìŠµ ë°ì´í„° ëˆ„ë½ ìœ„í—˜**: `simulation/orchestration/phases.py`ì˜ `Phase5_PostSequence` ë‚´ì— AI í•™ìŠµ ë³´ìƒ ê³„ì‚°ì„ ìœ„í•œ Firmì˜ ì‚¬ì „ ìƒíƒœ(`pre_state_snapshot`)ê°€ ì œëŒ€ë¡œ ì„¤ì •ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆë‹¤ëŠ” `TODO` ì£¼ì„ì´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” AI ì—ì´ì „íŠ¸ì˜ í•™ìŠµ ê³¼ì •ì— ì‹¬ê°í•œ ì˜¤ë¥˜ë¥¼ ìœ ë°œí•˜ê±°ë‚˜ í•™ìŠµì´ ì œëŒ€ë¡œ ì´ë£¨ì–´ì§€ì§€ ì•Šê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°°í¬ ì „ ë°˜ë“œì‹œ ì´ ë¡œì§ì„ ê²€ì¦í•˜ê³  ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
  ```python
  # simulation/orchestration/phases.py -> Phase5_PostSequence.execute()
  
  # We missed this in Phase 1.
  # We should add logic to Phase 1 to snapshot agents!
  pass # TODO: Fix learning snapshot if critical. 
  ```
- **[Minor] ìƒíƒœ ì˜¤ì—¼ ê°€ëŠ¥ì„±**: `simulation/orchestration/phases.py`ì˜ `Phase1_Decision`ì—ì„œ `household_time_allocation` ë°ì´í„°ê°€ `SimulationState` DTOì™€ `world_state` ê°ì²´ ì–‘ìª½ì— ëª¨ë‘ ì €ì¥ë˜ê³  ìˆìŠµë‹ˆë‹¤. `SimulationState` DTOì˜ ë„ì… ëª©ì ì€ í‹± ë‚´ì˜ íœ˜ë°œì„± ë°ì´í„°ë¥¼ `world_state`ë¡œë¶€í„° ê²©ë¦¬í•˜ëŠ” ê²ƒì´ë¯€ë¡œ, `world_state`ì— ì§ì ‘ ì“°ëŠ” ì½”ë“œëŠ” ì•„í‚¤í…ì²˜ ì„¤ê³„ì™€ ë§ì§€ ì•Šìœ¼ë©° ë°ì´í„° íë¦„ì„ í˜¼ë€ìŠ¤ëŸ½ê²Œ ë§Œë“­ë‹ˆë‹¤. `world_state`ì— ì§ì ‘ í• ë‹¹í•˜ëŠ” ì½”ë“œëŠ” ì œê±°í•´ì•¼ í•©ë‹ˆë‹¤.
  ```python
  # simulation/orchestration/phases.py -> Phase1_Decision.execute()
  
  state.household_pre_states = household_pre_states
  state.household_time_allocation = household_time_allocation
  self.world_state.household_time_allocation = household_time_allocation # <-- Redundant and potentially harmful
  ```

### 4. ğŸ’¡ Suggestions
- **íƒ€ì… ì•ˆì •ì„± ê°•í™”**: `simulation/orchestration/tick_orchestrator.py`ì˜ `prepare_market_data` ë©”ì†Œë“œì—ì„œ `type: ignore` ì£¼ì„ì„ ì‚¬ìš©í•˜ì—¬ `WorldState` ê°ì²´ë¥¼ `SimulationState` íƒ€ì…ìœ¼ë¡œ ê°•ì œí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë• íƒ€ì´í•‘ì— ì˜ì¡´í•˜ëŠ” ê²ƒìœ¼ë¡œ, ì¥ê¸°ì ìœ¼ë¡œ ìœ ì§€ë³´ìˆ˜ë¥¼ ì–´ë µê²Œ ë§Œë“­ë‹ˆë‹¤. `prepare_market_data` í•¨ìˆ˜ê°€ ìš”êµ¬í•˜ëŠ” ì†ì„±(`tracker`, `config_module` ë“±)ì„ ê°€ì§„ ìµœì†Œí•œì˜ `SimulationState` DTOë¥¼ ìƒì„±í•˜ì—¬ ì „ë‹¬í•˜ëŠ” ê²ƒì´ ë” ì•ˆì „í•˜ê³  ëª…ì‹œì ì¸ ë°©ë²•ì…ë‹ˆë‹¤.
- **í…ŒìŠ¤íŠ¸ ë³´ê°•**: ì´ë²ˆ ë¦¬íŒ©í† ë§ì€ ì‹œë®¬ë ˆì´ì…˜ì˜ í•µì‹¬ ì‹¤í–‰ ë¡œì§ì„ ë³€ê²½í•˜ëŠ” ì¤‘ëŒ€í•œ ì‘ì—…ì…ë‹ˆë‹¤. `TickOrchestrator`ê°€ ê° ë‹¨ê³„ë¥¼ ì •í™•í•œ ìˆœì„œë¡œ í˜¸ì¶œí•˜ëŠ”ì§€, ê·¸ë¦¬ê³  `SimulationState` DTOê°€ ê° ë‹¨ê³„ ê°„ì— ì˜¬ë°”ë¥´ê²Œ ì „ë‹¬ ë° ìˆ˜ì •ë˜ëŠ”ì§€ë¥¼ ê²€ì¦í•˜ëŠ” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ê°•ë ¥íˆ ê¶Œì¥í•©ë‹ˆë‹¤.

### 5. ğŸ§  Manual Update Proposal
ì´ë²ˆ ì•„í‚¤í…ì²˜ ë³€ê²½ì€ í”„ë¡œì íŠ¸ì˜ í•µì‹¬ ë™ì‘ ë°©ì‹ì„ ì •ì˜í•˜ë¯€ë¡œ, ë°˜ë“œì‹œ ë¬¸ì„œí™”í•˜ì—¬ íŒ€ ì „ì²´ê°€ ê³µìœ í•´ì•¼ í•©ë‹ˆë‹¤.

- **Target File**: `design/platform_architecture.md`
- **Update Content**:
  ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ "**í‹± ì‹¤í–‰ ì•„í‚¤í…ì²˜: ë‹¨ê³„ ê¸°ë°˜ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° (Tick Execution Architecture: The Phase-Based Orchestrator)**" ì„¹ì…˜ì„ ì‹ ì„¤í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•  ê²ƒì„ ì œì•ˆí•©ë‹ˆë‹¤.

  ---
  #### í‹± ì‹¤í–‰ ì•„í‚¤í…ì²˜: ë‹¨ê³„ ê¸°ë°˜ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°

  ì‹œë®¬ë ˆì´ì…˜ì˜ ë‹¨ì¼ í‹±(tick)ì€ ë” ì´ìƒ í•˜ë‚˜ì˜ ê±°ëŒ€í•œ í•¨ìˆ˜(`TickScheduler`)ì— ì˜í•´ ì²˜ë¦¬ë˜ì§€ ì•Šê³ , ëª…í™•í•œ ìˆœì„œì™€ ì±…ì„ì„ ê°€ì§„ ë…ë¦½ì ì¸ ë‹¨ê³„(Phase)ë“¤ì˜ ì—°ì†ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì´ ëª¨ë“  ê³¼ì •ì€ `TickOrchestrator`ì— ì˜í•´ ê´€ë¦¬ë©ë‹ˆë‹¤.

  **ì£¼ìš” ê°œë…:**
  1.  **ë°ì´í„° íë¦„**: ë§¤ í‹±ì´ ì‹œì‘ë  ë•Œ, í•´ë‹¹ í‹±ì—ì„œë§Œ ì‚¬ìš©ë  ì„ì‹œ ë°ì´í„° ì»¨í…Œì´ë„ˆì¸ `SimulationState` DTOê°€ ìƒì„±ë©ë‹ˆë‹¤. ì´ DTOëŠ” ê° ë‹¨ê³„ë¥¼ ìˆœì„œëŒ€ë¡œ í†µê³¼í•˜ë©° í•„ìš”í•œ ë°ì´í„°ë¥¼ ì¶•ì í•˜ê³  ìˆ˜ì •í•©ë‹ˆë‹¤. ì´ ë°©ì‹ì€ ì˜êµ¬ì ì¸ `WorldState`ê°€ ì„ì‹œ ë°ì´í„°ë¡œ ì˜¤ì—¼ë˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
  2.  **ì‹ ì„±í•œ ìˆœì„œ (The Sacred Sequence)**: í‹±ì˜ ì‹¤í–‰ ìˆœì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ì—„ê²©í•˜ê²Œ ì •ì˜ë˜ë©°, ê° ë‹¨ê³„ëŠ” `IPhaseStrategy` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
      - **Phase 0: PreSequence**: ì´ë²¤íŠ¸ ì‹¤í–‰, ì •ë¶€ ì •ì±… ê²°ì •, ê°ì¢… ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸ ë“± ì£¼ìš” ì˜ì‚¬ê²°ì • ì „ì— í•„ìš”í•œ ì‚¬ì „ ì¤€ë¹„ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
      - **Phase 1: Decision**: ëª¨ë“  ì—ì´ì „íŠ¸(ê°€ê³„, ê¸°ì—…)ê°€ ì‹œì¥ ìƒí™©ì„ ë°”íƒ•ìœ¼ë¡œ ì˜ì‚¬ê²°ì •ì„ ë‚´ë¦¬ê³  ì£¼ë¬¸(Order)ì„ ìƒì„±í•©ë‹ˆë‹¤.
      - **Phase 2: Matching**: ëª¨ë“  ì‹œì¥(ìƒí’ˆ, ë…¸ë™, ì£¼ì‹ ë“±)ì—ì„œ ì œì¶œëœ ì£¼ë¬¸ë“¤ì„ ë§¤ì¹­í•˜ì—¬ ê±°ë˜ë¥¼ ì²´ê²°í•©ë‹ˆë‹¤.
      - **Phase 3: Transaction**: ë§¤ì¹­ëœ ê±°ë˜ì™€ ì‹œìŠ¤í…œì— ì˜í•´ ë°œìƒí•œ ëª¨ë“  ê±°ë˜(ì„¸ê¸ˆ, ë³µì§€ ë“±)ë¥¼ ì²˜ë¦¬í•˜ì—¬ ì—ì´ì „íŠ¸ë“¤ì˜ ìì‚°ì„ ë³€ê²½í•©ë‹ˆë‹¤.
      - **Phase 4: Lifecycle**: ì¶œìƒ, ì‚¬ë§, ì´ë¯¼, ê¸°ì—… íŒŒì‚° ë“± ì—ì´ì „íŠ¸ì˜ ìƒëª…ì£¼ê¸° ë³€ê²½ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
      - **Phase 5: PostSequence**: AI í•™ìŠµ ì—…ë°ì´íŠ¸, ìƒíƒœ ê°’ ì´ˆê¸°í™”, ë°ì´í„° ì˜ì†ì„± ì²˜ë¦¬ ë“± í‹±ì„ ë§ˆë¬´ë¦¬í•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
  ---

### 6. âœ… Verdict
**REQUEST CHANGES**

> AI í•™ìŠµ ë¡œì§ì˜ ì ì¬ì  ê²°í•¨(`TODO`)ì€ ë°˜ë“œì‹œ ìˆ˜ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ ì œì•ˆëœ ì•„í‚¤í…ì²˜ì˜ ì´ì ì„ ì™„ì „íˆ ì‚´ë¦¬ê¸° ìœ„í•´ `world_state` ì˜¤ì—¼ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ë‹¤ì‹œ ë¦¬ë·° ìš”ì²­ ë°”ëë‹ˆë‹¤.
