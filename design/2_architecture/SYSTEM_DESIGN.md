# 시스템 설계 문서 (SYSTEM_DESIGN.md)

이 문서는 경제 시뮬레이션 프로젝트의 통합된 시스템 설계를 정의합니다. 여러 설계 문서의 핵심 내용을 통합하여 프로젝트의 전체적인 아키텍처, 데이터 흐름, 에이전트 모델, 시장 메커니즘에 대한 단일 진실 공급원(Single Source of Truth) 역할을 합니다.

---

## 1. 프로젝트 비전 및 목표

복잡계 경제학 원리를 기반으로 AI 에이전트(가계, 기업) 모델을 구축하여, 현실 경제 현상을 모사하고 분석하는 것을 목표로 합니다. 각 에이전트는 내재된 욕구와 AI 의사결정 엔진을 통해 자율적으로 행동하며, 이들의 상호작용으로부터 거시 경제 현상이 창발되는 과정을 관찰합니다.

- **핵심 목표:**
    1.  현실적인 에이전트 모델링 (욕구 기반, AI 의사결정)
    2.  동적 시장 메커니즘 구현 (수요-공급, 가격 결정)
    3.  AI 의사결정 엔진의 학습 및 진화
    4.  웹 기반 시각화 및 분석 도구 구축
    5.  확장 가능한 아키텍처 설계

---

## 2. 핵심 아키텍처

### 2.1. 아키텍처 원칙

- **에이전트 기반 모델 (Agent-Based Model):** 가계와 기업 에이전트의 상호작용이 시뮬레이션의 중심입니다.
- **의사결정 엔진 분리 (Decision Engine):** 에이전트의 상태(`Agent` 클래스)와 행동 로직(`DecisionEngine` 클래스)을 분리하여 유연성과 테스트 용이성을 확보합니다.
- **AI 훈련 관리자 분리 (AITrainingManager):** AI 모델의 훈련/관리(`AITrainingManager`)와 실제 의사결정(`AIDecisionEngine`)의 책임을 명확히 분리합니다.
- **오더북 시장 (Order Book Market):** 주식 시장과 유사한 오더북 기반 연속 이중 경매 시장을 통해 현실적인 거래 및 가격 발견 메커니즘을 구현합니다.
- **DB 기반 MVC 구조:** 시뮬레이션 엔진(Model), API 서버(Controller), 웹 UI(View)를 명확히 분리하고, 모든 데이터는 SQLite 데이터베이스를 통해 교환하여 확장성과 유지보수성을 극대화합니다.

### 2.2. 데이터 흐름 (단일 틱)

1.  **데이터 준비 (Engine):** `SimulationEngine`이 `Database`에서 이전 틱의 주요 거시 지표(`avg_wage`, `avg_goods_price` 등)를 조회하여 `market_data`를 준비합니다.
2.  **가격/임금 제시 (Firms):** `Engine`이 `market_data`를 모든 `Firm` 에이전트에게 전달합니다.
    -   기업들은 이를 바탕으로 이번 틱에 제공할 상품 가격과 직원에게 제시할 임금(wage offer)을 결정합니다.
    -   결정된 가격으로 상품 판매(SELL) 주문과 노동 구매(BUY) 주문을 `Market`에 제출합니다.
3.  **주문 수락 (Households):** `Engine`이 `market_data`와 시장에 제출된 오퍼들을 `Household` 에이전트에게 전달합니다.
    -   가계는 자신의 필요와 예산, 기대 임금에 맞춰 시장의 오퍼들을 확인합니다.
    -   가장 유리한 상품 구매(BUY) 주문과 노동 판매(SELL) 주문을 `Market`에 제출합니다.
4.  **주문 체결 (Markets):** `Market`이 접수된 모든 BUY/SELL 주문을 매칭하여 거래(Transaction)를 체결시키고, 그 결과를 `Engine`에 반환합니다.
5.  **상태 업데이트 (Engine):** `Engine`이 모든 거래 결과를 바탕으로 각 에이전트의 자산, 재고, 고용 상태 등을 업데이트합니다.
6.  **생산 및 소비 (Agents):**
    -   `Firms`는 고용된 직원을 바탕으로 상품을 생산합니다.
    -   `Households`는 구매한 상품을 소비하여 필요(needs)를 충족시킵니다.
7.  **데이터 기록 (Database):** `Engine`이 이번 틱에서 발생한 모든 거래, 에이전트 상태, 새로 계산된 거시 지표를 `Database`에 기록합니다. 이 데이터는 다음 틱의 "과거 데이터"가 됩니다.

### 2.3. AI Training Manager

- **역할:** `AITrainingManager`는 개별 에이전트 수준을 넘어, 전체 에이전트 집단의 학습을 관리하고 가속화하는 메타-학습 컴포넌트입니다.
- **주요 기능:** 주기적으로 상위 성과 에이전트의 학습된 전략(Q-테이블)을 다른 에이전트에게 전파하는 **모방 학습(Imitation Learning)** 메커니즘을 실행합니다.
- **통합:** 시뮬레이션 엔진(`simulation/engine.py`)에 의해 특정 간격(예: 100틱)마다 호출됩니다.
- **상세 설계:** 자세한 내용은 `design/ai_training_manager_design.md` 문서를 참조하십시오.

---

## 3. AI 에이전트 모델

AI의 역할을 저수준의 전술적 판단이 아닌, 장기적 이익을 추구하는 **고수준의 '전략' 결정**으로 격상시킵니다. 모든 AI는 공통 학습 메커니즘을 가진 `BaseAIEngine`을 상속받아 구현됩니다.

### 3.1. 가계(Household) AI

- **상태 (State):** `(자산 수준, 재고 수준, 주요 욕구)`의 튜플로 상태를 인식합니다.
    -   **자산 수준:** `[위험, 안정, 부유]` (전체 평균 대비)
    -   **재고 수준:** `[결핍, 충분, 과잉]` (필수품 기준)
    -   **주요 욕구:** `[생존, 인정, 성장 등]` (가장 높은 욕구)
- **행동 (Action):** `(전술, 적극성)`의 조합으로 행동을 결정합니다.
    -   **전술:** `BUY_ESSENTIAL_GOODS`, `PARTICIPATE_LABOR_MARKET` 등
    -   **적극성:** `[소극적, 일반적, 적극적]`
- **보상 (Reward):** `(자산 증가율) + (주요 욕구 감소율 * 가중치)`

### 3.2. 기업(Firm) AI

- **상태 (State):** `(이윤률, 재고율, 채용률, 판매 실적)` 튜플로 상태를 인식합니다.
    -   **이윤률/재고율/채용률:** `[낮음, 보통, 높음]`
    -   **판매 실적:** `[매우 부진, 부진, 보통, 완판]`
- **행동 (Action):** `가격 정책`, `임금 정책`, `투자 정책`과 같은 경영 전략을 선택합니다.
- **보상 (Reward):** `기업 자산 증가율`

---

## 4. 에이전트 상세 설계

### 4.1. 가계(Household) 에이전트

- **노동 공급:**
    1.  **기대 임금(`reservation_wage`) 설정:** 생존 필요 비용(식량 가격) 기반으로 최소 기대 임금 결정.
    2.  **동적 조정:** 자산이 특정 임계값 이하로 떨어지면 '유동성 필요'가 높아져 기대 임금을 낮춤으로써 취업 가능성을 높입니다.
    3.  **최적 직업 선택:** 시장의 임금 오퍼 중 기대 임금을 만족하는 가장 높은 임금을 제시하는 일자리를 선택합니다.
- **상품 소비:**
    1.  **예산 책정:** 현재 자산과 저축 계획(AI 결정)에 따라 소비 예산 결정.
    2.  **우선순위:** `survival_need`가 높으면 'food'를 최우선으로 구매합니다.
    3.  **구매 결정:** 예산 내에서 시장 가격을 보고 구매 여부를 결정합니다.

### 4.2. 기업(Firm) 에이전트

- **생산량 결정:** 이전 틱의 재고 수준에 따라 생산 목표를 동적으로 조정합니다.
- **고용 및 임금 결정:**
    1.  **필요 노동력 계산:** 새로운 생산 목표에 필요한 노동력을 계산합니다.
    2.  **임금 오퍼:** 시장 평균 임금을 기준으로, 기업의 수익성과 이전 틱의 채용 성공 여부에 따라 프리미엄을 붙여 임금을 제시합니다.
- **가격 결정:**
    1.  **원가 계산:** 생산 원가(주로 임금)를 계산합니다.
    2.  **가격 책정:** `원가 * (1 + AI가 결정한 이윤 마진)`으로 기본 가격을 설정합니다.
    3.  **피드백 조정:** 이전 틱에 '완판'되었으면 가격을 올리고, '재고 누적' 시 가격을 내립니다.
- **경제적 압박:**
    - **고정 비용:** 매 틱 고정 운영 비용을 지불하여 이윤 창출의 압박을 받습니다.
    - **의무 배당:** 이익의 일정 비율을 주주에게 의무적으로 배당하여, 이윤의 무한 축적을 방지하고 성장을 유도합니다.

---

## 5. 시장 메커니즘

가격이 시장의 상호작용으로부터 **창발**되도록 설계합니다. 판매자(기업)가 가격을 제시하고, 구매자(가계)가 수용 여부를 결정하며, 그 결과(판매 실적, 재고)가 다음 틱의 가격 결정에 피드백으로 작용하는 비대칭적 구조입니다.

- **노동 시장:** 기업이 임금을 제시하고, 가계는 기대 임금과 비교하여 수락 여부를 결정합니다.
- **상품 시장:** 기업이 상품 가격을 제시하고, 가계는 예산 내에서 구매 여부를 결정합니다.

---

## 6. 데이터베이스 스키마

| 테이블명 | 설명 | 주요 컬럼 |
| :--- | :--- | :--- |
| `simulation_runs` | 각 시뮬레이션 실행 정보를 관리합니다. | `run_id` (PK), `start_time`, `description`, `params_json` |
| `ticks` | 시뮬레이션의 각 틱 정보를 저장합니다. | `tick_id` (PK), `run_id` (FK), `tick_number` |
| `agents` | 모든 에이전트(가계, 기업)의 고유 정보를 저장합니다. | `agent_id` (PK), `run_id` (FK), `agent_type`, `birth_tick`, `death_tick` |
| `household_states` | 가계 에이전트의 틱별 상태를 저장합니다. | `state_id` (PK), `tick_id` (FK), `agent_id` (FK), `assets`, `needs_level`, `inventory_json` |
| `firm_states` | 기업 에이전트의 틱별 상태를 저장합니다. | `state_id` (PK), `tick_id` (FK), `agent_id` (FK), `assets`, `production_quantity`, `price`, `inventory_json` |
| `market_transactions` | 모든 시장(상품, 노동)의 거래 기록을 저장합니다. | `transaction_id` (PK), `tick_id` (FK), `good`, `buyer_id`, `seller_id`, `price`, `quantity` |
| `macro_indicators` | 틱별 거시 경제 지표를 저장합니다. | `indicator_id` (PK), `tick_id` (FK), `gdp`, `unemployment_rate`, `inflation` |

---

## 7. API 설계

| 메서드 | 경로 | 설명 |
| :--- | :--- | :--- |
| `POST` | `/api/simulations` | 새로운 시뮬레이션 실행을 시작합니다. |
| `GET` | `/api/simulations/{run_id}` | 특정 시뮬레이션의 현재 상태를 조회합니다. |
| `POST` | `/api/simulations/{run_id}/stop` | 실행 중인 시뮬레이션을 중지합니다. |
| `GET` | `/api/simulations/{run_id}/macro/timeseries` | 거시 지표 시계열 데이터를 가져옵니다. |
| `GET` | `/api/simulations/{run_id}/agents` | 에이전트 목록을 가져옵니다. |
| `GET` | `/api/agents/{agent_id}/state/timeseries` | 특정 에이전트의 상태 시계열 데이터를 가져옵니다. |
| `GET` | `/api/simulations/{run_id}/market/transactions` | 시장 거래 내역을 가져옵니다. |
