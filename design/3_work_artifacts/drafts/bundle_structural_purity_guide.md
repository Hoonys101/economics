# Phase 9.3: Master Structural Purity (The Composition Shift)

This guide synthesizes 3 technical specs and 1 ADR into a coherent execution plan to resolve the project's most critical structural debt (TDL-PH9-2-STRUCTURAL).

---

## üèóÔ∏è Phase 9.3: Strategic Objectives

1.  **Eliminate Abstraction Leaks**: Core Engines (`HR`, `Finance`, `Sales`) must operate on stateless Protocols/DTOs, not raw Agent objects.
2.  **Standardize Data Contracts**: Unify all market orders into a canonical `OrderDTO` and enforce `DecisionInputDTO` for all AI/Rule brains.
3.  **Dismantle God Classes**: Decompose `SettlementSystem`, `Firm`, and `Government` by extracting specialized logic into new engines/managers.
4.  **Composition Over Inheritance**: Deprecate `BaseAgent` inheritance in favor of a "Body-Brain-State" composition model using a new `InventoryManager` and standalone `Wallet`.

---

## üõ§Ô∏è Implementation Lanes (Parallel Implementable)

### 1. System Core Hardening (Prerequisite)
*   **Target**: `simulation/systems/settlement_system.py`
*   **Action**: Split into three components:
    -   **`SettlementSystem`**: Core atomic transfers only. Implement `transfer_from_wallet(payer_wallet, payee_id, ...)`.
    -   **`EstateManager`**: Handle agent death/inheritance logic.
    -   **`MonetaryAuthorityGateway`**: Handle mint/burn logic for Central Bank.

### 2. Engine Abstraction (TDR-001)
*   **Target**: `simulation/components/engines/`
*   **Action**: 
    -   Define `PayrollProcessingContext`, `FinancialTransactionContext`, and `InvestmentContext`.
    -   Refactor `HREngine`, `FinanceEngine`, and `SalesEngine` to use these Context DTOs and Protocols (`ITransactionalEntity`, `ITaxAuthority`).
    -   Remove all raw `agent`, `government`, `household` parameters.

### 3. DTO Standardization & Decision Decoupling (DTO-001)
*   **Target**: `simulation/decisions/` & `modules/simulation/api.py`
*   **Action**:
    -   **`OrderDTO`**: Unify `side` (BUY/SELL) and `item_category`. Remove `StockOrder`.
    -   **`DecisionInputDTO`**: Establish as the sole input for all decision engines.
    -   **`DecisionInputAdapter`**: Create a factory to safely map raw Agent objects to `DecisionInputDTO`.
    -   **`ActionProposalEngine`**: Refactor to strictly DTO-in, DTO-out.

### 4. The Composition Shift (ADR-004)
*   **Target**: `simulation/base_agent.py`, `firms.py`, `core_agents.py`
*   **Action**:
    -   **`InventoryManager`**: [NEW] Create to encapsulate quality-weighted inventory logic.
    -   **Refactor Agents**: Remove `BaseAgent` inheritance from `Household` and `Firm`.
    -   **Composition**: Plug in `Wallet` and `InventoryManager` directly as components.
    -   **Deprecation**: Remove legacy `firm.hr`/`firm.finance` proxies.

---

## üõ°Ô∏è Purity Gates & Verification

1.  **Signature Integrity**: No engine method in `simulation/components/engines/` may take a parameter of type `IAgent` or its subclasses.
2.  **Order Consistency**: All orders generated by the simulation must conform to the new `OrderDTO` schema. `StockOrder` must be purged.
3.  **Isolated Testing**: Engines must be verified using mock Protocols (e.g., `MockTaxAuthority`) without instantiating any Agent class.
4.  **Trace Leak (0.0000%)**: Decomposing `SettlementSystem` must not introduce monetary leaks.

---

## üìã Suggested Jules Missions
- `PH9.3-DECOMP-SETTLEMENT`: Decompose SettlementSystem (High Risk).
- `PH9.3-ENGINE-ABSTRACTION`: Refactor core engines to Context DTOs.
- `PH9.3-DECISION-DTOS`: Standardize OrderDTO and DecisionInput.
- `PH9.3-COMPOSITION-SHIFT`: Migrate Agents to Composition (The Final Strike).
