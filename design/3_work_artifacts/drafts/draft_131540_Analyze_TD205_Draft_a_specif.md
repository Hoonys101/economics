# [SPEC] Phase3_Transaction Decomposition

## 1. Overview

This document specifies the decomposition of the `Phase3_Transaction` God Class into three specialized, single-responsibility handlers. This refactoring addresses the technical debt item `TD-205` by improving modularity, testability, and clarity of the tick lifecycle.

The three new handlers are:
- `Phase_InheritanceHandler`: Processes agent death, asset liquidation, and inheritance transactions.
- `Phase_TaxHandler`: Processes all tax-related transactions.
- `Phase_SettlementHandler`: Processes all other general economic transactions.

These new phases will be integrated into the `TickOrchestrator`'s existing state management protocol, ensuring backward compatibility and preserving state integrity.

---

## 2. ðŸš¨ Risk & Impact Audit (Ref: TD-205)

This design explicitly mitigates the risks identified in the `TD-205` pre-flight audit.

| Risk ID | Risk Summary | Mitigation Strategy |
| :--- | :--- | :--- |
| `TD-205.1` | **State Synchronization Protocol Violation** | All new handlers will implement the `IPhaseStrategy` interface and operate on the transient `SimulationState` DTO provided by the `TickOrchestrator`. They will not directly mutate `WorldState`, adhering to the "Hub-and-Spoke" pattern. |
| `TD-205.2` | **Hidden Inheritance/Liquidation Dependency** | The `Phase_InheritanceHandler`'s sole responsibility is to process transactions from the `inter_tick_queue`. It does not generate them. Its execution is explicitly ordered *after* `Phase_Bankruptcy`, which is responsible for populating the queue. |
| `TD-205.3` | **`TransactionProcessor` God Class** | The new handlers act as "Filtering Facades". They will each filter and partition the master transaction queues, then delegate the core processing logic to the existing `TransactionProcessor`. This avoids duplicating logic while separating concerns. Transaction partitioning (see Section 3) prevents double-processing. |
| `TD-205.4` | **Fragile Phase Ordering** | A new, explicit phase order is defined for the `TickOrchestrator`. This order correctly sequences `Phase_TaxHandler` relative to the pre-existing `Phase_TaxationIntents` to ensure tax calculations are based on correct, end-of-tick data before settlement. |
| `TD-205.5` | **Obsolete Integration Tests** | The Verification Plan (Section 6) includes a mandatory task to refactor existing integration tests. Mocks for the monolithic `Phase3_Transaction` will be replaced with mocks for the new, granular handlers. |

---

## 3. Detailed Design

### 3.1. `Phase_InheritanceHandler`

- **Responsibility**: Manages the financial consequences of agent death. Processes transactions generated by the `LifecycleManager` in `Phase_Bankruptcy`.
- **Input Queue**: `state.inter_tick_queue`
- **Logic (Pseudo-code)**:
  ```python
  def execute(self, state: SimulationState) -> SimulationState:
      # 1. Isolate inheritance/liquidation transactions from the inter-tick queue.
      inheritance_transactions = [
          tx for tx in state.inter_tick_queue
          if tx.type in (TransactionType.INHERITANCE, TransactionType.LIQUIDATION)
      ]

      # 2. Remove these transactions from the queue to prevent reprocessing.
      state.inter_tick_queue = [
          tx for tx in state.inter_tick_queue
          if tx.type not in (TransactionType.INHERITANCE, TransactionType.LIQUIDATION)
      ]

      # 3. Delegate processing to the core processor.
      if inheritance_transactions:
          self.transaction_processor.process_transactions(state, inheritance_transactions)

      # 4. Return the mutated state.
      return state
  ```

### 3.2. `Phase_TaxHandler`

- **Responsibility**: Processes tax payment transactions generated during `Phase_TaxationIntents`.
- **Input Queue**: `state.transactions` (the main transaction queue)
- **Logic (Pseudo-code)**:
  ```python
  def execute(self, state: SimulationState) -> SimulationState:
      # 1. Isolate tax transactions from the main queue.
      tax_transactions = [
          tx for tx in state.transactions if tx.type == TransactionType.TAX
      ]

      # 2. Create a new main queue without the tax transactions.
      remaining_transactions = [
          tx for tx in state.transactions if tx.type != TransactionType.TAX
      ]
      state.transactions = remaining_transactions

      # 3. Delegate processing to the core processor, then record revenue.
      if tax_transactions:
          self.transaction_processor.process_transactions(state, tax_transactions)
          # The taxation system records revenue after successful settlement.
          self.taxation_system.record_revenue(state, tax_transactions)

      # 4. Return the mutated state.
      return state
  ```

### 3.3. `Phase_SettlementHandler`

- **Responsibility**: Processes all remaining general-purpose transactions (e.g., trades, salary payments, benefits). Acts as the final clearing house for the tick's economic activity.
- **Input Queue**: `state.transactions` (already filtered by `Phase_TaxHandler`)
- **Logic (Pseudo-code)**:
  ```python
  def execute(self, state: SimulationState) -> SimulationState:
      # 1. All remaining transactions in the main queue are for general settlement.
      settlement_transactions = state.transactions

      # 2. The queue is now exhausted for this tick. Clear it.
      state.transactions = []

      # 3. Delegate processing to the core processor.
      if settlement_transactions:
          self.transaction_processor.process_transactions(state, settlement_transactions)

      # 4. Return the mutated state.
      return state
  ```

---

## 4. Orchestration & Phase Ordering

The `TickOrchestrator.phases` list must be modified to remove `Phase3_Transaction` and insert the new handlers in the correct sequence.

**Before:**
```python
# TickOrchestrator.phases
[
    ...
    Phase_Bankruptcy,
    Phase_TaxationIntents,
    Phase_Reproduction,
    Phase3_Transaction, # Monolithic God Class
    ...
]
```

**After:**
```python
# TickOrchestrator.phases
[
    ...
    Phase_Bankruptcy,         # MUST run before InheritanceHandler
    Phase_TaxationIntents,    # MUST run before TaxHandler
    Phase_Reproduction,
    Phase_InheritanceHandler, # Processes death/liquidation from inter_tick_queue
    Phase_TaxHandler,         # Processes tax payments from main queue
    Phase_SettlementHandler,  # Processes all other transactions from main queue
    ...
]
```

---

## 5. Interface Specification (`api.py`)

The following new classes will be defined in `modules/finance/api.py`.

```python
class IPhaseStrategy(Protocol):
    def execute(self, state: SimulationState) -> SimulationState: ...

class Phase_InheritanceHandler(IPhaseStrategy):
    """Processes inheritance and liquidation transactions from the inter-tick queue."""
    def __init__(self, transaction_processor: TransactionProcessor): ...

class Phase_TaxHandler(IPhaseStrategy):
    """Processes tax transactions and records revenue."""
    def __init__(self, transaction_processor: TransactionProcessor, taxation_system: TaxationSystem): ...

class Phase_SettlementHandler(IPhaseStrategy):
    """Processes all remaining general economic transactions."""
    def __init__(self, transaction_processor: TransactionProcessor): ...
```

---

## 6. Verification Plan

1.  **Unit Tests**:
    - Each new handler (`Phase_InheritanceHandler`, `Phase_TaxHandler`, `Phase_SettlementHandler`) must have dedicated unit tests.
    - Tests should verify that the correct transactions are filtered from the input `SimulationState` and passed to a mocked `TransactionProcessor`.
    - Tests for `Phase_TaxHandler` must also verify that `taxation_system.record_revenue` is called on success.

2.  **Integration Tests (MANDATORY REFACTOR)**:
    - The existing integration tests that mock `Phase3_Transaction` (e.g., in `tests/integration/test_tick_normalization.py`) **must be updated**.
    - The monolithic mock must be removed and replaced with individual mocks for the three new handlers. This is critical for maintaining test suite integrity.

3.  **Mocking & Golden Data Strategy**:
    - All tests should leverage existing Golden Data fixtures (`golden_households`, `golden_firms`) from `tests/conftest.py` to construct the initial `SimulationState`.
    - **DO NOT** use `MagicMock()` to create agent instances. Use the provided fixtures to ensure type safety.

---

## 7. Mandatory Reporting & Tech Debt

- **Insight Logging**: All developers implementing these changes must log any discovered issues or insights in `communications/insights/[Mission_Key].md`.
- **New Tech Debt Item**:
    - **ID**: `TD-206`
    - **Description**: "Refactor integration tests dependent on `Phase3_Transaction`."
    - **Justification**: The decomposition specified herein renders existing integration tests that mock the monolithic `Phase3_Transaction` obsolete. A dedicated effort is required to update these tests to mock the new granular handlers. This task is created to track that effort.
```
# modules/finance/api.py
from typing import Protocol
from dataclasses import dataclass

# Assume these DTOs and systems are defined elsewhere, e.g., in core.dtos
# and other module APIs. This is for illustrative purposes.

@dataclass
class Transaction:
    """A placeholder for the transaction DTO."""
    type: str
    amount: float
    # ... other fields

class SimulationState:
    """A placeholder for the main simulation state DTO."""
    transactions: list[Transaction]
    inter_tick_queue: list[Transaction]
    # ... many other fields

class TransactionProcessor:
    """Placeholder for the core transaction processing engine."""
    def process_transactions(self, state: SimulationState, transactions: list[Transaction]):
        ...

class TaxationSystem:
    """Placeholder for the system managing tax logic."""
    def record_revenue(self, state: SimulationState, transactions: list[Transaction]):
        ...

# --- Interface Definition ---

class IPhaseStrategy(Protocol):
    """
    Interface for a phase in the simulation tick cycle.
    Each phase receives the current simulation state and returns the
    modified state.
    """
    def execute(self, state: SimulationState) -> SimulationState:
        """
        Executes the logic for this phase.

        Args:
            state: The current simulation state DTO.

        Returns:
            The simulation state DTO after this phase's modifications.
        """
        ...


# --- New API Classes for Transaction Decomposition ---

class Phase_InheritanceHandler:
    """
    A phase strategy that processes inheritance and asset liquidation transactions.

    This handler specifically drains transactions generated by Phase_Bankruptcy
    from the inter-tick queue and delegates them to the TransactionProcessor.
    """
    def __init__(self, transaction_processor: TransactionProcessor):
        """
        Initializes the handler.

        Args:
            transaction_processor: The central engine for executing transactions.
        """
        self.transaction_processor = transaction_processor

    def execute(self, state: SimulationState) -> SimulationState:
        """
        Filters and processes inheritance-related transactions.

        Args:
            state: The current simulation state DTO.

        Returns:
            The modified simulation state DTO.
        """
        ...


class Phase_TaxHandler:
    """
    A phase strategy that processes tax payment transactions.

    This handler filters tax transactions from the main queue, delegates them
    for processing, and then instructs the TaxationSystem to record the revenue.
    """
    def __init__(self, transaction_processor: TransactionProcessor, taxation_system: TaxationSystem):
        """
        Initializes the handler.

        Args:
            transaction_processor: The central engine for executing transactions.
            taxation_system: The system responsible for tax accounting.
        """
        self.transaction_processor = transaction_processor
        self.taxation_system = taxation_system

    def execute(self, state: SimulationState) -> SimulationState:
        """
        Filters and processes tax-related transactions.

        Args:
            state: The current simulation state DTO.

        Returns:
            The modified simulation state DTO.
        """
        ...


class Phase_SettlementHandler:
    """
    A phase strategy that processes all remaining general economic transactions.

    This acts as the final clearing house for the main transaction queue,
    handling trades, salaries, benefits, etc., after specialized handlers
    (like Tax) have run.
    """
    def __init__(self, transaction_processor: TransactionProcessor):
        """
        Initializes the handler.

        Args:
            transaction_processor: The central engine for executing transactions.
        """
        self.transaction_processor = transaction_processor

    def execute(self, state: SimulationState) -> SimulationState:
        """
        Processes all remaining general transactions in the main queue.

        Args:
            state: The current simulation state DTO.

        Returns:
            The modified simulation state DTO.
        """
        ...
```
