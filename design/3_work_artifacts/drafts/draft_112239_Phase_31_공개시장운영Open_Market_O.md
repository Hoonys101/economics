# Spec: Open Market Operations (OMO) System

## 1. ê°œìš” (Overview)
- **ëª©í‘œ**: ì¤‘ì•™ì€í–‰(ì—­í• ì„ ìˆ˜í–‰í•  ìƒˆë¡œìš´ ì‹œìŠ¤í…œ)ì´ ê³µê°œëœ ì¦ê¶Œ ì‹œìž¥(Security Market)ì—ì„œ êµ­ì±„ë¥¼ ë§¤ë§¤í•˜ì—¬ ì‹œì¤‘ ìœ ë™ì„±ì„ ì¡°ì ˆí•˜ëŠ” ê³µê°œì‹œìž¥ìš´ì˜(OMO) ë©”ì»¤ë‹ˆì¦˜ì„ êµ¬í˜„í•©ë‹ˆë‹¤.
- **í•µì‹¬ ì›ì¹™**:
    - **ì—­í•  ë¶„ë¦¬ (SRP)**: OMO ì‹¤í–‰ ë¡œì§ì„ `Government`ë‚˜ `Bank`ë¡œë¶€í„° ë¶„ë¦¬í•˜ì—¬ `CentralBankSystem`ì´ë¼ëŠ” ì „ë‹´ ëª¨ë“ˆì— ìº¡ìŠí™”í•©ë‹ˆë‹¤.
    - **íŠ¸ëžœìž­ì…˜ ê¸°ë°˜ ë¬´ê²°ì„±**: ëª¨ë“  OMO í™œë™ì€ íŠ¹ìˆ˜ íŠ¸ëžœìž­ì…˜(`omo_purchase`, `omo_sale`)ì„ í†µí•´ ê¸°ë¡ë˜ì–´ì•¼ í•˜ë©°, ì´ëŠ” **ë…¼ì œë¡œì„¬(Non-Zero-Sum)** ìž‘ì—…ìœ¼ë¡œ ëª…ì‹œì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ í†µí™”ëŸ‰ ì›ìž¥ì— ë°˜ì˜ë©ë‹ˆë‹¤.
    - **ê¸°ì¡´ ì¸í”„ë¼ í™œìš©**: ì‹ ê·œ ì‹œìž¥ì„ ë§Œë“¤ì§€ ì•Šê³ , `WO-075`ì—ì„œ êµ¬ì¶•ëœ ê¸°ì¡´ êµ­ì±„ ë° `SecurityMarket` ì¸í”„ë¼ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    - **ìˆœí™˜ ì°¸ì¡° ë°©ì§€**: `Government`ì˜ ì •ì±… ê²°ì •ê³¼ `CentralBankSystem`ì˜ ì‹¤í–‰ì€ `OMOInstructionDTO`ë¼ëŠ” ë°ì´í„° ê°ì²´ë¥¼ í†µí•´ ë¶„ë¦¬ë˜ì–´, ì§ì ‘ì ì¸ ìƒí˜¸ í˜¸ì¶œì„ ë°©ì§€í•©ë‹ˆë‹¤.

## 2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ (System Architecture)
- **ì£¼ìš” ì»´í¬ë„ŒíŠ¸**:
    - **`Government`**: `TaylorRulePolicy` ë“± ì •ì±… ì—”ì§„ì„ í†µí•´ OMO ì‹¤í–‰ ì—¬ë¶€ì™€ ê·œëª¨ë¥¼ **ê²°ì •(Decide)**í•©ë‹ˆë‹¤.
    - **`OMOInstructionDTO`**: `Government`ê°€ ìƒì„±í•˜ëŠ” OMO ì§€ì‹œì„œ. `operation_type` ('purchase' ë˜ëŠ” 'sale')ê³¼ `target_amount`ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
    - **`Orchestrator` (e.g., `TickScheduler`)**: `Government`ë¡œë¶€í„° `OMOInstructionDTO`ë¥¼ ìˆ˜ì‹ í•˜ì—¬ `CentralBankSystem`ìœ¼ë¡œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.
    - **`CentralBankSystem`**: OMO ì§€ì‹œë¥¼ ë°›ì•„ `SecurityMarket`ì— ì‹¤ì œ ë§¤ë§¤ ì£¼ë¬¸ì„ ìƒì„±í•˜ê³  **ì‹¤í–‰(Execute)**í•˜ëŠ” ìœ ì¼í•œ ì£¼ì²´ìž…ë‹ˆë‹¤.
    - **`SecurityMarket`**: êµ­ì±„ê°€ ê±°ëž˜ë˜ëŠ” ì‹œìž¥.
    - **`SettlementSystem`**: `omo_purchase`/`omo_sale` íŠ¸ëžœìž­ì…˜ì„ ì²˜ë¦¬í•˜ê³ , í™”íì˜ ìƒì„±/ì†Œë©¸ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

- **í”„ë¡œì„¸ìŠ¤ íë¦„**:
    1. **ì •ì±… ê²°ì •**: `Government.make_policy_decision()`ì´ ì‹œìž¥ ìƒí™©ì„ ë¶„ì„í•˜ì—¬ `OMOInstructionDTO`ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    2. **ì§€ì‹œ ì „ë‹¬**: `Orchestrator`ê°€ DTOë¥¼ `CentralBankSystem`ì— ì „ë‹¬í•©ë‹ˆë‹¤.
    3. **ì£¼ë¬¸ ìƒì„±**: `CentralBankSystem`ì€ DTOë¥¼ í•´ì„í•˜ì—¬ `SecurityMarket`ì— êµ­ì±„ ë§¤ìˆ˜ ë˜ëŠ” ë§¤ë„ `Order`ë¥¼ ì œì¶œí•©ë‹ˆë‹¤. ì´ ë•Œ ì¤‘ì•™ì€í–‰ì€ í™”íë¥¼ ë°œí–‰í•˜ê±°ë‚˜ ì†Œê°í•  ìˆ˜ ìžˆëŠ” ë¬´í•œí•œ ìžì‚°ì„ ê°€ì§„ ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
    4. **ê±°ëž˜ ì²´ê²°**: `SecurityMarket`ì´ ì£¼ë¬¸ì„ ì²´ê²°í•˜ê³  `Transaction` ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    5. **ê²°ì œ ë° í†µí™”ëŸ‰ ì¡°ì ˆ**: `SettlementSystem`ì´ í•´ë‹¹ `Transaction`ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        - **ë§¤ìˆ˜(Purchase) ì‹œ**: êµ­ì±„ë¥¼ íŒë§¤ìžì—ê²Œì„œ ì¤‘ì•™ì€í–‰ìœ¼ë¡œ ì´ì „í•˜ê³ , **ìƒˆë¡œìš´ í™”íë¥¼ ë°œí–‰(Mint)**í•˜ì—¬ íŒë§¤ìžì—ê²Œ ì§€ê¸‰í•©ë‹ˆë‹¤.
        - **ë§¤ë„(Sale) ì‹œ**: êµ­ì±„ë¥¼ ì¤‘ì•™ì€í–‰ì—ì„œ êµ¬ë§¤ìžì—ê²Œ ì´ì „í•˜ê³ , êµ¬ë§¤ìžì—ê²Œì„œ ë°›ì€ í™”íë¥¼ **ì†Œê°(Burn)**í•©ë‹ˆë‹¤.
    6. **ì›ìž¥ ê¸°ë¡**: `Government`ì˜ `total_money_issued` ë˜ëŠ” `total_money_destroyed` ì›ìž¥ì´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.

## 3. ìƒì„¸ ì„¤ê³„ (Detailed Design)

### 3.1. `modules/finance/api.py` (ë˜ëŠ” `modules/central_bank/api.py`)

```python
from typing import TypedDict, Literal, List, Protocol
from simulation.models import Transaction, Order

class OMOInstructionDTO(TypedDict):
    """
    Data Transfer Object for Open Market Operation instructions.
    Generated by a policy engine (e.g., in Government) and consumed by the executor.
    """
    operation_type: Literal['purchase', 'sale']
    target_amount: float
    # Optional: Could add target_price_limit, order_type etc. for more advanced ops
    
class IMonetaryOperations(Protocol):
    """
    Interface for a system that executes monetary operations like OMO.
    """
    def execute_open_market_operation(self, instruction: OMOInstructionDTO) -> List[Order]:
        """
        Takes an instruction and creates market orders to fulfill it.
        
        Args:
            instruction: The DTO containing the operational details.

        Returns:
            A list of Order objects to be placed on the SecurityMarket.
        """
        ...

class ICentralBank(IMonetaryOperations):
    """
    Represents the Central Bank entity, responsible for executing monetary policy.
    """
    id: int
    
    def process_omo_settlement(self, transaction: Transaction) -> None:
        """
        Callback for SettlementSystem to notify the Central Bank about
        a completed OMO transaction, allowing it to update internal state if needed.
        This is primarily for logging and verification. The actual money supply
        update happens in Government's ledger.
        """
        ...
```

### 3.2. `CentralBankSystem` êµ¬í˜„ (Pseudo-code)

```python
# In a new file: modules/finance/central_bank_system.py

class CentralBankSystem(ICentralBank):
    def __init__(self, id: int, security_market_id: str, government: "Government"):
        self.id = id # A unique ID, e.g., -2
        self.security_market_id = security_market_id
        self.government = government # For logging to the central ledger

    def execute_open_market_operation(self, instruction: OMOInstructionDTO) -> List[Order]:
        """Creates buy or sell orders for government bonds."""
        orders = []
        op_type = instruction['operation_type']
        amount = instruction['target_amount']

        # For simplicity, we assume we're trading a generic "government_bond"
        # and place a single large market order.
        # A real implementation might need to query available bonds and prices.
        
        if op_type == 'purchase':
            # To inject liquidity, we buy bonds.
            # We don't need to check assets; the central bank can create money.
            # We set a high price to ensure the order is likely filled.
            order = Order(
                agent_id=self.id,
                order_type='buy',
                item_id='government_bond', # Generic bond ID
                quantity=amount, # This should semantically be based on bond units not cash amount
                # Let's assume quantity = amount / price_estimate
                price=9999, # Buy at any price (market order)
                market_id=self.security_market_id
            )
            orders.append(order)
            
        elif op_type == 'sale':
            # To drain liquidity, we sell bonds.
            # We need to own bonds to sell them. (Assume CB holds them from past operations or issuance)
            order = Order(
                agent_id=self.id,
                order_type='sell',
                item_id='government_bond',
                quantity=amount, # Again, this needs refinement.
                price=0, # Sell at any price (market order)
                market_id=self.security_market_id
            )
            orders.append(order)

        return orders

    def process_omo_settlement(self, transaction: Transaction):
        # The core logic is in SettlementSystem. This is for record-keeping.
        if transaction.transaction_type == 'omo_purchase':
             # The central bank bought bonds, injecting money
             # The government ledger is the source of truth
             self.government.total_money_issued += transaction.price
        elif transaction.transaction_type == 'omo_sale':
             # The central bank sold bonds, destroying money
             self.government.total_money_destroyed += transaction.price
```

### 3.3. `SettlementSystem` ìˆ˜ì • (Pseudo-code)

```python
# In SettlementSystem or its transaction processor
def process_transaction(tx: Transaction):
    # ... existing logic
    if tx.transaction_type == 'omo_purchase':
        # Buyer is CentralBank, Seller is a regular agent
        seller = get_agent(tx.seller_id)
        central_bank = get_agent(tx.buyer_id) # Should be CentralBankSystem

        # 1. Transfer asset (bond) from seller to Central Bank's portfolio
        transfer_security(seller, central_bank, tx.item_id, tx.quantity)
        
        # 2. MINT new money and give to seller
        # THIS IS THE NON-ZERO-SUM PART
        seller.deposit(tx.price) # Magic money appears
        
        # 3. Notify government to update ledger
        # This could also be done via the central_bank.process_omo_settlement callback
        log_monetary_expansion(tx.price)
        
        return True

    elif tx.transaction_type == 'omo_sale':
        # Buyer is a regular agent, Seller is CentralBank
        buyer = get_agent(tx.buyer_id)
        central_bank = get_agent(tx.seller_id)
        
        # 1. Check if buyer has enough funds
        if buyer.assets < tx.price:
            return False # Transaction fails
        
        # 2. BURN money from buyer
        # THIS IS THE NON-ZERO-SUM PART
        buyer.withdraw(tx.price) # Money is destroyed
        
        # 3. Transfer asset (bond) from Central Bank to buyer
        transfer_security(central_bank, buyer, tx.item_id, tx.quantity)
        
        # 4. Notify government to update ledger
        log_monetary_contraction(tx.price)

        return True
    # ... other transaction types
```

## 4. ê²€ì¦ ê³„íš (Verification Plan)
- **Unit Test 1 (`CentralBankSystem`)**: `execute_open_market_operation`ì´ `OMOInstructionDTO`ì— ë”°ë¼ ì •í™•í•œ `Order` ê°ì²´ ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.
- **Integration Test 1 (Liquidity Injection)**:
    1. `Government`ì˜ ì •ì±… ì—”ì§„ì´ ìœ ë™ì„± ê³µê¸‰ì„ ê²°ì •í•˜ê³  `OMOInstructionDTO(operation_type='purchase', ...)`ë¥¼ ìƒì„±í•˜ë„ë¡ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    2. `Orchestrator`ê°€ ì´ DTOë¥¼ `CentralBankSystem`ì— ì „ë‹¬í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    3. `CentralBankSystem`ì´ `SecurityMarket`ì— ë§¤ìˆ˜ ì£¼ë¬¸ì„ ì œì¶œí•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    4. ê±°ëž˜ê°€ ì²´ê²°ë˜ì–´ `omo_purchase` íƒ€ìž…ì˜ `Transaction`ì´ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    5. `SettlementSystem` ì²˜ë¦¬ í›„, ì±„ê¶Œ íŒë§¤ìžì˜ ìžì‚°ì´ `tx.price`ë§Œí¼ ì¦ê°€í•˜ê³ , `Government.total_money_issued`ê°€ ë™ì¼í•œ ê¸ˆì•¡ë§Œí¼ ì¦ê°€í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. ì‹œìŠ¤í…œ ì „ì²´ í†µí™”ëŸ‰ì´ ì •í™•ížˆ `tx.price`ë§Œí¼ ì¦ê°€í–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
- **Integration Test 2 (Liquidity Drain)**: ìœ„ì™€ ìœ ì‚¬í•˜ê²Œ `omo_sale` ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•´ ì‹œìŠ¤í…œ ì „ì²´ í†µí™”ëŸ‰ì´ ì •í™•ížˆ `tx.price`ë§Œí¼ ê°ì†Œí•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.

## 5. Mocking ê°€ì´ë“œ (Mocking Guide)
- `CentralBankSystem`ì˜ ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹œ, `SecurityMarket`ì„ `MagicMock`ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
- í†µí•© í…ŒìŠ¤íŠ¸ ì‹œ, `golden_firms` ë˜ëŠ” `golden_households` í”½ìŠ¤ì²˜ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ­ì±„ë¥¼ ì†Œìœ í•˜ê±°ë‚˜ ë§¤ìˆ˜í•  ì‹œìž¥ ì°¸ì—¬ìžë¡œ í™œìš©í•©ë‹ˆë‹¤. ì¤‘ì•™ì€í–‰ì´ ì´ë“¤ê³¼ ìƒí˜¸ìž‘ìš©í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.

## ðŸš¨ Risk & Impact Audit (ê¸°ìˆ ì  ìœ„í—˜ ë¶„ì„)
- **ìˆœí™˜ ì°¸ì¡° ìœ„í—˜ (Mitigated)**: `Government`ì™€ `CentralBankSystem`ì´ ì§ì ‘ í†µì‹ í•˜ì§€ ì•Šê³ , `Orchestrator`ë¥¼ í†µí•´ `OMOInstructionDTO` ë°ì´í„° ê°ì²´ë¡œ í†µì‹ í•¨ìœ¼ë¡œì¨ ìˆœí™˜ ì°¸ì¡° ìœ„í—˜ì„ ì›ì²œì ìœ¼ë¡œ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.
- **í…ŒìŠ¤íŠ¸ ì˜í–¥ë„ (Identified)**:
    - `SecurityMarket` ê´€ë ¨ í…ŒìŠ¤íŠ¸ëŠ” ìƒˆë¡œìš´ ì°¸ì—¬ìž(`CentralBankSystem`)ì™€ ìƒˆë¡œìš´ ê±°ëž˜ ìœ í˜•(`omo_purchase`/`sale`)ì„ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •ì´ í•„ìš”í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
    - `SettlementSystem` í…ŒìŠ¤íŠ¸ì— `omo_purchase`/`sale` íŠ¸ëžœìž­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” ë…¼ì œë¡œì„¬ ë¡œì§ ê²€ì¦ì´ ì¶”ê°€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
    - `Government`ì˜ ì •ì±… ì—”ì§„ í…ŒìŠ¤íŠ¸ëŠ” ì´ì œ `OMOInstructionDTO`ë¥¼ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
- **ì„¤ì • ì˜ì¡´ì„± (Required)**:
    - `CentralBankSystem`ì„ ìœ„í•œ ê³ ìœ  IDë¥¼ `config` íŒŒì¼ì— ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤ (ì˜ˆ: `CENTRAL_BANK_ID = -2`).
    - OMO ê¸°ëŠ¥ì„ í™œì„±í™”/ë¹„í™œì„±í™”í•˜ëŠ” í”Œëž˜ê·¸(`ENABLE_OMO`)ë¥¼ `simulation.yaml`ì— ì¶”ê°€í•˜ëŠ” ê²ƒì„ ê¶Œìž¥í•©ë‹ˆë‹¤.
- **ì„ í–‰ ìž‘ì—… ê¶Œê³  (Prerequisite)**:
    - **`WO-075` (National Debt Auction)**: ë³¸ ê¸°ëŠ¥ì€ ì‹œìž¥ì—ì„œ ê±°ëž˜ë  êµ­ì±„ê°€ ì¡´ìž¬í•´ì•¼ í•˜ë¯€ë¡œ `WO-075` êµ¬í˜„ì´ ì™„ë£Œë˜ì–´ ìžˆì–´ì•¼ í•©ë‹ˆë‹¤. ë³¸ ì„¤ê³„ëŠ” í•´ë‹¹ ì¸í”„ë¼ê°€ ì¡´ìž¬í•¨ì„ ê°€ì •í•©ë‹ˆë‹¤.
