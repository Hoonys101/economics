# Finance System Double-Entry Integrity Refactor

**Date:** 2026-01-16
**Status:** READY FOR IMPLEMENTATION
**Assignee:** Jules (Implementer)
**Priority:** CRITICAL (Fixes Money Creation/Destruction Bugs)
**Context:** [Double-Entry Audit Report](file:///c:/coding/economics/reports/temp/report_20260116_073516_Analyze__modules_fin.md)

---

## 1. Objective
Refactor `modules/finance/system.py` to strictly enforce **Double-Entry Bookkeeping** principles. 
Currently, `issue_treasury_bonds` (QE path) creates money ("Magic Money") and `grant_bailout_loan` destroys money (Debit but no Credit). 
This Work Order mandates the introduction of a centralized `_transfer` helper to guarantee Zero-Sum monetary operations.

## 2. Scope
1. **Refactor `modules/finance/system.py`**:
 - Implement private `_transfer(debtor, creditor, amount)` helper.
 - Replace all direct `assets` or `cash_reserve` modifications with `_transfer`.
2. **Fix Logic Bugs**:
 - **QE Fix**: When Central Bank buys bonds, correctl deduct cash from `CentralBank.assets`.
 - **Bailout Fix**: When Government grants loan, correctly credit `Firm.cash_reserve`.
3. **Update Interface**:
 - Update `IFinanceSystem` in `modules/finance/api.py`.
4. **Verification**:
 - Create `tests/modules/finance/test_double_entry.py` to verify total money supply invariance.

## 3. Implementation Spec (Zero-Question)
Refer to the detailed specification generated by Gemini:
[FINANCE_REFACTOR_SPEC.md](file:///c:/coding/economics/design/gemini_output/double_entry_refactor_spec.md)

**Key Requirements from Spec:**
- **Helper Signature**: `def _transfer(self, debtor: Any, creditor: Any, amount: float) -> None:`
- **QE Logic**: Central Bank MUST represent a valid Debtor (using its 'cash' asset) even if it means negative cash (or explicit money creation log, but structurally it must be a transfer). *Correction*: For this iteration, assume CB has infinite cash or just track the flow. Spec says: `debtor.assets['cash'] = debtor.assets.get('cash', 0) - amount`.
- **Bailout Logic**: Firm MUST receive the cash. `creditor.cash_reserve += amount`.

## 4. Deliverables
- [ ] Modified `modules/finance/system.py`
- [ ] Updated `modules/finance/api.py`
- [ ] New Test: `tests/modules/finance/test_double_entry.py`
- [ ] Test Report: Verify that Total Economy Value (Gov + Bank + CB + Firms) remains constant after Bailout/QE operations.

---

**Instruction to Jules:**
Execute the changes defined in `design/gemini_output/double_entry_refactor_spec.md`. Ensure existing tests in `tests/modules/finance/test_system.py` still pass (or are updated if they relied on the buggy behavior).
