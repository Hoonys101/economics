# Phase 25 - Stock Exchange Activation (증권 거래소 개장)

**Priority**: HIGH | **Status**: ASSIGNED TO JULES

## Mission
> "잠든 자본 시장을 깨워라. 가계들이 기업의 주인이 되게 하라."

---

## 1. Overview

### 1.1 Core Objectives
1. **Engine Activation**: `engine.py`에 `StockMarket` 통합
2. **IPO Mechanism**: 기업 생성 시 자동 IPO (1000주, Treasury 보유)
3. **Secondary Offering**: 기업 AI가 현금 부족 시 자사주 매도
4. **Household Investment**: 부유한 가계(Assets >= 500)가 `PortfolioManager`를 통해 투자
5. **Tracker Activation**: `StockMarketTracker.track_all_firms` 호출

### 1.2 Market Rules (Architect Prime Decree)
- **Price Limit**: ±15% (Circuit Breaker)
- **Floor Price**: `max(Price * 0.85, 0.01)`
- **Initial Shares**: 1,000주 per Firm
- **Par Value**: `Net_Asset_Value / 1,000`

---

## 2. Implementation Details

### 2.1 engine.py Modifications

**Location**: `simulation/engine.py`

```python
# __init__ 에 추가
from simulation.markets.stock_market import StockMarket
from simulation.metrics.stock_tracker import StockMarketTracker

self.stock_market = StockMarket(config)
self.stock_tracker = StockMarketTracker(config)

# run_tick 내 추가 (가계 결정 이전)
self.stock_market.update_reference_prices(self.active_firms)

# run_tick 내 추가 (모든 시장 매칭 후)
stock_transactions = self.stock_market.match_orders(self.time)
self._process_stock_transactions(stock_transactions)
self.stock_market.clear_expired_orders(self.time)

# 틱 마지막에 추가
self.stock_tracker.track_all_firms(list(self.active_firms.values()), self.stock_market)
```

### 2.2 firms.py - IPO Logic

**Location**: `simulation/firms.py`

```python
# Firm.__init__ 에 추가
self.total_shares: float = 1000.0
self.treasury_shares: float = 1000.0 # 100% Treasury initially

# 창업 시 (또는 별도 init_ipo 메서드)
def init_ipo(self, stock_market: StockMarket):
 """Register firm in stock market order book."""
 par_value = self.assets / 1000.0 if self.assets > 0 else 1.0
 stock_market.update_shareholder(self.id, self.id, self.treasury_shares)
 # Reference price will be set by update_reference_prices
```

### 2.3 firm_ai.py or firms.py - Secondary Offering

**Trigger Condition**: `assets < STARTUP_COST * 0.5` AND `treasury_shares > 0`

```python
def attempt_secondary_offering(self, stock_market: StockMarket, tick: int):
 """Sell treasury shares to raise capital when cash is low."""
 if self.assets >= STARTUP_COST * 0.5:
 return
 if self.treasury_shares <= 0:
 return

 # Sell up to 10% of treasury
 sell_qty = min(self.treasury_shares * 0.10, self.treasury_shares)
 if sell_qty < 1.0:
 return

 price = stock_market.get_stock_price(self.id)
 order = StockOrder(
 agent_id=self.id,
 firm_id=self.id,
 is_buy=False,
 quantity=sell_qty,
 price=price,
 tick_placed=tick
 )
 stock_market.place_order(order, tick)
 logger.info(f"SEO | Firm {self.id} offering {sell_qty:.1f} shares at {price:.2f}")
```

### 2.4 household_ai.py - Portfolio Investment

**Wealth Threshold**: `assets >= 500`
**Risk Aversion Mapping**: 
- STATUS_SEEKER: 0.5 (Risk-loving)
- CONSERVATIVE: 5.0 (Risk-averse)
- Default: 2.0

```python
def attempt_stock_investment(self, household, stock_market, market_data, tick):
 if household.assets < 500:
 return # Survival first

 # Get market metrics
 avg_dividend_yield = market_data.get("avg_dividend_yield", 0.05)
 risk_free_rate = market_data.get("bank_deposit_rate", 0.03)
 survival_cost = household.get_survival_cost()

 # Risk aversion based on personality
 risk_aversion = self._get_risk_aversion(household.personality_type)

 # Optimize allocation
 target_cash, target_deposit, target_equity = PortfolioManager.optimize_portfolio(
 total_liquid_assets=household.assets,
 risk_aversion=risk_aversion,
 risk_free_rate=risk_free_rate,
 equity_return_proxy=avg_dividend_yield,
 survival_cost=survival_cost,
 inflation_expectation=market_data.get("inflation", 0.02)
 )

 # Calculate delta and place orders
 current_equity_value = household.portfolio.get_valuation(stock_market.current_prices)
 equity_delta = target_equity - current_equity_value

 if equity_delta > 10: # Buy threshold
 self._place_buy_orders(household, equity_delta, stock_market, tick)
 elif equity_delta < -10: # Sell threshold
 self._place_sell_orders(household, -equity_delta, stock_market, tick)
```

### 2.5 config.py Updates

```python
# --- Phase 25: Stock Exchange ---
STOCK_MARKET_ENABLED = True
STOCK_PRICE_LIMIT_RATE = 0.15 # ±15% Circuit Breaker
STOCK_ORDER_EXPIRY_TICKS = 5 # Order validity
STOCK_TRANSACTION_FEE_RATE = 0.001 # 0.1% fee
HOUSEHOLD_MIN_ASSETS_FOR_INVESTMENT = 500.0
IPO_INITIAL_SHARES = 1000.0
SEO_TRIGGER_RATIO = 0.5 # Trigger SEO when assets < STARTUP_COST * ratio
SEO_MAX_SELL_RATIO = 0.10 # Max 10% of treasury per tick
```

---

## 3. Verification

### 3.1 Unit Tests
- `test_ipo_share_count`: Verify 1000 shares created at firm init
- `test_seo_triggers`: Cash < threshold → SEO order placed
- `test_household_investment`: Assets >= 500 → optimize_portfolio called
- `test_price_limit`: Verify ±15% cap enforced

### 3.2 Integration Test (Iron Test)
```bash
python scripts/iron_test.py --ticks 200 --scenario stock_market_test
```

**Success Criteria**:
- Daily trading volume > 0 by tick 50
- At least 1 household owns stock by tick 100
- No crashes or assertion errors

---

## 4. Files to Modify

| File | Change |
|------|--------|
| `simulation/engine.py` | Add StockMarket instance and tick integration |
| `simulation/firms.py` | Add IPO init and treasury tracking |
| `simulation/ai/firm_ai.py` | Add SEO decision logic |
| `simulation/ai/household_ai.py` | Add portfolio investment logic |
| `config.py` | Add Phase 25 parameters |
| `tests/test_stock_market.py` | Add unit tests |

---

## 5. Notes

> **CRITICAL**: Do NOT modify `simulation/markets/stock_market.py` or `simulation/portfolio.py` - these are already complete.

> Report any insights (e.g., liquidity issues, price volatility) to `communications/insights/WO-060_insights.md`.
