# Work Order: .1 - Config Factory & Test Infrastructure

**Phase:** Refactoring
**Priority:** CRITICAL
**Prerequisite:** TD-103
**Successor:** .2

## 1. Problem Statement

Core agents contain brittle, manual code for creating configuration DTOs from a monolithic config module. This violates SRP and is a primary source of configuration drift, where changes to DTOs or the config file are not synchronized, leading to runtime errors. Furthermore, the project's testing suite relies on "Golden Sample" data fixtures that are incompatible with the upcoming DTO schema changes, risking catastrophic test failures.

This work order establishes the foundational, automated infrastructure to resolve configuration drift and prepare the testing environment for subsequent refactoring.

## 2. Objective

1. **Implement `ConfigFactory`**: Create a reusable, introspection-based factory to automate the creation of configuration DTOs, eliminating manual mapping.
2. **Implement Configuration Parity Test**: Create a new automated test to ensure that `config.py` and all configuration DTOs remain synchronized. This test will act as a permanent guardrail against configuration drift.
3. **Migrate Golden Sample Fixtures**: Update the underlying data for core test fixtures (e.g., `golden_households`, `golden_firms`) to conform to the new, strictly-typed DTO schemas (`GoodsDTO`, `MarketHistoryDTO`). This is a critical prerequisite for all subsequent testing.

## 3. Implementation Plan

1. **Create `simulation/utils/config_factory.py`**: Implement the `create_config_dto` function as specified in `-Wall.md`, section 3.1.
2. **Create Unit Test for `ConfigFactory`**: In `tests/utils/test_config_factory.py`, create a test using a mock config object and a sample DTO to verify the factory correctly populates DTOs and raises `AttributeError` for missing configs.
3. **Create Configuration Parity Test**:
 * Create a new test file `tests/test_config_parity.py`.
 * This test will import the real `config` module and the `HouseholdConfigDTO` and `FirmConfigDTO`.
 * It will programmatically iterate through the fields of each DTO and assert that a corresponding uppercase attribute exists on the `config` module. This test must fail if a new field is added to a config DTO without updating the main config file.
4. **Harvest & Migrate Golden Samples**:
 * **Analyze**: Inspect the data structure of existing golden samples (e.g., in `design/snapshots/` or referenced by `scripts/fixture_harvester.py`).
 * **Update Harvester**: Modify `scripts/fixture_harvester.py` or create a new script to transform the old, dictionary-based data structures into the new `GoodsDTO` and `MarketHistoryDTO` formats.
 * **Regenerate**: Run the updated script to generate new golden sample files. This ensures fixtures like `golden_households` will provide data in the correct, new format for future tests.

## 4. Verification

- All new unit tests in `tests/utils/test_config_factory.py` must pass.
- The new `tests/test_config_parity.py` must pass, successfully validating the current configuration state.
- Execution of the fixture harvesting script must complete without errors, and the output files must reflect the new, nested DTO structures.

## 5. ðŸš¨ Risk & Impact Audit

- **Risk**: The `test_config_parity` test may immediately fail if the current `config.py` is already out of sync with its DTOs. This is an expected and desired outcome, as it exposes existing technical debt that must be resolved within this work order.
- **Dependency**: All subsequent work orders (.2, 135.3, 135.4) are critically dependent on the successful completion of the Golden Sample migration in this WO. Failure to complete this step will block all future testing.
- **Principle**: This work order directly enforces the "No Mock-Magic" and "Schema Change Notice" protocols outlined in `PROTOCOL_ENGINEERING.md` and `spec_writer.md`.
