# Design Spec: D_TRACK_CHARLIE_REMEDIATION (Education System)

## 1. Objective

This document outlines the test plan to remediate **TD-114 (Sparse System Tests)** by creating a comprehensive, robust, and maintainable test suite for the `MinistryOfEducation` system.

The primary goals are:
1.  **Achieve Test Coverage**: Implement unit and integration tests for the `run_public_education` function, covering all major logic paths, including basic education grants and scholarships.
2.  **Mitigate Architectural Risks**: Design tests that are decoupled from stateful, "God-Class" objects, directly addressing the concerns raised in **TD-108 (Stateful Engine Violation)** and **TD-103/107 (Leaky Abstractions)**.
3.  **Future-Proofing**: Align the testing strategy with the project's stated goal of a DTO-driven architecture (**TD-117**), ensuring test longevity through planned refactoring.
4.  **Verify System Integrity**: Validate the two-stage process of transaction generation and settlement, respecting the principle of **TD-109 (Sacred Sequence Violation)**.

---

## 2. Testing Strategy: A Two-Level Approach

To isolate logic and verify end-to-end behavior, we will implement two distinct levels of tests.

### Level 1: Unit Tests (Transaction Generation Logic)

-   **Focus**: Verify that the `MinistryOfEducation.run_public_education` function generates the correct `Transaction` objects based on a given state.
-   **Methodology**:
    -   Input: DTO-like mock objects representing households and the government.
    -   Action: Call `run_public_education`.
    -   Assertion: Assert against the properties of the `Transaction` objects in the returned list (e.g., `buyer_id`, `seller_id`, `price`, `item_id`, `metadata`).
-   **Benefit**: Isolates the system's decision-making logic from any external dependencies or subsequent processing steps.

### Level 2: Integration Tests (End-to-End State Verification)

-   **Focus**: Verify that the transactions generated by the system lead to the correct final state for all involved agents.
-   **Methodology**:
    1.  Input: The same DTO-like mock objects from the unit tests.
    2.  Action 1: Call `run_public_education` to get the list of transactions.
    3.  Action 2: Pass these transactions to a `FakeTransactionProcessor`.
    4.  Assertion: Assert against the final state of the mock household and government objects (e.g., `agent.assets`, `agent.education_level`, `government.assets`).
-   **Benefit**: Confirms the system's intended economic impact is correctly realized, validating the entire workflow from decision to settlement.

---

## 3. Test Harness & Mocking Strategy

To avoid brittle tests and adhere to architectural principles, the following mocking strategy is mandated.

-   **Use Test Doubles, Not Real Objects**:
    -   All `Household` and `Government` objects will be replaced with simple test doubles (e.g., Python's `SimpleNamespace` or a lightweight dataclass). This prevents dependency on the complex internal state of the actual simulation models.
    -   **Example Household Double**: `SimpleNamespace(id=1, assets=1000, education_level=0, aptitude=0.8, is_active=True)`

-   **FakeTransactionProcessor**:
    -   A simple, in-test `FakeTransactionProcessor` will be created. It will have a method like `process(transactions, agents_by_id)` that iterates through transactions and updates the `assets` of the corresponding agent doubles. This is critical for Level 2 tests.

-   **Mock System Dependencies**:
    -   `reflux_system` and `settlement_system` will be simple mocks, primarily providing an `id` to act as the `seller_id` in transactions.

---

## 4. Test Cases

The following test cases will be implemented for both Unit (Level 1) and Integration (Level 2) levels.

### 4.1. Basic Education (Level 1 Grant)

| Case ID | Scenario | Expected Outcome (Unit Test) | Expected Outcome (Integration Test) |
| :--- | :--- | :--- | :--- |
| **EDU-01** | Sufficient budget for all households. | One `education_level_1` transaction is generated for each active household. | Each agent's `education_level` becomes 1. Government assets decrease by `cost * num_agents`. |
| **EDU-02** | Insufficient budget for all, but enough for some. | Transactions are generated until the budget is depleted. | Agents are educated sequentially until budget runs out. |
| **EDU-03** | Zero budget. | No transactions are generated. | No state changes occur. |
| **EDU-04** | No active households. | No transactions are generated. | No state changes occur. |

### 4.2. Scholarship (Advanced Education)

| Case ID | Scenario | Expected Outcome (Unit Test) | Expected Outcome (Integration Test) |
| :--- | :--- | :--- | :--- |
| **EDU-10** | **Qualifying Scholar**: Poor, high-aptitude household with sufficient personal funds for their share. | Two transactions are generated: one `_subsidy` (from govt) and one `_tuition` (from agent). | Agent's `education_level` increments. Agent's assets decrease by their share. Govt assets decrease by the subsidy amount. |
| **EDU-11** | **Non-Qualifying (Rich)**: Rich, high-aptitude household. | No scholarship transactions are generated. | No state changes occur. |
| **EDU-12** | **Non-Qualifying (Low Aptitude)**: Poor, low-aptitude household. | No scholarship transactions are generated. | No state changes occur. |
| **EDU-13** | **Non-Qualifying (Broke)**: Poor, high-aptitude, but cannot afford their 20% share. | No scholarship transactions are generated. | No state changes occur. |
| **EDU-14** | **Budget Exhaustion**: A qualifying scholar is evaluated after the scholarship budget has been spent. | No scholarship transactions are generated for this agent. | No state changes occur for this agent. |

---

## 5. Implementation Plan

-   **File Location**: `tests/system/test_education_system.py`
-   **Fixtures**:
    -   Test configuration values (costs, budget ratios) will be managed within the test file.
    -   Helper functions will be created to generate the required test doubles for households and government, e.g., `create_mock_household(...)`.
-   **Initial Focus**: Implement the test cases for `MinistryOfEducation` as defined above. The same pattern will then be applied to create similar test specs for the Housing and Labor market systems as part of the broader **TD-114** remediation.
