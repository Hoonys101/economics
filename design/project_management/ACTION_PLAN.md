# 프로젝트 실행 계획: "살아있는 디지털 경제" 구축

## 1. 프로젝트 청사진 (Overall Blueprint)

이 프로젝트의 최종 목표는 단순한 시뮬레이션을 넘어, **AI 에이전트들이 스스로 학습하고 적응하며 진화하는 "디지털 트윈(Digital Twin)" 경제 생태계**를 구축하는 것입니다.

### 4대 핵심 기둥 (4 Key Pillars):

1.  **견고한 경제 엔진 (Robust Economic Engine):**
    *   **설명:** 모든 경제 활동의 기반. 현실적인 상품/노동 시장, 에이전트의 생애주기(창업/폐업, 출생/사망), 신뢰할 수 있는 거시 경제 지표(GDP, 실업률, 물가)가 안정적으로 동작하는 시스템입니다.
    *   **현재 상태:** **노동 시장 활성화 및 가계 소비 문제 해결 완료.**
    *   **이전 상태:** **가장 시급한 개선 영역.** 노동 시장이 멈춰있는 등 핵심 기능의 불안정성 해소가 최우선 과제였습니다.

2.  **적응형 AI 에이전트 (Adaptive AI Agents):**
    *   **설명:** 프로젝트의 핵심 혁신. 가계와 기업이 하드코딩된 규칙이 아닌, 강화학습과 모방학습을 통해 자신만의 생존 및 성장 전략을 발전시킵니다. 성공한 다른 에이전트를 모방하고, 변화하는 시장 상황에 맞춰 의사결정을 동적으로 수정합니다.
    *   **현재 상태:** AI 모델의 기본 골격은 존재하나, 의사결정 로직과의 연동 및 학습 메커니즘의 고도화가 필요합니다.

3.  **확장 가능한 세계 모델 (Extensible World Model):**
    *   **설명:** 시뮬레이션의 세계관을 확장할 수 있는 유연한 구조. 정부(세금, 보조금), 금융 시장(대출, 투자), 기술 발전(R&D) 등 새로운 경제 주체와 시스템을 손쉽게 추가할 수 있어야 합니다.
    *   **현재 상태:** 현재는 가계/기업만 존재. 확장을 위한 기반 설계가 필요합니다.

4.  **통찰력 있는 분석 및 UI (Insightful Analytics & UI):**
    *   **설명:** 복잡한 시뮬레이션 결과를 이해하고 실험하기 위한 창구. 단순 데이터 표시를 넘어, 부의 분배(지니 계수), 산업 구조 변화 등 거시 경제 현상을 시각적으로 분석하고, 다양한 "What-if" 시나리오를 실험할 수 있는 환경을 제공합니다.
    *   **현재 상태:** 기본적인 UI 골격은 있으나, 데이터 표시 오류가 있고 분석 기능이 거의 없습니다.

---

## 2. 단계별 실행 계획 (Phased Approach)

### Phase 0: 기반 안정화 (Foundation Stabilization) - 즉시 실행

*   **목표:** 현재 멈춰있는 시뮬레이션의 핵심 기능을 정상화하여, 신뢰할 수 있는 실험의 기반을 마련합니다.
*   **주요 과업:**
    1.  **로깅 시스템 정상화:** 디버깅을 위한 로그 필터링 기능 구현 및 멀티프로세싱 오류 수정.
    2.  **노동/상품 시장 활성화:** 기업의 고용과 가계의 소비가 정상적으로 발생하는지 확인하고 관련 로직을 디버깅.
    3.  **핵심 지표 검증:** 실업률, 평균 임금, 평균 자산 등 UI에 표시되는 모든 지표의 정확성 확보.
*   **완료 조건:** 시뮬레이션이 100틱 이상 안정적으로 실행되며, 모든 핵심 경제 지표가 비정상적인 값(0 또는 100%)이 아닌 유의미한 값을 보이는 상태.

### Phase 1: AI 통합 및 고도화 (AI Integration & Refinement)

*   **목표:** AI 에이전트가 단순 반응을 넘어, 학습을 통해 지능적으로 행동하게 만듭니다.
*   **주요 과업:**
    1.  의사결정 엔진 리팩토링 (규칙 기반 vs AI 기반 로직 분리).
    2.  성공적인 에이전트를 따라하는 '모방 학습' 메커니즘 구현 및 검증.
    3.  다양한 시나리오(호황, 불황)를 통해 AI 모델을 학습시켜 다채로운 에이전트 행동 패턴 확보.

### 최근 진행 상황 (2025년 9월 29일)

*   **AI 에이전트 지능 고도화:**
    *   **가계 AI (`HouseholdAI`):**
        *   전략적 상태 (`_get_strategic_state`)를 자산 및 욕구 수준에 따라 5단계로 이산화하여 정교화했습니다.
        *   전술적 상태 (`_get_tactical_state`)를 생존, 사회적 욕구, 자산 증식, 능력 향상 등 다양한 의도에 맞춰 시장 데이터(구매 여력, 노동 시장 상황 등)를 기반으로 구체화했습니다.
        *   보상 함수 (`_calculate_reward`)에 가중치를 도입하여 생존 욕구 충족에 높은 우선순위를 부여하고, 파산 시 큰 페널티를 부과하도록 고도화했습니다.
        *   **완료:** `AIDecisionEngine`과의 순환 참조 문제를 해결하고, `HouseholdDecisionEngine`에서 사치품 및 교육 서비스 시장 데이터를 AI에 제공하도록 업데이트하여 AI 기반 가계 소비 의사결정 로직을 강화했습니다.
        *   `Tactic` enum에 `DO_NOTHING`을 추가하여 AI의 의사결정 유연성을 높였습니다.
        *   `food_price` 접근 방식을 `market_data['goods_market']['food_current_sell_price']`로 수정하여 정확한 시장 데이터를 활용하도록 개선했습니다.
    *   **기업 AI (`FirmAI`):**
        *   전략적 상태 (`_get_strategic_state`)를 자산, 이윤, 시장 점유율, 재고 수준에 따라 여러 단계로 이산화하여 정교화했습니다.
        *   전술적 상태 (`_get_tactical_state`)를 이윤 극대화, 시장 점유율 확대, 생산성 향상 등 다양한 의도에 맞춰 시장 데이터(수요-공급 비율, 경쟁사 가격, 투자 여력 등)를 기반으로 구체화했습니다.
        *   보상 함수 (`_calculate_reward`)에 가중치를 도입하여 이윤 변화와 시장 점유율 변화를 함께 고려하고, 손실 및 파산에 대한 페널티를 부과하도록 고도화했습니다.
        *   `Firm` 클래스에 `get_agent_data()` 메서드를 구현하여 에이전트 데이터 접근 일관성을 확보했습니다.
        *   로깅 `extra` 파라미터 형식을 수정하여 로그 가독성과 정확성을 높였습니다.

*   **시뮬레이션 엔진 안정화 및 버그 수정:**
    *   `market.place_order()` 호출에 `current_time` 인자를 추가하여 시장 주문 처리의 정확성을 높였습니다.
    *   `EconomicIndicatorTracker` 초기화 시 `config_module`을 전달하도록 수정하여 경제 지표 추적의 일관성을 확보했습니다.
    *   `Bank` 객체에 대한 `is_active` 접근 오류를 `isinstance(agent, BaseAgent)` 체크 로직으로 수정하고 `BaseAgent`를 임포트하여 시뮬레이션 루프의 안정성을 강화했습니다.
    *   `config.py`에서 `LIQUIDITY_NEED_INCREASE_RATE` 설정을 활성화하여 유동성 관리 로직을 정상화했습니다.
    *   **생산량 0 문제 해결을 확인했습니다. 기업들이 정상적으로 재화를 생산하고 있습니다.**

*   **에이전트 생명주기 및 복제 메커니즘 설계:**
    *   파산 에이전트(가계, 기업)를 성공 에이전트의 복제본으로 대체하는 '도태 및 복제' 메커니즘에 대한 상세 설계 문서 (`design/project_management/agent_lifecycle_and_cloning_design.md`)를 생성했습니다. 이 설계는 복제 로직의 모듈화를 포함합니다.
    *   `BaseAgent` 클래스에 `clone()` 추상 메서드를 추가하여, 모든 에이전트가 복제 기능을 구현해야 함을 강제하는 계약을 정의했습니다.

*   **코드 품질 개선 (Ruff Linting):**
    *   `ruff check . --fix`를 실행하여 코드 스타일 및 잠재적 오류를 점검했습니다.
    *   **모든 `ruff` 오류를 성공적으로 수정했습니다. 현재 코드는 `ruff` 검사에서 깨끗합니다.**

### 현재 작업: 로깅 시스템 리팩토링 및 DB 통합

**목적:**
*   시뮬레이션 진행 상황 출력(예: `print` 또는 `logging.info`)과 에이전트의 의사결정, 상태 변화, 시장 활동 등 상세 시뮬레이션 데이터를 분리합니다.
*   상세 시뮬레이션 데이터를 구조화된 데이터베이스 형식으로 저장하여 분석 및 시각화를 용이하게 합니다.
*   각 시뮬레이션 실행 시 데이터베이스를 초기화하여 실험의 독립성을 보장합니다.
*   오류 및 경고 메시지를 표준 `logging` 모듈로 전환하여 더 나은 오류 처리 및 제어 기능을 제공합니다.

**진행 현황 체크리스트:**

1.  **DBManager에 `reset_database()` 메서드 추가 및 통합:**
    *   **목표:** 시뮬레이션 시작 시 데이터베이스를 초기화하여 매 실행이 독립적인 분석이 가능하도록 함.
    *   **구체적인 방법:**
        *   `simulation/db/db_manager.py` 파일에 `reset_database()` 메서드 추가 (모든 테이블 삭제 후 재생성).
        *   `main.py` 파일에서 `DBManager` 초기화 후 `reset_database()` 호출.
    *   **진행 현황:** ✅ 완료

2.  **`simulation/` 디렉토리 내 `print()` 문 리팩토링:**
    *   **목표:** 에이전트의 의사결정, 상태 변화, 시장 활동 등 상세 시뮬레이션 데이터를 `print()` 대신 `DBManager`를 통해 데이터베이스에 저장하고, 오류/경고 메시지는 `logging` 모듈로 전환.
    *   **구체적인 방법:**
        *   **오류/경고 메시지 `print()` -> `logging` 전환:**
            *   `simulation/ai/q_table_manager.py` 파일 내 `print()` 문을 `logging.error()` 또는 `logging.warning()`으로 전환.
            *   `simulation/db/db_manager.py` 파일 내 `print()` 문을 `logging.error()`로 전환.
            *   `simulation/db/repository.py` 파일 내 `print()` 문을 `logging.error()`로 전환.
        *   **시뮬레이션 런타임 데이터 `print()` -> `DBManager` 저장 로직으로 전환:**
            *   `simulation/` 디렉토리 내에서 에이전트의 의사결정, 상태 변화, 시장 활동을 출력하는 `print()` 문 식별.
            *   해당 `print()` 문을 `DBManager`의 `save_ai_decision()`, `save_agent_state()`, `save_transaction()` 등의 적절한 메서드 호출로 대체.
            *   `decision_details` 필드(JSON)에 `tactic`, `reason` 등 상세 컨텍스트 포함.
    *   **진행 현황:**
        *   `simulation/ai/q_table_manager.py`의 `print()` 문 `logging` 전환: ✅ 완료
        *   `simulation/db/db_manager.py`의 `print()` 문 `logging` 전환: ✅ 완료
        *   `simulation/db/repository.py`의 `print()` 문 `logging` 전환: ✅ 완료
        *   `simulation/db/db_manager.py`의 `if __name__ == '__main__':` 블록 내 `print()` 문 `logging` 전환: ✅ 완료
        *   시뮬레이션 런타임 데이터 `print()` -> `DBManager` 저장 로직 전환: ⬜ 미완료

### Phase 2: 세계 확장 (World Expansion)

*   **목표:** 정부, 금융 등 새로운 시스템을 도입하여 경제 생태계를 더욱 현실적으로 만듭니다.
*   **주요 과업:**
    1.  `정부` 에이전트 도입 (세금 징수, 실업 수당 지급 기능).
    2.  기본적인 `금융 시장` 구현 (에이전트 간 대출 기능).
    3.  기업의 `R&D` 활동과 생산성 향상 모델 구현.

---

## 3. TODO 리스트 (Actionable TODO List) - Phase 0

가장 시급한 **Phase 0**를 완수하기 위한 구체적인 작업 목록입니다.

-   [x] **1. (버그) 로깅 시스템 수정:**
    -   **위치:** `utils/logger.py`
    -   **내용:** `__setstate__` 메서드를 수정하여 멀티프로세싱 환경에서 발생하는 핸들러 중복 문제를 해결한다.

-   [x] **2. (기능) 설정 기반 로그 필터링 구현:**
    -   **위치:** `utils/logger.py`, `config.py`, `run_experiment.py`
    -   **내용:**
        -   `logger.py`: 로그 타입을 외부 리스트로 설정하는 `set_allowed_log_types()` 메서드 추가.
        -   `config.py`: 허용할 로그 목록을 정의하는 `ALLOWED_LOG_TYPES` 리스트 변수 추가.
        -   `run_experiment.py` (또는 main): 시작 시 `config.py` 설정을 로거에 적용하는 로직 추가.

-   [x] **3. (버그) 노동 시장 활성화:**
    -   **위치:** `firm_decision_engine.py`, `simulation/markets_v2.py`
    -   **내용:** 수정된 로거를 사용하여 `HiringCheck`, `OrderPlacement` 등의 로그가 정상적으로 생성되는지 확인하고, 기업의 구인 주문이 시장에 제출되는 과정을 추적하여 막혀있는 부분을 해결한다.

-   [x] **4. (검증) 핵심 지표 확인:**
    -   **위치:** `analyze_results.py`, `app.py`
    -   **내용:** 노동 시장 활성화 후, 시뮬레이션을 실행하여 `unemployment_rate`와 `avg_wage`가 유의미한 값을 갖는지 최종 확인한다. **확인 결과: 노동 시장은 활성화되었으나, 가계의 소비 활동이 전혀 이루어지지 않아 자산이 감소하고 있습니다. 이는 다음 해결 과제입니다.**

-   [x] **5. (문서) 기획 문서 업데이트:**
    -   **위치:** `design/ACTION_PLAN.md`
    -   **내용:** 현재 논의된 청사진과 TODO 목록을 문서에 정리하여 팀의 목표를 동기화한다.

-   [x] **6. (버그) 가계 소비 문제 해결:**
    -   **문제 정의:** 시뮬레이션 초기 단계에서 가계 에이전트의 소비 활동이 전혀 이루어지지 않아 `total_consumption` 지표가 0으로 나타나던 문제.
    -   **해결 내용:** `simulation/engine.py`의 `Simulation.run_tick` 메서드 내 임시 가계 소비 로직을 제거하고, `HouseholdDecisionEngine`이 가계의 소비 결정을 담당하도록 통합했습니다. 이로써 가계의 기본적인 소비 활동이 AI 기반으로 처리됩니다. 또한, `simulation/engine.py`에서 `HouseholdDecisionEngine.make_decisions` 호출 시 `current_time`을 전달하도록 수정했습니다.
    -   **다음 과제:** `HouseholdDecisionEngine` 내에서 AI가 다른 욕구(인정, 성장)에 대한 소비를 결정하도록 로직을 고도화하는 것이 필요합니다.