============================= test session starts =============================
collected 4 items

tests/integration/test_cockpit_integration.py::test_simulation_processes_pause_resume 
-------------------------------- live log call --------------------------------
INFO     simulation.engine:engine.py:118 Simulation PAUSED by command.
FAILED                                                                   [ 25%]
tests/integration/test_cockpit_integration.py::test_simulation_processes_set_base_rate FAILED [ 50%]
tests/integration/test_cockpit_integration.py::test_simulation_processes_set_tax_rate FAILED [ 75%]
tests/integration/test_tick_normalization.py::TestTickNormalization::test_run_tick_executes_phases PASSED [100%]

================================== FAILURES ===================================
___________________ test_simulation_processes_pause_resume ____________________

mock_simulation_deps = (<MagicMock name='mock.config_manager' id='2006522990608'>, <MagicMock id='2006522990944'>, <MagicMock id='20065229912...ock name='mock.global_registry' id='2006522991952'>, <MagicMock name='mock.settlement_system' id='2006522992288'>, ...)

    def test_simulation_processes_pause_resume(mock_simulation_deps):
        cm, config_module, logger, repo, registry, settlement_system, agent_registry, ws = mock_simulation_deps
    
        with pytest.MonkeyPatch.context() as m:
            m.setattr("simulation.engine.WorldState", MagicMock(return_value=ws))
            m.setattr("simulation.engine.ActionProcessor", MagicMock())
            m.setattr("simulation.engine.TickOrchestrator", MagicMock())
            m.setattr("simulation.engine.SimulationLogger", MagicMock())
    
            # Mocks for new dependencies
            reg = MagicMock(spec=IGlobalRegistry)
            settle = MagicMock(spec=ISettlementSystem)
            agent_reg = MagicMock(spec=IAgentRegistry)
            cmd_service = MagicMock(spec=CommandService)
    
            sim = Simulation(cm, config_module, logger, repo, registry, settlement_system, agent_registry, cmd_service)
            # Force world_state to be our mock
            sim.world_state = ws
    
            # Verify initial state
            assert sim.is_paused is False
    
            # Enqueue PAUSE (using new DTO format)
            cmd = GodCommandDTO(
                command_type="PAUSE_STATE",
                target_domain="System",
                parameter_key="pause",
                new_value=True,
                command_id=uuid4()
            )
            ws.command_queue.put(cmd)
    
            # Run tick (should process command locally in _process_commands)
>           sim.run_tick()

tests\integration\test_cockpit_integration.py:76: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\engine.py:176: in run_tick
    self._process_commands()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.engine.Simulation object at 0x000001D32E172BA0>

    def _process_commands(self) -> None:
        """Processes all pending commands from the world state command queue."""
        # Check External Queue (from Dashboard/Server)
        if hasattr(self.world_state, "command_queue") and self.world_state.command_queue:
            while not self.world_state.command_queue.empty():
                try:
                    cmd = self.world_state.command_queue.get_nowait()
    
                    # Handle Control Commands locally
                    # Map PAUSE_STATE to Pause/Resume
                    if cmd.command_type == "PAUSE_STATE":
                        # new_value should be boolean: True = Pause, False = Resume
                        should_pause = bool(cmd.new_value)
                        self.is_paused = should_pause
                        logger.info(f"Simulation {'PAUSED' if should_pause else 'RESUMED'} by command.")
    
                    # Map TRIGGER_EVENT: STEP
                    elif cmd.command_type == "TRIGGER_EVENT" and cmd.parameter_key == "STEP":
                        self.step_requested = True
                        logger.info("Simulation STEP requested.")
    
                    # Forward everything else (including other TRIGGER_EVENTs) to God Command Queue for Phase 0
                    else:
                        if hasattr(self.world_state, "god_command_queue"):
                            self.world_state.god_command_queue.append(cmd)
                except Exception:
                    break
    
        # Also drain god_command_queue if it's being used for ingestion
        if hasattr(self.world_state, "god_command_queue") and self.world_state.god_command_queue:
            while self.world_state.god_command_queue:
                commands.append(self.world_state.god_command_queue.popleft())
    
>       if not commands:
               ^^^^^^^^
E       NameError: name 'commands' is not defined

simulation\engine.py:137: NameError
------------------------------ Captured log call ------------------------------
INFO     simulation.engine:engine.py:118 Simulation PAUSED by command.
___________________ test_simulation_processes_set_base_rate ___________________

mock_simulation_deps = (<MagicMock name='mock.config_manager' id='2006521512352'>, <MagicMock id='2006521512688'>, <MagicMock id='20065215130...ock name='mock.global_registry' id='2006521513696'>, <MagicMock name='mock.settlement_system' id='2006521514032'>, ...)

    def test_simulation_processes_set_base_rate(mock_simulation_deps):
        cm, config_module, logger, repo, registry, settlement_system, agent_registry, ws = mock_simulation_deps
    
        with pytest.MonkeyPatch.context() as m:
            m.setattr("simulation.engine.WorldState", MagicMock(return_value=ws))
            m.setattr("simulation.engine.ActionProcessor", MagicMock())
            m.setattr("simulation.engine.TickOrchestrator", MagicMock())
            m.setattr("simulation.engine.SimulationLogger", MagicMock())
    
            cmd_service = MagicMock(spec=CommandService)
            sim = Simulation(cm, config_module, logger, repo, registry, settlement_system, agent_registry, cmd_service)
            sim.world_state = ws
    
            # Enqueue SET_PARAM central_bank.base_rate
            cmd = GodCommandDTO(
                command_type="SET_PARAM",
                target_domain="CentralBank",
                parameter_key="central_bank.base_rate",
                new_value=0.15,
                command_id=uuid4()
            )
            ws.command_queue.put(cmd)
    
            # Enqueue SET_BASE_RATE via SET_PARAM
            cmd = GodCommandDTO(
                command_type="SET_PARAM",
                target_domain="CentralBank",
                parameter_key="base_rate",
                new_value=0.15
            )
            ws.command_queue.put(cmd)
    
            # Run tick
            # Note: Since TickOrchestrator is mocked, it won't execute Phase 0.
            # We verify that Simulation forwarded the command to god_command_queue.
>           sim.run_tick()

tests\integration\test_cockpit_integration.py:128: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\engine.py:176: in run_tick
    self._process_commands()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.engine.Simulation object at 0x000001D32E0C47D0>

    def _process_commands(self) -> None:
        """Processes all pending commands from the world state command queue."""
        # Check External Queue (from Dashboard/Server)
        if hasattr(self.world_state, "command_queue") and self.world_state.command_queue:
            while not self.world_state.command_queue.empty():
                try:
                    cmd = self.world_state.command_queue.get_nowait()
    
                    # Handle Control Commands locally
                    # Map PAUSE_STATE to Pause/Resume
                    if cmd.command_type == "PAUSE_STATE":
                        # new_value should be boolean: True = Pause, False = Resume
                        should_pause = bool(cmd.new_value)
                        self.is_paused = should_pause
                        logger.info(f"Simulation {'PAUSED' if should_pause else 'RESUMED'} by command.")
    
                    # Map TRIGGER_EVENT: STEP
                    elif cmd.command_type == "TRIGGER_EVENT" and cmd.parameter_key == "STEP":
                        self.step_requested = True
                        logger.info("Simulation STEP requested.")
    
                    # Forward everything else (including other TRIGGER_EVENTs) to God Command Queue for Phase 0
                    else:
                        if hasattr(self.world_state, "god_command_queue"):
                            self.world_state.god_command_queue.append(cmd)
                except Exception:
                    break
    
        # Also drain god_command_queue if it's being used for ingestion
        if hasattr(self.world_state, "god_command_queue") and self.world_state.god_command_queue:
            while self.world_state.god_command_queue:
>               commands.append(self.world_state.god_command_queue.popleft())
                ^^^^^^^^
E               NameError: name 'commands' is not defined

simulation\engine.py:135: NameError
___________________ test_simulation_processes_set_tax_rate ____________________

mock_simulation_deps = (<MagicMock name='mock.config_manager' id='2006521520752'>, <MagicMock id='2006521521088'>, <MagicMock id='20065215214...ock name='mock.global_registry' id='2006521522096'>, <MagicMock name='mock.settlement_system' id='2006521522432'>, ...)

    def test_simulation_processes_set_tax_rate(mock_simulation_deps):
        cm, config_module, logger, repo, registry, settlement_system, agent_registry, ws = mock_simulation_deps
    
        with pytest.MonkeyPatch.context() as m:
            m.setattr("simulation.engine.WorldState", MagicMock(return_value=ws))
            m.setattr("simulation.engine.ActionProcessor", MagicMock())
            m.setattr("simulation.engine.TickOrchestrator", MagicMock())
            m.setattr("simulation.engine.SimulationLogger", MagicMock())
    
            cmd_service = MagicMock(spec=CommandService)
            sim = Simulation(cm, config_module, logger, repo, registry, settlement_system, agent_registry, cmd_service)
            sim.world_state = ws
    
            # Enqueue SET_TAX_RATE (Corporate)
            cmd = GodCommandDTO(
                command_type="SET_PARAM",
                target_domain="Government",
                parameter_key="corporate_tax_rate",
                new_value=0.25,
                command_id=uuid4()
            )
            ws.command_queue.put(cmd)
    
>           sim.run_tick()

tests\integration\test_cockpit_integration.py:160: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\engine.py:176: in run_tick
    self._process_commands()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.engine.Simulation object at 0x000001D32E0C7D90>

    def _process_commands(self) -> None:
        """Processes all pending commands from the world state command queue."""
        # Check External Queue (from Dashboard/Server)
        if hasattr(self.world_state, "command_queue") and self.world_state.command_queue:
            while not self.world_state.command_queue.empty():
                try:
                    cmd = self.world_state.command_queue.get_nowait()
    
                    # Handle Control Commands locally
                    # Map PAUSE_STATE to Pause/Resume
                    if cmd.command_type == "PAUSE_STATE":
                        # new_value should be boolean: True = Pause, False = Resume
                        should_pause = bool(cmd.new_value)
                        self.is_paused = should_pause
                        logger.info(f"Simulation {'PAUSED' if should_pause else 'RESUMED'} by command.")
    
                    # Map TRIGGER_EVENT: STEP
                    elif cmd.command_type == "TRIGGER_EVENT" and cmd.parameter_key == "STEP":
                        self.step_requested = True
                        logger.info("Simulation STEP requested.")
    
                    # Forward everything else (including other TRIGGER_EVENTs) to God Command Queue for Phase 0
                    else:
                        if hasattr(self.world_state, "god_command_queue"):
                            self.world_state.god_command_queue.append(cmd)
                except Exception:
                    break
    
        # Also drain god_command_queue if it's being used for ingestion
        if hasattr(self.world_state, "god_command_queue") and self.world_state.god_command_queue:
            while self.world_state.god_command_queue:
>               commands.append(self.world_state.god_command_queue.popleft())
                ^^^^^^^^
E               NameError: name 'commands' is not defined

simulation\engine.py:135: NameError
============================== warnings summary ===============================
..\..\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\site-packages\_pytest\config\__init__.py:1474
  C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\site-packages\_pytest\config\__init__.py:1474: PytestConfigWarning: Unknown config option: asyncio_default_fixture_loop_scope
  
    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

..\..\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\site-packages\_pytest\config\__init__.py:1474
  C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\site-packages\_pytest\config\__init__.py:1474: PytestConfigWarning: Unknown config option: asyncio_mode
  
    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/integration/test_cockpit_integration.py::test_simulation_processes_pause_resume
FAILED tests/integration/test_cockpit_integration.py::test_simulation_processes_set_base_rate
FAILED tests/integration/test_cockpit_integration.py::test_simulation_processes_set_tax_rate
=================== 3 failed, 1 passed, 2 warnings in 0.61s ===================
