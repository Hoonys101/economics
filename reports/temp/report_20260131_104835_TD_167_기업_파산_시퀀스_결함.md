# Report: Liquidation Systems Analysis and Resolution Specification (TD-167, TD-171)

## Executive Summary

This report analyzes two critical technical debt items related to agent liquidation. **TD-167 (Firm Bankruptcy Flaw)** is caused by firm assets being written off instead of being sold on the market, preventing asset reallocation within the economy. **TD-171 (Household Liquidation Leak)** is caused by a redundant, non-transactional inheritance implementation in `DemographicManager` that conflicts with the robust, transaction-based `InheritanceManager`, leading to asset "dust" vanishing from the simulation.

The proposed resolution involves unifying the logic into a single, transaction-based pipeline for both firms and households, deprecating conflicting legacy code, and introducing a true market-based liquidation mechanism for firm assets.

## Detailed Analysis

### 1. TD-167: Firm Bankruptcy Sequence Flaw

-   **Status**: ⚠️ Partial / Conflicting
-   **Problem**: When a firm goes bankrupt, its assets are not sold back into the economy. Instead, they are either destroyed or transferred via non-market means, preventing other firms from acquiring them. This violates the principle of creative destruction.
-   **Evidence**:
    -   **Path A (`ma_manager.py:L178-L208`)**: The `_execute_bankruptcy` function explicitly writes off real assets. The call to `record_liquidation` uses `recovered_cash=0.0` with the comment `WO-018: Real assets written off, not sold` (`ma_manager.py:L196`).
    -   **Path B (`lifecycle_manager.py:L218-L242`)**: A more recent implementation for inactive firms recovers inventory by transferring it to a `PublicManager`. However, it still destroys the firm's `capital_stock` value instead of liquidating it (`lifecycle_manager.py:L232-L239`).
    -   **Conclusion**: Neither path creates market `Order`s to sell the bankrupt firm's assets (inventory, capital) to other agents.

### 2. TD-171: Liquidation Dust Leak (Household)

-   **Status**: ❌ Conflicting Implementations
-   **Problem**: When a household agent dies without heirs, their remaining assets (especially small "dust" amounts from rounding) are not reliably transferred to the state (escheatment) and instead vanish from the simulation, causing a money supply leak.
-   **Evidence**:
    -   **Modern Path (`inheritance_manager.py`)**: This system generates a complete, auditable sequence of `Transaction` objects for asset valuation, liquidation, taxation, and distribution/escheatment. This is the correct, modern approach that respects the "Sacred Sequence".
    -   **Legacy Path (`demographic_manager.py:L277-L343`)**: This file contains a completely separate method, `handle_inheritance`, which directly calls `settlement_system.transfer`. This bypasses the transaction queue and audit trail. Direct calls are prone to rounding errors and race conditions that cause small amounts of assets to be left in the deceased agent's account. When the agent object is garbage-collected at tick-end, these residual assets are destroyed.
    -   **Conclusion**: The existence of the legacy `handle_inheritance` in `DemographicManager` is the direct cause of the reported leak. The logic in `InheritanceManager` and its corresponding `InheritanceHandler` is robust.

---

## Resolution Specification

To resolve these issues, the liquidation and inheritance processes must be unified into a single, atomic, transaction-based pipeline.

### Part A: Spec for Resolving TD-167 (Firm Bankruptcy)

1.  **Unify Liquidation Path**:
    -   The `_execute_bankruptcy` method in `simulation/systems/ma_manager.py` **MUST** be deprecated and removed.
    -   `MAManager`'s responsibility will end at identifying and marking a firm as bankrupt (`firm.is_active = False`).
    -   The `AgentLifecycleManager` in `simulation/systems/lifecycle_manager.py` will be the sole entry point for all agent liquidations.

2.  **Implement Market-Based Asset Liquidation**:
    -   Within `AgentLifecycleManager._handle_agent_liquidation`, the logic for inactive firms **MUST** be changed from destroying assets to selling them.
    -   A new component, **`AssetLiquidator`**, should be created to encapsulate this logic. `AgentLifecycleManager` will delegate to it.
    -   **`AssetLiquidator`'s Responsibilities**:
        -   **Inventory Liquidation**: For all items in the bankrupt firm's `inventory` and `input_inventory`, create `SELL` orders on the corresponding goods markets. The sell price should be at a significant discount (e.g., `market.avg_price * 0.7`) to ensure a quick sale. The seller is the bankrupt firm.
        -   **Capital Stock Liquidation**: The firm's `capital_stock` represents physical assets. These will be sold as a generic "salvage" good. A `SELL` order for `item_id='salvaged_capital'` will be placed on a general goods market. The quantity will be the `capital_stock` value, and the price will be a fixed recovery rate (e.g., `0.5`, representing a 50% loss).
        -   The liquidation process will generate transactions that are processed in the following tick, converting the firm's physical assets into cash.

3.  **Final Settlement**:
    -   The bankrupt firm will persist as an inactive entity until all of its liquidation-related `SELL` orders have been processed and its assets are converted to cash.
    -   Once all assets are cash, the existing logic in `AgentLifecycleManager` for distributing the remaining cash to shareholders (or the government via escheatment) will proceed. This ensures financial integrity.

### Part B: Spec for Resolving TD-171 (Household Liquidation)

1.  **Deprecate Legacy Inheritance**:
    -   The `handle_inheritance` method in `simulation/systems/demographic_manager.py` **MUST** be completely removed.
    -   All calls to this method must be located and removed to ensure it is no longer used.

2.  **Enforce the Modern Path**:
    -   The sole process for handling a household's death will be the flow starting from `AgentLifecycleManager`, which calls `InheritanceManager`.
    -   `InheritanceManager` will continue to be responsible for generating the full sequence of transactions:
        1.  `asset_liquidation` (if necessary, to pay taxes)
        2.  `tax`
        3.  `inheritance_distribution` (to heirs) or `escheatment` (to government)

3.  **Final State Verification (No-Op)**:
    -   No changes are required for the `InheritanceManager` itself. Its transaction-based approach, combined with the robust integer math inside `InheritanceHandler`, already ensures that the deceased agent's entire estate is transferred, preventing dust leaks. The critical fix is the removal of the conflicting legacy path.
