# Analysis: Server Integration Async Regressions

## Executive Summary
The error "async def functions are not natively supported" confirms that the `pytest-asyncio` plugin is **inactive or missing** in the test environment. While the configuration and code structure are correct for async testing, the runtime environment lacks the necessary plugin support to execute `async def` test functions.

## Detailed Analysis

### 1. Error Root Cause
- **Status**: ❌ Plugin Inactive
- **Evidence**: The error "async def functions are not natively supported" is generated by standard `pytest` when encountering `async def` tests without an installed/active async plugin.
- **Notes**: This error takes precedence over configuration issues; if the plugin were installed but misconfigured, the error would likely be different (e.g., "fixture loop scope mismatch").

### 2. Dependency Configuration
- **Status**: ⚠️ Inconsistent
- **Evidence**: `requirements.txt:L14,17,22` lists `pytest-asyncio>=0.21.0` **three times**, indicating maintenance issues.
- **Notes**: `pytest.ini:L11` uses `asyncio_default_fixture_loop_scope = function`, a configuration option introduced in `pytest-asyncio` **v0.24.0**. The current requirement (`>=0.21.0`) allows installation of older versions that do not support this flag, though the primary error suggests the plugin is missing entirely.

### 3. Test File Structure
- **Status**: ✅ Correct
- **Evidence**: `tests/integration/test_server_integration.py` correctly uses `@pytest.mark.asyncio` (L38, L59) and `async def` syntax.
- **Notes**: The code expects `pytest-asyncio` to handle the async event loop, even with synchronous fixtures (`server`, `bridge`).

### 4. Pytest Configuration
- **Status**: ✅ Correct (Assuming v0.24+)
- **Evidence**: `pytest.ini` sets `asyncio_mode = auto` and `asyncio_default_fixture_loop_scope = function`.
- **Notes**: These settings are optimal for modern `pytest-asyncio` but require the plugin to be installed.

## Risk Assessment
- **High**: Integration tests for the server are completely blocked.
- **Medium**: `requirements.txt` contains duplicate entries and outdated version constraints (`>=0.21.0` vs need for `0.24.0` features).

## Conclusion
The environment fails to load `pytest-asyncio`.

**Action Items:**
1.  **Install/Verify Plugin**: Ensure `pytest-asyncio` is installed in the active environment.
2.  **Update Requirements**: Clean up `requirements.txt` (remove duplicates) and bump version to `pytest-asyncio>=0.24.0` to support the `asyncio_default_fixture_loop_scope` setting in `pytest.ini`.

---

### Mandatory Insight Report Content
*(For `communications/insights/analyze-regress-server.md`)*

```markdown
# Architectural Insight: Server Async Regression

## Architectural Insights
- **Dependency Gap**: The project relies on `pytest-asyncio` for integration testing of the WebSocket server. The error "async def functions are not natively supported" indicates the plugin is missing or inactive in the test environment, despite being listed in `requirements.txt`.
- **Configuration Mismatch**: `pytest.ini` specifies `asyncio_default_fixture_loop_scope = function`, which requires `pytest-asyncio >= 0.24.0`. The current `requirements.txt` specifies `>=0.21.0`, creating a configuration gap where valid config for the intended version is invalid for the allowed installed version.

## Test Evidence
- **Failure**: `test_server_integration.py::test_command_injection` -> `Failed: async def functions are not natively supported.`
- **Resolution**: Install `pytest-asyncio>=0.24.0` and remove duplicate entries in `requirements.txt`.
```