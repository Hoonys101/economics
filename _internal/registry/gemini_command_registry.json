{
  "_meta": {
    "version": "1.0"
  },
  "missions": {
    "modernize-tests": {
      "key": "modernize-tests",
      "title": "Test Modernization: Aligning with Phase 19/20 Architecture",
      "type": "gemini",
      "instruction_raw": "Analyze current test failures and deprecation warnings to design a modernization plan.\n\n**Primary Objectives:**\n1. **Taxation Fix**: Replace `government.collect_tax(...)` calls with `government.settlement_system.settle_atomic(...)` or proper service-based calls.\n2. **Birth Gift Fix**: Update `test_birth_gift_rounding` to assert against `settle_atomic` or `transfer` within the context of the new `HouseholdFactory`.\n3. **Mock Hardening**: Fix `AttributeError: Mock object has no attribute 'id'` by ensuring mocks in `test_transaction_handlers.py` correctly simulate `IAgent` or `IFinancialAgent` protocols.\n4. **Factory Migration**: Update `test_agent_factory.py` and others to use `simulation.factories.household_factory` and the mandatory `simulation` injection.\n5. **Engine Migration**: Replace `GovernmentDecisionEngine` with `FiscalEngine` in tests.\n\n**Constraint:** Every refactor must enforce Zero-Sum integrity and match the current `SettlementSystem` API.",
      "status": "pending",
      "created_at": "",
      "command": null,
      "file_path": null,
      "wait": false,
      "session_id": null,
      "worker": "spec",
      "context_files": [
        "simulation/agents/government.py",
        "simulation/factories/household_factory.py",
        "simulation/systems/settlement_system.py",
        "simulation/systems/demographic_manager.py",
        "tests/integration/test_government_fiscal_policy.py",
        "tests/system/test_audit_integrity.py",
        "tests/unit/test_tax_collection.py",
        "tests/unit/test_transaction_handlers.py",
        "tests/simulation/factories/test_agent_factory.py",
        "tests/integration/test_government_refactor_behavior.py"
      ],
      "output_path": "design/3_work_artifacts/spec/TEST_MODERNIZATION_SPEC.md",
      "model": null,
      "audit_requirements": null
    },
    "analyze-test-failures": {
      "key": "analyze-test-failures",
      "title": "Comprehensive Test Failure Analysis: 10 Failures in 3 Categories",
      "type": "gemini",
      "instruction_raw": "Analyze all 10 test failures and produce a single, actionable specification for Jules.\n\n## Category A: Stale `collect_tax` References (6 failures)\n- `test_government_fiscal_policy.py::test_tax_collection_and_bailouts` calls `government.collect_tax(...)` which was removed.\n- `test_tax_collection.py::test_government_collect_tax_adapter_success` and `_failure` call the same removed method.\n- `test_transaction_handlers.py::TestLaborTransactionHandler` (2 tests) assert `government.collect_tax.assert_called_with(...)` but production `LaborTransactionHandler` now uses `settlement.settle_atomic()` + `government.record_revenue()`. The mock `government` also lacks an explicit `id` attribute (only set via `spec=ITaxCollector` which may not include `id`).\n\n**Fix Pattern**: Update test assertions to match the NEW production flow:\n  - `settle_atomic(debit_agent=..., credits_list=[...], tick=...)` for FIRM tax payer\n  - `transfer(buyer, seller, amount, memo)` + `settle_atomic(debit_agent=seller, credits_list=[(gov, tax, memo)], tick=...)` for HOUSEHOLD tax payer\n  - `government.record_revenue({...})` instead of `government.collect_tax(...)`\n  - Add `self.government.id = 99` explicitly in `TestLaborTransactionHandler.setUp`\n\n## Category B: Birth Gift Factory Wiring (1 failure)\n- `test_audit_integrity.py::test_birth_gift_rounding` \u2014 `DemographicManager.process_births()` calls `factory.create_newborn()` which calls `context.settlement_system.transfer()` with kwargs `sender=`, `receiver=`, `amount=`, `transaction_type=`, `tick=`. But the mock's `transfer` is never called because the test mock setup doesn't provide `HouseholdFactoryContext`. Fix: Provide a real `HouseholdFactory` with a mock context containing a mock `settlement_system`, then assert `settlement_system.transfer` was called.\n\n## Category C: WebSocket Auth Exception Mismatch (4 failures)\n- `test_websocket_auth.py` and `test_server_auth.py` expect `websockets.exceptions.InvalidStatus` but get `websockets.exceptions.InvalidMessage`. This is a `websockets` library version issue. The `_process_request` callback signature changed in v14+. Check if the server's `_process_request(self, connection, request)` signature matches the installed `websockets` version. If the server returns an HTTP response tuple but the library expects a different rejection mechanism, the client gets `InvalidMessage` instead of `InvalidStatus`.\n**Fix Pattern**: Either update `_process_request` to use `websockets.http.Response` or catch `InvalidMessage` in tests, or fix the server handler signature to match the installed version.\n\n## Constraints\n- Every refactored test must enforce Zero-Sum integer penny integrity.\n- All mocks implementing financial protocols MUST have explicit `id` attributes.\n- Production code in `labor.py`, `goods.py`, `server.py` MUST NOT be modified \u2014 only tests.\n",
      "status": "pending",
      "created_at": "",
      "command": null,
      "file_path": null,
      "wait": false,
      "session_id": null,
      "worker": "spec",
      "context_files": [
        "simulation/agents/government.py",
        "simulation/factories/household_factory.py",
        "simulation/systems/settlement_system.py",
        "simulation/systems/demographic_manager.py",
        "modules/finance/transaction/handlers/labor.py",
        "modules/finance/transaction/handlers/protocols.py",
        "modules/system/server.py",
        "modules/system/security.py",
        "tests/integration/test_government_fiscal_policy.py",
        "tests/system/test_audit_integrity.py",
        "tests/unit/test_tax_collection.py",
        "tests/unit/test_transaction_handlers.py",
        "tests/security/test_websocket_auth.py",
        "tests/system/test_server_auth.py"
      ],
      "output_path": "design/3_work_artifacts/spec/TEST_FAILURE_FIX_SPEC.md",
      "model": null,
      "audit_requirements": null
    }
  }
}