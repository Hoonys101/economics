
tests/integration/scenarios/diagnosis/test_agent_decision.py::test_household_makes_decision ERROR [  0%]
tests/integration/scenarios/diagnosis/test_agent_decision.py::test_firm_makes_decision ERROR [  0%]
tests/integration/scenarios/diagnosis/test_api_contract.py::test_api_contract_placeholder PASSED [  0%]
tests/integration/scenarios/diagnosis/test_dashboard_contract.py::test_dashboard_snapshot_structure 
-------------------------------- live log call --------------------------------
ERROR    simulation.orchestration.persistence_bridge:persistence_bridge.py:54 ‚ùå [Persistence] Failed to save snapshot: Object of type MagicMock is not JSON serializable
FAILED                                                                   [  0%]
tests/integration/scenarios/diagnosis/test_indicator_pipeline.py::test_indicator_aggregation ERROR [  0%]
tests/integration/scenarios/diagnosis/test_market_mechanics.py::test_order_book_matching 
------------------------------- live log setup --------------------------------
INFO     Market_basic_food:order_book_market.py:97 OrderBookMarket basic_food initialized.
-------------------------------- live log call --------------------------------
INFO     Market_basic_food:order_book_market.py:252 Starting order matching for items: ['basic_food']
PASSED                                                                   [  0%]
tests/integration/scenarios/phase21/test_automation.py::test_firm_automation_init ERROR [  1%]
tests/integration/scenarios/phase21/test_automation.py::test_production_function_with_automation ERROR [  1%]
tests/integration/scenarios/phase21/test_automation.py::test_system2_planner_guidance ERROR [  1%]
tests/integration/scenarios/phase21/test_firm_system2.py::test_system2_planner_guidance_automation_preference ERROR [  1%]
tests/integration/scenarios/phase21/test_firm_system2.py::test_system2_planner_guidance_ma_preference ERROR [  1%]
tests/integration/scenarios/test_stress_scenarios.py::TestPhase28StressScenarios::test_hyperinflation_trigger 
-------------------------------- live log call --------------------------------
WARNING  simulation.systems.event_system:event_system.py:33 üî• STRESS_TEST: Activating 'hyperinflation' at Tick 10!
INFO     simulation.systems.event_system:event_system.py:63   -> Injected 50% cash into all households.
PASSED                                                                   [  1%]
tests/integration/scenarios/test_stress_scenarios.py::TestPhase28StressScenarios::test_deflation_asset_shock 
-------------------------------- live log call --------------------------------
WARNING  simulation.systems.event_system:event_system.py:33 üî• STRESS_TEST: Activating 'deflation' at Tick 20!
INFO     simulation.systems.event_system:event_system.py:87   -> Reduced all agent assets by 20%.
FAILED                                                                   [  2%]
tests/integration/scenarios/test_stress_scenarios.py::TestPhase28StressScenarios::test_consumption_pessimism PASSED [  2%]
tests/integration/scenarios/test_stress_scenarios.py::TestPhase28StressScenarios::test_supply_shock 
-------------------------------- live log call --------------------------------
WARNING  simulation.systems.event_system:event_system.py:33 üî• STRESS_TEST: Activating 'supply_shock' at Tick 30!
INFO     simulation.systems.event_system:event_system.py:98   -> Applied productivity shock (0.5) to Firm 101 (Type: Farm).
PASSED                                                                   [  2%]
tests/integration/scenarios/test_stress_scenarios.py::TestPhase28StressScenarios::test_panic_selling_order_generation FAILED [  2%]
tests/integration/scenarios/test_stress_scenarios.py::TestPhase28StressScenarios::test_hoarding_amplification 
-------------------------------- live log call --------------------------------
INFO     simulation.decisions.ai_driven_household_engine:ai_driven_household_engine.py:43 AIDrivenHouseholdDecisionEngine initialized (Modularized).
INFO     simulation.decisions.ai_driven_household_engine:consumption_manager.py:32 SURVIVAL_CHECK | Need: 50.0, Threshold: 0.8, Food: food
PASSED                                                                   [  2%]
tests/integration/scenarios/test_stress_scenarios.py::TestPhase28StressScenarios::test_debt_repayment_priority 
-------------------------------- live log call --------------------------------
INFO     simulation.decisions.ai_driven_household_engine:ai_driven_household_engine.py:43 AIDrivenHouseholdDecisionEngine initialized (Modularized).
INFO     simulation.decisions.ai_driven_household_engine:consumption_manager.py:32 SURVIVAL_CHECK | Need: 0, Threshold: 0.8, Food: food
INFO     simulation.decisions.ai_driven_household_engine:asset_manager.py:72 DEBT_AVERSION | Household 1 prioritizing repayment: 550.0
PASSED                                                                   [  2%]
tests/integration/test_app.py::test_app_placeholder PASSED               [  3%]
tests/integration/test_atomic_settlement.py::test_settle_atomic_success 
-------------------------------- live log call --------------------------------
ERROR    simulation.systems.settlement_system:settlement_system.py:381 SETTLEMENT_UNHANDLED_FAIL | MockAgent.withdraw() got an unexpected keyword argument 'currency'
Traceback (most recent call last):
  File "C:\coding\economics\simulation\systems\settlement_system.py", line 353, in _execute_withdrawal
    agent.withdraw(amount, currency=currency)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: MockAgent.withdraw() got an unexpected keyword argument 'currency'
FAILED                                                                   [  3%]
tests/integration/test_atomic_settlement.py::test_settle_atomic_rollback 
-------------------------------- live log call --------------------------------
ERROR    simulation.systems.settlement_system:settlement_system.py:381 SETTLEMENT_UNHANDLED_FAIL | MockAgent.withdraw() got an unexpected keyword argument 'currency'
Traceback (most recent call last):
  File "C:\coding\economics\simulation\systems\settlement_system.py", line 353, in _execute_withdrawal
    agent.withdraw(amount, currency=currency)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: MockAgent.withdraw() got an unexpected keyword argument 'currency'
FAILED                                                                   [  3%]
tests/integration/test_cockpit_integration.py::test_simulation_processes_pause_resume 
-------------------------------- live log call --------------------------------
INFO     simulation.orchestration.command_service:command_service.py:71 Command enqueued: PAUSE | Payload: {}
INFO     simulation.engine:engine.py:96 Executing command: PAUSE | {}
INFO     simulation.orchestration.command_service:command_service.py:71 Command enqueued: RESUME | Payload: {}
INFO     simulation.engine:engine.py:96 Executing command: RESUME | {}
PASSED                                                                   [  3%]
tests/integration/test_cockpit_integration.py::test_simulation_processes_set_base_rate 
-------------------------------- live log call --------------------------------
INFO     simulation.orchestration.command_service:command_service.py:71 Command enqueued: SET_BASE_RATE | Payload: {'rate': 0.15}
INFO     simulation.engine:engine.py:96 Executing command: SET_BASE_RATE | {'rate': 0.15}
INFO     simulation.engine:engine.py:109 MANUAL INTERVENTION: Base Rate set to 0.15
PASSED                                                                   [  3%]
tests/integration/test_cockpit_integration.py::test_simulation_processes_set_tax_rate 
-------------------------------- live log call --------------------------------
INFO     simulation.orchestration.command_service:command_service.py:71 Command enqueued: SET_TAX_RATE | Payload: {'tax_type': 'corporate', 'rate': 0.25}
INFO     simulation.engine:engine.py:96 Executing command: SET_TAX_RATE | {'tax_type': 'corporate', 'rate': 0.25}
INFO     simulation.engine:engine.py:118 MANUAL INTERVENTION: corporate Tax Rate set to 0.25
INFO     simulation.orchestration.command_service:command_service.py:71 Command enqueued: SET_TAX_RATE | Payload: {'tax_type': 'income', 'rate': 0.15}
INFO     simulation.engine:engine.py:96 Executing command: SET_TAX_RATE | {'tax_type': 'income', 'rate': 0.15}
INFO     simulation.engine:engine.py:118 MANUAL INTERVENTION: income Tax Rate set to 0.15
PASSED                                                                   [  3%]
tests/integration/test_decision_engine_integration.py::TestDecisionEngineIntegration::test_firm_places_sell_order_for_food 
------------------------------- live log setup --------------------------------
INFO     Market_goods_market:order_book_market.py:97 OrderBookMarket goods_market initialized.
PASSED                                                                   [  4%]
tests/integration/test_decision_engine_integration.py::TestDecisionEngineIntegration::test_household_places_buy_order_for_food 
------------------------------- live log setup --------------------------------
INFO     Market_goods_market:order_book_market.py:97 OrderBookMarket goods_market initialized.
PASSED                                                                   [  4%]
tests/integration/test_decision_engine_integration.py::TestDecisionEngineIntegration::test_household_sells_labor 
------------------------------- live log setup --------------------------------
INFO     Market_labor_market:order_book_market.py:97 OrderBookMarket labor_market initialized.
PASSED                                                                   [  4%]
tests/integration/test_decision_engine_integration.py::TestDecisionEngineIntegration::test_firm_buys_labor 
------------------------------- live log setup --------------------------------
INFO     Market_labor_market:order_book_market.py:97 OrderBookMarket labor_market initialized.
PASSED                                                                   [  4%]
tests/integration/test_decision_engine_integration.py::TestDecisionEngineIntegration::test_goods_market_matching_integration 
------------------------------- live log setup --------------------------------
INFO     Market_goods_market:order_book_market.py:97 OrderBookMarket goods_market initialized.
-------------------------------- live log call --------------------------------
INFO     Market_goods_market:order_book_market.py:252 Starting order matching for items: ['food']
PASSED                                                                   [  4%]
tests/integration/test_decision_engine_integration.py::TestDecisionEngineIntegration::test_labor_market_matching_integration 
------------------------------- live log setup --------------------------------
INFO     Market_labor_market:order_book_market.py:97 OrderBookMarket labor_market initialized.
-------------------------------- live log call --------------------------------
INFO     Market_labor_market:order_book_market.py:252 Starting order matching for items: ['labor']
PASSED                                                                   [  4%]
tests/integration/test_finance_bailout.py::test_grant_bailout_loan_success_and_covenant_type FAILED [  5%]
tests/integration/test_finance_bailout.py::test_grant_bailout_loan_insufficient_government_funds FAILED [  5%]
tests/integration/test_firm_decision_scenarios.py::test_growth_scenario_with_golden_firm 
-------------------------------- live log call --------------------------------
INFO     simulation.decisions.ai_driven_firm_engine:ai_driven_firm_engine.py:40 AIDrivenFirmDecisionEngine initialized with CorporateManager.
FAILED                                                                   [  5%]
tests/integration/test_fiscal_integrity.py::test_infrastructure_investment_generates_transactions_and_issues_bonds 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
INFO     simulation.bank:bank.py:91 Bank 2 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
INFO     modules.finance.system:system.py:276 BOND_SYNC_SUCCESS | Raised 4000.00 from 2 for Gov 1
INFO     modules.government.components.infrastructure_manager:infrastructure_manager.py:90 INFRASTRUCTURE_PENDING | Level 1 initiated. Cost: 5000.0. Distributed to 1 households.
FAILED                                                                   [  5%]
tests/integration/test_fiscal_integrity.py::test_education_spending_generates_transactions_only 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 100.0})
FAILED                                                                   [  5%]
tests/integration/test_fiscal_policy.py::test_potential_gdp_ema_convergence 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
-------------------------------- live log call --------------------------------
INFO     simulation.utils.shadow_logger:shadow_logger.py:36 ShadowLogger initialized at logs/shadow_hand_stage1.csv
PASSED                                                                   [  5%]
tests/integration/test_fiscal_policy.py::test_counter_cyclical_tax_adjustment_recession 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
PASSED                                                                   [  5%]
tests/integration/test_fiscal_policy.py::test_counter_cyclical_tax_adjustment_boom 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
PASSED                                                                   [  6%]
tests/integration/test_fiscal_policy.py::test_debt_ceiling_enforcement 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
-------------------------------- live log call --------------------------------
WARNING  simulation.agents.government:government.py:438 WELFARE_FAILED | Insufficient funds even after bond issuance attempt. Needed: 100.0, Has: 0.0
PASSED                                                                   [  6%]
tests/integration/test_fiscal_policy.py::test_calculate_income_tax_uses_current_rate 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
PASSED                                                                   [  6%]
tests/integration/test_generational_wealth_audit.py::TestGenerationalWealthAudit::test_run_audit FAILED [  6%]
tests/integration/test_generational_wealth_audit.py::TestGenerationalWealthAudit::test_run_audit_no_agents PASSED [  6%]
tests/integration/test_government_ai_logic.py::TestGovernmentAILogic::test_calculate_reward PASSED [  6%]
tests/integration/test_government_ai_logic.py::TestGovernmentAILogic::test_get_state_debt_crisis PASSED [  7%]
tests/integration/test_government_ai_logic.py::TestGovernmentAILogic::test_get_state_high_inflation_low_unemp PASSED [  7%]
tests/integration/test_government_ai_logic.py::TestGovernmentAILogic::test_get_state_ideal PASSED [  7%]
tests/integration/test_government_ai_logic.py::TestGovernmentAILogic::test_learning_flow PASSED [  7%]
tests/integration/test_government_finance.py::test_invest_infrastructure_generates_transaction 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 10000.0})
INFO     modules.government.components.infrastructure_manager:infrastructure_manager.py:90 INFRASTRUCTURE_PENDING | Level 1 initiated. Cost: 1000.0. Distributed to 1 households.
PASSED                                                                   [  7%]
tests/integration/test_government_fiscal_integration.py::TestGovernmentFiscalIntegration::test_calculate_income_tax_uses_fiscal_policy_manager 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
FAILED                                                                   [  7%]
tests/integration/test_government_fiscal_integration.py::TestGovernmentFiscalIntegration::test_make_policy_decision_updates_fiscal_policy 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
FAILED                                                                   [  8%]
tests/integration/test_government_fiscal_policy.py::test_tax_collection_and_bailouts 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
PASSED                                                                   [  8%]
tests/integration/test_government_fiscal_policy.py::test_infrastructure_investment 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 6000.0})
INFO     modules.government.components.infrastructure_manager:infrastructure_manager.py:90 INFRASTRUCTURE_PENDING | Level 1 initiated. Cost: 5000.0. Distributed to 1 households.
PASSED                                                                   [  8%]
tests/integration/test_government_integration.py::test_government_execute_social_policy_tax_and_welfare 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 100000.0})
PASSED                                                                   [  8%]
tests/integration/test_government_refactor_behavior.py::TestGovernmentRefactor::test_decision_engine_taylor_rule PASSED [  8%]
tests/integration/test_government_refactor_behavior.py::TestGovernmentRefactor::test_execution_engine_state_update PASSED [  8%]
tests/integration/test_government_refactor_behavior.py::TestGovernmentRefactor::test_orchestrator_integration 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 100000.0})
PASSED                                                                   [  9%]
tests/integration/test_government_refactor_behavior.py::TestGovernmentRefactor::test_social_policy_execution 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 100000.0})
PASSED                                                                   [  9%]
tests/integration/test_government_tax.py::TestGovernmentTax::test_record_revenue_success 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
FAILED                                                                   [  9%]
tests/integration/test_government_tax.py::TestGovernmentTax::test_record_revenue_failure 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
PASSED                                                                   [  9%]
tests/integration/test_government_tax.py::TestGovernmentTax::test_collect_tax_legacy 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
FAILED                                                                   [  9%]
tests/integration/test_government_tax.py::TestGovernmentTax::test_collect_tax_no_settlement_system 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
-------------------------------- live log call --------------------------------
ERROR    simulation.agents.government:government.py:228 Government has no SettlementSystem linked. Cannot collect tax.
PASSED                                                                   [  9%]
tests/integration/test_interest_sensitivity.py::TestInterestSensitivityLogic::test_savings_incentive_ant_high_rate PASSED [ 10%]
tests/integration/test_interest_sensitivity.py::TestInterestSensitivityLogic::test_savings_incentive_grasshopper_high_rate PASSED [ 10%]
tests/integration/test_interest_sensitivity.py::TestInterestSensitivityLogic::test_savings_incentive_at_neutral_rate PASSED [ 10%]
tests/integration/test_interest_sensitivity.py::TestInterestSensitivityLogic::test_savings_incentive_with_inflation_expectation PASSED [ 10%]
tests/integration/test_interest_sensitivity.py::TestInterestSensitivityLogic::test_consumption_aggressiveness_reduction PASSED [ 10%]
tests/integration/test_interest_sensitivity.py::TestInterestSensitivityLogic::test_dsr_penalty_applied PASSED [ 10%]
tests/integration/test_interest_sensitivity.py::TestInterestSensitivityLogic::test_subsistence_constraint_bypasses_reduction PASSED [ 11%]
tests/integration/test_liquidation_services.py::TestLiquidationServices::test_hr_service_severance FAILED [ 11%]
tests/integration/test_liquidation_services.py::TestLiquidationServices::test_hr_service_unpaid_wages FAILED [ 11%]
tests/integration/test_liquidation_services.py::TestLiquidationServices::test_tax_service FAILED [ 11%]
tests/integration/test_liquidation_waterfall.py::TestLiquidationWaterfallIntegration::test_asset_rich_cash_poor_liquidation 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.liquidation_handlers:liquidation_handlers.py:87 LIQUIDATION_ASSET_SALE | Agent 1 sold inventory to PublicManager for 800.00.
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:80 LIQUIDATION_START | Agent 1 starting liquidation. Assets: 800.00, Total Claims: 500.00
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:125 LIQUIDATION_WATERFALL | Tier 1 fully paid. Remaining cash: 300.00
PASSED                                                                   [ 11%]
tests/integration/test_liquidation_waterfall.py::TestLiquidationWaterfallIntegration::test_severance_priority_over_shareholders 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:80 LIQUIDATION_START | Agent 1 starting liquidation. Assets: 5000.00, Total Claims: 5615.38
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:133 LIQUIDATION_WATERFALL | Tier 1 partially paid (Factor: 0.89). Cash exhausted.
PASSED                                                                   [ 11%]
tests/integration/test_liquidation_waterfall.py::TestLiquidationWaterfallIntegration::test_waterfall_tiers 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:80 LIQUIDATION_START | Agent 1 starting liquidation. Assets: 10000.00, Total Claims: 7003.85
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:125 LIQUIDATION_WATERFALL | Tier 1 fully paid. Remaining cash: 7996.15
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:125 LIQUIDATION_WATERFALL | Tier 2 fully paid. Remaining cash: 2996.15
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:164 LIQUIDATION_WATERFALL | Tier 5 (Equity) distributed 1498.08 USD and foreign assets: {} to shareholders.
PASSED                                                                   [ 11%]
tests/integration/test_m2_integrity.py::TestM2Integrity::test_credit_creation_expansion PASSED [ 12%]
tests/integration/test_m2_integrity.py::TestM2Integrity::test_credit_destruction_contraction PASSED [ 12%]
tests/integration/test_m2_integrity.py::TestM2Integrity::test_internal_transfers_are_neutral PASSED [ 12%]
tests/integration/test_multicurrency_liquidation.py::TestMultiCurrencyLiquidation::test_foreign_currency_distribution_to_shareholders 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:80 LIQUIDATION_START | Agent 1 starting liquidation. Assets: 1000.00, Total Claims: 0.00
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:164 LIQUIDATION_WATERFALL | Tier 5 (Equity) distributed 0.00 USD and foreign assets: {} to shareholders.
FAILED                                                                   [ 12%]
tests/integration/test_omo_system.py::test_execute_omo_purchase_order_creation PASSED [ 12%]
tests/integration/test_omo_system.py::test_execute_omo_sale_order_creation PASSED [ 12%]
tests/integration/test_omo_system.py::test_process_omo_purchase_transaction PASSED [ 13%]
tests/integration/test_omo_system.py::test_process_omo_sale_transaction PASSED [ 13%]
tests/integration/test_persistence_purity.py::test_analytics_system_purity PASSED [ 13%]
tests/integration/test_phase20_integration.py::TestPhase20Integration::test_immigration_trigger 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.immigration_manager:immigration_manager.py:55 IMMIGRATION_TRIGGERED | Pop: 50, Unemp: 1.00%, Vacancies: 10. Influx: 5
INFO     simulation.decisions.ai_driven_household_engine:ai_driven_household_engine.py:43 AIDrivenHouseholdDecisionEngine initialized (Modularized).
FAILED                                                                   [ 13%]
tests/integration/test_phase20_integration.py::TestPhase20Integration::test_immigration_conditions_not_met PASSED [ 13%]
tests/integration/test_phase20_integration.py::TestPhase20Integration::test_system2_housing_cost_renter FAILED [ 13%]
tests/integration/test_phase20_integration.py::TestPhase20Integration::test_system2_housing_cost_owner FAILED [ 14%]
tests/integration/test_phase20_scaffolding.py::TestPhase20Scaffolding::test_gender_distribution PASSED [ 14%]
tests/integration/test_phase20_scaffolding.py::TestPhase20Scaffolding::test_household_attributes_initialization PASSED [ 14%]
tests/integration/test_phase20_scaffolding.py::TestPhase20Scaffolding::test_system2_planner_projection_bankruptcy PASSED [ 14%]
tests/integration/test_phase20_scaffolding.py::TestPhase20Scaffolding::test_system2_planner_projection_positive PASSED [ 14%]
tests/integration/test_phase23_production.py::TestPhase23Production::test_production_boost_from_fertilizer_tech FAILED [ 14%]
tests/integration/test_portfolio_integration.py::TestPortfolioIntegration::test_bank_deposit_balance 
-------------------------------- live log call --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 100000.0})
FAILED                                                                   [ 15%]
tests/integration/test_portfolio_integration.py::TestPortfolioIntegration::test_portfolio_manager_logic PASSED [ 15%]
tests/integration/test_portfolio_integration.py::TestPortfolioIntegration::test_portfolio_manager_risk_averse PASSED [ 15%]
tests/integration/test_public_manager_integration.py::TestPublicManagerIntegration::test_full_liquidation_cycle 
-------------------------------- live log call --------------------------------
WARNING  PublicManager:public_manager.py:79 Processing bankruptcy for Agent 99 at tick 1. Recovering inventory.
INFO     PublicManager:public_manager.py:87 Recovered 10.0 of gold.
INFO     PublicManager:public_manager.py:159 Generated liquidation order for 10.0 of gold at 100.0.
ERROR    simulation.systems.transaction_manager:transaction_manager.py:87 PUBLIC_MANAGER transaction failed: argument of type 'float' is not iterable
FAILED                                                                   [ 15%]
tests/integration/test_purity_gate.py::test_decision_context_purity PASSED [ 15%]
tests/integration/test_purity_gate.py::test_standalone_firm_engine_uses_dto 
-------------------------------- live log call --------------------------------
INFO     simulation.decisions.standalone_rule_based_firm_engine:standalone_rule_based_firm_engine.py:33 StandaloneRuleBasedFirmDecisionEngine initialized.
INFO     simulation.decisions.standalone_rule_based_firm_engine:standalone_rule_based_firm_engine.py:101 Firm 1 RuleBased: Need more labor, adjusting wages/hiring.
INFO     simulation.decisions.standalone_rule_based_firm_engine:standalone_rule_based_firm_engine.py:214 Firm 1 RuleBased Price Adj: Selling 50.0 of wood at price 10.00
INFO     simulation.decisions.standalone_rule_based_firm_engine:standalone_rule_based_firm_engine.py:140 Firm 1 RuleBased: Adjusting price and selling.
PASSED                                                                   [ 15%]
tests/integration/test_purity_gate.py::test_household_engine_uses_dto 
-------------------------------- live log call --------------------------------
INFO     simulation.decisions.ai_driven_household_engine:ai_driven_household_engine.py:43 AIDrivenHouseholdDecisionEngine initialized (Modularized).
INFO     simulation.decisions.ai_driven_household_engine:consumption_manager.py:32 SURVIVAL_CHECK | Need: 0, Threshold: 0.8, Food: <MagicMock name='mock.config.primary_survival_good_id' id='1806937660048'>
PASSED                                                                   [ 16%]
tests/integration/test_settlement_system_atomic.py::test_settlement_scenario_1_standard_inheritance 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
FAILED                                                                   [ 16%]
tests/integration/test_settlement_system_atomic.py::test_settlement_scenario_2_escheatment 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
FAILED                                                                   [ 16%]
tests/integration/test_settlement_system_atomic.py::test_settlement_scenario_3_insolvency 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
FAILED                                                                   [ 16%]
tests/integration/test_shareholder_registry.py::test_registry_basic_operations PASSED [ 16%]
tests/integration/test_shareholder_registry.py::test_stock_market_integration PASSED [ 16%]
tests/integration/test_td194_integration.py::TestTD194Integration::test_household_make_decision_integrity PASSED [ 16%]
tests/integration/test_td194_integration.py::TestTD194Integration::test_firm_make_decision_integrity PASSED [ 17%]
tests/integration/test_thoughtstream_logger.py::test_logger_functionality PASSED [ 17%]
tests/integration/test_tick_normalization.py::TestTickNormalization::test_run_tick_executes_phases FAILED [ 17%]
tests/integration/test_wo048_breeding.py::TestWO048Breeding::test_scenario_a_pre_modern PASSED [ 17%]
tests/integration/test_wo048_breeding.py::TestWO048Breeding::test_scenario_b_high_income PASSED [ 17%]
tests/integration/test_wo048_breeding.py::TestWO048Breeding::test_scenario_c_low_income PASSED [ 17%]
tests/integration/test_wo048_breeding.py::TestWO048Breeding::test_scenario_d_middle_income PASSED [ 18%]
tests/integration/test_wo058_production.py::test_bootstrapper_injection 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.bootstrapper:bootstrapper.py:94 BOOTSTRAPPER | Injected 50.0 units to Firm 100
WARNING  simulation.systems.bootstrapper:bootstrapper.py:108 BOOTSTRAPPER | Legacy injection of 99500.00 to Firm 100 (No SettlementSystem).
INFO     simulation.systems.bootstrapper:bootstrapper.py:94 BOOTSTRAPPER | Injected 50.0 units to Firm 101
WARNING  simulation.systems.bootstrapper:bootstrapper.py:108 BOOTSTRAPPER | Legacy injection of 97500.00 to Firm 101 (No SettlementSystem).
INFO     simulation.systems.bootstrapper:bootstrapper.py:110 BOOTSTRAPPER | Injected resources into 1 firms.
INFO     simulation.systems.bootstrapper:bootstrapper.py:52 BOOTSTRAPPER | Force-assigned 1 workers to Firm 100
INFO     simulation.systems.bootstrapper:bootstrapper.py:52 BOOTSTRAPPER | Force-assigned 0 workers to Firm 101
INFO     simulation.systems.bootstrapper:bootstrapper.py:54 BOOTSTRAPPER | Total force-assigned workers: 1
PASSED                                                                   [ 18%]
tests/integration/test_wo058_production.py::test_production_kickstart 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.bootstrapper:bootstrapper.py:94 BOOTSTRAPPER | Injected 50.0 units to Firm 100
WARNING  simulation.systems.bootstrapper:bootstrapper.py:108 BOOTSTRAPPER | Legacy injection of 97000.00 to Firm 100 (No SettlementSystem).
INFO     simulation.systems.bootstrapper:bootstrapper.py:110 BOOTSTRAPPER | Injected resources into 1 firms.
INFO     simulation.systems.bootstrapper:bootstrapper.py:52 BOOTSTRAPPER | Force-assigned 1 workers to Firm 100
INFO     simulation.systems.bootstrapper:bootstrapper.py:54 BOOTSTRAPPER | Total force-assigned workers: 1
PASSED                                                                   [ 18%]
tests/integration/test_wo167_grace_protocol.py::TestGraceProtocol::test_firm_grace_protocol PASSED [ 18%]
tests/integration/test_wo167_grace_protocol.py::TestGraceProtocol::test_household_grace_protocol PASSED [ 18%]
tests/modules/finance/test_exchange_engine.py::TestCurrencyExchangeEngine::test_convert PASSED [ 18%]
tests/modules/finance/test_exchange_engine.py::TestCurrencyExchangeEngine::test_load_parity PASSED [ 19%]
tests/modules/finance/test_exchange_engine.py::TestCurrencyExchangeEngine::test_missing_config PASSED [ 19%]
tests/modules/governance/test_system_command_processor.py::test_set_corporate_tax_rate 
-------------------------------- live log call --------------------------------
INFO     modules.governance.processor:processor.py:27 SYSTEM_COMMAND | Executing SET_TAX_RATE
INFO     modules.governance.processor:processor.py:66 SYSTEM_COMMAND | Corporate Tax Rate: 0.2 -> 0.25
PASSED                                                                   [ 19%]
tests/modules/governance/test_system_command_processor.py::test_set_income_tax_rate 
-------------------------------- live log call --------------------------------
INFO     modules.governance.processor:processor.py:27 SYSTEM_COMMAND | Executing SET_TAX_RATE
INFO     modules.governance.processor:processor.py:75 SYSTEM_COMMAND | Income Tax Rate: 0.1 -> 0.15
PASSED                                                                   [ 19%]
tests/modules/governance/test_system_command_processor.py::test_set_base_interest_rate 
-------------------------------- live log call --------------------------------
INFO     modules.governance.processor:processor.py:27 SYSTEM_COMMAND | Executing SET_INTEREST_RATE
INFO     modules.governance.processor:processor.py:98 SYSTEM_COMMAND | CB Base Rate: 0.05 -> 0.03
PASSED                                                                   [ 19%]
tests/modules/governance/test_system_command_processor.py::test_ignore_unknown_tax_type 
-------------------------------- live log call --------------------------------
INFO     modules.governance.processor:processor.py:27 SYSTEM_COMMAND | Executing SET_TAX_RATE
WARNING  modules.governance.processor:processor.py:78 SYSTEM_COMMAND | Unknown tax type: invalid
PASSED                                                                   [ 19%]
tests/modules/governance/test_system_command_processor.py::test_missing_government 
-------------------------------- live log call --------------------------------
INFO     modules.governance.processor:processor.py:27 SYSTEM_COMMAND | Executing SET_TAX_RATE
ERROR    modules.governance.processor:processor.py:46 SYSTEM_COMMAND | Government agent is None.
PASSED                                                                   [ 20%]
tests/modules/government/test_government_integration.py::test_execute_social_policy_integration 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 20%]
tests/modules/government/test_government_integration.py::test_execute_social_policy_tax_and_welfare 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 20%]
tests/modules/government/test_tax_service.py::test_collect_wealth_tax PASSED [ 20%]
tests/modules/government/test_tax_service.py::test_collect_wealth_tax_below_threshold PASSED [ 20%]
tests/modules/government/test_welfare_manager.py::test_run_welfare_check_unemployment PASSED [ 20%]
tests/modules/government/test_welfare_manager.py::test_run_welfare_check_stimulus 
-------------------------------- live log call --------------------------------
WARNING  modules.government.welfare.manager:manager.py:111 STIMULUS_TRIGGERED | GDP Drop Detected. Requests generated.
PASSED                                                                   [ 21%]
tests/modules/government/test_welfare_manager.py::test_provide_firm_bailout PASSED [ 21%]
tests/modules/government/test_welfare_manager.py::test_run_welfare_check_with_firm PASSED [ 21%]
tests/modules/household/test_political_component.py::test_initialize_state_growth_oriented PASSED [ 21%]
tests/modules/household/test_political_component.py::test_initialize_state_conservative PASSED [ 21%]
tests/modules/household/test_political_component.py::test_update_opinion_match PASSED [ 21%]
tests/modules/household/test_political_component.py::test_update_opinion_mismatch_and_discontent PASSED [ 22%]
tests/modules/household/test_political_component.py::test_trust_damper PASSED [ 22%]
tests/modules/household/test_political_integration.py::test_household_update_political_opinion_integration FAILED [ 22%]
tests/orchestration/test_state_synchronization.py::TestStateSynchronization::test_transient_queue_accumulation PASSED [ 22%]
tests/orchestration/test_state_synchronization.py::TestStateSynchronization::test_reassignment_guardrail PASSED [ 22%]
tests/scenarios/test_leviathan_emergence.py::TestLeviathanEmergence::test_scapegoat_emergence 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
WARNING  simulation.policies.adaptive_gov_policy:adaptive_gov_policy.py:89 Failed to load adaptive policy bounds from config: not enough values to unpack (expected 2, got 0). Using defaults.
INFO     modules.government.components.policy_lockout_manager:policy_lockout_manager.py:33 POLICY_LOCKOUT | Locked KEYNESIAN_FISCAL until tick 30 (Duration: 20)
INFO     simulation.agents.government:government.py:413 ADVISOR_FIRED | Fired KEYNESIAN advisor. Locked tags: ['KEYNESIAN_FISCAL'] for 20 ticks.
INFO     simulation.policies.adaptive_gov_policy:adaptive_gov_policy.py:117 POLICY_EXECUTE | Fire Advisor (Scapegoat) (U=0.1840)
PASSED                                                                   [ 22%]
tests/scenarios/test_leviathan_emergence.py::TestLeviathanEmergence::test_paradox_support_emergence PASSED [ 22%]
tests/scenarios/test_leviathan_emergence.py::TestLeviathanEmergence::test_political_business_cycle_emergence 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
WARNING  simulation.policies.adaptive_gov_policy:adaptive_gov_policy.py:89 Failed to load adaptive policy bounds from config: not enough values to unpack (expected 2, got 0). Using defaults.
INFO     simulation.policies.adaptive_gov_policy:adaptive_gov_policy.py:117 POLICY_EXECUTE | Tax Cut (Corp) (U=0.4875)
PASSED                                                                   [ 23%]
tests/simulation/test_bank_decomposition.py::test_bank_initialization 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 23%]
tests/simulation/test_bank_decomposition.py::test_grant_loan_delegation 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 23%]
tests/simulation/test_bank_decomposition.py::test_run_tick_defaults 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
-------------------------------- live log call --------------------------------
WARNING  simulation.bank:bank.py:491 Bank: EventBus not injected. Loan default consequences (penalties, seizure) skipped.
FAILED                                                                   [ 23%]
tests/simulation/test_firm_refactor.py::test_firm_initialization_states PASSED [ 23%]
tests/simulation/test_firm_refactor.py::test_inventory_handler_implementation PASSED [ 23%]
tests/simulation/test_firm_refactor.py::test_command_bus_internal_orders PASSED [ 24%]
tests/simulation/test_firm_refactor.py::test_generate_transactions_delegation PASSED [ 24%]
tests/simulation/test_firm_refactor.py::test_produce_delegation PASSED   [ 24%]
tests/system/test_audit_integrity.py::TestEconomicIntegrityAudit::test_birth_gift_rounding 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.demographic_manager:demographic_manager.py:39 DemographicManager initialized.
PASSED                                                                   [ 24%]
tests/system/test_audit_integrity.py::TestEconomicIntegrityAudit::test_inheritance_dust_sweep PASSED [ 24%]
tests/system/test_audit_integrity.py::TestEconomicIntegrityAudit::test_public_manager_tax_atomicity PASSED [ 24%]
tests/system/test_engine.py::TestSimulation::test_simulation_initialization ERROR [ 25%]
tests/system/test_engine.py::TestSimulation::test_prepare_market_data_basic ERROR [ 25%]
tests/system/test_engine.py::TestSimulation::test_prepare_market_data_no_goods_market ERROR [ 25%]
tests/system/test_engine.py::TestSimulation::test_prepare_market_data_with_best_ask ERROR [ 25%]
tests/system/test_engine.py::TestSimulation::test_process_transactions_goods_trade ERROR [ 25%]
tests/system/test_engine.py::TestSimulation::test_process_transactions_labor_trade ERROR [ 25%]
tests/system/test_engine.py::TestSimulation::test_process_transactions_research_labor_trade ERROR [ 26%]
tests/system/test_engine.py::TestSimulation::test_process_transactions_invalid_agents ERROR [ 26%]
tests/system/test_engine.py::test_handle_agent_lifecycle_removes_inactive_agents ERROR [ 26%]
tests/system/test_phase29_depression.py::TestPhase29Depression::test_crisis_monitor_logging 
-------------------------------- live log call --------------------------------
INFO     TestPhase29:initializer.py:134 Acquired exclusive lock on simulation.lock
INFO     simulation.agents.central_bank:central_bank.py:49 CENTRAL_BANK_INIT | Rate: 5.00%, Target Infl: 2.00%
INFO     TestPhase29:initializer.py:269 GENESIS | Central Bank minted M0: 1,000,000.00
INFO     simulation.bank:bank.py:91 Bank 10 initialized. Assets: defaultdict(<class 'float'>, {'USD': 0.0})
INFO     simulation.agents.government:government.py:152 Government 11 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
FAILED                                                                   [ 26%]
tests/system/test_phase29_depression.py::TestPhase29Depression::test_depression_scenario_triggers 
-------------------------------- live log call --------------------------------
INFO     TestPhase29:initializer.py:134 Acquired exclusive lock on simulation.lock
INFO     simulation.agents.central_bank:central_bank.py:49 CENTRAL_BANK_INIT | Rate: 5.00%, Target Infl: 2.00%
INFO     TestPhase29:initializer.py:269 GENESIS | Central Bank minted M0: 1,000,000.00
INFO     simulation.bank:bank.py:91 Bank 10 initialized. Assets: defaultdict(<class 'float'>, {'USD': 0.0})
INFO     simulation.agents.government:government.py:152 Government 11 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
FAILED                                                                   [ 26%]
tests/test_ledger_manager.py::test_parse_ledger_standard PASSED          [ 26%]
tests/test_ledger_manager.py::test_archive_resolved_items PASSED         [ 27%]
tests/test_ledger_manager.py::test_register_new_item PASSED              [ 27%]
tests/test_ledger_manager.py::test_sync_with_codebase PASSED             [ 27%]
tests/test_ledger_manager.py::test_parser_resilience PASSED              [ 27%]
tests/test_ledger_manager.py::test_archive_atomicity_failure PASSED      [ 27%]
tests/test_ledger_manager.py::test_get_next_id PASSED                    [ 27%]
tests/test_policy_lockout.py::TestPolicyLockout::test_government_fire_advisor 
-------------------------------- live log call --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
INFO     modules.government.components.policy_lockout_manager:policy_lockout_manager.py:33 POLICY_LOCKOUT | Locked KEYNESIAN_FISCAL until tick 520 (Duration: 20)
INFO     simulation.agents.government:government.py:413 ADVISOR_FIRED | Fired KEYNESIAN advisor. Locked tags: ['KEYNESIAN_FISCAL'] for 20 ticks.
PASSED                                                                   [ 27%]
tests/test_policy_lockout.py::TestPolicyLockout::test_manager_lockout 
-------------------------------- live log call --------------------------------
INFO     modules.government.components.policy_lockout_manager:policy_lockout_manager.py:33 POLICY_LOCKOUT | Locked KEYNESIAN_FISCAL until tick 120 (Duration: 20)
INFO     modules.government.components.policy_lockout_manager:policy_lockout_manager.py:33 POLICY_LOCKOUT | Locked KEYNESIAN_FISCAL until tick 130 (Duration: 30)
PASSED                                                                   [ 28%]
tests/test_wo_4_1_protocols.py::test_housing_handler_with_protocol_agent FAILED [ 28%]
tests/test_wo_4_1_protocols.py::test_protocol_compliance PASSED          [ 28%]
tests/test_ws.py::test_websocket_endpoint 
-------------------------------- live log call --------------------------------
INFO     server:server.py:57 Initializing simulation...
INFO     server:server.py:68 Simulation initialized and running. Server is ready.
INFO     server:server.py:37 Starting simulation loop...
ERROR    simulation.orchestration.persistence_bridge:persistence_bridge.py:54 ‚ùå [Persistence] Failed to save snapshot: Object of type MagicMock is not JSON serializable
INFO     server:server.py:77 Shutting down simulation...
FAILED                                                                   [ 28%]
tests/unit/agents/test_government.py::test_calculate_income_tax_delegation 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 100000.0})
PASSED                                                                   [ 28%]
tests/unit/agents/test_government.py::test_calculate_corporate_tax_delegation 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 100000.0})
PASSED                                                                   [ 28%]
tests/unit/agents/test_government.py::test_collect_tax_delegation 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 100000.0})
PASSED                                                                   [ 29%]
tests/unit/agents/test_government.py::test_run_public_education_delegation 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 100000.0})
PASSED                                                                   [ 29%]
tests/unit/agents/test_government.py::test_deficit_spending_allowed_within_limit 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
PASSED                                                                   [ 29%]
tests/unit/agents/test_government.py::test_deficit_spending_blocked_beyond_limit 
------------------------------- live log setup --------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
-------------------------------- live log call --------------------------------
WARNING  simulation.agents.government:government.py:438 WELFARE_FAILED | Insufficient funds even after bond issuance attempt. Needed: 500.0, Has: 100.0
PASSED                                                                   [ 29%]
tests/unit/components/test_agent_lifecycle.py::test_run_tick_execution_order PASSED [ 29%]
tests/unit/components/test_agent_lifecycle.py::test_run_tick_unemployed PASSED [ 29%]
tests/unit/components/test_demographics_component.py::TestDemographicsComponent::test_add_child PASSED [ 30%]
tests/unit/components/test_demographics_component.py::TestDemographicsComponent::test_age_one_tick PASSED [ 30%]
tests/unit/components/test_demographics_component.py::TestDemographicsComponent::test_create_offspring_demographics PASSED [ 30%]
tests/unit/components/test_demographics_component.py::TestDemographicsComponent::test_get_generational_similarity PASSED [ 30%]
tests/unit/components/test_demographics_component.py::TestDemographicsComponent::test_handle_death_above_threshold FAILED [ 30%]
tests/unit/components/test_demographics_component.py::TestDemographicsComponent::test_handle_death_under_threshold PASSED [ 30%]
tests/unit/components/test_demographics_component.py::TestDemographicsComponent::test_initialization PASSED [ 31%]
tests/unit/components/test_demographics_component.py::TestDemographicsComponent::test_set_spouse PASSED [ 31%]
tests/unit/components/test_market_component.py::test_choose_best_seller_utility PASSED [ 31%]
tests/unit/components/test_market_component.py::test_choose_best_seller_no_market PASSED [ 31%]
tests/unit/corporate/test_corporate_orchestrator.py::test_orchestration PASSED [ 31%]
tests/unit/corporate/test_financial_strategy.py::test_dividend_logic PASSED [ 31%]
tests/unit/corporate/test_financial_strategy.py::test_debt_logic_borrow PASSED [ 32%]
tests/unit/corporate/test_hr_strategy.py::test_hiring_logic PASSED       [ 32%]
tests/unit/corporate/test_production_strategy.py::test_rd_logic PASSED   [ 32%]
tests/unit/corporate/test_production_strategy.py::test_automation_investment PASSED [ 32%]
tests/unit/corporate/test_sales_manager.py::test_pricing_logic PASSED    [ 32%]
tests/unit/decisions/test_animal_spirits_phase2.py::TestHouseholdSurvivalOverride::test_survival_override_triggered PASSED [ 32%]
tests/unit/decisions/test_animal_spirits_phase2.py::TestHouseholdSurvivalOverride::test_survival_override_insufficient_funds PASSED [ 33%]
tests/unit/decisions/test_animal_spirits_phase2.py::TestFirmPricingLogic::test_cost_plus_fallback PASSED [ 33%]
tests/unit/decisions/test_animal_spirits_phase2.py::TestFirmPricingLogic::test_fire_sale_trigger PASSED [ 33%]
tests/unit/decisions/test_finance_rules.py::TestFinanceRules::test_rd_investment 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
PASSED                                                                   [ 33%]
tests/unit/decisions/test_finance_rules.py::TestFinanceRules::test_capex_investment 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
PASSED                                                                   [ 33%]
tests/unit/decisions/test_finance_rules.py::TestFinanceRules::test_dividend_setting 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
INFO     simulation.decisions.firm.financial_strategy:financial_strategy.py:199 SEO | Firm 1 offering 500.0 shares at 1.00
PASSED                                                                   [ 33%]
tests/unit/decisions/test_household_engine_refactor.py::test_engine_execution_parity_smoke PASSED [ 33%]
tests/unit/decisions/test_household_integration_new.py::TestHouseholdIntegrationNew::test_make_decision_integration SKIPPED [ 34%]
tests/unit/decisions/test_hr_rules.py::TestHRRules::test_make_decisions_hires_labor 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
INFO     simulation.decisions.firm.financial_strategy:financial_strategy.py:199 SEO | Firm 1 offering 500.0 shares at 1.00
PASSED                                                                   [ 34%]
tests/unit/decisions/test_hr_rules.py::TestHRRules::test_make_decisions_does_not_hire_when_full 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
INFO     simulation.decisions.firm.financial_strategy:financial_strategy.py:199 SEO | Firm 1 offering 500.0 shares at 1.00
PASSED                                                                   [ 34%]
tests/unit/decisions/test_hr_rules.py::TestHRRules::test_make_decisions_fires_excess_labor 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
INFO     simulation.decisions.firm.financial_strategy:financial_strategy.py:199 SEO | Firm 1 offering 500.0 shares at 1.00
PASSED                                                                   [ 34%]
tests/unit/decisions/test_production_rules.py::TestProductionRules::test_initialization PASSED [ 34%]
tests/unit/decisions/test_production_rules.py::TestProductionRules::test_make_decisions_overstock_reduces_target 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
INFO     simulation.decisions.firm.financial_strategy:financial_strategy.py:199 SEO | Firm 1 offering 500.0 shares at 1.00
PASSED                                                                   [ 34%]
tests/unit/decisions/test_production_rules.py::TestProductionRules::test_make_decisions_understock_increases_target 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
INFO     simulation.decisions.firm.financial_strategy:financial_strategy.py:199 SEO | Firm 1 offering 500.0 shares at 1.00
PASSED                                                                   [ 35%]
tests/unit/decisions/test_production_rules.py::TestProductionRules::test_make_decisions_target_within_bounds_no_change 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
INFO     simulation.decisions.firm.financial_strategy:financial_strategy.py:199 SEO | Firm 1 offering 500.0 shares at 1.00
PASSED                                                                   [ 35%]
tests/unit/decisions/test_production_rules.py::TestProductionRules::test_make_decisions_target_min_max_bounds 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
INFO     simulation.decisions.firm.financial_strategy:financial_strategy.py:199 SEO | Firm 1 offering 500.0 shares at 1.00
PASSED                                                                   [ 35%]
tests/unit/decisions/test_sales_rules.py::TestSalesRules::test_sales_aggressiveness_impact_on_price 
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
INFO     simulation.decisions.firm.financial_strategy:financial_strategy.py:199 SEO | Firm 1 offering 500.0 shares at 1.00
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
INFO     simulation.decisions.firm.financial_strategy:financial_strategy.py:199 SEO | Firm 1 offering 500.0 shares at 1.00
PASSED                                                                   [ 35%]
tests/unit/finance/call_market/test_service.py::TestCallMarketService::test_clear_market_matching PASSED [ 35%]
tests/unit/finance/call_market/test_service.py::TestCallMarketService::test_settle_matured_loans PASSED [ 35%]
tests/unit/finance/call_market/test_service.py::TestCallMarketService::test_submit_loan_offer_insufficient_reserves PASSED [ 36%]
tests/unit/finance/call_market/test_service.py::TestCallMarketService::test_submit_loan_offer_success PASSED [ 36%]
tests/unit/finance/call_market/test_service.py::TestCallMarketService::test_submit_loan_request PASSED [ 36%]
tests/unit/finance/test_bank_service_interface.py::TestBankServiceInterface::test_bank_methods_presence 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 36%]
tests/unit/finance/test_bank_service_interface.py::TestBankServiceInterface::test_grant_loan 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 36%]
tests/unit/finance/test_bank_service_interface.py::TestBankServiceInterface::test_repay_loan 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 36%]
tests/unit/finance/test_bank_service_interface.py::TestBankServiceInterface::test_get_balance 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 37%]
tests/unit/finance/test_bank_service_interface.py::TestBankServiceInterface::test_get_debt_status 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 37%]
tests/unit/finance/test_bank_service_interface.py::TestBankServiceInterface::test_interface_compliance_mypy PASSED [ 37%]
tests/unit/finance/test_credit_scoring.py::test_assess_approved PASSED   [ 37%]
tests/unit/finance/test_credit_scoring.py::test_assess_dti_fail PASSED   [ 37%]
tests/unit/finance/test_credit_scoring.py::test_assess_ltv_fail PASSED   [ 37%]
tests/unit/finance/test_credit_scoring.py::test_assess_unsecured_cap_fail PASSED [ 38%]
tests/unit/finance/test_credit_scoring.py::test_zero_income_fail PASSED  [ 38%]
tests/unit/finance/test_finance_system_refactor.py::test_request_bailout_loan_success PASSED [ 38%]
tests/unit/finance/test_finance_system_refactor.py::test_request_bailout_loan_insufficient_funds 
-------------------------------- live log call --------------------------------
WARNING  modules.finance.system:system.py:303 BAILOUT_DENIED | Government insufficient funds: 100.00 < 5000.00
PASSED                                                                   [ 38%]
tests/unit/finance/test_finance_system_refactor.py::test_grant_bailout_loan_deprecated 
-------------------------------- live log call --------------------------------
WARNING  modules.finance.system:system.py:324 FinanceSystem.grant_bailout_loan is deprecated. Use request_bailout_loan.
PASSED                                                                   [ 38%]
tests/unit/governance/test_judicial_system.py::test_judicial_system_waterfall_full_recovery 
-------------------------------- live log call --------------------------------
INFO     modules.governance.judicial.system:system.py:65 JudicialSystem: Credit frozen for Agent 1 until tick 110.
INFO     modules.governance.judicial.system:system.py:72 JudicialSystem: Applied XP penalty to Agent 1.
PASSED                                                                   [ 38%]
tests/unit/governance/test_judicial_system.py::test_judicial_system_waterfall_partial_recovery_and_restructuring 
-------------------------------- live log call --------------------------------
INFO     modules.governance.judicial.system:system.py:65 JudicialSystem: Credit frozen for Agent 1 until tick 110.
INFO     modules.governance.judicial.system:system.py:72 JudicialSystem: Applied XP penalty to Agent 1.
INFO     modules.governance.judicial.system:system.py:157 JudicialSystem: Transferred 10 shares of Firm 99 from 1 to 2.
WARNING  modules.governance.judicial.system:system.py:187 JudicialSystem: Debt Restructuring Required for Agent 1. Remaining Debt: 850.0
PASSED                                                                   [ 38%]
tests/unit/household/engines/test_budget.py::test_budget_allocation PASSED [ 39%]
tests/unit/household/engines/test_consumption.py::test_consumption_execution PASSED [ 39%]
tests/unit/household/engines/test_lifecycle.py::test_lifecycle_aging PASSED [ 39%]
tests/unit/household/engines/test_lifecycle.py::test_lifecycle_death_check 
-------------------------------- live log call --------------------------------
INFO     modules.household.engines.lifecycle:lifecycle.py:54 BIO_DEATH | Agent 1 died of natural causes at age 100.0
PASSED                                                                   [ 39%]
tests/unit/household/engines/test_needs.py::test_needs_update PASSED     [ 39%]
tests/unit/household/engines/test_social.py::test_social_status_update PASSED [ 39%]
tests/unit/household/engines/test_survival_instinct.py::test_budget_survival_priority PASSED [ 40%]
tests/unit/household/engines/test_survival_instinct.py::test_consumption_survival_instinct PASSED [ 40%]
tests/unit/household/test_snapshot_assembler.py::TestHouseholdSnapshotAssembler::test_assemble_snapshot_copies_state PASSED [ 40%]
tests/unit/household/test_snapshot_assembler.py::TestHouseholdSnapshotAssembler::test_assemble_nested_structures PASSED [ 40%]
tests/unit/markets/test_circuit_breaker_relaxation.py::TestCircuitBreakerRelaxation::test_sparse_history_returns_infinite_bounds PASSED [ 40%]
tests/unit/markets/test_circuit_breaker_relaxation.py::TestCircuitBreakerRelaxation::test_sufficient_history_returns_finite_bounds PASSED [ 40%]
tests/unit/markets/test_circuit_breaker_relaxation.py::TestCircuitBreakerRelaxation::test_no_history_returns_infinite_bounds PASSED [ 41%]
tests/unit/markets/test_circuit_breaker_relaxation.py::TestCircuitBreakerRelaxation::test_default_config_fallback PASSED [ 41%]
tests/unit/markets/test_housing_transaction_handler.py::test_housing_transaction_success PASSED [ 41%]
tests/unit/markets/test_housing_transaction_handler.py::test_housing_transaction_insufficient_down_payment PASSED [ 41%]
tests/unit/markets/test_housing_transaction_handler.py::test_housing_transaction_loan_rejected PASSED [ 41%]
tests/unit/markets/test_housing_transaction_handler.py::test_housing_transaction_disbursement_failed PASSED [ 41%]
tests/unit/markets/test_loan_market.py::TestLoanMarket::test_initialization PASSED [ 42%]
tests/unit/markets/test_loan_market.py::TestLoanMarket::test_place_loan_request_grants_loan 
-------------------------------- live log call --------------------------------
INFO     simulation.loan_market:loan_market.py:270 Order placed: Type=LOAN_REQUEST, Item=loan_item, Agent=1, Amount=100
INFO     simulation.loan_market:loan_market.py:302 Loan granted to 1 for 100.00. Loan ID: loan_id_123
PASSED                                                                   [ 42%]
tests/unit/markets/test_loan_market.py::TestLoanMarket::test_place_loan_request_with_profile 
-------------------------------- live log call --------------------------------
INFO     simulation.loan_market:loan_market.py:270 Order placed: Type=LOAN_REQUEST, Item=loan_item, Agent=1, Amount=100
INFO     simulation.loan_market:loan_market.py:302 Loan granted to 1 for 100.00. Loan ID: loan_id_123
PASSED                                                                   [ 42%]
tests/unit/markets/test_loan_market.py::TestLoanMarket::test_place_loan_request_denies_loan 
-------------------------------- live log call --------------------------------
INFO     simulation.loan_market:loan_market.py:270 Order placed: Type=LOAN_REQUEST, Item=loan_item, Agent=1, Amount=100
WARNING  simulation.loan_market:loan_market.py:307 Loan denied for 1 for 100.00.
PASSED                                                                   [ 42%]
tests/unit/markets/test_loan_market.py::TestLoanMarket::test_place_repayment_processes_repayment 
-------------------------------- live log call --------------------------------
INFO     simulation.loan_market:loan_market.py:270 Order placed: Type=REPAYMENT, Item=loan_id_456, Agent=1, Amount=50
INFO     simulation.loan_market:loan_market.py:331 Repayment of 50.00 processed for loan loan_id_456 by 1.
PASSED                                                                   [ 42%]
tests/unit/markets/test_loan_market.py::TestLoanMarket::test_place_order_unknown_type_logs_warning 
-------------------------------- live log call --------------------------------
INFO     simulation.loan_market:loan_market.py:270 Order placed: Type=UNKNOWN_TYPE, Item=item, Agent=1, Amount=10
WARNING  simulation.loan_market:loan_market.py:393 Unknown order type: UNKNOWN_TYPE
PASSED                                                                   [ 42%]
tests/unit/markets/test_loan_market_mortgage.py::TestLoanMarketMortgage::test_evaluate_mortgage_success PASSED [ 43%]
tests/unit/markets/test_loan_market_mortgage.py::TestLoanMarketMortgage::test_evaluate_mortgage_fail_ltv 
-------------------------------- live log call --------------------------------
INFO     simulation.loan_market:loan_market.py:89 LOAN_DENIED | LTV 0.90 > 0.8
PASSED                                                                   [ 43%]
tests/unit/markets/test_loan_market_mortgage.py::TestLoanMarketMortgage::test_evaluate_mortgage_fail_dti 
-------------------------------- live log call --------------------------------
INFO     simulation.loan_market:loan_market.py:122 LOAN_DENIED | DTI 0.54 > 0.43
PASSED                                                                   [ 43%]
tests/unit/markets/test_loan_market_mortgage.py::TestLoanMarketMortgage::test_evaluate_mortgage_fail_dti_with_existing_debt 
-------------------------------- live log call --------------------------------
INFO     simulation.loan_market:loan_market.py:122 LOAN_DENIED | DTI 0.47 > 0.43
PASSED                                                                   [ 43%]
tests/unit/markets/test_loan_market_mortgage.py::TestLoanMarketMortgage::test_stage_mortgage_success PASSED [ 43%]
tests/unit/markets/test_loan_market_mortgage.py::TestLoanMarketMortgage::test_stage_mortgage_fail_eval 
-------------------------------- live log call --------------------------------
INFO     simulation.loan_market:loan_market.py:89 LOAN_DENIED | LTV 0.90 > 0.8
PASSED                                                                   [ 43%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_initialization PASSED [ 44%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_place_buy_order_adds_and_sorts PASSED [ 44%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_place_sell_order_adds_and_sorts PASSED [ 44%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_place_order_unknown_type_logs_warning PASSED [ 44%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_match_orders_full_fill PASSED [ 44%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_match_orders_partial_fill_buy_order PASSED [ 44%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_match_orders_partial_fill_sell_order PASSED [ 44%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_match_orders_no_match_price PASSED [ 45%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_match_orders_multiple_matches PASSED [ 45%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_match_orders_different_items PASSED [ 45%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_match_orders_empty_books PASSED [ 45%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_match_orders_transaction_type_goods PASSED [ 45%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_match_orders_transaction_type_labor PASSED [ 45%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_get_best_ask_empty PASSED [ 46%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_get_best_ask_non_empty PASSED [ 46%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_get_best_bid_empty PASSED [ 46%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_get_best_bid_non_empty PASSED [ 46%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_get_order_book_status_empty PASSED [ 46%]
tests/unit/markets/test_order_book_market.py::TestOrderBookMarket::test_get_order_book_status_non_empty PASSED [ 46%]
tests/unit/modules/analysis/test_bubble_observatory.py::TestBubbleObservatory::test_pir_calculation_normal PASSED [ 47%]
tests/unit/modules/analysis/test_bubble_observatory.py::TestBubbleObservatory::test_pir_calculation_zero_income PASSED [ 47%]
tests/unit/modules/analysis/test_bubble_observatory.py::TestBubbleObservatory::test_pir_alarm PASSED [ 47%]
tests/unit/modules/analysis/test_bubble_observatory.py::TestBubbleObservatory::test_csv_logging_structure PASSED [ 47%]
tests/unit/modules/common/config/test_impl.py::test_config_manager_load_and_get PASSED [ 47%]
tests/unit/modules/common/config/test_impl.py::test_config_manager_override 
-------------------------------- live log call --------------------------------
INFO     modules.common.config.impl:impl.py:63 Registered new domain: test_domain
PASSED                                                                   [ 47%]
tests/unit/modules/common/config/test_impl.py::test_legacy_support PASSED [ 48%]
tests/unit/modules/common/config_manager/test_config_manager.py::test_load_yaml PASSED [ 48%]
tests/unit/modules/common/config_manager/test_config_manager.py::test_get_with_default PASSED [ 48%]
tests/unit/modules/common/config_manager/test_config_manager.py::test_hybrid_fallback PASSED [ 48%]
tests/unit/modules/common/config_manager/test_config_manager.py::test_set_value_for_test PASSED [ 48%]
tests/unit/modules/finance/central_bank/test_cb_service.py::test_set_policy_rate_valid PASSED [ 48%]
tests/unit/modules/finance/central_bank/test_cb_service.py::test_set_policy_rate_invalid PASSED [ 49%]
tests/unit/modules/finance/central_bank/test_cb_service.py::test_conduct_omo_purchase_success PASSED [ 49%]
tests/unit/modules/finance/central_bank/test_cb_service.py::test_conduct_omo_sale_success PASSED [ 49%]
tests/unit/modules/finance/central_bank/test_cb_service.py::test_conduct_omo_failure PASSED [ 49%]
tests/unit/modules/finance/test_corporate_finance.py::TestAltmanZScoreCalculator::test_calculate_safe_zone PASSED [ 49%]
tests/unit/modules/finance/test_corporate_finance.py::TestAltmanZScoreCalculator::test_calculate_distress_zone PASSED [ 49%]
tests/unit/modules/finance/test_corporate_finance.py::TestAltmanZScoreCalculator::test_calculate_zero_assets PASSED [ 50%]
tests/unit/modules/finance/test_corporate_finance.py::TestAltmanZScoreCalculator::test_calculate_negative_values PASSED [ 50%]
tests/unit/modules/finance/test_double_entry.py::TestDoubleEntry::test_bailout_loan_generates_command PASSED [ 50%]
tests/unit/modules/finance/test_double_entry.py::TestDoubleEntry::test_market_bond_issuance_generates_transaction PASSED [ 50%]
tests/unit/modules/finance/test_double_entry.py::TestDoubleEntry::test_qe_bond_issuance_generates_transaction PASSED [ 50%]
tests/unit/modules/finance/test_sovereign_debt.py::TestSovereignDebt::test_issue_treasury_bonds_calls_settlement_system PASSED [ 50%]
tests/unit/modules/finance/test_sovereign_debt.py::TestSovereignDebt::test_collect_corporate_tax_calls_settlement_system 
-------------------------------- live log call --------------------------------
WARNING  modules.finance.system:system.py:288 FinanceSystem.collect_corporate_tax called. Should be using Transaction Generation.
PASSED                                                                   [ 50%]
tests/unit/modules/finance/test_sovereign_debt.py::TestSovereignDebt::test_risk_premium_calculation PASSED [ 51%]
tests/unit/modules/finance/test_sovereign_debt.py::TestSovereignDebt::test_insufficient_funds_fails_issuance 
-------------------------------- live log call --------------------------------
WARNING  modules.finance.system:system.py:131 BOND_ISSUANCE_FAILED | No buyer found (Bank insufficient funds).
PASSED                                                                   [ 51%]
tests/unit/modules/finance/test_system.py::test_evaluate_solvency_startup_pass PASSED [ 51%]
tests/unit/modules/finance/test_system.py::test_evaluate_solvency_startup_fail PASSED [ 51%]
tests/unit/modules/finance/test_system.py::test_evaluate_solvency_established_pass PASSED [ 51%]
tests/unit/modules/finance/test_system.py::test_evaluate_solvency_established_fail PASSED [ 51%]
tests/unit/modules/finance/test_system.py::test_issue_treasury_bonds_market PASSED [ 52%]
tests/unit/modules/finance/test_system.py::test_issue_treasury_bonds_qe PASSED [ 52%]
tests/unit/modules/finance/test_system.py::test_issue_treasury_bonds_fail 
-------------------------------- live log call --------------------------------
WARNING  modules.finance.system:system.py:131 BOND_ISSUANCE_FAILED | No buyer found (Bank insufficient funds).
PASSED                                                                   [ 52%]
tests/unit/modules/finance/test_system.py::test_bailout_fails_with_insufficient_government_funds 
-------------------------------- live log call --------------------------------
WARNING  modules.finance.system:system.py:303 BAILOUT_DENIED | Government insufficient funds: 100.00 < 500.00
PASSED                                                                   [ 52%]
tests/unit/modules/finance/test_system.py::test_grant_bailout_loan PASSED [ 52%]
tests/unit/modules/finance/test_system.py::test_service_debt_central_bank_repayment PASSED [ 52%]
tests/unit/modules/government/components/test_fiscal_policy_manager.py::TestFiscalPolicyManager::test_determine_fiscal_stance_calculates_survival_cost_correctly PASSED [ 53%]
tests/unit/modules/government/components/test_fiscal_policy_manager.py::TestFiscalPolicyManager::test_determine_fiscal_stance_defaults_if_no_config PASSED [ 53%]
tests/unit/modules/government/components/test_fiscal_policy_manager.py::TestFiscalPolicyManager::test_calculate_tax_liability_progressive PASSED [ 53%]
tests/unit/modules/government/components/test_fiscal_policy_manager.py::TestFiscalPolicyManager::test_calculate_tax_liability_zero_or_negative PASSED [ 53%]
tests/unit/modules/government/components/test_monetary_policy_manager.py::TestMonetaryPolicyManager::test_equilibrium PASSED [ 53%]
tests/unit/modules/government/components/test_monetary_policy_manager.py::TestMonetaryPolicyManager::test_gdp_zero_or_negative PASSED [ 53%]
tests/unit/modules/government/components/test_monetary_policy_manager.py::TestMonetaryPolicyManager::test_high_inflation PASSED [ 54%]
tests/unit/modules/government/components/test_monetary_policy_manager.py::TestMonetaryPolicyManager::test_missing_data_defaults PASSED [ 54%]
tests/unit/modules/government/components/test_monetary_policy_manager.py::TestMonetaryPolicyManager::test_overheating_economy PASSED [ 54%]
tests/unit/modules/government/components/test_monetary_policy_manager.py::TestMonetaryPolicyManager::test_recession PASSED [ 54%]
tests/unit/modules/government/test_adaptive_gov_brain.py::test_propose_actions_red_party PASSED [ 54%]
tests/unit/modules/government/test_adaptive_gov_brain.py::test_propose_actions_blue_party PASSED [ 54%]
tests/unit/modules/government/test_adaptive_gov_brain.py::test_candidates_generation PASSED [ 55%]
tests/unit/modules/government/test_politics_system.py::test_enact_new_tax_policy PASSED [ 55%]
tests/unit/modules/household/test_consumption_manager.py::TestConsumptionManager::test_consume_basic PASSED [ 55%]
tests/unit/modules/household/test_consumption_manager.py::TestConsumptionManager::test_consume_service PASSED [ 55%]
tests/unit/modules/household/test_consumption_manager.py::TestConsumptionManager::test_decide_and_consume PASSED [ 55%]
tests/unit/modules/household/test_decision_unit.py::TestDecisionUnit::test_orchestrate_housing_buy PASSED [ 55%]
tests/unit/modules/household/test_decision_unit.py::TestDecisionUnit::test_shadow_wage_update PASSED [ 55%]
tests/unit/modules/household/test_econ_component.py::TestEconComponent::test_update_perceived_prices_basic PASSED [ 56%]
tests/unit/modules/household/test_econ_component.py::TestEconComponent::test_update_perceived_prices_hyperinflation PASSED [ 56%]
tests/unit/modules/memory/test_memory_v2.py::TestMemoryManager::test_add_and_query_record PASSED [ 56%]
tests/unit/modules/memory/test_memory_v2.py::TestMemoryManager::test_query_filtering PASSED [ 56%]
tests/unit/modules/memory/test_memory_v2.py::TestMemoryManager::test_persistence PASSED [ 56%]
tests/unit/modules/system/execution/test_public_manager.py::TestPublicManager::test_process_bankruptcy_event 
-------------------------------- live log call --------------------------------
WARNING  PublicManager:public_manager.py:79 Processing bankruptcy for Agent 1 at tick 10. Recovering inventory.
INFO     PublicManager:public_manager.py:87 Recovered 10.0 of apple.
INFO     PublicManager:public_manager.py:87 Recovered 5.0 of banana.
PASSED                                                                   [ 56%]
tests/unit/modules/system/execution/test_public_manager.py::TestPublicManager::test_generate_liquidation_orders 
-------------------------------- live log call --------------------------------
INFO     PublicManager:public_manager.py:159 Generated liquidation order for 50.0 of apple at 9.0.
FAILED                                                                   [ 57%]
tests/unit/modules/system/execution/test_public_manager.py::TestPublicManager::test_confirm_sale PASSED [ 57%]
tests/unit/modules/system/execution/test_public_manager.py::TestPublicManager::test_deposit_revenue FAILED [ 57%]
tests/unit/modules/system/execution/test_public_manager.py::TestPublicManager::test_generate_liquidation_orders_no_signal PASSED [ 57%]
tests/unit/modules/system/execution/test_public_manager.py::TestPublicManager::test_generate_liquidation_orders_resets_metrics PASSED [ 57%]
tests/unit/modules/system/execution/test_public_manager_compliance.py::TestPublicManagerCompliance::test_implements_financial_entity FAILED [ 57%]
tests/unit/modules/system/execution/test_public_manager_compliance.py::TestPublicManagerCompliance::test_implements_asset_recovery_system PASSED [ 58%]
tests/unit/modules/system/execution/test_public_manager_compliance.py::TestPublicManagerCompliance::test_bankruptcy_processing_id_handling 
-------------------------------- live log call --------------------------------
WARNING  PublicManager:public_manager.py:79 Processing bankruptcy for Agent 99 at tick 1. Recovering inventory.
INFO     PublicManager:public_manager.py:87 Recovered 10.0 of gold.
PASSED                                                                   [ 58%]
tests/unit/modules/system/execution/test_public_manager_compliance.py::TestPublicManagerCompliance::test_liquidation_order_generation_id 
-------------------------------- live log call --------------------------------
INFO     PublicManager:public_manager.py:159 Generated liquidation order for 1.0 of gold at 95.0.
FAILED                                                                   [ 58%]
tests/unit/orchestration/test_command_service.py::test_command_service_initialization PASSED [ 58%]
tests/unit/orchestration/test_command_service.py::test_validate_set_base_rate_valid PASSED [ 58%]
tests/unit/orchestration/test_command_service.py::test_validate_set_base_rate_invalid_type 
-------------------------------- live log call --------------------------------
WARNING  simulation.orchestration.command_service:command_service.py:29 Invalid rate type for SET_BASE_RATE: <class 'str'>
PASSED                                                                   [ 58%]
tests/unit/orchestration/test_command_service.py::test_validate_set_base_rate_out_of_bounds 
-------------------------------- live log call --------------------------------
WARNING  simulation.orchestration.command_service:command_service.py:32 Rate out of bounds for SET_BASE_RATE: 0.25 (Expected 0.0-0.2)
PASSED                                                                   [ 59%]
tests/unit/orchestration/test_command_service.py::test_validate_set_tax_rate_valid PASSED [ 59%]
tests/unit/orchestration/test_command_service.py::test_validate_set_tax_rate_invalid_type 
-------------------------------- live log call --------------------------------
WARNING  simulation.orchestration.command_service:command_service.py:41 Invalid tax_type for SET_TAX_RATE: luxury
PASSED                                                                   [ 59%]
tests/unit/orchestration/test_command_service.py::test_validate_pause_resume_step PASSED [ 59%]
tests/unit/orchestration/test_command_service.py::test_enqueue_valid_command 
-------------------------------- live log call --------------------------------
INFO     simulation.orchestration.command_service:command_service.py:71 Command enqueued: PAUSE | Payload: {}
PASSED                                                                   [ 59%]
tests/unit/orchestration/test_command_service.py::test_enqueue_invalid_command 
-------------------------------- live log call --------------------------------
WARNING  simulation.orchestration.command_service:command_service.py:32 Rate out of bounds for SET_BASE_RATE: 1.5 (Expected 0.0-0.2)
WARNING  simulation.orchestration.command_service:command_service.py:73 Command rejected due to validation failure: CockpitCommand(type='SET_BASE_RATE', payload={'rate': 1.5})
PASSED                                                                   [ 59%]
tests/unit/orchestration/test_command_service.py::test_pop_commands 
-------------------------------- live log call --------------------------------
INFO     simulation.orchestration.command_service:command_service.py:71 Command enqueued: PAUSE | Payload: {}
INFO     simulation.orchestration.command_service:command_service.py:71 Command enqueued: RESUME | Payload: {}
PASSED                                                                   [ 60%]
tests/unit/orchestration/test_phase_housing_saga.py::test_phase_housing_saga_execution PASSED [ 60%]
tests/unit/orchestration/test_phase_housing_saga.py::test_phase_housing_saga_execution_fallback PASSED [ 60%]
tests/unit/orchestration/test_phase_housing_saga.py::test_phase_housing_saga_no_settlement_system PASSED [ 60%]
tests/unit/orchestration/test_phase_housing_saga.py::test_phase_housing_saga_system_no_method PASSED [ 60%]
tests/unit/sagas/test_orchestrator.py::test_submit_saga 
-------------------------------- live log call --------------------------------
INFO     modules.finance.sagas.orchestrator:orchestrator.py:31 SAGA_SUBMITTED | Saga test-saga-uuid submitted.
PASSED                                                                   [ 60%]
tests/unit/sagas/test_orchestrator.py::test_process_sagas_liveness_check 
-------------------------------- live log call --------------------------------
INFO     modules.finance.sagas.orchestrator:orchestrator.py:31 SAGA_SUBMITTED | Saga test-saga-uuid submitted.
WARNING  modules.finance.sagas.orchestrator:orchestrator.py:77 SAGA_CANCELLED | Saga test-saga-uuid cancelled due to inactive participant. Buyer Active: False, Seller Active: True
PASSED                                                                   [ 61%]
tests/unit/sagas/test_orchestrator.py::test_process_sagas_active_participants 
-------------------------------- live log call --------------------------------
INFO     modules.finance.sagas.orchestrator:orchestrator.py:31 SAGA_SUBMITTED | Saga test-saga-uuid-2 submitted.
PASSED                                                                   [ 61%]
tests/unit/sagas/test_orchestrator.py::test_find_and_compensate_by_agent_success 
-------------------------------- live log call --------------------------------
INFO     modules.finance.sagas.orchestrator:orchestrator.py:31 SAGA_SUBMITTED | Saga saga-compensation-test submitted.
WARNING  modules.finance.sagas.orchestrator:orchestrator.py:143 SAGA_AGENT_DEATH | Triggering compensation for Saga saga-compensation-test due to agent 999 death.
PASSED                                                                   [ 61%]
tests/unit/sagas/test_orchestrator.py::test_find_and_compensate_by_agent_no_handler 
-------------------------------- live log call --------------------------------
INFO     modules.finance.sagas.orchestrator:orchestrator.py:31 SAGA_SUBMITTED | Saga saga-no-handler submitted.
ERROR    modules.finance.sagas.orchestrator:orchestrator.py:138 SAGA_COMPENSATE_FAIL | No handler provided for find_and_compensate_by_agent
PASSED                                                                   [ 61%]
tests/unit/systems/handlers/test_housing_handler.py::TestHousingTransactionHandler::test_handle_disbursement_failure PASSED [ 61%]
tests/unit/systems/handlers/test_housing_handler.py::TestHousingTransactionHandler::test_handle_government_seller PASSED [ 61%]
tests/unit/systems/handlers/test_housing_handler.py::TestHousingTransactionHandler::test_handle_payment_failure PASSED [ 61%]
tests/unit/systems/handlers/test_housing_handler.py::TestHousingTransactionHandler::test_handle_purchase_success PASSED [ 62%]
tests/unit/systems/handlers/test_liquidation_handlers.py::TestInventoryLiquidationHandler::test_liquidate_fallback_price 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.liquidation_handlers:liquidation_handlers.py:87 LIQUIDATION_ASSET_SALE | Agent 1 sold inventory to PublicManager for 80.00.
PASSED                                                                   [ 62%]
tests/unit/systems/handlers/test_liquidation_handlers.py::TestInventoryLiquidationHandler::test_liquidate_no_inventory PASSED [ 62%]
tests/unit/systems/handlers/test_liquidation_handlers.py::TestInventoryLiquidationHandler::test_liquidate_no_public_manager PASSED [ 62%]
tests/unit/systems/handlers/test_liquidation_handlers.py::TestInventoryLiquidationHandler::test_liquidate_payment_fail 
-------------------------------- live log call --------------------------------
ERROR    simulation.systems.liquidation_handlers:liquidation_handlers.py:95 LIQUIDATION_ASSET_SALE_FAIL | PublicManager failed to pay 40.00 to Agent 1.
PASSED                                                                   [ 62%]
tests/unit/systems/handlers/test_liquidation_handlers.py::TestInventoryLiquidationHandler::test_liquidate_with_inventory 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.liquidation_handlers:liquidation_handlers.py:87 LIQUIDATION_ASSET_SALE | Agent 1 sold inventory to PublicManager for 40.00.
PASSED                                                                   [ 62%]
tests/unit/systems/test_commerce_system.py::test_execute_consumption_and_leisure PASSED [ 63%]
tests/unit/systems/test_commerce_system.py::test_fast_track_consumption_if_needed PASSED [ 63%]
tests/unit/systems/test_commerce_system_logging.py::test_log_reject_when_stock_out_and_insolvent PASSED [ 63%]
tests/unit/systems/test_commerce_system_logging.py::test_log_reject_when_stock_out_but_solvent PASSED [ 63%]
tests/unit/systems/test_demographic_manager_newborn.py::test_newborn_receives_initial_needs_from_config FAILED [ 63%]
tests/unit/systems/test_event_system.py::test_inflation_shock 
-------------------------------- live log call --------------------------------
WARNING  simulation.systems.event_system:event_system.py:33 üî• STRESS_TEST: Activating 'hyperinflation' at Tick 200!
INFO     simulation.systems.event_system:event_system.py:63   -> Injected 50% cash into all households.
PASSED                                                                   [ 63%]
tests/unit/systems/test_event_system.py::test_recession_shock 
-------------------------------- live log call --------------------------------
WARNING  simulation.systems.event_system:event_system.py:33 üî• STRESS_TEST: Activating 'deflation' at Tick 600!
INFO     simulation.systems.event_system:event_system.py:87   -> Reduced all agent assets by 50%.
PASSED                                                                   [ 64%]
tests/unit/systems/test_event_system.py::test_no_event PASSED            [ 64%]
tests/unit/systems/test_firm_management_leak.py::TestFirmManagementLeak::test_spawn_firm_leak_detection 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.firm_management:firm_management.py:174 STARTUP | Household 1 founded Firm 1 (Specialization: steel, Capital: 1500.0)
PASSED                                                                   [ 64%]
tests/unit/systems/test_firm_management_refactor.py::TestFirmManagementRefactor::test_spawn_firm_missing_settlement_system PASSED [ 64%]
tests/unit/systems/test_firm_management_refactor.py::TestFirmManagementRefactor::test_spawn_firm_transfer_failure 
-------------------------------- live log call --------------------------------
CRITICAL simulation.systems.firm_management:firm_management.py:151 STARTUP_FATAL | Founder household has NULL ID! Aborting.
PASSED                                                                   [ 64%]
tests/unit/systems/test_housing_service.py::test_housing_service_handle_housing_updates_mortgage 
-------------------------------- live log call --------------------------------
INFO     modules.housing.service:service.py:204 HOUSING_REGISTRY | Unit 101 transferred from 2 to 1
PASSED                                                                   [ 64%]
tests/unit/systems/test_housing_service.py::test_housing_service_handle_housing_clears_mortgage_if_missing 
-------------------------------- live log call --------------------------------
INFO     modules.housing.service:service.py:204 HOUSING_REGISTRY | Unit 101 transferred from 2 to 1
PASSED                                                                   [ 65%]
tests/unit/systems/test_housing_system.py::TestHousingSystemRefactor::test_process_housing_maintenance_uses_transfer PASSED [ 65%]
tests/unit/systems/test_housing_system.py::TestHousingSystemRefactor::test_process_housing_rent_collection_uses_transfer PASSED [ 65%]
tests/unit/systems/test_inheritance_manager.py::TestInheritanceManager::test_distribution_transaction_generation 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.inheritance_manager:inheritance_manager.py:49 INHERITANCE_START | Processing death for Household 1. Assets: 10000.00
PASSED                                                                   [ 65%]
tests/unit/systems/test_inheritance_manager.py::TestInheritanceManager::test_multiple_heirs_metadata 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.inheritance_manager:inheritance_manager.py:49 INHERITANCE_START | Processing death for Household 1. Assets: 100.00
PASSED                                                                   [ 65%]
tests/unit/systems/test_inheritance_manager.py::TestInheritanceManager::test_escheatment_when_no_heirs 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.inheritance_manager:inheritance_manager.py:49 INHERITANCE_START | Processing death for Household 1. Assets: 1000.00
PASSED                                                                   [ 65%]
tests/unit/systems/test_inheritance_manager.py::TestInheritanceManager::test_zero_assets_distribution 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.inheritance_manager:inheritance_manager.py:49 INHERITANCE_START | Processing death for Household 1. Assets: 0.00
PASSED                                                                   [ 66%]
tests/unit/systems/test_inheritance_manager.py::TestInheritanceManager::test_tax_transaction_generation 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.inheritance_manager:inheritance_manager.py:49 INHERITANCE_START | Processing death for Household 1. Assets: 1000.00
PASSED                                                                   [ 66%]
tests/unit/systems/test_labor_market_analyzer.py::test_update_market_history PASSED [ 66%]
tests/unit/systems/test_labor_market_analyzer.py::test_calculate_shadow_reservation_wage_increase PASSED [ 66%]
tests/unit/systems/test_labor_market_analyzer.py::test_calculate_shadow_reservation_wage_decay PASSED [ 66%]
tests/unit/systems/test_labor_market_analyzer.py::test_calculate_shadow_reservation_wage_floor PASSED [ 66%]
tests/unit/systems/test_liquidation_manager.py::TestLiquidationManager::test_asset_liquidation_integration 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.liquidation_handlers:liquidation_handlers.py:87 LIQUIDATION_ASSET_SALE | Agent 1 sold inventory to PublicManager for 40.00.
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:80 LIQUIDATION_START | Agent 1 starting liquidation. Assets: 1000.00, Total Claims: 0.00
PASSED                                                                   [ 66%]
tests/unit/systems/test_liquidation_manager.py::TestLiquidationManager::test_bank_claim_handling 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:80 LIQUIDATION_START | Agent 1 starting liquidation. Assets: 1000.00, Total Claims: 500.00
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:125 LIQUIDATION_WATERFALL | Tier 2 fully paid. Remaining cash: 500.00
PASSED                                                                   [ 67%]
tests/unit/systems/test_liquidation_manager.py::TestLiquidationManager::test_initiate_liquidation_orchestration 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:80 LIQUIDATION_START | Agent 1 starting liquidation. Assets: 1000.00, Total Claims: 150.00
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:125 LIQUIDATION_WATERFALL | Tier 1 fully paid. Remaining cash: 900.00
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:125 LIQUIDATION_WATERFALL | Tier 3 fully paid. Remaining cash: 850.00
PASSED                                                                   [ 67%]
tests/unit/systems/test_ma_manager.py::TestMAManager::test_execute_bankruptcy_records_loss_in_ledger 
-------------------------------- live log call --------------------------------
INFO     MAManager:ma_manager.py:243 BANKRUPTCY | Firm 999 liquidated. Cash Remaining: 1,000.00.
PASSED                                                                   [ 67%]
tests/unit/systems/test_ministry_of_education.py::TestMinistryOfEducation::test_budget_constraints PASSED [ 67%]
tests/unit/systems/test_ministry_of_education.py::TestMinistryOfEducation::test_run_public_education_basic_grant_legacy PASSED [ 67%]
tests/unit/systems/test_ministry_of_education.py::TestMinistryOfEducation::test_run_public_education_basic_grant_settlement PASSED [ 67%]
tests/unit/systems/test_ministry_of_education.py::TestMinistryOfEducation::test_run_public_education_scholarship_settlement 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.ministry_of_education:ministry_of_education.py:122 EDU_SCHOLARSHIP_PENDING | Household 101 nominated for Level 2.
PASSED                                                                   [ 68%]
tests/unit/systems/test_sensory_system.py::test_sensory_dto_generation PASSED [ 68%]
tests/unit/systems/test_sensory_system.py::test_sensory_dto_missing_tracker PASSED [ 68%]
tests/unit/systems/test_settlement_saga_integration.py::TestSettlementSagaIntegration::test_process_sagas_integration_initiated_to_credit_check 
-------------------------------- live log call --------------------------------
INFO     modules.finance.sagas.orchestrator:orchestrator.py:31 SAGA_SUBMITTED | Saga saga-integration-1 submitted.
PASSED                                                                   [ 68%]
tests/unit/systems/test_settlement_saga_integration.py::TestSettlementSagaIntegration::test_process_sagas_integration_cancellation 
-------------------------------- live log call --------------------------------
INFO     modules.finance.sagas.orchestrator:orchestrator.py:31 SAGA_SUBMITTED | Saga saga-integration-cancel submitted.
WARNING  modules.finance.sagas.orchestrator:orchestrator.py:77 SAGA_CANCELLED | Saga saga-integration-cancel cancelled due to inactive participant. Buyer Active: False, Seller Active: True
WARNING  modules.finance.saga_handler:saga_handler.py:70 SAGA_COMPENSATE | Rolling back saga saga-integration-cancel from CANCELLED
PASSED                                                                   [ 68%]
tests/unit/systems/test_settlement_system.py::test_transfer_success PASSED [ 68%]
tests/unit/systems/test_settlement_system.py::test_transfer_insufficient_funds 
-------------------------------- live log call --------------------------------
ERROR    simulation.systems.settlement_system:settlement_system.py:334 SETTLEMENT_FAIL | Insufficient total funds (Cash+Deposits) for 1. Cash: 10.00, Bank: 0.00, Total: 10.00. Required: 20.00. Memo: Test Fail
PASSED                                                                   [ 69%]
tests/unit/systems/test_settlement_system.py::test_create_and_transfer_minting 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.settlement_system:settlement_system.py:582 MINT_AND_TRANSFER | Created 100.00 USD from 0 to 1. Reason: Minting
PASSED                                                                   [ 69%]
tests/unit/systems/test_settlement_system.py::test_create_and_transfer_government_grant PASSED [ 69%]
tests/unit/systems/test_settlement_system.py::test_transfer_and_destroy_burning 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.settlement_system:settlement_system.py:617 TRANSFER_AND_DESTROY | Destroyed 50.00 USD from 1 to 0. Reason: Burning
PASSED                                                                   [ 69%]
tests/unit/systems/test_settlement_system.py::test_transfer_and_destroy_tax PASSED [ 69%]
tests/unit/systems/test_settlement_system.py::test_record_liquidation 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.settlement_system:settlement_system.py:268 LIQUIDATION: Agent 1 liquidated. Inventory: 100.00, Capital: 50.00, Recovered: 20.00. Net Destruction: 130.00. Total Destroyed: 130.00. Reason: Bankruptcy
INFO     simulation.systems.settlement_system:settlement_system.py:268 LIQUIDATION: Agent 1 liquidated. Inventory: 10.00, Capital: 0.00, Recovered: 0.00. Net Destruction: 10.00. Total Destroyed: 140.00. Reason: More Loss
PASSED                                                                   [ 69%]
tests/unit/systems/test_settlement_system.py::test_record_liquidation_escheatment 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.settlement_system:settlement_system.py:268 LIQUIDATION: Agent 1 liquidated. Inventory: 10.00, Capital: 10.00, Recovered: 0.00. Net Destruction: 20.00. Total Destroyed: 20.00. Reason: Escheatment Test
PASSED                                                                   [ 70%]
tests/unit/systems/test_settlement_system.py::test_transfer_rollback 
-------------------------------- live log call --------------------------------
ERROR    simulation.systems.settlement_system:settlement_system.py:539 SETTLEMENT_ROLLBACK | Deposit failed for 2. Rolling back withdrawal of 20.00 from 1. Error: Deposit Failed
INFO     simulation.systems.settlement_system:settlement_system.py:544 SETTLEMENT_ROLLBACK_SUCCESS | Rolled back 20.00 to 1.
PASSED                                                                   [ 70%]
tests/unit/systems/test_settlement_system.py::test_atomic_settlement_success 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.settlement_system:settlement_system.py:85 SETTLEMENT_CREATED | Escrow account created for Agent 101. Cash: 500.00. Portfolio items: 0. Heir: NONE (Escheatment)
INFO     simulation.systems.settlement_system:settlement_system.py:240 SETTLEMENT_CLOSED | Account 101 closed successfully.
PASSED                                                                   [ 70%]
tests/unit/systems/test_settlement_system.py::test_atomic_settlement_leak_prevention 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.settlement_system:settlement_system.py:85 SETTLEMENT_CREATED | Escrow account created for Agent 102. Cash: 100.00. Portfolio items: 0. Heir: NONE (Escheatment)
WARNING  simulation.systems.settlement_system:settlement_system.py:219 SETTLEMENT_LEAK | Account 102 closed with remaining cash: 10.00. Burning it.
PASSED                                                                   [ 70%]
tests/unit/systems/test_settlement_system.py::test_atomic_settlement_overdraft_protection 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.settlement_system:settlement_system.py:85 SETTLEMENT_CREATED | Escrow account created for Agent 103. Cash: 100.00. Portfolio items: 0. Heir: NONE (Escheatment)
CRITICAL simulation.systems.settlement_system:settlement_system.py:159 SETTLEMENT_OVERDRAFT | Attempted to distribute more than escrow! Escrow: 100.00, Distributed: 0.00, Requested: 150.00
PASSED                                                                   [ 70%]
tests/unit/systems/test_settlement_system.py::test_transfer_seamless_success 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.settlement_system:settlement_system.py:372 SEAMLESS_PAYMENT | Agent 1 paid 50.00 using 10.00 cash and 40.00 from bank.
PASSED                                                                   [ 70%]
tests/unit/systems/test_settlement_system.py::test_transfer_seamless_fail_bank 
-------------------------------- live log call --------------------------------
ERROR    simulation.systems.settlement_system:settlement_system.py:334 SETTLEMENT_FAIL | Insufficient total funds (Cash+Deposits) for 1. Cash: 10.00, Bank: 10.00, Total: 20.00. Required: 50.00. Memo: Seamless Fail
PASSED                                                                   [ 71%]
tests/unit/systems/test_settlement_system.py::test_execute_multiparty_settlement_success PASSED [ 71%]
tests/unit/systems/test_settlement_system.py::test_execute_multiparty_settlement_rollback 
-------------------------------- live log call --------------------------------
ERROR    simulation.systems.settlement_system:settlement_system.py:334 SETTLEMENT_FAIL | Insufficient total funds (Cash+Deposits) for B. Cash: 150.00, Bank: 0.00, Total: 150.00. Required: 200.00. Memo: multiparty_seq_1
WARNING  simulation.systems.settlement_system:settlement_system.py:409 MULTIPARTY_FAIL | Transfer 1 failed (B -> C). Rolling back 1 previous transfers.
PASSED                                                                   [ 71%]
tests/unit/systems/test_settlement_system.py::test_settle_atomic_success PASSED [ 71%]
tests/unit/systems/test_settlement_system.py::test_settle_atomic_rollback 
-------------------------------- live log call --------------------------------
ERROR    simulation.systems.settlement_system:settlement_system.py:334 SETTLEMENT_FAIL | Insufficient total funds (Cash+Deposits) for A. Cash: 90.00, Bank: 0.00, Total: 90.00. Required: 100.00. Memo: atomic_batch_2_txs
PASSED                                                                   [ 71%]
tests/unit/systems/test_settlement_system.py::test_settle_atomic_credit_fail_rollback 
-------------------------------- live log call --------------------------------
ERROR    simulation.systems.settlement_system:settlement_system.py:468 SETTLEMENT_ROLLBACK | Deposit failed for B. Rolling back atomic batch. Error: Deposit Fail
PASSED                                                                   [ 71%]
tests/unit/systems/test_settlement_system.py::test_inheritance_portfolio_transfer 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.settlement_system:settlement_system.py:85 SETTLEMENT_CREATED | Escrow account created for Agent 100. Cash: 0.00. Portfolio items: 1. Heir: 900
INFO     simulation.systems.settlement_system:settlement_system.py:141 PORTFOLIO_TRANSFER | Transferred portfolio to 900
PASSED                                                                   [ 72%]
tests/unit/systems/test_settlement_system.py::test_escheatment_portfolio_transfer 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.settlement_system:settlement_system.py:85 SETTLEMENT_CREATED | Escrow account created for Agent 100. Cash: 0.00. Portfolio items: 1. Heir: NONE (Escheatment)
INFO     simulation.systems.settlement_system:settlement_system.py:141 PORTFOLIO_TRANSFER | Transferred portfolio to GOVERNMENT
PASSED                                                                   [ 72%]
tests/unit/systems/test_social_system.py::test_update_social_ranks PASSED [ 72%]
tests/unit/systems/test_social_system.py::test_calculate_reference_standard PASSED [ 72%]
tests/unit/systems/test_tax_agency.py::TestTaxAgency::test_calculate_corporate_tax PASSED [ 72%]
tests/unit/systems/test_tax_agency.py::TestTaxAgency::test_calculate_income_tax_flat PASSED [ 72%]
tests/unit/systems/test_tax_agency.py::TestTaxAgency::test_calculate_income_tax_progressive_scaling PASSED [ 72%]
tests/unit/systems/test_tax_agency.py::TestTaxAgency::test_calculate_income_tax_progressive_with_brackets PASSED [ 73%]
tests/unit/systems/test_tax_agency.py::TestTaxAgency::test_collect_tax 
-------------------------------- live log call --------------------------------
INFO     simulation.systems.tax_agency:tax_agency.py:140 TAX_COLLECTION_SUCCESS | Tick 1 | Collected 100.00 of income from 101
PASSED                                                                   [ 73%]
tests/unit/systems/test_technology_manager.py::TestTechnologyManager::test_effective_diffusion_rate PASSED [ 73%]
tests/unit/systems/test_technology_manager.py::TestTechnologyManager::test_unlock_mechanism PASSED [ 73%]
tests/unit/systems/test_technology_manager.py::TestTechnologyManager::test_diffusion_over_time PASSED [ 73%]
tests/unit/systems/test_technology_manager.py::TestTechnologyManager::test_productivity_multiplier PASSED [ 73%]
tests/unit/test_ai_driven_firm_engine.py::test_adjust_price_tactic 
------------------------------- live log setup --------------------------------
INFO     simulation.decisions.ai_driven_firm_engine:ai_driven_firm_engine.py:40 AIDrivenFirmDecisionEngine initialized with CorporateManager.
-------------------------------- live log call --------------------------------
WARNING  simulation.decisions.firm.financial_strategy:financial_strategy.py:112 FINANCE_WARNING | Missing policy/market rate for firm 1. Used default fallback.
PASSED                                                                   [ 74%]
tests/unit/test_ai_training_manager.py::test_get_top_performing_agents 
-------------------------------- live log call --------------------------------
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:20 AITrainingManager initialized.
PASSED                                                                   [ 74%]
tests/unit/test_ai_training_manager.py::test_get_under_performing_agents 
-------------------------------- live log call --------------------------------
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:20 AITrainingManager initialized.
PASSED                                                                   [ 74%]
tests/unit/test_ai_training_manager.py::test_clone_and_mutate_q_table 
-------------------------------- live log call --------------------------------
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:20 AITrainingManager initialized.
PASSED                                                                   [ 74%]
tests/unit/test_ai_training_manager.py::test_clone_from_fittest_agent 
-------------------------------- live log call --------------------------------
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:20 AITrainingManager initialized.
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:53 Cloning from fittest agent 9 to new agent 0
PASSED                                                                   [ 74%]
tests/unit/test_ai_training_manager.py::test_run_imitation_learning_cycle 
-------------------------------- live log call --------------------------------
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:20 AITrainingManager initialized.
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:24 Running imitation learning cycle at tick 1000.
INFO     simulation.ai.ai_training_manager:ai_training_manager.py:36 Imitation Cycle: 1 Role Models, 5 Learners.
PASSED                                                                   [ 74%]
tests/unit/test_api_extensions.py::TestEconomicIndicatorsViewModel::test_get_wealth_distribution FAILED [ 75%]
tests/unit/test_api_extensions.py::TestEconomicIndicatorsViewModel::test_get_needs_distribution FAILED [ 75%]
tests/unit/test_api_extensions.py::TestEconomicIndicatorsViewModel::test_get_sales_by_good PASSED [ 75%]
tests/unit/test_api_extensions.py::TestEconomicIndicatorsViewModel::test_get_market_order_book 
-------------------------------- live log call --------------------------------
INFO     Market_test_market:order_book_market.py:97 OrderBookMarket test_market initialized.
FAILED                                                                   [ 75%]
tests/unit/test_api_history.py::TestHistoryAPI::test_gdp_history_on_refresh PASSED [ 75%]
tests/unit/test_bank.py::TestBank::test_initialization 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 75%]
tests/unit/test_bank.py::TestBank::test_grant_loan_successful 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 76%]
tests/unit/test_bank.py::TestBank::test_grant_loan_denied_credit 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 76%]
tests/unit/test_bank.py::TestBank::test_grant_loan_insufficient_reserves 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 76%]
tests/unit/test_bank.py::TestBank::test_grant_loan_multiple_loans 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 76%]
tests/unit/test_bank.py::TestBank::test_deposit_from_customer 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 76%]
tests/unit/test_bank.py::TestBank::test_withdraw_for_customer_success 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 76%]
tests/unit/test_bank.py::TestBank::test_withdraw_for_customer_insufficient 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 77%]
tests/unit/test_bank.py::TestBank::test_financial_entity_deposit 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 77%]
tests/unit/test_bank.py::TestBank::test_financial_entity_withdraw 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 77%]
tests/unit/test_bank.py::TestBank::test_financial_entity_withdraw_insufficient 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 77%]
tests/unit/test_bank.py::TestBank::test_run_tick_returns_transactions 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 77%]
tests/unit/test_bank.py::TestBank::test_void_loan_failure_raises_exception 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
-------------------------------- live log call --------------------------------
CRITICAL simulation.bank:bank.py:550 VOID_LOAN_FAIL | Could not find deposit for loan loan_broken_link. Cannot safely rollback.
PASSED                                                                   [ 77%]
tests/unit/test_bank.py::TestBank::test_loan_default_emits_event 
------------------------------- live log setup --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 77%]
tests/unit/test_bank_decomposition.py::TestBankDecomposition::test_default_processing 
-------------------------------- live log call --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
WARNING  simulation.bank:bank.py:491 Bank: EventBus not injected. Loan default consequences (penalties, seizure) skipped.
PASSED                                                                   [ 78%]
tests/unit/test_bank_decomposition.py::TestBankDecomposition::test_grant_loan_delegation 
-------------------------------- live log call --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 78%]
tests/unit/test_bank_decomposition.py::TestBankDecomposition::test_run_tick_interest_collection 
-------------------------------- live log call --------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
PASSED                                                                   [ 78%]
tests/unit/test_config_parity.py::test_household_config_parity PASSED    [ 78%]
tests/unit/test_config_parity.py::test_firm_config_parity PASSED         [ 78%]
tests/unit/test_consumption_manager_survival.py::TestConsumptionManagerSurvival::test_check_survival_override_no_emergency PASSED [ 78%]
tests/unit/test_consumption_manager_survival.py::TestConsumptionManagerSurvival::test_check_survival_override_emergency_triggered PASSED [ 79%]
tests/unit/test_consumption_manager_survival.py::TestConsumptionManagerSurvival::test_check_survival_override_emergency_triggered_insufficient_funds PASSED [ 79%]
tests/unit/test_consumption_manager_survival.py::TestConsumptionManagerSurvival::test_check_survival_override_no_signal PASSED [ 79%]
tests/unit/test_diagnostics.py::test_get_total_system_money_diagnostics PASSED [ 79%]
tests/unit/test_factories.py::TestMarketSignalFactory::test_create_market_signals PASSED [ 79%]
tests/unit/test_factories.py::TestMarketSnapshotFactory::test_create_snapshot PASSED [ 79%]
tests/unit/test_factories.py::TestDecisionInputFactory::test_create_decision_input PASSED [ 80%]
tests/unit/test_firm_profit.py::test_firm_profit_history_update PASSED   [ 80%]
tests/unit/test_firm_profit.py::test_firm_revenue_expenses_reset PASSED  [ 80%]
tests/unit/test_firms.py::TestFirmBookValue::test_book_value_no_liabilities PASSED [ 80%]
tests/unit/test_firms.py::TestFirmBookValue::test_book_value_with_liabilities PASSED [ 80%]
tests/unit/test_firms.py::TestFirmBookValue::test_book_value_with_treasury_shares PASSED [ 80%]
tests/unit/test_firms.py::TestFirmBookValue::test_book_value_negative_net_assets PASSED [ 81%]
tests/unit/test_firms.py::TestFirmBookValue::test_book_value_zero_shares PASSED [ 81%]
tests/unit/test_firms.py::TestFirmProduction::test_produce PASSED        [ 81%]
tests/unit/test_firms.py::TestFirmSales::test_post_ask PASSED            [ 81%]
tests/unit/test_firms.py::TestFirmSales::test_adjust_marketing_budget_increase PASSED [ 81%]
tests/unit/test_handlers_fix.py::TestHandlerFix::test_goods_handler_uses_record_consumption 
-------------------------------- live log call --------------------------------
WARNING  simulation.systems.handlers.goods_handler:goods_handler.py:108 GOODS_HANDLER_WARN | Seller <MagicMock name='mock.id' id='1806915874032'> does not implement IInventoryHandler
FAILED                                                                   [ 81%]
tests/unit/test_handlers_fix.py::TestHandlerFix::test_labor_handler_uses_add_labor_income FAILED [ 82%]
tests/unit/test_household_ai.py::test_ai_creates_purchase_order 
------------------------------- live log setup --------------------------------
INFO     Market_goods_market:order_book_market.py:97 OrderBookMarket goods_market initialized.
INFO     Market_labor_market:order_book_market.py:97 OrderBookMarket labor_market initialized.
-------------------------------- live log call --------------------------------
INFO     simulation.ai.model_wrapper:model_wrapper.py:150 No existing model found for wealth_and_needs.
INFO     simulation.decisions.ai_driven_household_engine:ai_driven_household_engine.py:43 AIDrivenHouseholdDecisionEngine initialized (Modularized).
PASSED                                                                   [ 82%]
tests/unit/test_household_ai.py::test_ai_evaluates_consumption_options 
------------------------------- live log setup --------------------------------
INFO     Market_goods_market:order_book_market.py:97 OrderBookMarket goods_market initialized.
INFO     Market_labor_market:order_book_market.py:97 OrderBookMarket labor_market initialized.
-------------------------------- live log call --------------------------------
INFO     simulation.ai.model_wrapper:model_wrapper.py:150 No existing model found for needs_and_social_status.
INFO     simulation.decisions.ai_driven_household_engine:ai_driven_household_engine.py:43 AIDrivenHouseholdDecisionEngine initialized (Modularized).
PASSED                                                                   [ 82%]
tests/unit/test_household_decision_engine_new.py::TestAIDrivenHouseholdDecisionEngine::test_make_decisions_calls_ai PASSED [ 82%]
tests/unit/test_household_decision_engine_new.py::TestAIDrivenHouseholdDecisionEngine::test_consumption_do_nothing PASSED [ 82%]
tests/unit/test_household_decision_engine_new.py::TestAIDrivenHouseholdDecisionEngine::test_consumption_buy_basic_food_sufficient_assets PASSED [ 82%]
tests/unit/test_household_decision_engine_new.py::TestAIDrivenHouseholdDecisionEngine::test_consumption_buy_luxury_food_insufficient_assets PASSED [ 83%]
tests/unit/test_household_decision_engine_new.py::TestAIDrivenHouseholdDecisionEngine::test_consumption_evaluate_options_chooses_best_utility PASSED [ 83%]
tests/unit/test_household_decision_engine_new.py::TestAIDrivenHouseholdDecisionEngine::test_labor_market_participation_aggressive PASSED [ 83%]
tests/unit/test_household_decision_engine_new.py::TestAIDrivenHouseholdDecisionEngine::test_labor_market_participation_passive_no_offer PASSED [ 83%]
tests/unit/test_household_refactor.py::TestHouseholdRefactor::test_property_management PASSED [ 83%]
tests/unit/test_household_system2.py::TestHouseholdSystem2::test_dti_guardrail PASSED [ 83%]
tests/unit/test_household_system2.py::TestHouseholdSystem2::test_npv_buy_calculation PASSED [ 83%]
tests/unit/test_household_system2.py::TestHouseholdSystem2::test_rational_choice_buy PASSED [ 84%]
tests/unit/test_learning_tracker.py::TestLearningTracker::test_get_summary_multiple_agents PASSED [ 84%]
tests/unit/test_learning_tracker.py::TestLearningTracker::test_get_summary_no_data PASSED [ 84%]
tests/unit/test_learning_tracker.py::TestLearningTracker::test_get_summary_single_agent PASSED [ 84%]
tests/unit/test_ledger_manager.py::test_archive_resolved_items PASSED    [ 84%]
tests/unit/test_ledger_manager.py::test_register_new_item PASSED         [ 84%]
tests/unit/test_ledger_manager.py::test_sync_with_codebase PASSED        [ 85%]
tests/unit/test_ledger_manager.py::test_pipe_escaping_in_ledger PASSED   [ 85%]
tests/unit/test_logger.py::TestLogger::test_clear_logs PASSED            [ 85%]
tests/unit/test_logger.py::TestLogger::test_log_writing PASSED           [ 85%]
tests/unit/test_logger.py::TestLogger::test_singleton_instance PASSED    [ 85%]
tests/unit/test_market_adapter.py::TestMarketAdapter::test_pass_through PASSED [ 85%]
tests/unit/test_market_adapter.py::TestMarketAdapter::test_convert_stock_order PASSED [ 86%]
tests/unit/test_market_adapter.py::TestMarketAdapter::test_convert_dict_legacy_format PASSED [ 86%]
tests/unit/test_market_adapter.py::TestMarketAdapter::test_convert_dict_canonical_format PASSED [ 86%]
tests/unit/test_market_adapter.py::TestMarketAdapter::test_invalid_input PASSED [ 86%]
tests/unit/test_marketing_roi.py::TestMarketingROI::test_budget_decrease_on_low_efficiency SKIPPED [ 86%]
tests/unit/test_marketing_roi.py::TestMarketingROI::test_budget_increase_on_high_efficiency SKIPPED [ 86%]
tests/unit/test_marketing_roi.py::TestMarketingROI::test_budget_stable_on_saturation FAILED [ 87%]
tests/unit/test_marketing_roi.py::TestMarketingROI::test_first_tick_skip SKIPPED [ 87%]
tests/unit/test_markets_v2.py::TestOrderBookMarketInitialization::test_market_initialization PASSED [ 87%]
tests/unit/test_markets_v2.py::TestPlaceOrderToBook::test_add_single_buy_order PASSED [ 87%]
tests/unit/test_markets_v2.py::TestPlaceOrderToBook::test_add_buy_orders_sorted PASSED [ 87%]
tests/unit/test_markets_v2.py::TestPlaceOrderToBook::test_add_sell_orders_sorted PASSED [ 87%]
tests/unit/test_markets_v2.py::TestPlaceOrderToBook::test_add_orders_with_same_price PASSED [ 88%]
tests/unit/test_markets_v2.py::TestOrderMatching::test_unfilled_order_no_match PASSED [ 88%]
tests/unit/test_markets_v2.py::TestOrderMatching::test_full_match_one_to_one PASSED [ 88%]
tests/unit/test_markets_v2.py::TestOrderMatching::test_partial_match_then_book PASSED [ 88%]
tests/unit/test_markets_v2.py::TestOrderMatching::test_match_with_multiple_orders PASSED [ 88%]
tests/unit/test_markets_v2.py::TestMarketAPI::test_get_best_bid_empty PASSED [ 88%]
tests/unit/test_markets_v2.py::TestMarketAPI::test_get_best_bid_non_empty PASSED [ 88%]
tests/unit/test_markets_v2.py::TestMarketAPI::test_get_best_ask_empty PASSED [ 89%]
tests/unit/test_markets_v2.py::TestMarketAPI::test_get_best_ask_non_empty PASSED [ 89%]
tests/unit/test_markets_v2.py::TestMarketAPI::test_get_last_traded_price PASSED [ 89%]
tests/unit/test_markets_v2.py::TestMarketAPI::test_get_spread PASSED     [ 89%]
tests/unit/test_markets_v2.py::TestMarketAPI::test_get_spread_no_bid_or_ask PASSED [ 89%]
tests/unit/test_markets_v2.py::TestMarketAPI::test_get_market_depth PASSED [ 89%]
tests/unit/test_monetary_ledger_repayment.py::TestMonetaryLedgerRepayment::test_bond_repayment_split PASSED [ 90%]
tests/unit/test_monetary_ledger_repayment.py::TestMonetaryLedgerRepayment::test_bond_repayment_legacy_fallback PASSED [ 90%]
tests/unit/test_monetary_ledger_repayment.py::TestMonetaryLedgerRepayment::test_interest_is_not_destroyed PASSED [ 90%]
tests/unit/test_phase1_refactor.py::TestPhase1DecisionRefactor::test_execute_flow PASSED [ 90%]
tests/unit/test_phase1_refactor.py::TestPhase1DecisionRefactor::test_dispatch_logic PASSED [ 90%]
tests/unit/test_portfolio_macro.py::test_portfolio_optimization_under_stagflation PASSED [ 90%]
tests/unit/test_real_estate_lien.py::test_real_estate_unit_initialization PASSED [ 91%]
tests/unit/test_real_estate_lien.py::test_liens_management PASSED        [ 91%]
tests/unit/test_real_estate_lien.py::test_mortgage_id_backward_compatibility PASSED [ 91%]
tests/unit/test_repository.py::test_save_and_get_simulation_run PASSED   [ 91%]
tests/unit/test_repository.py::test_save_and_get_agent_state PASSED      [ 91%]
tests/unit/test_repository.py::test_save_and_get_transaction PASSED      [ 91%]
tests/unit/test_repository.py::test_save_and_get_economic_indicators PASSED [ 92%]
tests/unit/test_repository.py::test_indexes_created PASSED               [ 92%]
tests/unit/test_sensory_purity.py::TestSensoryPurity::test_generate_government_sensory_dto_purity PASSED [ 92%]
tests/unit/test_sensory_purity.py::TestSensoryPurity::test_logic_with_more_agents PASSED [ 92%]
tests/unit/test_socio_tech.py::TestSocioTechDynamics::test_appliance_effect FAILED [ 92%]
tests/unit/test_socio_tech.py::TestSocioTechDynamics::test_scenario_a_dark_ages FAILED [ 92%]
tests/unit/test_socio_tech.py::TestSocioTechDynamics::test_scenario_b_techno_optimism FAILED [ 93%]
tests/unit/test_stock_market.py::TestStockMarketInitialization::test_initialization PASSED [ 93%]
tests/unit/test_stock_market.py::TestStockMarketInitialization::test_update_reference_prices PASSED [ 93%]
tests/unit/test_stock_market.py::TestStockOrderPlacement::test_place_buy_order PASSED [ 93%]
tests/unit/test_stock_market.py::TestStockOrderPlacement::test_place_sell_order PASSED [ 93%]
tests/unit/test_stock_market.py::TestStockOrderPlacement::test_price_clamping PASSED [ 93%]
tests/unit/test_stock_market.py::TestStockOrderPlacement::test_order_sorting PASSED [ 94%]
tests/unit/test_stock_market.py::TestStockOrderMatching::test_full_match PASSED [ 94%]
tests/unit/test_stock_market.py::TestStockOrderMatching::test_partial_match PASSED [ 94%]
tests/unit/test_stock_market.py::TestOrderExpiry::test_clear_expired_orders PASSED [ 94%]
tests/unit/test_tax_collection.py::test_atomic_wealth_tax_collection_success PASSED [ 94%]
tests/unit/test_tax_collection.py::test_atomic_wealth_tax_collection_insufficient_funds PASSED [ 94%]
tests/unit/test_tax_collection.py::test_government_collect_tax_adapter_success PASSED [ 94%]
tests/unit/test_tax_collection.py::test_government_collect_tax_adapter_failure PASSED [ 95%]
tests/unit/test_tax_incidence.py::TestTaxIncidence::test_firm_payer_scenario PASSED [ 95%]
tests/unit/test_tax_incidence.py::TestTaxIncidence::test_household_payer_scenario PASSED [ 95%]
tests/unit/test_taxation_system.py::test_generate_corporate_tax_intents PASSED [ 95%]
tests/unit/test_taxation_system.py::test_generate_corporate_tax_intents_missing_config PASSED [ 95%]
tests/unit/test_taxation_system.py::test_record_revenue_success PASSED   [ 95%]
tests/unit/test_taxation_system.py::test_record_revenue_failure PASSED   [ 96%]
tests/unit/test_transaction_engine.py::test_validator_success PASSED     [ 96%]
tests/unit/test_transaction_engine.py::test_validator_negative_amount PASSED [ 96%]
tests/unit/test_transaction_engine.py::test_validator_insufficient_funds PASSED [ 96%]
tests/unit/test_transaction_engine.py::test_validator_invalid_account PASSED [ 96%]
tests/unit/test_transaction_engine.py::test_executor_success PASSED      [ 96%]
tests/unit/test_transaction_engine.py::test_executor_failure PASSED      [ 97%]
tests/unit/test_transaction_engine.py::test_engine_process_transaction_success PASSED [ 97%]
tests/unit/test_transaction_engine.py::test_engine_process_transaction_validation_fail PASSED [ 97%]
tests/unit/test_transaction_engine.py::test_engine_process_transaction_execution_fail PASSED [ 97%]
tests/unit/test_transaction_engine.py::test_adapter_registry_accessor PASSED [ 97%]
tests/unit/test_transaction_processor.py::test_transaction_processor_dispatch_to_handler PASSED [ 97%]
tests/unit/test_transaction_processor.py::test_transaction_processor_ignores_credit_creation PASSED [ 98%]
tests/unit/test_transaction_processor.py::test_goods_handler_uses_atomic_settlement PASSED [ 98%]
tests/unit/test_transaction_processor.py::test_public_manager_routing PASSED [ 98%]
tests/unit/test_transaction_processor.py::test_transaction_processor_dispatches_housing PASSED [ 98%]
tests/unit/test_watchtower_hardening.py::TestWatchtowerHardening::test_repo_birth_counts PASSED [ 98%]
tests/unit/test_watchtower_hardening.py::TestWatchtowerHardening::test_tracker_sma_logic PASSED [ 98%]
tests/unit/test_wo157_dynamic_pricing.py::TestWO157DynamicPricing::test_record_sale_updates_tick PASSED [ 99%]
tests/unit/test_wo157_dynamic_pricing.py::TestWO157DynamicPricing::test_dynamic_pricing_reduction PASSED [ 99%]
tests/unit/test_wo157_dynamic_pricing.py::TestWO157DynamicPricing::test_dynamic_pricing_floor PASSED [ 99%]
tests/unit/test_wo157_dynamic_pricing.py::TestWO157DynamicPricing::test_dynamic_pricing_not_stale PASSED [ 99%]
tests/unit/test_wo157_dynamic_pricing.py::TestWO157DynamicPricing::test_transaction_processor_calls_record_sale PASSED [ 99%]
tests/unit/utils/test_config_factory.py::test_create_config_dto_success PASSED [ 99%]
tests/unit/utils/test_config_factory.py::test_create_config_dto_missing_field PASSED [100%]

=================================== ERRORS ====================================
_______________ ERROR at setup of test_household_makes_decision _______________

mock_config_module = <MagicMock id='1806912551776'>

    @pytest.fixture
    def simple_household(mock_config_module):
        mock_engine = MagicMock(spec=BaseDecisionEngine)
>       household = Household(
            id=1,
            talent=Talent(1.0, {}),
            goods_data=[], # Simplification
            initial_assets=100.0,
            initial_needs={"survival": 50.0},
            decision_engine=mock_engine,
            value_orientation="wealth_and_needs", # Default
            personality=Personality.MISER, # Default
            config_dto=create_household_config_dto()
        )
E       TypeError: Household.__init__() missing 2 required positional arguments: 'core_config' and 'engine'

tests\integration\scenarios\diagnosis\conftest.py:29: TypeError
_________________ ERROR at setup of test_firm_makes_decision __________________

mock_config_module = <MagicMock id='1806913358544'>

    @pytest.fixture
    def simple_firm(mock_config_module):
        mock_engine = MagicMock(spec=BaseDecisionEngine)
>       firm = Firm(
            id=101,
            initial_capital=1000.0,
            initial_liquidity_need=0.0,
            specialization="basic_food",
            productivity_factor=1.0,
            decision_engine=mock_engine,
            value_orientation="wealth_and_needs", # Default
            config_dto=create_firm_config_dto()
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\integration\scenarios\diagnosis\conftest.py:45: TypeError
________________ ERROR at setup of test_indicator_aggregation _________________

mock_config_module = <MagicMock id='1806914294448'>

    @pytest.fixture
    def simple_household(mock_config_module):
        mock_engine = MagicMock(spec=BaseDecisionEngine)
>       household = Household(
            id=1,
            talent=Talent(1.0, {}),
            goods_data=[], # Simplification
            initial_assets=100.0,
            initial_needs={"survival": 50.0},
            decision_engine=mock_engine,
            value_orientation="wealth_and_needs", # Default
            personality=Personality.MISER, # Default
            config_dto=create_household_config_dto()
        )
E       TypeError: Household.__init__() missing 2 required positional arguments: 'core_config' and 'engine'

tests\integration\scenarios\diagnosis\conftest.py:29: TypeError
_________________ ERROR at setup of test_firm_automation_init _________________

    @pytest.fixture
    def firm_mock():
        # Setup mock decision engine
        decision_engine = Mock()
        decision_engine.loan_market = Mock()
    
        # Create Firm
>       firm = Firm(
            id=1,
            initial_capital=10000.0,
            initial_liquidity_need=100.0,
            specialization="basic_food",
            productivity_factor=10.0,
            decision_engine=decision_engine,
            value_orientation="growth",
            config_dto=create_firm_config_dto()
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\integration\scenarios\phase21\test_automation.py:16: TypeError
_________ ERROR at setup of test_production_function_with_automation __________

    @pytest.fixture
    def firm_mock():
        # Setup mock decision engine
        decision_engine = Mock()
        decision_engine.loan_market = Mock()
    
        # Create Firm
>       firm = Firm(
            id=1,
            initial_capital=10000.0,
            initial_liquidity_need=100.0,
            specialization="basic_food",
            productivity_factor=10.0,
            decision_engine=decision_engine,
            value_orientation="growth",
            config_dto=create_firm_config_dto()
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\integration\scenarios\phase21\test_automation.py:16: TypeError
_______________ ERROR at setup of test_system2_planner_guidance _______________

    @pytest.fixture
    def firm_mock():
        # Setup mock decision engine
        decision_engine = Mock()
        decision_engine.loan_market = Mock()
    
        # Create Firm
>       firm = Firm(
            id=1,
            initial_capital=10000.0,
            initial_liquidity_need=100.0,
            specialization="basic_food",
            productivity_factor=10.0,
            decision_engine=decision_engine,
            value_orientation="growth",
            config_dto=create_firm_config_dto()
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\integration\scenarios\phase21\test_automation.py:16: TypeError
____ ERROR at setup of test_system2_planner_guidance_automation_preference ____

    @pytest.fixture
    def firm_mock():
        # Setup mock decision engine
        decision_engine = Mock()
        decision_engine.loan_market = Mock()
    
        # Create Firm
>       firm = Firm(
            id=1,
            initial_capital=10000.0,
            initial_liquidity_need=100.0,
            specialization="basic_food",
            productivity_factor=10.0,
            decision_engine=decision_engine,
            value_orientation="growth",
            config_dto=create_firm_config_dto()
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\integration\scenarios\phase21\test_firm_system2.py:16: TypeError
________ ERROR at setup of test_system2_planner_guidance_ma_preference ________

    @pytest.fixture
    def firm_mock():
        # Setup mock decision engine
        decision_engine = Mock()
        decision_engine.loan_market = Mock()
    
        # Create Firm
>       firm = Firm(
            id=1,
            initial_capital=10000.0,
            initial_liquidity_need=100.0,
            specialization="basic_food",
            productivity_factor=10.0,
            decision_engine=decision_engine,
            value_orientation="growth",
            config_dto=create_firm_config_dto()
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\integration\scenarios\phase21\test_firm_system2.py:16: TypeError
_______ ERROR at setup of TestSimulation.test_simulation_initialization _______

mock_config_module = <Mock spec='module' id='1806917259952'>

    @pytest.fixture
    def mock_firms(mock_config_module):
>       f1 = Firm(
            id=101,
            initial_capital=1000,
            initial_liquidity_need=100,
            specialization="basic_food",
            productivity_factor=1.0,
            decision_engine=Mock(),
            value_orientation="test",
            config_dto=create_firm_config_dto(),
            initial_inventory={"basic_food": 50},
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\system\test_engine.py:240: TypeError
_______ ERROR at setup of TestSimulation.test_prepare_market_data_basic _______

mock_config_module = <Mock spec='module' id='1806916113744'>

    @pytest.fixture
    def mock_firms(mock_config_module):
>       f1 = Firm(
            id=101,
            initial_capital=1000,
            initial_liquidity_need=100,
            specialization="basic_food",
            productivity_factor=1.0,
            decision_engine=Mock(),
            value_orientation="test",
            config_dto=create_firm_config_dto(),
            initial_inventory={"basic_food": 50},
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\system\test_engine.py:240: TypeError
__ ERROR at setup of TestSimulation.test_prepare_market_data_no_goods_market __

mock_config_module = <Mock spec='module' id='1806913358880'>

    @pytest.fixture
    def mock_firms(mock_config_module):
>       f1 = Firm(
            id=101,
            initial_capital=1000,
            initial_liquidity_need=100,
            specialization="basic_food",
            productivity_factor=1.0,
            decision_engine=Mock(),
            value_orientation="test",
            config_dto=create_firm_config_dto(),
            initial_inventory={"basic_food": 50},
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\system\test_engine.py:240: TypeError
___ ERROR at setup of TestSimulation.test_prepare_market_data_with_best_ask ___

mock_config_module = <Mock spec='module' id='1806937656016'>

    @pytest.fixture
    def mock_firms(mock_config_module):
>       f1 = Firm(
            id=101,
            initial_capital=1000,
            initial_liquidity_need=100,
            specialization="basic_food",
            productivity_factor=1.0,
            decision_engine=Mock(),
            value_orientation="test",
            config_dto=create_firm_config_dto(),
            initial_inventory={"basic_food": 50},
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\system\test_engine.py:240: TypeError
___ ERROR at setup of TestSimulation.test_process_transactions_goods_trade ____

mock_config_module = <Mock spec='module' id='1806935573232'>

    @pytest.fixture
    def mock_firms(mock_config_module):
>       f1 = Firm(
            id=101,
            initial_capital=1000,
            initial_liquidity_need=100,
            specialization="basic_food",
            productivity_factor=1.0,
            decision_engine=Mock(),
            value_orientation="test",
            config_dto=create_firm_config_dto(),
            initial_inventory={"basic_food": 50},
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\system\test_engine.py:240: TypeError
___ ERROR at setup of TestSimulation.test_process_transactions_labor_trade ____

mock_config_module = <Mock spec='module' id='1806935583312'>

    @pytest.fixture
    def mock_firms(mock_config_module):
>       f1 = Firm(
            id=101,
            initial_capital=1000,
            initial_liquidity_need=100,
            specialization="basic_food",
            productivity_factor=1.0,
            decision_engine=Mock(),
            value_orientation="test",
            config_dto=create_firm_config_dto(),
            initial_inventory={"basic_food": 50},
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\system\test_engine.py:240: TypeError
_ ERROR at setup of TestSimulation.test_process_transactions_research_labor_trade _

mock_config_module = <Mock spec='module' id='1806937903792'>

    @pytest.fixture
    def mock_firms(mock_config_module):
>       f1 = Firm(
            id=101,
            initial_capital=1000,
            initial_liquidity_need=100,
            specialization="basic_food",
            productivity_factor=1.0,
            decision_engine=Mock(),
            value_orientation="test",
            config_dto=create_firm_config_dto(),
            initial_inventory={"basic_food": 50},
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\system\test_engine.py:240: TypeError
__ ERROR at setup of TestSimulation.test_process_transactions_invalid_agents __

mock_config_module = <Mock spec='module' id='1806937913872'>

    @pytest.fixture
    def mock_firms(mock_config_module):
>       f1 = Firm(
            id=101,
            initial_capital=1000,
            initial_liquidity_need=100,
            specialization="basic_food",
            productivity_factor=1.0,
            decision_engine=Mock(),
            value_orientation="test",
            config_dto=create_firm_config_dto(),
            initial_inventory={"basic_food": 50},
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\system\test_engine.py:240: TypeError
____ ERROR at setup of test_handle_agent_lifecycle_removes_inactive_agents ____

mock_goods_data_for_lifecycle = [{'id': 'food', 'utility_per_need': {'survival_need': 1.0}}]
mock_ai_trainer_for_lifecycle = <Mock spec='AIEngineRegistry' id='1806937743984'>
mock_household_decision_engine_for_lifecycle = <Mock spec='AIDrivenHouseholdDecisionEngine' id='1806937745328'>
mock_firm_decision_engine_for_lifecycle = <Mock spec='AIDrivenFirmDecisionEngine' id='1806937745664'>
mock_repository = <MagicMock id='1806937746000'>
mock_config_module = <Mock spec='module' id='1806937748688'>
mock_logger = <MagicMock name='getLogger()' id='1806937743648'>

    @pytest.fixture
    def setup_simulation_for_lifecycle(
        mock_goods_data_for_lifecycle,
        mock_ai_trainer_for_lifecycle,
        mock_household_decision_engine_for_lifecycle,
        mock_firm_decision_engine_for_lifecycle,
        mock_repository,
        mock_config_module,
        mock_logger,
    ):
        # Prepare initial needs with 'survival' and other keys to avoid KeyError in update_needs
        initial_needs = {
            "survival": 50.0, "survival_need": 50.0,
            "asset": 10.0,
            "social": 10.0,
            "improvement": 10.0
        }
    
        # Create pre-configured talent mocks
        talent_active = Mock(spec=Talent)
        talent_active.base_learning_rate = 0.1
    
        talent_inactive = Mock(spec=Talent)
        talent_inactive.base_learning_rate = 0.1
    
        talent_employed = Mock(spec=Talent)
        talent_employed.base_learning_rate = 0.1
    
>       household_active = Household(
            id=1,
            talent=talent_active,
            goods_data=mock_goods_data_for_lifecycle,
            initial_assets=100,
            initial_needs=initial_needs.copy(),
            decision_engine=mock_household_decision_engine_for_lifecycle,
            value_orientation="test",
            personality=Personality.MISER,
            config_dto=create_household_config_dto(),
        )
E       TypeError: Household.__init__() missing 2 required positional arguments: 'core_config' and 'engine'

tests\system\test_engine.py:658: TypeError
================================== FAILURES ===================================
______________________ test_dashboard_snapshot_structure ______________________

mock_sim_instance = <MagicMock spec='Simulation' id='1806913361232'>

    def test_dashboard_snapshot_structure(mock_sim_instance):
        """
        Phase 3-A: Verify DashboardService produces a valid WatchtowerSnapshotDTO.
        """
        service = DashboardService(mock_sim_instance)
        snapshot = service.get_snapshot()
    
        assert isinstance(snapshot, WatchtowerSnapshotDTO)
        assert snapshot.tick == 42
>       assert snapshot.macro.gdp == 1000.0
E       AssertionError: assert <MagicMock name='mock.world_state.tracker.get_smoothed_values().get()' id='1806912552448'> == 1000.0
E        +  where <MagicMock name='mock.world_state.tracker.get_smoothed_values().get()' id='1806912552448'> = MacroDTO(gdp=<MagicMock name='mock.world_state.tracker.get_smoothed_values().get()' id='1806912552448'>, cpi=<MagicMock name='mock.world_state.tracker.get_smoothed_values().get()' id='1806912552448'>, unemploy=5.0, gini=0.3).gdp
E        +    where MacroDTO(gdp=<MagicMock name='mock.world_state.tracker.get_smoothed_values().get()' id='1806912552448'>, cpi=<MagicMock name='mock.world_state.tracker.get_smoothed_values().get()' id='1806912552448'>, unemploy=5.0, gini=0.3) = WatchtowerSnapshotDTO(tick=42, status='RUNNING', integrity=IntegrityDTO(m2_leak=<MagicMock name='mock.world_state.tracker.get_smoothed_values().get()' id='1806912552448'>, fps=20095.693779904308), macro=MacroDTO(gdp=<MagicMock name='mock.world_state.tracker.get_smoothed_values().get()' id='1806912552448'>, cpi=<MagicMock name='mock.world_state.tracker.get_smoothed_values().get()' id='1806912552448'>, unemploy=5.0, gini=0.3), finance=FinanceDTO(rates=FinanceRatesDTO(base=0.0, call=0.0, loan=0.0, savings=0.0), supply=FinanceSupplyDTO(m0=100.0, m1=500.0, m2=600.0, velocity=1.5)), politics=PoliticsDTO(approval=PoliticsApprovalDTO(total=0.0, low=0.0, mid=0.0, high=0.0), status=PoliticsStatusDTO(ruling_party='NEUTRAL', cohesion=0.7), fiscal=PoliticsFiscalDTO(revenue=0.0, welfare=0.0, debt=0.0)), population=PopulationDTO(distribution=PopulationDistributionDTO(q1=100.0, q2=200.0, q3=300.0, q4=400.0, q5=500.0), active_count=100, metrics=PopulationMetricsDTO(birth=0.0, death=0.0))).macro

tests\integration\scenarios\diagnosis\test_dashboard_contract.py:55: AssertionError
---------------------------- Captured stderr call -----------------------------
Traceback (most recent call last):
  File "C:\coding\economics\simulation\orchestration\persistence_bridge.py", line 43, in save_snapshot
    json.dump(data, f, indent=2, ensure_ascii=False)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\__init__.py", line 179, in dump
    for chunk in iterable:
                 ^^^^^^^^
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 433, in _iterencode
    yield from _iterencode_dict(o, _current_indent_level)
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 407, in _iterencode_dict
    yield from chunks
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 407, in _iterencode_dict
    yield from chunks
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 440, in _iterencode
    o = _default(o)
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 180, in default
    raise TypeError(f'Object of type {o.__class__.__name__} '
                    f'is not JSON serializable')
TypeError: Object of type MagicMock is not JSON serializable
------------------------------ Captured log call ------------------------------
ERROR    simulation.orchestration.persistence_bridge:persistence_bridge.py:54 ‚ùå [Persistence] Failed to save snapshot: Object of type MagicMock is not JSON serializable
____________ TestPhase28StressScenarios.test_deflation_asset_shock ____________

self = <tests.integration.scenarios.test_stress_scenarios.TestPhase28StressScenarios object at 0x000001A4B3644050>
event_system = <simulation.systems.event_system.EventSystem object at 0x000001A4B46734D0>
mock_households = [<MagicMock spec='Household' id='1806912551440'>, <MagicMock spec='Household' id='1806913359552'>]
mock_firms = [<MagicMock id='1806913363584'>]

    def test_deflation_asset_shock(self, event_system, mock_households, mock_firms):
        """Verify Asset Reduction Trigger"""
        config = StressScenarioConfig(
            is_active=True,
            scenario_name='deflation',
            start_tick=20,
            asset_shock_reduction=0.2
        )
    
        central_bank = MagicMock()
        context: EventContext = {
            "households": mock_households,
            "firms": mock_firms,
            "markets": {},
            "central_bank": central_bank
        }
    
        event_system.execute_scheduled_events(20, context, config)
    
        # Verify destruction
        # h1: 1000 * 0.2 = 200
        # h2: 5000 * 0.2 = 1000
        # f1: 10000 * 0.2 = 2000
        assert event_system.settlement_system.transfer_and_destroy.call_count == 3
    
>       amounts = sorted([c.kwargs['amount'] for c in event_system.settlement_system.transfer_and_destroy.call_args_list])
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: '<' not supported between instances of 'MagicMock' and 'float'

tests\integration\scenarios\test_stress_scenarios.py:150: TypeError
------------------------------ Captured log call ------------------------------
WARNING  simulation.systems.event_system:event_system.py:33 üî• STRESS_TEST: Activating 'deflation' at Tick 20!
INFO     simulation.systems.event_system:event_system.py:87   -> Reduced all agent assets by 20%.
_______ TestPhase28StressScenarios.test_panic_selling_order_generation ________

self = <tests.integration.scenarios.test_stress_scenarios.TestPhase28StressScenarios object at 0x000001A4B3616450>

    def test_panic_selling_order_generation(self):
        """Verify Panic Selling Order Generation when assets are low."""
        # Arrange
        config_module = MagicMock()
        config_module.PANIC_SELLING_ASSET_THRESHOLD = 500.0
        config_module.STOCK_MARKET_ENABLED = True
    
        # Add Value Orientation Mapping (Required by Household.__init__)
        config_module.value_orientation_mapping = {
            "wealth_and_needs": {"preference_asset": 1.0, "preference_social": 1.0, "preference_growth": 1.0}
        }
        # Add required ranges for SocialState
        config_module.conformity_ranges = {}
        config_module.initial_household_assets_mean = 1000.0
        config_module.quality_pref_snob_min = 0.8
        config_module.quality_pref_miser_max = 0.2
        config_module.price_memory_length = 10
        config_module.wage_memory_length = 10
        config_module.ticks_per_year = 100
        config_module.adaptation_rate_normal = 0.1
    
        # Use ConfigDTO mock
        config_dto = MagicMock(spec=HouseholdConfigDTO)
        config_dto.value_orientation_mapping = config_module.value_orientation_mapping
        config_dto.conformity_ranges = config_module.conformity_ranges
        config_dto.initial_household_assets_mean = config_module.initial_household_assets_mean
        config_dto.quality_pref_snob_min = config_module.quality_pref_snob_min
        config_dto.quality_pref_miser_max = config_module.quality_pref_miser_max
        config_dto.price_memory_length = config_module.price_memory_length
        config_dto.wage_memory_length = config_module.wage_memory_length
        config_dto.ticks_per_year = config_module.ticks_per_year
        config_dto.adaptation_rate_normal = config_module.adaptation_rate_normal
        config_dto.adaptation_rate_conservative = 0.05
        config_dto.adaptation_rate_impulsive = 0.2
        config_dto.social_status_asset_weight = 0.5
        config_dto.social_status_luxury_weight = 0.5
        config_dto.base_desire_growth = 0.1
        config_dto.max_desire_value = 100.0
        config_dto.initial_wage = 10.0
        config_dto.household_low_asset_threshold = 100.0
        config_dto.household_low_asset_wage = 5.0
        config_dto.household_default_wage = 10.0
        config_dto.survival_need_consumption_threshold = 10.0
        config_dto.wage_decay_rate = 0.01
        config_dto.reservation_wage_floor = 1.0
        config_dto.household_min_wage_demand = 1.0
        config_dto.panic_selling_asset_threshold = 500.0
    
    
>       household = Household(
            id=1,
            talent=MagicMock(),
            goods_data=[],
            initial_assets=400.0, # Below threshold
            initial_needs={},
            decision_engine=MagicMock(),
            value_orientation="wealth_and_needs",
            personality=Personality.CONSERVATIVE,
            config_dto=config_dto, # Pass DTO
            # config_module=config_module # Removed
        )
E       TypeError: Household.__init__() missing 2 required positional arguments: 'core_config' and 'engine'

tests\integration\scenarios\test_stress_scenarios.py:267: TypeError
_________________________ test_settle_atomic_success __________________________

    def test_settle_atomic_success():
        settlement = SettlementSystem()
        debit_agent = MockAgent(1, 100.0)
        credit_agent1 = MockAgent(2, 0.0)
        credit_agent2 = MockAgent(3, 0.0)
    
        credits = [
            (credit_agent1, 30.0, "c1"),
            (credit_agent2, 20.0, "c2")
        ]
    
        success = settlement.settle_atomic(debit_agent, credits, tick=1)
    
>       assert success is True
E       assert False is True

tests\integration\test_atomic_settlement.py:37: AssertionError
------------------------------ Captured log call ------------------------------
ERROR    simulation.systems.settlement_system:settlement_system.py:381 SETTLEMENT_UNHANDLED_FAIL | MockAgent.withdraw() got an unexpected keyword argument 'currency'
Traceback (most recent call last):
  File "C:\coding\economics\simulation\systems\settlement_system.py", line 353, in _execute_withdrawal
    agent.withdraw(amount, currency=currency)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: MockAgent.withdraw() got an unexpected keyword argument 'currency'
_________________________ test_settle_atomic_rollback _________________________

self = <MagicMock id='1806915202960'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'mock' to have been called once. Called 0 times.

C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:958: AssertionError

During handling of the above exception, another exception occurred:

    def test_settle_atomic_rollback():
        settlement = SettlementSystem()
        debit_agent = MockAgent(1, 100.0)
        credit_agent1 = MockAgent(2, 0.0)
        credit_agent2 = MockAgent(3, 0.0)
    
        # Mock credit_agent2 to fail on deposit
        credit_agent2.deposit = MagicMock(side_effect=Exception("Bank Frozen"))
    
        credits = [
            (credit_agent1, 30.0, "c1"),
            (credit_agent2, 20.0, "c2")
        ]
    
        success = settlement.settle_atomic(debit_agent, credits, tick=1)
    
        assert success is False
        assert debit_agent.assets == 100.0 # Full refund (100 - 50 + 50)
        assert credit_agent1.assets == 0.0 # Rolled back (0 + 30 - 30)
    
        # Verify that credit_agent2.deposit was called
>       credit_agent2.deposit.assert_called_once()
E       AssertionError: Expected 'mock' to have been called once. Called 0 times.

tests\integration\test_atomic_settlement.py:63: AssertionError
------------------------------ Captured log call ------------------------------
ERROR    simulation.systems.settlement_system:settlement_system.py:381 SETTLEMENT_UNHANDLED_FAIL | MockAgent.withdraw() got an unexpected keyword argument 'currency'
Traceback (most recent call last):
  File "C:\coding\economics\simulation\systems\settlement_system.py", line 353, in _execute_withdrawal
    agent.withdraw(amount, currency=currency)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: MockAgent.withdraw() got an unexpected keyword argument 'currency'
______________ test_grant_bailout_loan_success_and_covenant_type ______________

finance_test_environment = (<modules.finance.system.FinanceSystem object at 0x000001A4B5BAA120>, <Mock id='1806935164640'>, <Mock id='1806935170352'>)

    def test_grant_bailout_loan_success_and_covenant_type(finance_test_environment):
        """
        Tests that a bailout loan is granted successfully, generating the correct transactions
        and DTOs (Phase 3 Compliance).
        """
        finance_system, mock_government, mock_firm = finance_test_environment
    
        # Setup dynamic asset property for government to support check in grant_bailout_loan
        # The method checks if self.government.assets < amount
        type(mock_government).assets = PropertyMock(return_value=1_000_000.0)
    
        initial_firm_debt = mock_firm.total_debt
        loan_amount = 50_000.0
        current_tick = 10
    
        # Act
        # Update: method now returns (loan_dto, txs)
>       loan_dto, txs = finance_system.grant_bailout_loan(mock_firm, loan_amount, current_tick)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: FinanceSystem.grant_bailout_loan() takes 3 positional arguments but 4 were given

tests\integration\test_finance_bailout.py:66: TypeError
____________ test_grant_bailout_loan_insufficient_government_funds ____________

finance_test_environment = (<modules.finance.system.FinanceSystem object at 0x000001A4B4673ED0>, <Mock id='1806935173040'>, <Mock id='1806935174720'>)

    def test_grant_bailout_loan_insufficient_government_funds(finance_test_environment):
        """
        Tests that the bailout loan is not granted if the government has insufficient funds.
        """
        finance_system, mock_government, mock_firm = finance_test_environment
    
        # Arrange: Government has less money than the loan amount
        loan_amount = 2_000_000.0
        # Set assets lower than loan amount
        type(mock_government).assets = PropertyMock(return_value=1_000_000.0)
    
        # Act
>       loan_dto, txs = finance_system.grant_bailout_loan(mock_firm, loan_amount, current_tick=10)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: FinanceSystem.grant_bailout_loan() got an unexpected keyword argument 'current_tick'

tests\integration\test_finance_bailout.py:102: TypeError
____________________ test_growth_scenario_with_golden_firm ____________________

golden_firms = [namespace(id=100, assets=55000.0, is_active=True, specialization='food', productivity_factor=1.0, employees_count=3, ...ock id='1806916115760'>, wallet=<MagicMock id='1806916115424'>, get_financial_snapshot=<MagicMock id='1806916114080'>)]
golden_config = <MagicMock id='1806915396208'>

    def test_growth_scenario_with_golden_firm(golden_firms, golden_config):
        """
        Tests that a healthy firm from a golden snapshot correctly decides
        to invest in capex and hire more employees when presented with
        high demand signals.
        """
        if not golden_firms:
            pytest.skip("Golden fixtures not found.")
    
        # Arrange: Select a healthy firm and create context
        healthy_firm_mock = golden_firms[0] # Assume first is healthy
    
        # We need a mock AI engine
        mock_ai_engine = Mock()
        # Setup AI to return a growth-oriented vector
        from simulation.schemas import FirmActionVector
        mock_ai_engine.decide_action_vector.return_value = FirmActionVector(
            sales_aggressiveness=0.5,
            hiring_aggressiveness=0.8, # Hire!
            rd_aggressiveness=0.5,
            capital_aggressiveness=0.8, # Invest!
            dividend_aggressiveness=0.2,
            debt_aggressiveness=0.5
        )
    
        engine = AIDrivenFirmDecisionEngine(ai_engine=mock_ai_engine, config_module=golden_config)
    
        # Mock system2_planner
        engine.corporate_manager.system2_planner = Mock()
        engine.corporate_manager.system2_planner.project_future.return_value = {}
    
        # Create a State DTO from the mock
        state = create_firm_state_dto(healthy_firm_mock, golden_config)
    
        # Simulate high demand
        market_data = {"food": {"demand_signal": 1.5}}
    
        # We need to ensure state.production.inventory has the key "food" if specialization is food
        if "food" not in state.production.inventory:
            state.production.inventory["food"] = 0.0
    
        # Create a proper FirmConfigDTO for the context
        from tests.utils.factories import create_firm_config_dto
        firm_config = create_firm_config_dto()
    
        context = DecisionContext(
            state=state,
            config=firm_config,
            market_data=market_data,
            goods_data=[],
            current_time=1,
        )
    
        # Act
>       output = engine.make_decisions(context)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_firm_decision_scenarios.py:119: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\decisions\base_decision_engine.py:25: in make_decisions
    return self._make_decisions_internal(context, macro_context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
simulation\decisions\ai_driven_firm_engine.py:65: in _make_decisions_internal
    orders = self.corporate_manager.realize_ceo_actions(firm_state, context, action_vector)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
simulation\decisions\corporate_manager.py:55: in realize_ceo_actions
    financial_plan = self.financial_strategy.formulate_plan(
simulation\decisions\firm\financial_strategy.py:21: in formulate_plan
    div_order = self._manage_dividends(firm, dividend_aggressiveness, config)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.decisions.firm.financial_strategy.FinancialStrategy object at 0x000001A4B497CD70>
firm = <Mock spec='FirmStateDTO' id='1806916109376'>, aggressiveness = 0.2
config = FirmConfigDTO(firm_min_production_target=10.0, firm_max_production_target=100.0, startup_cost=1000.0, seo_trigger_rati...ecay_params=(0.5, 0.05, 700), ai_reward_brand_value_multiplier=0.05, default_unit_cost=5.0, space_utility_factor=100.0)

    def _manage_dividends(self, firm: FirmStateDTO, aggressiveness: float, config: FirmConfigDTO) -> Optional[Order]:
        """
        Set Dividend Rate.
        """
        z_score = firm.finance.altman_z_score
        z_score_threshold = config.altman_z_score_threshold
        loss_limit = config.dividend_suspension_loss_ticks
    
>       is_distressed = (z_score < z_score_threshold) or (firm.finance.consecutive_loss_turns >= loss_limit)
                                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: '>=' not supported between instances of 'MagicMock' and 'int'

simulation\decisions\firm\financial_strategy.py:44: TypeError
------------------------------ Captured log call ------------------------------
INFO     simulation.decisions.ai_driven_firm_engine:ai_driven_firm_engine.py:40 AIDrivenFirmDecisionEngine initialized with CorporateManager.
___ test_infrastructure_investment_generates_transactions_and_issues_bonds ____

    def test_infrastructure_investment_generates_transactions_and_issues_bonds():
        # Setup
        config = MockConfig()
        settlement_system = SettlementSystem()
    
        gov = Government(id=1, initial_assets=1000.0, config_module=config)
        gov.settlement_system = settlement_system
    
        bank = Bank(id=2, initial_assets=10000.0, config_manager=config, settlement_system=settlement_system)
        bank.settlement_system = settlement_system
        bank.set_government(gov) # Bank needs gov reference
    
        central_bank = MagicMock()
        central_bank.get_base_rate.return_value = 0.05
    
        finance_system = FinanceSystem(gov, central_bank, bank, config, settlement_system)
        gov.finance_system = finance_system
    
        # Mock Sensory Data for FinanceSystem (GDP needed for bond issuance check)
        gov.sensory_data = MagicMock()
        gov.sensory_data.current_gdp = 10000.0
    
        # Setup Households for Public Works
        h1 = MagicMock(spec=Household)
        h1.id = 101
        h1.is_active = True
        h1.assets = 0.0
    
        households = [h1]
    
        # Check Initial State
        initial_gov_assets = gov.assets
        initial_bank_assets = bank.assets
    
        # Cost 5000. Gov has 1000. Deficit 4000.
        # Gov should issue 4000 bonds (synchronous).
        # Then create transactions for 5000.
    
        transactions = gov.invest_infrastructure(current_tick=1, households=households)
    
        # Verification
    
        # 1. Bond Issuance (Synchronous)
        # Gov assets should have increased by 4000 (to cover deficit)
        # NOTE: invest_infrastructure calculates 'needed' and calls issue_treasury_bonds_synchronous.
        # This transfers 4000 from Bank to Gov immediately.
        # The SPENDING (5000) is returned as transactions, NOT executed immediately.
        # So Gov assets should be 1000 + 4000 = 5000.
    
>       assert gov.assets['USD'] == 5000.0
               ^^^^^^^^^^^^^^^^^
E       TypeError: 'float' object is not subscriptable

tests\integration\test_fiscal_integrity.py:83: TypeError
------------------------------ Captured log call ------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
INFO     simulation.bank:bank.py:91 Bank 2 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
INFO     modules.finance.system:system.py:276 BOND_SYNC_SUCCESS | Raised 4000.00 from 2 for Gov 1
INFO     modules.government.components.infrastructure_manager:infrastructure_manager.py:90 INFRASTRUCTURE_PENDING | Level 1 initiated. Cost: 5000.0. Distributed to 1 households.
_____________ test_education_spending_generates_transactions_only _____________

    def test_education_spending_generates_transactions_only():
        # Setup
        config = MockConfig()
        settlement_system = SettlementSystem()
    
        gov = Government(id=1, initial_assets=100.0, config_module=config)
        gov.settlement_system = settlement_system
>       gov.revenue_this_tick = 10000.0 # High revenue to trigger high budget
        ^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: property 'revenue_this_tick' of 'Government' object has no setter

tests\integration\test_fiscal_integrity.py:115: AttributeError
------------------------------ Captured log call ------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 100.0})
_________________ TestGenerationalWealthAudit.test_run_audit __________________

self = <tests.integration.test_generational_wealth_audit.TestGenerationalWealthAudit testMethod=test_run_audit>
mock_log_info = <MagicMock name='info' id='1806915206656'>

    @patch('logging.Logger.info')
    def test_run_audit(self, mock_log_info):
        # Create mock agents
        agent1 = self.create_mock_household(1, 1000, 1)
        agent2 = self.create_mock_household(2, 2000, 2)
        agent3 = self.create_mock_household(3, 3000, 1)
    
        agents = [agent1, agent2, agent3]
    
        # Run the audit
>       self.audit.run_audit(agents, 100)

tests\integration\test_generational_wealth_audit.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.systems.generational_wealth_audit.GenerationalWealthAudit object at 0x000001A4B489D940>
agents = [<MagicMock id='1806915203296'>, <MagicMock id='1806915206320'>, <MagicMock id='1806915202960'>]
current_tick = 100

    def run_audit(self, agents: List[Household], current_tick: int) -> None:
        """
        Calculates and logs the wealth distribution across generations.
    
        Args:
            agents: A list of all household agents in the simulation.
            current_tick: The current simulation tick.
        """
        wealth_by_generation: Dict[int, float] = {}
        count_by_generation: Dict[int, int] = {}
    
        for agent in agents:
            if not agent.is_active:
                continue
    
            generation = getattr(agent, 'generation', 1)
    
            wealth = 0.0
            if hasattr(agent, 'wallet'):
                wealth = agent.wallet.get_balance(DEFAULT_CURRENCY)
            elif hasattr(agent, 'assets') and isinstance(agent.assets, dict):
                wealth = agent.assets.get(DEFAULT_CURRENCY, 0.0)
            elif hasattr(agent, 'assets'):
                wealth = float(agent.assets)
    
            wealth_by_generation[generation] = wealth_by_generation.get(generation, 0.0) + wealth
            count_by_generation[generation] = count_by_generation.get(generation, 0) + 1
    
        if not wealth_by_generation:
            self.logger.info("GENERATIONAL_WEALTH_AUDIT | No active agents to audit.", extra={"tick": current_tick})
            return
    
        total_wealth = sum(wealth_by_generation.values())
        total_agents = sum(count_by_generation.values())
    
>       log_message = f"GENERATIONAL_WEALTH_AUDIT | Tick: {current_tick} | Total Wealth: {total_wealth:.2f} | Total Agents: {total_agents}\n"
                                                                                         ^^^^^^^^^^^^^^^^^^
E       TypeError: unsupported format string passed to MagicMock.__format__

simulation\systems\generational_wealth_audit.py:53: TypeError
_ TestGovernmentFiscalIntegration.test_calculate_income_tax_uses_fiscal_policy_manager _

self = <tests.integration.test_government_fiscal_integration.TestGovernmentFiscalIntegration object at 0x000001A4B3644910>
mock_config = <MagicMock id='1806935173376'>

    def test_calculate_income_tax_uses_fiscal_policy_manager(self, mock_config):
        # Setup
        gov = Government(id=1, config_module=mock_config)
    
        # Override manager with a mock to verify delegation
        gov.fiscal_policy_manager = MagicMock()
        gov.fiscal_policy_manager.calculate_tax_liability.return_value = 123.45
    
        # Ensure a policy is set
        gov.fiscal_policy = MagicMock(spec=FiscalPolicyDTO)
    
        # Execute
>       tax = gov.calculate_income_tax(1000.0, 10.0)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_government_fiscal_integration.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\agents\government.py:201: in calculate_income_tax
    return self.tax_service.calculate_tax_liability(self.fiscal_policy, income)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
modules\government\tax\service.py:50: in calculate_tax_liability
    return self.fiscal_policy_manager.calculate_tax_liability(policy, income)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
modules\government\components\fiscal_policy_manager.py:107: in calculate_tax_liability
    for bracket in policy.progressive_tax_brackets:
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock spec='FiscalPolicyDTO' id='1806915193888'>
name = 'progressive_tax_brackets'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'progressive_tax_brackets'

C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:690: AttributeError
------------------------------ Captured log call ------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
_ TestGovernmentFiscalIntegration.test_make_policy_decision_updates_fiscal_policy _

self = <tests.integration.test_government_fiscal_integration.TestGovernmentFiscalIntegration object at 0x000001A4B3645950>
mock_config = <MagicMock id='1806912552112'>

    def test_make_policy_decision_updates_fiscal_policy(self, mock_config):
        # Setup
        gov = Government(id=1, config_module=mock_config)
    
        # Mock manager
        gov.fiscal_policy_manager = MagicMock()
        expected_policy = FiscalPolicyDTO(progressive_tax_brackets=[])
        gov.fiscal_policy_manager.determine_fiscal_stance.return_value = expected_policy
    
        # Setup market data
        market_data = {
            "goods_market": {
                "basic_food_current_sell_price": 20.0
            }
        }
    
        # Execute
        # We need a dummy CentralBank
        cb = MagicMock()
        gov.sensory_data = MagicMock() # Need sensory data for policy engine
        gov.sensory_data.current_gdp = 1000.0
        gov.sensory_data.inflation_sma = 0.02
>       gov.make_policy_decision(market_data, 1, cb)

tests\integration\test_government_fiscal_integration.py:60: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\agents\government.py:309: in make_policy_decision
    policy_decision = self.decision_engine.decide(current_state_dto, market_snapshot, central_bank)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
modules\government\engines\decision_engine.py:81: in decide
    return self._decide_taylor_rule(state, market_snapshot, central_bank, potential_gdp, current_gdp)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <modules.government.engines.decision_engine.GovernmentDecisionEngine object at 0x000001A4B46CD450>
state = GovernmentStateDTO(tick=1, assets=defaultdict(<class 'float'>, {'USD': 0.0}), total_debt=0.0, income_tax_rate=0.1, cor...912551440'>, gdp_history=[], welfare_budget_multiplier=1.0, monetary_policy=None, potential_gdp=0.0, fiscal_stance=0.0)
market_snapshot = MarketSnapshotDTO(tick=1, market_signals={}, housing=None, loan=None, labor=None, market_data={'goods_market': {'basic_food_current_sell_price': 20.0}})
central_bank = <MagicMock id='1806912551104'>, potential_gdp = 1000.0
current_gdp = 1000.0

    def _decide_taylor_rule(self, state: GovernmentStateDTO, market_snapshot: MarketSnapshotDTO, central_bank: Any, potential_gdp: float, current_gdp: float) -> PolicyDecisionDTO:
        """
        Implements Taylor Rule-based fiscal policy logic.
        """
        gdp_gap = 0.0
        if potential_gdp > 0:
            gdp_gap = (current_gdp - potential_gdp) / potential_gdp
    
        # Counter-Cyclical Logic
        auto_cyclical = getattr(self.config, "AUTO_COUNTER_CYCLICAL_ENABLED", False)
    
        new_income_tax_rate = state.income_tax_rate
        action_tag = PolicyActionTag.GENERAL_ADMIN
        fiscal_stance = 0.0
    
        if auto_cyclical:
            sensitivity = getattr(self.config, "FISCAL_SENSITIVITY_ALPHA", 0.5)
            base_tax_rate = getattr(self.config, "INCOME_TAX_RATE", 0.1)
    
            fiscal_stance = -sensitivity * gdp_gap
            new_tax_rate = base_tax_rate * (1 - fiscal_stance)
            new_income_tax_rate = new_tax_rate
    
>           if fiscal_stance > 0:
               ^^^^^^^^^^^^^^^^^
E           TypeError: '>' not supported between instances of 'MagicMock' and 'int'

modules\government\engines\decision_engine.py:106: TypeError
------------------------------ Captured log call ------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
________________ TestGovernmentTax.test_record_revenue_success ________________

self = <tests.integration.test_government_tax.TestGovernmentTax object at 0x000001A4B3646210>
government = <simulation.agents.government.Government object at 0x000001A4B4672E90>

    def test_record_revenue_success(self, government):
        # Arrange
        result: TaxCollectionResult = {
            "success": True,
            "amount_collected": 100.0,
            "tax_type": "income_tax",
            "payer_id": 101,
            "payee_id": 1,
            "error_message": None
        }
        initial_total = government.total_collected_tax
        initial_revenue = government.revenue_this_tick
    
        # Act
        government.record_revenue(result)
    
        # Assert
>       assert government.total_collected_tax == initial_total + 100.0
                                                 ^^^^^^^^^^^^^^^^^^^^^
E       TypeError: unsupported operand type(s) for +: 'dict' and 'float'

tests\integration\test_government_tax.py:39: TypeError
----------------------------- Captured log setup ------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
__________________ TestGovernmentTax.test_collect_tax_legacy __________________

self = <tests.integration.test_government_tax.TestGovernmentTax object at 0x000001A4B3563E10>
government = <simulation.agents.government.Government object at 0x000001A4B34CD810>

    def test_collect_tax_legacy(self, government):
        # Arrange
        payer = MagicMock()
        payer.id = 101
        amount = 50.0
        tax_type = "wealth_tax"
        current_tick = 10
    
        government.settlement_system.transfer.return_value = True
    
        # Act
        with pytest.warns(DeprecationWarning, match="Government.collect_tax is deprecated"):
            result = government.collect_tax(amount, tax_type, payer, current_tick)
    
        # Assert
        government.settlement_system.transfer.assert_called_once_with(
            payer, government, amount, f"{tax_type} collection"
        )
    
        assert result["success"] is True
        assert result["amount_collected"] == amount
        assert result["tax_type"] == tax_type
>       assert government.total_collected_tax == 50.0 # Should have called record_revenue internally
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AssertionError: assert {'USD': 50.0} == 50.0
E        +  where {'USD': 50.0} = <simulation.agents.government.Government object at 0x000001A4B34CD810>.total_collected_tax

tests\integration\test_government_tax.py:84: AssertionError
----------------------------- Captured log setup ------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 1000.0})
______________ TestLiquidationServices.test_hr_service_severance ______________

self = <tests.integration.test_liquidation_services.TestLiquidationServices testMethod=test_hr_service_severance>

    def test_hr_service_severance(self):
        current_tick = 2000
    
        # Employee: 2 years tenure
        # Start tick = 2000 - (365 * 2) = 1270
        emp = MagicMock()
        emp.id = 101
        emp._econ_state.employment_start_tick = 1270
    
        self.firm.hr.employees = [emp]
        self.firm.hr.employee_wages = {101: 100.0}
        self.firm.hr.unpaid_wages = {}
    
        # Severance = 2 yrs * 2 weeks/yr * 7.019 ticks/week * 100 wage
        # ticks_per_week = 365/52 = 7.01923
        # 2 * 2 * 7.019 * 100 = 2807.69
    
>       claims = self.hr_service.calculate_liquidation_employee_claims(self.firm, current_tick)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_liquidation_services.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
modules\hr\service.py:17: in calculate_liquidation_employee_claims
    if hasattr(firm.hr_state, 'unpaid_wages'):
               ^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock spec='Firm' id='1806935164976'>, name = 'hr_state'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'hr_state'

C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:690: AttributeError
____________ TestLiquidationServices.test_hr_service_unpaid_wages _____________

self = <tests.integration.test_liquidation_services.TestLiquidationServices testMethod=test_hr_service_unpaid_wages>

    def test_hr_service_unpaid_wages(self):
        current_tick = 1000
        # Wage cutoff = 1000 - 91 = 909
    
        # Employee 1: Unpaid wages 500 (tick 950 - OK)
        # Employee 2: Unpaid wages 500 (tick 800 - Too Old)
    
        self.firm.hr.unpaid_wages = {
            101: [(950, 500.0)],
            102: [(800, 500.0)]
        }
        self.firm.hr.employees = []
        self.firm.hr.employee_wages = {}
    
>       claims = self.hr_service.calculate_liquidation_employee_claims(self.firm, current_tick)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_liquidation_services.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
modules\hr\service.py:17: in calculate_liquidation_employee_claims
    if hasattr(firm.hr_state, 'unpaid_wages'):
               ^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock spec='Firm' id='1806915204304'>, name = 'hr_state'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'hr_state'

C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:690: AttributeError
__________________ TestLiquidationServices.test_tax_service ___________________

self = <tests.integration.test_liquidation_services.TestLiquidationServices testMethod=test_tax_service>

    def test_tax_service(self):
        self.firm.finance.current_profit = 1000.0
    
        # Mock Registry to return Government
        gov_agent = MagicMock()
        gov_agent.id = "gov_real_id"
        self.agent_registry.get_agent = MagicMock(return_value=gov_agent)
    
>       claims = self.tax_service.calculate_liquidation_tax_claims(self.firm)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_liquidation_services.py:82: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
modules\finance\service.py:19: in calculate_liquidation_tax_claims
    current_profit_raw = firm.finance_state.current_profit
                         ^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock spec='Firm' id='1806915202960'>, name = 'finance_state'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'finance_state'

C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:690: AttributeError
_ TestMultiCurrencyLiquidation.test_foreign_currency_distribution_to_shareholders _

self = <tests.integration.test_multicurrency_liquidation.TestMultiCurrencyLiquidation testMethod=test_foreign_currency_distribution_to_shareholders>

    def test_foreign_currency_distribution_to_shareholders(self):
        """
        Verify that foreign currency assets are distributed to shareholders
        after debts are paid.
        """
        # Setup Shareholder
        shareholder = MagicMock(spec=Household)
        shareholder.id = 101
        shareholder.shares_owned = {1: 100.0} # 100% ownership
    
        self.state.households = [shareholder]
        self.state.agents[101] = shareholder
    
        # Execute
        self.manager.initiate_liquidation(self.firm, self.state)
    
        # Verify Transfers
        # Expect:
        # 1. 1000.0 USD to Shareholder
        # 2. 50000.0 KRW to Shareholder
    
        calls = self.mock_settlement.transfer.call_args_list
    
        usd_transfer = False
        krw_transfer = False
    
        for call in calls:
            args = call[0]
            kwargs = call[1]
            payee = args[1]
            amount = args[2]
            currency = kwargs.get('currency', DEFAULT_CURRENCY)
    
            if payee.id == 101:
                if currency == DEFAULT_CURRENCY and amount == 1000.0:
                    usd_transfer = True
                elif currency == "KRW" and amount == 50000.0:
                    krw_transfer = True
    
>       self.assertTrue(usd_transfer, "Shareholder should receive 1000 USD")
E       AssertionError: False is not true : Shareholder should receive 1000 USD

tests\integration\test_multicurrency_liquidation.py:101: AssertionError
------------------------------ Captured log call ------------------------------
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:80 LIQUIDATION_START | Agent 1 starting liquidation. Assets: 1000.00, Total Claims: 0.00
INFO     simulation.systems.liquidation_manager:liquidation_manager.py:164 LIQUIDATION_WATERFALL | Tier 5 (Equity) distributed 0.00 USD and foreign assets: {} to shareholders.
_______________ TestPhase20Integration.test_immigration_trigger _______________

self = <tests.integration.test_phase20_integration.TestPhase20Integration object at 0x000001A4B36479D0>
mock_config = <MagicMock id='1806934331408'>

    def test_immigration_trigger(self, mock_config):
        """Test if immigration is triggered under correct conditions."""
    
        # Setup ImmigrationManager
        manager = ImmigrationManager(mock_config, settlement_system=MagicMock())
    
        # Mock Engine
        engine = MagicMock()
        engine.time = 100
        engine.next_agent_id = 100
        # Mock households list with MagicMock objects, but ensure is_active is boolean
        engine.households = []
        for i in range(50):
            h = MagicMock()
            h._bio_state.is_active = True # Boolean, not Mock
            h._econ_state.assets = 5000.0
            engine.households.append(h)
        engine.goods_data = []
        engine.ai_trainer = MagicMock()
    
        # Mock Tracker Indicators
        engine.tracker.get_latest_indicators.return_value = {
            "unemployment_rate": 0.01 # < 0.05 (Labor Shortage)
        }
    
        # Mock Market Data (Vacancies)
        engine._prepare_market_data.return_value = {
            "job_vacancies": 10 # > 0
        }
    
        # Mock Engine Markets
        labor_market = MagicMock()
        labor_market.get_total_demand.return_value = 10
        engine.markets = {"labor": labor_market}
    
        # Execute
>       new_immigrants = manager.process_immigration(engine)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_phase20_integration.py:76: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\systems\immigration_manager.py:60: in process_immigration
    new_immigrants = self._create_immigrants(engine, batch_size)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
simulation\systems\immigration_manager.py:127: in _create_immigrants
    household = Household(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.core_agents.Household object at 0x000001A4B464D5B0>
core_config = AgentCoreConfigDTO(id=100, value_orientation='needs_and_social_status', initial_needs={'survival': 60.0, 'social': 20....ed': 50.0}, name='Immigrant_100', logger=<Logger simulation.systems.immigration_manager (INFO)>, memory_interface=None)
engine = <simulation.decisions.ai_driven_household_engine.AIDrivenHouseholdDecisionEngine object at 0x000001A4B4672210>
talent = Talent(base_learning_rate=0.9972140745994431, max_potential={}, related_domains={})
goods_data = [], personality = <Personality.STATUS_SEEKER: 2>
config_dto = HouseholdConfigDTO(survival_need_consumption_threshold=<MagicMock name='mock.SURVIVAL_NEED_CONSUMPTION_THRESHOLD' id='...ION' id='1806937656688'>, food_consumption_utility=<MagicMock name='mock.FOOD_CONSUMPTION_UTILITY' id='1806937657024'>)
loan_market = None, risk_aversion = 9.142387875073435, initial_age = None
gender = None, parent_id = None, generation = None, initial_assets_record = 0.0
kwargs = {}

    def __init__(
        self,
        core_config: AgentCoreConfigDTO,
        engine: IDecisionEngine,
        talent: Talent,
        goods_data: List[Dict[str, Any]],
        personality: Personality,
        config_dto: HouseholdConfigDTO,
        loan_market: Optional[LoanMarket] = None,
        risk_aversion: float = 1.0,
        # Demographics
        initial_age: Optional[float] = None,
        gender: Optional[str] = None,
        parent_id: Optional[int] = None,
        generation: Optional[int] = None,
        initial_assets_record: Optional[float] = None,  # WO-124: Explicit record of intended assets
        **kwargs,
    ) -> None:
        self.config = config_dto
        self.logger = core_config.logger
    
        # --- Initialize Engines (Stateless) ---
        self.lifecycle_engine = LifecycleEngine()
        self.needs_engine = NeedsEngine()
        self.social_engine = SocialEngine()
        self.budget_engine = BudgetEngine()
        self.consumption_engine = ConsumptionEngine()
    
        # --- Initialize Internal State DTOs ---
    
        # 1. Bio State
        self._bio_state = BioStateDTO(
            id=core_config.id,
>           age=initial_age if initial_age is not None else random.uniform(*self.config.initial_household_age_range),
                                                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            gender=gender if gender is not None else random.choice(["M", "F"]),
            generation=generation if generation is not None else 0,
            is_active=True,
            needs=core_config.initial_needs.copy(),
            parent_id=parent_id
        )
E       TypeError: Random.uniform() missing 2 required positional arguments: 'a' and 'b'

simulation\core_agents.py:133: TypeError
------------------------------ Captured log call ------------------------------
INFO     simulation.systems.immigration_manager:immigration_manager.py:55 IMMIGRATION_TRIGGERED | Pop: 50, Unemp: 1.00%, Vacancies: 10. Influx: 5
INFO     simulation.decisions.ai_driven_household_engine:ai_driven_household_engine.py:43 AIDrivenHouseholdDecisionEngine initialized (Modularized).
___________ TestPhase20Integration.test_system2_housing_cost_renter ___________

self = <tests.integration.test_phase20_integration.TestPhase20Integration object at 0x000001A4B36CCB00>
mock_config = <MagicMock id='1806916611312'>

    def test_system2_housing_cost_renter(self, mock_config):
        """Test System2Planner deducting rent for non-owners."""
        agent = MagicMock()
        agent.assets = 1000.0
        agent.expected_wage = 10.0 # Make sure this is float
        agent.residing_property_id = None # Homeless/Renter
        agent.owned_properties = []
        agent.spouse_id = None
        agent.children_ids = []
    
        planner = System2Planner(agent, mock_config)
    
        market_data = {
            "goods_market": {"basic_food_current_sell_price": 5.0},
            "housing_market": {"avg_rent_price": 50.0},
            "debt_data": {}
        }
    
        # Mock time allocation
        agent.decision_engine.ai_engine.decide_time_allocation.return_value = {"total_obligated": 0.0}
    
>       result = planner.project_future(1, market_data)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_phase20_integration.py:129: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.ai.system2_planner.System2Planner object at 0x000001A4B49F6F90>
current_tick = 1
market_data = {'debt_data': {}, 'goods_market': {'basic_food_current_sell_price': 5.0}, 'housing_market': {'avg_rent_price': 50.0}}

    def project_future(self, current_tick: int, market_data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Projects future wealth and survival probability.
        Phase 20 Step 3: Includes Housing Costs (Rent/Mortgage)
        """
        # Optimization: Run only every X ticks
        if current_tick - self.last_calc_tick < self.calc_interval and self.cached_projection:
            return self.cached_projection
    
        self.last_calc_tick = current_tick
    
        # 1. Gather Inputs
        current_wealth = 0.0
        if hasattr(self.agent, 'wallet'):
            current_wealth = self.agent.wallet.get_balance(DEFAULT_CURRENCY)
        elif hasattr(self.agent, 'assets') and isinstance(self.agent.assets, dict):
            current_wealth = self.agent.assets.get(DEFAULT_CURRENCY, 0.0)
        elif hasattr(self.agent, 'assets'):
            current_wealth = float(self.agent.assets)
    
        expected_wage = getattr(self.agent, "expected_wage", 10.0)
    
        # Survival Cost
        goods_market = market_data.get("goods_market", {})
        food_price = goods_market.get("basic_food_current_sell_price", 5.0)
        daily_consumption = getattr(self.config, "HOUSEHOLD_FOOD_CONSUMPTION_PER_TICK", 2.0)
        daily_survival_cost = food_price * daily_consumption
    
        # A. Determine Work Hours (Existing)
        agent_data = self.agent.get_agent_data()
        household_ai = getattr(self.agent.decision_engine, "ai_engine", None)
        time_obligations = 0.0
    
        if household_ai and hasattr(household_ai, "decide_time_allocation"):
            spouse_data = {"id": self.agent.spouse_id} if self.agent.spouse_id else None
            c_count = len(self.agent.children_ids)
            dummy_children = [{"age": 1}] if c_count > 0 else []
            alloc = household_ai.decide_time_allocation(agent_data, spouse_data, dummy_children, self.config)
            time_obligations = alloc["total_obligated"]
    
        available_work_hours = max(0.0, 14.0 - time_obligations)
        projected_work_hours = min(8.0, available_work_hours)
    
        # C. Housing Costs Integration (Rent/Mortgage)
        housing_costs = 0.0
    
        # Scenario 1: Homeowner with Mortgage
        # We check actual daily interest burden from Bank via injected debt_data
        debt_data_map = market_data.get("debt_data", {})
        my_debt = debt_data_map.get(self.agent.id, {})
        daily_interest = my_debt.get("daily_interest_burden", 0.0)
    
        # Scenario 2: Renter (or Homeless)
        # If I don't own the home I live in, or I am homeless -> I pay rent (or should pay rent)
        # Note: If homeless, cost is 0 financially but huge utility penalty.
        # But System 2 tracks financial solvency. Homeless people might eventually rent.
        # However, strictly:
        # If agent.residing_property_id is NOT in agent.owned_properties -> Renter.
        # If agent.is_homeless -> Potential Renter (Assumed to pay rent to survive or 0)
        # Spec says: "If agent.is_homeless or no resident property: deduct avg_rent_price"
    
        is_homeowner = False
        if self.agent.residing_property_id is not None:
            if self.agent.residing_property_id in self.agent.owned_properties:
                is_homeowner = True
    
        if is_homeowner:
            housing_costs = daily_interest # Mortgage Interest
        else:
            # Renter or Homeless
            housing_market = market_data.get("housing_market", {})
            avg_rent = housing_market.get("avg_rent_price", 100.0)
            housing_costs = avg_rent
    
        # D. Expenses (Formula)
        extra_expenses = 0.0
        tech_level = getattr(self.config, "FORMULA_TECH_LEVEL", 0.0)
        if len(self.agent.children_ids) > 0:
            if tech_level > 0.5:
                extra_expenses += 5.0
    
        daily_income = expected_wage * projected_work_hours
        daily_net_flow = daily_income - daily_survival_cost - extra_expenses - housing_costs
    
        # 2. Simulation Loop
        npv_wealth = 0.0
        bankruptcy_tick = None
        simulated_wealth = current_wealth
    
        for t in range(1, self.horizon + 1):
            discount_factor = self.discount_rate ** t
            simulated_wealth += daily_net_flow
>           if simulated_wealth < 0 and bankruptcy_tick is None:
               ^^^^^^^^^^^^^^^^^^^^
E           TypeError: '<' not supported between instances of 'MagicMock' and 'int'

simulation\ai\system2_planner.py:119: TypeError
___________ TestPhase20Integration.test_system2_housing_cost_owner ____________

self = <tests.integration.test_phase20_integration.TestPhase20Integration object at 0x000001A4B36CCC30>
mock_config = <MagicMock id='1806917257600'>

    def test_system2_housing_cost_owner(self, mock_config):
        """Test System2Planner deducting mortgage interest for owners."""
        agent = MagicMock()
        agent.assets = 1000.0
        agent.expected_wage = 10.0 # Make sure this is float
        agent.residing_property_id = 1
        agent.owned_properties = [1]
        agent.id = 1
        agent.spouse_id = None
        agent.children_ids = []
    
        planner = System2Planner(agent, mock_config)
    
        market_data = {
            "goods_market": {"basic_food_current_sell_price": 5.0},
            "housing_market": {"avg_rent_price": 50.0},
            "debt_data": {
                1: {"daily_interest_burden": 30.0}
            }
        }
    
        agent.decision_engine.ai_engine.decide_time_allocation.return_value = {"total_obligated": 0.0}
    
>       result = planner.project_future(1, market_data)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_phase20_integration.py:173: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.ai.system2_planner.System2Planner object at 0x000001A4B4673250>
current_tick = 1
market_data = {'debt_data': {1: {'daily_interest_burden': 30.0}}, 'goods_market': {'basic_food_current_sell_price': 5.0}, 'housing_market': {'avg_rent_price': 50.0}}

    def project_future(self, current_tick: int, market_data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Projects future wealth and survival probability.
        Phase 20 Step 3: Includes Housing Costs (Rent/Mortgage)
        """
        # Optimization: Run only every X ticks
        if current_tick - self.last_calc_tick < self.calc_interval and self.cached_projection:
            return self.cached_projection
    
        self.last_calc_tick = current_tick
    
        # 1. Gather Inputs
        current_wealth = 0.0
        if hasattr(self.agent, 'wallet'):
            current_wealth = self.agent.wallet.get_balance(DEFAULT_CURRENCY)
        elif hasattr(self.agent, 'assets') and isinstance(self.agent.assets, dict):
            current_wealth = self.agent.assets.get(DEFAULT_CURRENCY, 0.0)
        elif hasattr(self.agent, 'assets'):
            current_wealth = float(self.agent.assets)
    
        expected_wage = getattr(self.agent, "expected_wage", 10.0)
    
        # Survival Cost
        goods_market = market_data.get("goods_market", {})
        food_price = goods_market.get("basic_food_current_sell_price", 5.0)
        daily_consumption = getattr(self.config, "HOUSEHOLD_FOOD_CONSUMPTION_PER_TICK", 2.0)
        daily_survival_cost = food_price * daily_consumption
    
        # A. Determine Work Hours (Existing)
        agent_data = self.agent.get_agent_data()
        household_ai = getattr(self.agent.decision_engine, "ai_engine", None)
        time_obligations = 0.0
    
        if household_ai and hasattr(household_ai, "decide_time_allocation"):
            spouse_data = {"id": self.agent.spouse_id} if self.agent.spouse_id else None
            c_count = len(self.agent.children_ids)
            dummy_children = [{"age": 1}] if c_count > 0 else []
            alloc = household_ai.decide_time_allocation(agent_data, spouse_data, dummy_children, self.config)
            time_obligations = alloc["total_obligated"]
    
        available_work_hours = max(0.0, 14.0 - time_obligations)
        projected_work_hours = min(8.0, available_work_hours)
    
        # C. Housing Costs Integration (Rent/Mortgage)
        housing_costs = 0.0
    
        # Scenario 1: Homeowner with Mortgage
        # We check actual daily interest burden from Bank via injected debt_data
        debt_data_map = market_data.get("debt_data", {})
        my_debt = debt_data_map.get(self.agent.id, {})
        daily_interest = my_debt.get("daily_interest_burden", 0.0)
    
        # Scenario 2: Renter (or Homeless)
        # If I don't own the home I live in, or I am homeless -> I pay rent (or should pay rent)
        # Note: If homeless, cost is 0 financially but huge utility penalty.
        # But System 2 tracks financial solvency. Homeless people might eventually rent.
        # However, strictly:
        # If agent.residing_property_id is NOT in agent.owned_properties -> Renter.
        # If agent.is_homeless -> Potential Renter (Assumed to pay rent to survive or 0)
        # Spec says: "If agent.is_homeless or no resident property: deduct avg_rent_price"
    
        is_homeowner = False
        if self.agent.residing_property_id is not None:
            if self.agent.residing_property_id in self.agent.owned_properties:
                is_homeowner = True
    
        if is_homeowner:
            housing_costs = daily_interest # Mortgage Interest
        else:
            # Renter or Homeless
            housing_market = market_data.get("housing_market", {})
            avg_rent = housing_market.get("avg_rent_price", 100.0)
            housing_costs = avg_rent
    
        # D. Expenses (Formula)
        extra_expenses = 0.0
        tech_level = getattr(self.config, "FORMULA_TECH_LEVEL", 0.0)
        if len(self.agent.children_ids) > 0:
            if tech_level > 0.5:
                extra_expenses += 5.0
    
        daily_income = expected_wage * projected_work_hours
        daily_net_flow = daily_income - daily_survival_cost - extra_expenses - housing_costs
    
        # 2. Simulation Loop
        npv_wealth = 0.0
        bankruptcy_tick = None
        simulated_wealth = current_wealth
    
        for t in range(1, self.horizon + 1):
            discount_factor = self.discount_rate ** t
            simulated_wealth += daily_net_flow
>           if simulated_wealth < 0 and bankruptcy_tick is None:
               ^^^^^^^^^^^^^^^^^^^^
E           TypeError: '<' not supported between instances of 'MagicMock' and 'int'

simulation\ai\system2_planner.py:119: TypeError
______ TestPhase23Production.test_production_boost_from_fertilizer_tech _______

self = <tests.integration.test_phase23_production.TestPhase23Production object at 0x000001A4B3728190>
config = <MagicMock id='1806917267680'>
firm_setup = <function TestPhase23Production.firm_setup.<locals>._create_firm at 0x000001A4B5C2BF60>

    def test_production_boost_from_fertilizer_tech(self, config, firm_setup):
        # 1. Create two identical firms
>       firm_A = firm_setup(1)
                 ^^^^^^^^^^^^^

tests\integration\test_phase23_production.py:60: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
tests\integration\test_phase23_production.py:35: in _create_firm
    firm = Firm(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.firms.Firm object at 0x000001A4B455EE00>
core_config = AgentCoreConfigDTO(id=1, value_orientation='PROFIT', initial_needs={}, name='Firm_1', logger=<MagicMock id='1806917267008'>, memory_interface=None)
engine = <MagicMock id='1806917266672'>, specialization = 'food'
productivity_factor = 1.0, config_dto = <MagicMock id='1806917267680'>
initial_inventory = {}, loan_market = None, sector = 'FOOD', personality = None

    def __init__(
        self,
        core_config: AgentCoreConfigDTO,
        engine: IDecisionEngine,
        specialization: str,
        productivity_factor: float,
        config_dto: FirmConfigDTO,
        initial_inventory: Optional[Dict[str, float]] = None,
        loan_market: Optional[LoanMarket] = None,
        sector: str = "FOOD",
        personality: Optional[Personality] = None,
    ) -> None:
        # Composition: Initialize Core Attributes manually (No BaseAgent)
        self._core_config = core_config
        self.decision_engine = engine
        self.id = core_config.id
        self.name = core_config.name
        self.logger = core_config.logger
        self.memory_v2 = core_config.memory_interface
        self.value_orientation = core_config.value_orientation
        self.needs = core_config.initial_needs.copy()
    
        # ICreditFrozen
        self._credit_frozen_until_tick = 0
    
        # Wallet & Inventory
        self._wallet = Wallet(self.id, {})
        self._inventory: Dict[str, float] = {} # Direct dict for IInventoryHandler
    
        self.is_active = True
    
        self.config = config_dto
    
        # State Initialization
        self.hr_state = HRState()
        self.finance_state = FinanceState()
        self.production_state = ProductionState()
        self.sales_state = SalesState()
    
        # Engine Initialization (Stateless)
        self.hr_engine = HREngine()
        self.finance_engine = FinanceEngine()
        self.production_engine = ProductionEngine()
        self.sales_engine = SalesEngine()
    
        # Initialize core attributes in State
        self.production_state.specialization = specialization
        self.production_state.sector = sector
        self.production_state.productivity_factor = productivity_factor
        self.production_state.production_target = self.config.firm_min_production_target
    
        self.finance_state.total_shares = self.config.ipo_initial_shares
        self.finance_state.treasury_shares = self.config.ipo_initial_shares # Initially all treasury
        self.finance_state.dividend_rate = self.config.dividend_rate
>       self.finance_state.profit_history = deque(maxlen=self.config.profit_history_ticks)
                                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: an integer is required

simulation\firms.py:153: TypeError
_____________ TestPortfolioIntegration.test_bank_deposit_balance ______________

self = <tests.integration.test_portfolio_integration.TestPortfolioIntegration testMethod=test_bank_deposit_balance>

    def test_bank_deposit_balance(self):
        config_manager = MagicMock()
        bank = Bank(1, 100000.0, config_manager=config_manager)
        bank.deposits = {
            "d1": MagicMock(depositor_id=1, amount=100.0),
            "d2": MagicMock(depositor_id=2, amount=200.0),
            "d3": MagicMock(depositor_id=1, amount=50.0)
        }
    
        balance = bank.get_deposit_balance(1)
>       self.assertEqual(balance, 150.0)
E       AssertionError: 0.0 != 150.0

tests\integration\test_portfolio_integration.py:64: AssertionError
------------------------------ Captured log call ------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 100000.0})
__________ TestPublicManagerIntegration.test_full_liquidation_cycle ___________

self = <tests.integration.test_public_manager_integration.TestPublicManagerIntegration object at 0x000001A4B3728690>

    def test_full_liquidation_cycle(self):
        # 1. Setup PublicManager
        config = MagicMock()
        config.LIQUIDATION_SELL_RATE = 1.0 # Sell all for test
        config.LIQUIDATION_ASK_UNDERCUT = 0.0
        # Setup GOODS config for Registry
        config.GOODS = {
            "gold": {"is_service": False, "is_essential": False}
        }
        config.RAW_MATERIAL_SECTORS = []
    
        pm = PublicManager(config)
    
        # 2. Simulate Bankruptcy Event
        event = {
            "agent_id": 99,
            "tick": 1,
            "inventory": {"gold": 10.0}
        }
        pm.process_bankruptcy_event(event)
        assert pm.managed_inventory["gold"] == 10.0
    
        # 3. Generate Liquidation Orders (Phase 4.5)
        # Mock Market Signals
        signals = {
            "gold": MarketSignalDTO(
                market_id="gold",
                item_id="gold",
                best_ask=100.0,
                best_bid=90.0,
                last_traded_price=95.0,
                last_trade_tick=1,
                price_history_7d=[],
                volatility_7d=0.0,
                order_book_depth_buy=1,
                order_book_depth_sell=1,
                is_frozen=False
            )
        }
        orders = pm.generate_liquidation_orders(signals)
        assert len(orders) == 1
        order = orders[0]
        assert order.quantity == 10.0
        assert order.price == 100.0
        assert pm.managed_inventory["gold"] == 10.0 # NOT Tentatively decremented
    
        # 4. Simulate Market Matching (Phase 2/5)
        # Assume market matched it perfectly
        buyer = MockAgent(2, assets=5000.0)
    
        tx = Transaction(
            item_id="gold",
            quantity=10.0,
            price=100.0,
            buyer_id=buyer.id,
            seller_id=-1,
            market_id="gold",
            transaction_type="goods",
            time=1
        )
    
        # 5. Execute Transaction (Phase 3)
        # Setup TransactionManager dependencies
        registry = Registry()
        accounting = MagicMock() # Mock accounting
        settlement = MagicMock() # Mock settlement (won't be used for PublicManager)
    
        tm = TransactionManager(registry, accounting, settlement, MagicMock(), config, MagicMock())
    
        # Setup State
        state = MagicMock()
        state.transactions = [tx]
        state.agents = {buyer.id: buyer}
        state.public_manager = pm
        state.market_data = {}
        state.config_module = config
        state.time = 1
    
        tm.execute(state)
    
        # 6. Verify Outcome
        # Buyer assets should decrease: 10 * 100 = 1000
        assert buyer.assets == 4000.0
    
        # PublicManager treasury should increase
>       assert pm.system_treasury == 1000.0
E       AssertionError: assert {'USD': 0.0} == 1000.0
E        +  where {'USD': 0.0} = <modules.system.execution.public_manager.PublicManager object at 0x000001A4B5E86E40>.system_treasury

tests\integration\test_public_manager_integration.py:112: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  PublicManager:public_manager.py:79 Processing bankruptcy for Agent 99 at tick 1. Recovering inventory.
INFO     PublicManager:public_manager.py:87 Recovered 10.0 of gold.
INFO     PublicManager:public_manager.py:159 Generated liquidation order for 10.0 of gold at 100.0.
ERROR    simulation.systems.transaction_manager:transaction_manager.py:87 PUBLIC_MANAGER transaction failed: argument of type 'float' is not iterable
_______________ test_settlement_scenario_1_standard_inheritance _______________

settlement_system = <simulation.systems.settlement_system.SettlementSystem object at 0x000001A4B46CE850>
golden_households = [namespace(id=101, assets=1000.0, is_active=True, is_employed=True, employer_id=100, age=25, education_level=1.0, curr...{}, approval_rating=0.8, make_decision=<MagicMock id='1806937655680'>, decision_engine=<MagicMock id='1806937655344'>)]
government = <simulation.agents.government.Government object at 0x000001A4B34CD6D0>

    def test_settlement_scenario_1_standard_inheritance(settlement_system, golden_households, government):
        if not golden_households:
            pytest.skip("No golden households found. Please generate fixtures.")
    
        deceased = golden_households[0]
        heir = golden_households[1] if len(golden_households) > 1 else golden_households[0]
    
        # Setup Deceased Agent
        deceased.id = 101
        deceased.assets = 1000.0
    
        portfolio_dto = PortfolioDTO(assets=[
            PortfolioAsset(asset_type="stock", asset_id="999", quantity=10.0)
        ])
    
        # Setup Heir
        heir.id = 102
        heir.get_portfolio = MagicMock() # Required for IPortfolioHandler check
        heir.clear_portfolio = MagicMock() # Required for IPortfolioHandler check
        heir.receive_portfolio = MagicMock()
        heir.deposit = MagicMock()
    
        # Patch Deceased
        deceased.get_portfolio = MagicMock(return_value=portfolio_dto)
        deceased.clear_portfolio = MagicMock()
        deceased.receive_portfolio = MagicMock() # Required for IPortfolioHandler check
        deceased.get_heir = MagicMock(return_value=heir.id)
        deceased.withdraw = MagicMock()
        # SimpleNamespace has assets attribute, so mocking withdraw is enough if SettlementSystem reads .assets
    
        # Run Create
>       account = settlement_system.create_settlement(deceased, tick=100)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_settlement_system_atomic.py:40: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.systems.settlement_system.SettlementSystem object at 0x000001A4B46CE850>
agent = namespace(id=101, assets=1000.0, is_active=True, is_employed=True, employer_id=100, age=25, education_level=1.0, curre...folio=<MagicMock id='1806913361232'>, get_heir=<MagicMock id='1806913368288'>, withdraw=<MagicMock id='1806913359552'>)
tick = 100

    def create_settlement(
        self,
        agent: Any, # IPortfolioHandler & IHeirProvider & IFinancialEntity
        tick: int
    ) -> LegacySettlementAccount:
        """
        TD-160: Initiates the settlement process by creating an escrow account.
        Atomically transfers all assets (Cash + Portfolio) from the agent to the escrow.
        """
        agent_id = agent.id
    
        # 1. Atomic Transfer: Portfolio
        if isinstance(agent, IPortfolioHandler):
            portfolio_dto = agent.get_portfolio()
            agent.clear_portfolio()
        else:
            # Fallback for non-compliant agents (should not happen with new Households)
            portfolio_dto = PortfolioDTO(assets=[])
            self.logger.warning(f"Agent {agent_id} does not implement IPortfolioHandler. Portfolio not captured.")
    
        # 2. Atomic Transfer: Cash
        # IFinancialAgent protocol enforcement (was agent.assets)
>       cash_balance = agent.get_balance(DEFAULT_CURRENCY)
                       ^^^^^^^^^^^^^^^^^
E       AttributeError: 'types.SimpleNamespace' object has no attribute 'get_balance'

simulation\systems\settlement_system.py:59: AttributeError
----------------------------- Captured log setup ------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
___________________ test_settlement_scenario_2_escheatment ____________________

settlement_system = <simulation.systems.settlement_system.SettlementSystem object at 0x000001A4B46CEA50>
golden_households = [namespace(id=201, assets=1000.0, is_active=True, is_employed=True, employer_id=100, age=25, education_level=1.0, curr...{}, approval_rating=0.8, make_decision=<MagicMock id='1806913366944'>, decision_engine=<MagicMock id='1806913365936'>)]
government = <simulation.agents.government.Government object at 0x000001A4B3728410>

    def test_settlement_scenario_2_escheatment(settlement_system, golden_households, government):
        if not golden_households:
            pytest.skip("No golden households found")
    
        deceased = golden_households[0]
        deceased.id = 201
        deceased.assets = 1000.0
    
        portfolio_dto = PortfolioDTO(assets=[
            PortfolioAsset(asset_type="stock", asset_id="123", quantity=50.0)
        ])
    
        deceased.get_portfolio = MagicMock(return_value=portfolio_dto)
        deceased.clear_portfolio = MagicMock()
        deceased.receive_portfolio = MagicMock() # Required for IPortfolioHandler check
        deceased.get_heir = MagicMock(return_value=None) # No heir
        deceased.withdraw = MagicMock()
    
        # Mock Government behavior (spy/mock)
        # Government fixture is a real object with mocked deps.
        # We want to verify it receives portfolio.
        # Government implements receive_portfolio (which adds to self.portfolio).
        # We can check self.portfolio after.
        # But government in fixture has id=1.
        government.id = 1
        # Clear gov portfolio first
        government.portfolio.holdings.clear()
    
        # Run Create
>       account = settlement_system.create_settlement(deceased, tick=200)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_settlement_system_atomic.py:95: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.systems.settlement_system.SettlementSystem object at 0x000001A4B46CEA50>
agent = namespace(id=201, assets=1000.0, is_active=True, is_employed=True, employer_id=100, age=25, education_level=1.0, curre...folio=<MagicMock id='1806916108704'>, get_heir=<MagicMock id='1806916109712'>, withdraw=<MagicMock id='1806916108368'>)
tick = 200

    def create_settlement(
        self,
        agent: Any, # IPortfolioHandler & IHeirProvider & IFinancialEntity
        tick: int
    ) -> LegacySettlementAccount:
        """
        TD-160: Initiates the settlement process by creating an escrow account.
        Atomically transfers all assets (Cash + Portfolio) from the agent to the escrow.
        """
        agent_id = agent.id
    
        # 1. Atomic Transfer: Portfolio
        if isinstance(agent, IPortfolioHandler):
            portfolio_dto = agent.get_portfolio()
            agent.clear_portfolio()
        else:
            # Fallback for non-compliant agents (should not happen with new Households)
            portfolio_dto = PortfolioDTO(assets=[])
            self.logger.warning(f"Agent {agent_id} does not implement IPortfolioHandler. Portfolio not captured.")
    
        # 2. Atomic Transfer: Cash
        # IFinancialAgent protocol enforcement (was agent.assets)
>       cash_balance = agent.get_balance(DEFAULT_CURRENCY)
                       ^^^^^^^^^^^^^^^^^
E       AttributeError: 'types.SimpleNamespace' object has no attribute 'get_balance'

simulation\systems\settlement_system.py:59: AttributeError
----------------------------- Captured log setup ------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
____________________ test_settlement_scenario_3_insolvency ____________________

settlement_system = <simulation.systems.settlement_system.SettlementSystem object at 0x000001A4B4779220>
golden_households = [namespace(id=301, assets=100.0, is_active=True, is_employed=True, employer_id=100, age=25, education_level=1.0, curre...{}, approval_rating=0.8, make_decision=<MagicMock id='1806915401920'>, decision_engine=<MagicMock id='1806915396880'>)]
government = <simulation.agents.government.Government object at 0x000001A4B479FED0>

    def test_settlement_scenario_3_insolvency(settlement_system, golden_households, government):
        if not golden_households:
            pytest.skip("No golden households found")
    
        deceased = golden_households[0]
        deceased.id = 301
        deceased.assets = 100.0 # Only 100 cash
    
        portfolio_dto = PortfolioDTO(assets=[])
    
        deceased.get_portfolio = MagicMock(return_value=portfolio_dto)
        deceased.clear_portfolio = MagicMock()
        deceased.receive_portfolio = MagicMock() # Required for IPortfolioHandler check
        deceased.get_heir = MagicMock(return_value=None)
        deceased.withdraw = MagicMock()
    
>       account = settlement_system.create_settlement(deceased, tick=300)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_settlement_system_atomic.py:136: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.systems.settlement_system.SettlementSystem object at 0x000001A4B4779220>
agent = namespace(id=301, assets=100.0, is_active=True, is_employed=True, employer_id=100, age=25, education_level=1.0, curren...folio=<MagicMock id='1806915191872'>, get_heir=<MagicMock id='1806915196912'>, withdraw=<MagicMock id='1806915193552'>)
tick = 300

    def create_settlement(
        self,
        agent: Any, # IPortfolioHandler & IHeirProvider & IFinancialEntity
        tick: int
    ) -> LegacySettlementAccount:
        """
        TD-160: Initiates the settlement process by creating an escrow account.
        Atomically transfers all assets (Cash + Portfolio) from the agent to the escrow.
        """
        agent_id = agent.id
    
        # 1. Atomic Transfer: Portfolio
        if isinstance(agent, IPortfolioHandler):
            portfolio_dto = agent.get_portfolio()
            agent.clear_portfolio()
        else:
            # Fallback for non-compliant agents (should not happen with new Households)
            portfolio_dto = PortfolioDTO(assets=[])
            self.logger.warning(f"Agent {agent_id} does not implement IPortfolioHandler. Portfolio not captured.")
    
        # 2. Atomic Transfer: Cash
        # IFinancialAgent protocol enforcement (was agent.assets)
>       cash_balance = agent.get_balance(DEFAULT_CURRENCY)
                       ^^^^^^^^^^^^^^^^^
E       AttributeError: 'types.SimpleNamespace' object has no attribute 'get_balance'

simulation\systems\settlement_system.py:59: AttributeError
----------------------------- Captured log setup ------------------------------
INFO     simulation.agents.government:government.py:152 Government 1 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
_____________ TestTickNormalization.test_run_tick_executes_phases _____________

self = <tests.integration.test_tick_normalization.TestTickNormalization object at 0x000001A4B3729310>
orchestrator = <simulation.orchestration.tick_orchestrator.TickOrchestrator object at 0x000001A4B497D160>
mock_world_state = <MagicMock id='1806915203296'>

    def test_run_tick_executes_phases(self, orchestrator, mock_world_state):
        # Act
>       orchestrator.run_tick()

tests\integration\test_tick_normalization.py:123: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.orchestration.tick_orchestrator.TickOrchestrator object at 0x000001A4B497D160>
injectable_sensory_dto = None

    def run_tick(self, injectable_sensory_dto: Optional[GovernmentSensoryDTO] = None) -> None:
        state = self.world_state
    
        # Money Supply Verification (Tick 0)
        # This check is usually done before any activity starts
        if state.time == 0:
            # Ensure currency_holders is correct before baseline calculation
            # TD-030: Removed _rebuild_currency_holders. Initializer populates this.
            # self._rebuild_currency_holders(state)
>           state.baseline_money_supply = state.calculate_total_money().get(DEFAULT_CURRENCY, 0.0)
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'float' object has no attribute 'get'

simulation\orchestration\tick_orchestrator.py:61: AttributeError
_____________ test_household_update_political_opinion_integration _____________

    def test_household_update_political_opinion_integration():
        # 1. Setup Mock Household
        # Minimal config
        config = MagicMock(spec=HouseholdConfigDTO)
        config.initial_household_age_range = (20, 40)
        config.value_orientation_mapping = {}
        config.ticks_per_year = 100
        config.wage_memory_length = 10
        config.price_memory_length = 10
        config.adaptation_rate_normal = 0.1
        config.adaptation_rate_impulsive = 0.2
        config.adaptation_rate_conservative = 0.05
        config.initial_aptitude_distribution = (0.5, 0.1)
        config.conformity_ranges = {}
        config.initial_household_assets_mean = 1000
        config.quality_pref_snob_min = 0.8
        config.quality_pref_miser_max = 0.2
        config.base_desire_growth = 1.0
        config.max_desire_value = 100.0
        config.survival_need_death_threshold = 200.0
        config.social_status_asset_weight = 0.5
        config.social_status_luxury_weight = 0.5
        config.leisure_coeffs = {}
        config.distress_grace_period_ticks = 10
        config.elasticity_mapping = {}
    
        mock_decision_engine = MagicMock()
    
>       household = Household(
            id=1,
            talent=MagicMock(),
            goods_data=[],
            initial_assets=1000.0,
            initial_needs={"survival": 0.0},
            decision_engine=mock_decision_engine,
            value_orientation="Survival",
            personality=Personality.GROWTH_ORIENTED,
            config_dto=config
        )
E       TypeError: Household.__init__() missing 2 required positional arguments: 'core_config' and 'engine'

tests\modules\household\test_political_integration.py:36: TypeError
___________________________ test_run_tick_defaults ____________________________

bank = <simulation.bank.Bank object at 0x000001A4B464FA80>

    def test_run_tick_defaults(bank):
        # Setup
        agent = MockAgent(101)
        agents = {101: agent}
    
        # Mock loan manager to return a default event
        bank.loan_manager.service_loans = MagicMock(return_value=[
            {'type': 'default', 'loan_id': 'loan_1', 'borrower_id': 101, 'amount_defaulted': 500.0}
        ])
    
        # Execute
        txs = bank.run_tick(agents, current_tick=10)
    
        # Verify
        assert len(txs) > 0
        # Check for credit destruction
        assert any(tx.transaction_type == 'credit_destruction' for tx in txs)
    
        # Check Protocol interactions
        # 1. ICreditFrozen: Should be set to > 10
>       assert agent.credit_frozen_until_tick > 10
E       assert 0 > 10
E        +  where 0 = <test_bank_decomposition.MockAgent object at 0x000001A4B497CAD0>.credit_frozen_until_tick

tests\simulation\test_bank_decomposition.py:109: AssertionError
----------------------------- Captured log setup ------------------------------
INFO     simulation.bank:bank.py:91 Bank 1 initialized. Assets: defaultdict(<class 'float'>, {'USD': 10000.0})
------------------------------ Captured log call ------------------------------
WARNING  simulation.bank:bank.py:491 Bank: EventBus not injected. Loan default consequences (penalties, seizure) skipped.
______________ TestPhase29Depression.test_crisis_monitor_logging ______________

self = <test_phase29_depression.TestPhase29Depression testMethod=test_crisis_monitor_logging>

    def setUp(self):
        # Setup Logger
        self.logger = logging.getLogger("TestPhase29")
        logging.basicConfig(level=logging.INFO)
    
        # Setup ConfigManager with Mock Config
        self.config_manager = MagicMock(spec=ConfigManager)
        # Mocking get method to return appropriate values
        def config_get_side_effect(key, default=None):
            if key == "bank_defaults.initial_base_annual_rate":
                return 0.05
            if key == "simulation.household_consumable_goods":
                return ["food", "electronics"]
            return default
        self.config_manager.get.side_effect = config_get_side_effect
    
        self.config_module = MagicMock()
    
        # Configure Mock using configure_mock to ensure attributes are set correctly
        self.config_module.configure_mock(
            GOODS={"food": {"initial_price": 10}, "electronics": {"initial_price": 50}},
            INITIAL_BANK_ASSETS=1000000,
            INITIAL_MONEY_SUPPLY=1000000, # Explicitly set here too, but will enforce below
            INITIAL_PROPERTY_VALUE=10000,
            INITIAL_RENT_PRICE=100,
            NUM_HOUSING_UNITS=10,
            LABOR_MARKET_MIN_WAGE=10,
            MAX_WORK_HOURS=12,
            IMITATION_LEARNING_INTERVAL=10,
            SIMULATION_TICK_LIMIT=100,
            DEFAULT_INFLATION_RATE=0.02,
            SHOPPING_HOURS=2,
            HOURS_PER_TICK=24,
            INFRASTRUCTURE_TFP_BOOST=0.05,
            CRITICAL_CARBS_LEVEL=10,
            CRITICAL_PROTEIN_LEVEL=10,
            CRITICAL_FAT_LEVEL=10,
            DAILY_CARBS_NEED=2,
            DAILY_PROTEIN_NEED=2,
            DAILY_FAT_NEED=2,
            SURVIVAL_DAILY_CALORIES=50,
            MACRO_PORTFOLIO_ADJUSTMENT_ENABLED=False,
            STOCK_MARKET_ENABLED=False,
            ENABLE_VANITY_SYSTEM=False,
            PRODUCTION_TAX_RATE=0.1,
            SALES_TAX_RATE=0.1,
            INCOME_TAX_RATE=0.1,
            CORPORATE_TAX_RATE=0.2,
            BANK_DEFAULTS_RATE=0.05,
            INITIAL_BASE_ANNUAL_RATE=0.05,
            CB_UPDATE_INTERVAL=10,
            CB_INFLATION_TARGET=0.02,
            CB_TAYLOR_ALPHA=1.5,
            CB_TAYLOR_BETA=0.5,
            CB_NEUTRAL_RATE=0.02,
            MIN_BASE_RATE=0.0,
            MAX_BASE_RATE=0.2,
            HOUSEHOLD_FOOD_CONSUMPTION_PER_TICK=1.0,
            GOODS_INITIAL_PRICE={"basic_food": 5.0},
            ANNUAL_WEALTH_TAX_RATE=0.02,
            TICKS_PER_YEAR=100.0,
            WEALTH_TAX_THRESHOLD=50000.0,
            UNEMPLOYMENT_BENEFIT_RATIO=0.8,
            QE_INTERVENTION_YIELD_THRESHOLD=0.10,
            DEBT_RISK_PREMIUM_TIERS={1.2: 0.05, 0.9: 0.02, 0.6: 0.005},
            BOND_MATURITY_TICKS=400,
            SURVIVAL_NEED_DEATH_THRESHOLD=100.0,
            SURVIVAL_NEED_CONSUMPTION_THRESHOLD=50.0,
            FOOD_CONSUMPTION_QUANTITY=1.0,
            FOOD_PURCHASE_MAX_PER_TICK=5.0,
            MAINTENANCE_RATE_PER_TICK=0.001,
            CHILD_MONTHLY_COST=500.0,
            OPPORTUNITY_COST_FACTOR=0.3,
            CHILD_EMOTIONAL_VALUE_BASE=500000.0,
            TECH_CONTRACEPTION_ENABLED=True,
            BIOLOGICAL_FERTILITY_RATE=0.15,
            POPULATION_IMMIGRATION_THRESHOLD=80,
            INFRASTRUCTURE_INVESTMENT_COST=5000.0,
            REPRODUCTION_AGE_START=200, # Prevent births
            REPRODUCTION_AGE_END=45,
            BANKRUPTCY_LOSS_THRESHOLD=10,
            MA_ENABLED=True,
            HOSTILE_TAKEOVER_DISCOUNT_THRESHOLD=0.7,
            MITOSIS_MUTATION_PROBABILITY=0.1,
            INFLATION_MEMORY_WINDOW=10,
            PUBLIC_EDU_BUDGET_RATIO=0.20,
            CONFORMITY_RANGES={},
            INITIAL_HOUSEHOLD_ASSETS_MEAN=1000.0,
            EDUCATION_COST_PER_LEVEL={1: 500},
            SCHOLARSHIP_WEALTH_PERCENTILE=0.20,
            SCHOLARSHIP_POTENTIAL_THRESHOLD=0.7,
            LIQUIDITY_NEED_INCREASE_RATE=1.0,
            ASSETS_CLOSURE_THRESHOLD=0.0,
            FIRM_CLOSURE_TURNS_THRESHOLD=5
        )
    
        # Create dummy agents
        self.households = [MagicMock(spec=Household) for _ in range(5)]
        for i, h in enumerate(self.households):
            h.id = i
            h._bio_state = MagicMock() # Needs explicit sub-mock with spec
            h._econ_state = MagicMock()
            h._social_state = MagicMock()
            h._bio_state.is_active = True
            h._econ_state.employer_id = None
            h._econ_state.is_employed = False
            h._bio_state.age = 25
            h.age = 25  # Explicitly set property
            h.income = 100
            h._econ_state.current_consumption = 0.0
            h._econ_state.current_food_consumption = 0.0
            h._econ_state.labor_income_this_tick = 0.0
            h._econ_state.education_level = 1.0
            h._econ_state.aptitude = 0.5
            h._econ_state.current_wage = 10.0
            h.current_wage = 10.0
            h._bio_state.children_ids = []
            h.children_ids = []
            h._bio_state.needs = {"survival": 0.5}
            h._assets = 1000
            h.assets = 1000.0
            h._econ_state.assets = 1000 # Explicitly set property for sorting
            h.decision_engine = MagicMock()
            h.decision_engine.ai_engine = MagicMock()
            # make_decision must return (orders, action_vector)
            mock_action_vector = MagicMock()
            mock_action_vector.work_aggressiveness = 0.5
            h.make_decision.return_value = ([], mock_action_vector)
            h._econ_state.inventory = {}
            h._econ_state.owned_properties = []
            h._econ_state.residing_property_id = None
            h._social_state.approval_rating = 1.0
    
        self.firms = [MagicMock(spec=Firm) for _ in range(5)]
        for i, f in enumerate(self.firms):
            f.id = 100 + i
            f.type = "ConsumerGoodFirm"
            f.sector = "consumer_goods"
            f.specialization = "food" if i % 2 == 0 else "electronics"
            f.is_active = True
            f.age = 0
            f._assets = 5000
            f.assets = 5000 # Explicitly set property
            f.current_profit = 100
            f.consecutive_loss_turns = 0
            f.valuation = 5000.0
            f.get_market_cap.return_value = 5000.0
            f.current_production = 0.0
            f.sales_volume_this_tick = 0.0
            f.inventory = {"food": 0.0, "electronics": 0.0}
            f.retained_earnings = 1000.0
            f.total_debt = 0.0
            f.decision_engine = MagicMock()
            f.decision_engine.ai_engine = MagicMock()
            # make_decision must return (orders, action_vector)
            f.make_decision.return_value = ([], MagicMock())
            f.inventory = {f.specialization: 10}
            f.needs = {"liquidity_need": 0.0} # Needs initialization
            f.price = 10
            f.productivity_factor = 1.0
            f.hr = MagicMock()
            f.hr.employees = []
    
            # Phase 29 Refinement: Mock FinanceDepartment
            f.finance = MagicMock()
            f.finance.balance = 5000.0  # Initialize balance (fix for Bootstrapper)
            f.finance.consecutive_loss_turns = 0
            f.finance.current_profit = 100.0
            f.finance.calculate_altman_z_score.return_value = 3.0
            f.finance.calculate_valuation.return_value = 5000.0
            f.finance.get_inventory_value.return_value = 0.0
            f.finance.check_cash_crunch.return_value = False
    
            # Phase 29 Refinement: Mock get_financial_snapshot
            f.get_financial_snapshot.return_value = {
                "total_assets": 5500.0,
                "working_capital": 5500.0,
                "retained_earnings": 1000.0,
                "average_profit": 100.0,
                "total_debt": 0.0
            }
    
        self.repository = MagicMock(spec=SimulationRepository)
        self.repository.runs = MagicMock()
        self.repository.analytics = MagicMock()
        self.repository.agents = MagicMock()
        self.repository.runs.save_simulation_run.return_value = "test_run"
        self.ai_trainer = MagicMock(spec=AIEngineRegistry)
    
        # Create Initializer
        self.initializer = SimulationInitializer(
            config_manager=self.config_manager,
            config_module=self.config_module,
            goods_data=[{"id": "food", "name": "food"}, {"id": "electronics", "name": "electronics"}],
            repository=self.repository,
            logger=self.logger,
            households=self.households,
            firms=self.firms,
            ai_trainer=self.ai_trainer
        )
    
        # Build Simulation
>       self.sim = self.initializer.build_simulation()
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\system\test_phase29_depression.py:218: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\initialization\initializer.py:333: in build_simulation
    top_households = sorted(sim.households, key=lambda h: h._econ_state.assets.get(DEFAULT_CURRENCY, 0.0), reverse=True)[:top_20_count]
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

h = <MagicMock spec='Household' id='1806933952560'>

>   top_households = sorted(sim.households, key=lambda h: h._econ_state.assets.get(DEFAULT_CURRENCY, 0.0), reverse=True)[:top_20_count]
                                                          ^^^^^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'int' object has no attribute 'get'

simulation\initialization\initializer.py:333: AttributeError
------------------------------ Captured log call ------------------------------
INFO     TestPhase29:initializer.py:134 Acquired exclusive lock on simulation.lock
INFO     simulation.agents.central_bank:central_bank.py:49 CENTRAL_BANK_INIT | Rate: 5.00%, Target Infl: 2.00%
INFO     TestPhase29:initializer.py:269 GENESIS | Central Bank minted M0: 1,000,000.00
INFO     simulation.bank:bank.py:91 Bank 10 initialized. Assets: defaultdict(<class 'float'>, {'USD': 0.0})
INFO     simulation.agents.government:government.py:152 Government 11 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
___________ TestPhase29Depression.test_depression_scenario_triggers ___________

self = <test_phase29_depression.TestPhase29Depression testMethod=test_depression_scenario_triggers>

    def setUp(self):
        # Setup Logger
        self.logger = logging.getLogger("TestPhase29")
        logging.basicConfig(level=logging.INFO)
    
        # Setup ConfigManager with Mock Config
        self.config_manager = MagicMock(spec=ConfigManager)
        # Mocking get method to return appropriate values
        def config_get_side_effect(key, default=None):
            if key == "bank_defaults.initial_base_annual_rate":
                return 0.05
            if key == "simulation.household_consumable_goods":
                return ["food", "electronics"]
            return default
        self.config_manager.get.side_effect = config_get_side_effect
    
        self.config_module = MagicMock()
    
        # Configure Mock using configure_mock to ensure attributes are set correctly
        self.config_module.configure_mock(
            GOODS={"food": {"initial_price": 10}, "electronics": {"initial_price": 50}},
            INITIAL_BANK_ASSETS=1000000,
            INITIAL_MONEY_SUPPLY=1000000, # Explicitly set here too, but will enforce below
            INITIAL_PROPERTY_VALUE=10000,
            INITIAL_RENT_PRICE=100,
            NUM_HOUSING_UNITS=10,
            LABOR_MARKET_MIN_WAGE=10,
            MAX_WORK_HOURS=12,
            IMITATION_LEARNING_INTERVAL=10,
            SIMULATION_TICK_LIMIT=100,
            DEFAULT_INFLATION_RATE=0.02,
            SHOPPING_HOURS=2,
            HOURS_PER_TICK=24,
            INFRASTRUCTURE_TFP_BOOST=0.05,
            CRITICAL_CARBS_LEVEL=10,
            CRITICAL_PROTEIN_LEVEL=10,
            CRITICAL_FAT_LEVEL=10,
            DAILY_CARBS_NEED=2,
            DAILY_PROTEIN_NEED=2,
            DAILY_FAT_NEED=2,
            SURVIVAL_DAILY_CALORIES=50,
            MACRO_PORTFOLIO_ADJUSTMENT_ENABLED=False,
            STOCK_MARKET_ENABLED=False,
            ENABLE_VANITY_SYSTEM=False,
            PRODUCTION_TAX_RATE=0.1,
            SALES_TAX_RATE=0.1,
            INCOME_TAX_RATE=0.1,
            CORPORATE_TAX_RATE=0.2,
            BANK_DEFAULTS_RATE=0.05,
            INITIAL_BASE_ANNUAL_RATE=0.05,
            CB_UPDATE_INTERVAL=10,
            CB_INFLATION_TARGET=0.02,
            CB_TAYLOR_ALPHA=1.5,
            CB_TAYLOR_BETA=0.5,
            CB_NEUTRAL_RATE=0.02,
            MIN_BASE_RATE=0.0,
            MAX_BASE_RATE=0.2,
            HOUSEHOLD_FOOD_CONSUMPTION_PER_TICK=1.0,
            GOODS_INITIAL_PRICE={"basic_food": 5.0},
            ANNUAL_WEALTH_TAX_RATE=0.02,
            TICKS_PER_YEAR=100.0,
            WEALTH_TAX_THRESHOLD=50000.0,
            UNEMPLOYMENT_BENEFIT_RATIO=0.8,
            QE_INTERVENTION_YIELD_THRESHOLD=0.10,
            DEBT_RISK_PREMIUM_TIERS={1.2: 0.05, 0.9: 0.02, 0.6: 0.005},
            BOND_MATURITY_TICKS=400,
            SURVIVAL_NEED_DEATH_THRESHOLD=100.0,
            SURVIVAL_NEED_CONSUMPTION_THRESHOLD=50.0,
            FOOD_CONSUMPTION_QUANTITY=1.0,
            FOOD_PURCHASE_MAX_PER_TICK=5.0,
            MAINTENANCE_RATE_PER_TICK=0.001,
            CHILD_MONTHLY_COST=500.0,
            OPPORTUNITY_COST_FACTOR=0.3,
            CHILD_EMOTIONAL_VALUE_BASE=500000.0,
            TECH_CONTRACEPTION_ENABLED=True,
            BIOLOGICAL_FERTILITY_RATE=0.15,
            POPULATION_IMMIGRATION_THRESHOLD=80,
            INFRASTRUCTURE_INVESTMENT_COST=5000.0,
            REPRODUCTION_AGE_START=200, # Prevent births
            REPRODUCTION_AGE_END=45,
            BANKRUPTCY_LOSS_THRESHOLD=10,
            MA_ENABLED=True,
            HOSTILE_TAKEOVER_DISCOUNT_THRESHOLD=0.7,
            MITOSIS_MUTATION_PROBABILITY=0.1,
            INFLATION_MEMORY_WINDOW=10,
            PUBLIC_EDU_BUDGET_RATIO=0.20,
            CONFORMITY_RANGES={},
            INITIAL_HOUSEHOLD_ASSETS_MEAN=1000.0,
            EDUCATION_COST_PER_LEVEL={1: 500},
            SCHOLARSHIP_WEALTH_PERCENTILE=0.20,
            SCHOLARSHIP_POTENTIAL_THRESHOLD=0.7,
            LIQUIDITY_NEED_INCREASE_RATE=1.0,
            ASSETS_CLOSURE_THRESHOLD=0.0,
            FIRM_CLOSURE_TURNS_THRESHOLD=5
        )
    
        # Create dummy agents
        self.households = [MagicMock(spec=Household) for _ in range(5)]
        for i, h in enumerate(self.households):
            h.id = i
            h._bio_state = MagicMock() # Needs explicit sub-mock with spec
            h._econ_state = MagicMock()
            h._social_state = MagicMock()
            h._bio_state.is_active = True
            h._econ_state.employer_id = None
            h._econ_state.is_employed = False
            h._bio_state.age = 25
            h.age = 25  # Explicitly set property
            h.income = 100
            h._econ_state.current_consumption = 0.0
            h._econ_state.current_food_consumption = 0.0
            h._econ_state.labor_income_this_tick = 0.0
            h._econ_state.education_level = 1.0
            h._econ_state.aptitude = 0.5
            h._econ_state.current_wage = 10.0
            h.current_wage = 10.0
            h._bio_state.children_ids = []
            h.children_ids = []
            h._bio_state.needs = {"survival": 0.5}
            h._assets = 1000
            h.assets = 1000.0
            h._econ_state.assets = 1000 # Explicitly set property for sorting
            h.decision_engine = MagicMock()
            h.decision_engine.ai_engine = MagicMock()
            # make_decision must return (orders, action_vector)
            mock_action_vector = MagicMock()
            mock_action_vector.work_aggressiveness = 0.5
            h.make_decision.return_value = ([], mock_action_vector)
            h._econ_state.inventory = {}
            h._econ_state.owned_properties = []
            h._econ_state.residing_property_id = None
            h._social_state.approval_rating = 1.0
    
        self.firms = [MagicMock(spec=Firm) for _ in range(5)]
        for i, f in enumerate(self.firms):
            f.id = 100 + i
            f.type = "ConsumerGoodFirm"
            f.sector = "consumer_goods"
            f.specialization = "food" if i % 2 == 0 else "electronics"
            f.is_active = True
            f.age = 0
            f._assets = 5000
            f.assets = 5000 # Explicitly set property
            f.current_profit = 100
            f.consecutive_loss_turns = 0
            f.valuation = 5000.0
            f.get_market_cap.return_value = 5000.0
            f.current_production = 0.0
            f.sales_volume_this_tick = 0.0
            f.inventory = {"food": 0.0, "electronics": 0.0}
            f.retained_earnings = 1000.0
            f.total_debt = 0.0
            f.decision_engine = MagicMock()
            f.decision_engine.ai_engine = MagicMock()
            # make_decision must return (orders, action_vector)
            f.make_decision.return_value = ([], MagicMock())
            f.inventory = {f.specialization: 10}
            f.needs = {"liquidity_need": 0.0} # Needs initialization
            f.price = 10
            f.productivity_factor = 1.0
            f.hr = MagicMock()
            f.hr.employees = []
    
            # Phase 29 Refinement: Mock FinanceDepartment
            f.finance = MagicMock()
            f.finance.balance = 5000.0  # Initialize balance (fix for Bootstrapper)
            f.finance.consecutive_loss_turns = 0
            f.finance.current_profit = 100.0
            f.finance.calculate_altman_z_score.return_value = 3.0
            f.finance.calculate_valuation.return_value = 5000.0
            f.finance.get_inventory_value.return_value = 0.0
            f.finance.check_cash_crunch.return_value = False
    
            # Phase 29 Refinement: Mock get_financial_snapshot
            f.get_financial_snapshot.return_value = {
                "total_assets": 5500.0,
                "working_capital": 5500.0,
                "retained_earnings": 1000.0,
                "average_profit": 100.0,
                "total_debt": 0.0
            }
    
        self.repository = MagicMock(spec=SimulationRepository)
        self.repository.runs = MagicMock()
        self.repository.analytics = MagicMock()
        self.repository.agents = MagicMock()
        self.repository.runs.save_simulation_run.return_value = "test_run"
        self.ai_trainer = MagicMock(spec=AIEngineRegistry)
    
        # Create Initializer
        self.initializer = SimulationInitializer(
            config_manager=self.config_manager,
            config_module=self.config_module,
            goods_data=[{"id": "food", "name": "food"}, {"id": "electronics", "name": "electronics"}],
            repository=self.repository,
            logger=self.logger,
            households=self.households,
            firms=self.firms,
            ai_trainer=self.ai_trainer
        )
    
        # Build Simulation
>       self.sim = self.initializer.build_simulation()
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\system\test_phase29_depression.py:218: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\initialization\initializer.py:333: in build_simulation
    top_households = sorted(sim.households, key=lambda h: h._econ_state.assets.get(DEFAULT_CURRENCY, 0.0), reverse=True)[:top_20_count]
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

h = <MagicMock spec='Household' id='1806913360560'>

>   top_households = sorted(sim.households, key=lambda h: h._econ_state.assets.get(DEFAULT_CURRENCY, 0.0), reverse=True)[:top_20_count]
                                                          ^^^^^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'int' object has no attribute 'get'

simulation\initialization\initializer.py:333: AttributeError
------------------------------ Captured log call ------------------------------
INFO     TestPhase29:initializer.py:134 Acquired exclusive lock on simulation.lock
INFO     simulation.agents.central_bank:central_bank.py:49 CENTRAL_BANK_INIT | Rate: 5.00%, Target Infl: 2.00%
INFO     TestPhase29:initializer.py:269 GENESIS | Central Bank minted M0: 1,000,000.00
INFO     simulation.bank:bank.py:91 Bank 10 initialized. Assets: defaultdict(<class 'float'>, {'USD': 0.0})
INFO     simulation.agents.government:government.py:152 Government 11 initialized with assets: defaultdict(<class 'float'>, {'USD': 0.0})
__________________ test_housing_handler_with_protocol_agent ___________________

    def test_housing_handler_with_protocol_agent():
        # Setup
        handler = HousingTransactionHandler()
    
        buyer = MockAgent(id=101)
        # Ensure buyer implements protocols (runtime check)
        assert isinstance(buyer, IMortgageBorrower)
        assert isinstance(buyer, IPropertyOwner)
        assert isinstance(buyer, IResident)
    
        seller = MockAgent(id=102)
        seller.add_property(999)
    
        # Context mocks
        context = MagicMock()
        context.time = 1
    
        # Escrow Agent
        escrow = EscrowAgent(id=9999)
        context.agents = {
            101: buyer,
            102: seller,
            9999: escrow
        }
    
        # Unit
        unit = MagicMock()
        unit.id = 999
        unit.liens = []
        context.real_estate_units = [unit]
    
        # Config
        context.config_module.housing = {"max_ltv_ratio": 0.8, "mortgage_term_ticks": 300}
        context.config_module.MORTGAGE_INTEREST_RATE = 0.05
        context.config_module.WORK_HOURS_PER_DAY = 8.0
        context.config_module.TICKS_PER_YEAR = 100.0
    
        # Bank
        context.bank = MagicMock()
        context.bank.grant_loan.return_value = ({"loan_id": "loan_1"}, MagicMock())
        context.bank.withdraw_for_customer.return_value = True
        context.bank.id = 8888
    
        # Settlement
        context.settlement_system.transfer.return_value = True
    
        # Transaction
        tx = Transaction(
            buyer_id=101,
            seller_id=102,
            item_id="unit_999",
            quantity=1,
            price=1000.0,
            market_id="housing_market",
            transaction_type="housing",
            time=1,
            metadata={}
        )
    
        # Execute
        result = handler.handle(tx, buyer, seller, context)
    
        # Verify
>       assert result is True
E       assert False is True

tests\test_wo_4_1_protocols.py:89: AssertionError
___________________________ test_websocket_endpoint ___________________________

    def test_websocket_endpoint():
        with patch("server.create_simulation") as mock_create:
            sim_instance = MagicMock()
            mock_create.return_value = sim_instance
    
            # Mock world state and components
            world_state = MagicMock()
            sim_instance.world_state = world_state
            sim_instance.run_tick = MagicMock()
    
            world_state.time = 1
            world_state.baseline_money_supply = 1000.0
            world_state.calculate_total_money.return_value = {"USD": 1000.0}
    
            # Tracker
            tracker = MagicMock()
            world_state.tracker = tracker
            tracker.get_latest_indicators.return_value = {"unemployment_rate": 5.0}
            tracker.get_m2_money_supply.return_value = 1000.0
            tracker.exchange_engine.get_all_rates.return_value = {"USD": 1.0}
    
            # Government
            gov = MagicMock()
            world_state.governments = [gov]
            gov.gdp_history = [100.0, 105.0]
            gov.sensory_data.inflation_sma = 0.02
            gov.sensory_data.gini_index = 0.3
            gov.ruling_party.name = "BLUE"
            gov.approval_rating = 0.6
    
            # Ledger
            ledger = MagicMock()
            gov.monetary_ledger = ledger
            ledger.total_money_issued = {"USD": 0.0}
            ledger.total_money_destroyed = {"USD": 0.0}
    
            # Mock other components to avoid attribute errors
            world_state.central_bank.base_rate = 0.05
            world_state.markets.get.return_value = MagicMock(interest_rate=0.04)
    
            with TestClient(app) as client:
                with client.websocket_connect("/ws/live") as websocket:
                    data = websocket.receive_json()
    
                    assert "tick" in data
>                   assert "timestamp" in data
E                   assert 'timestamp' in {'finance': {'rates': {'base': 5.0, 'call': "<MagicMock name='create_simulation().world_state.markets.__getitem__().interest_rate.__mul__()' id='1806916574512'>", 'loan': 4.0, 'savings': 2.0}, 'supply': {'m0': "<MagicMock name='create_simulation().world_state.tracker.calculate_monetary_aggregates().__getitem__()' id='1806916575856'>", 'm1': "<MagicMock name='create_simulation().world_state.tracker.calculate_monetary_aggregates().__getitem__()' id='1806916575856'>", 'm2': "<MagicMock name='create_simulation().world_state.tracker.calculate_monetary_aggregates().__getitem__()' id='1806916575856'>", 'velocity': 0.0}}, 'integrity': {'fps': 115.5268022181146, 'm2_leak': 0.0}, 'macro': {'cpi': 1.0, 'gdp': 0.0, 'gini': 0.0, 'unemploy': 5.0}, 'politics': {'approval': {'high': 0.6, 'low': 0.6, 'mid': 0.6, 'total': 0.6}, 'fiscal': {'debt': 0.0, 'revenue': "<MagicMock name='mock.last_revenue' id='1806916576192'>", 'welfare': 0.0}, 'status': {'cohesion': 0.5, 'ruling_party': 'BLUE'}}, ...}

tests\test_ws.py:51: AssertionError
---------------------------- Captured stderr call -----------------------------
Traceback (most recent call last):
  File "C:\coding\economics\simulation\orchestration\persistence_bridge.py", line 43, in save_snapshot
    json.dump(data, f, indent=2, ensure_ascii=False)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\__init__.py", line 179, in dump
    for chunk in iterable:
                 ^^^^^^^^
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 433, in _iterencode
    yield from _iterencode_dict(o, _current_indent_level)
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 407, in _iterencode_dict
    yield from chunks
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 407, in _iterencode_dict
    yield from chunks
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 407, in _iterencode_dict
    yield from chunks
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 440, in _iterencode
    o = _default(o)
  File "C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\json\encoder.py", line 180, in default
    raise TypeError(f'Object of type {o.__class__.__name__} '
                    f'is not JSON serializable')
TypeError: Object of type MagicMock is not JSON serializable
------------------------------ Captured log call ------------------------------
INFO     server:server.py:57 Initializing simulation...
INFO     server:server.py:68 Simulation initialized and running. Server is ready.
INFO     server:server.py:37 Starting simulation loop...
ERROR    simulation.orchestration.persistence_bridge:persistence_bridge.py:54 ‚ùå [Persistence] Failed to save snapshot: Object of type MagicMock is not JSON serializable
INFO     server:server.py:77 Shutting down simulation...
_________ TestDemographicsComponent.test_handle_death_above_threshold _________

self = <test_demographics_component.TestDemographicsComponent testMethod=test_handle_death_above_threshold>

    def test_handle_death_above_threshold(self):
        """Test that the agent has a chance to die if above the age threshold."""
        self.component._age = 85
    
        # Since death is probabilistic, we can't guarantee it.
        # Instead, we check if the logic runs without error and returns a boolean.
        # To make it deterministic for a test, we could mock random.random
        with unittest.mock.patch('random.random', return_value=0.0): # Force death
>           self.assertTrue(self.component.handle_death(current_tick=1))
E           AssertionError: False is not true

tests\unit\components\test_demographics_component.py:58: AssertionError
_____________ TestPublicManager.test_generate_liquidation_orders ______________

self = <test_public_manager.TestPublicManager object at 0x000001A4B43FF390>
public_manager = <modules.system.execution.public_manager.PublicManager object at 0x000001A4B43FDF90>

    def test_generate_liquidation_orders(self, public_manager):
        # Setup inventory
        public_manager.managed_inventory["apple"] = 100.0
    
        # Setup signals
        signals = {
            "apple": MarketSignalDTO(
                market_id="apple",
                item_id="apple",
                best_ask=10.0,
                best_bid=9.0,
                last_traded_price=9.5,
                last_trade_tick=9,
                price_history_7d=[],
                volatility_7d=0.1,
                order_book_depth_buy=5,
                order_book_depth_sell=5,
                is_frozen=False
            )
        }
    
        orders = public_manager.generate_liquidation_orders(signals)
    
        assert len(orders) == 1
        order = orders[0]
>       assert order.agent_id == -1
E       AssertionError: assert 999999 == -1
E        +  where 999999 = CanonicalOrderDTO(agent_id=999999, side='SELL', item_id='apple', quantity=50.0, price_limit=9.0, market_id='apple', target_agent_id=None, brand_info=None, metadata=None, monetary_amount=None, currency='USD', id='f4bd566a-4e6a-4d88-bb93-bcf543cc523f').agent_id

tests\unit\modules\system\execution\test_public_manager.py:52: AssertionError
------------------------------ Captured log call ------------------------------
INFO     PublicManager:public_manager.py:159 Generated liquidation order for 50.0 of apple at 9.0.
___________________ TestPublicManager.test_deposit_revenue ____________________

self = <test_public_manager.TestPublicManager object at 0x000001A4B437B820>
public_manager = <modules.system.execution.public_manager.PublicManager object at 0x000001A4B464FE10>

    def test_deposit_revenue(self, public_manager):
        public_manager.deposit_revenue(100.0)
>       assert public_manager.system_treasury == 100.0
E       AssertionError: assert {'USD': 100.0} == 100.0
E        +  where {'USD': 100.0} = <modules.system.execution.public_manager.PublicManager object at 0x000001A4B464FE10>.system_treasury

tests\unit\modules\system\execution\test_public_manager.py:75: AssertionError
________ TestPublicManagerCompliance.test_implements_financial_entity _________

self = <test_public_manager_compliance.TestPublicManagerCompliance object at 0x000001A4B43FF4D0>
public_manager = <modules.system.execution.public_manager.PublicManager object at 0x000001A4B4832AD0>

    def test_implements_financial_entity(self, public_manager):
        """Verify PublicManager strictly implements IFinancialEntity."""
        # Check ID Type
        assert isinstance(public_manager.id, int), "PublicManager.id must be an integer"
>       assert public_manager.id == -1
E       assert 999999 == -1
E        +  where 999999 = <modules.system.execution.public_manager.PublicManager object at 0x000001A4B4832AD0>.id

tests\unit\modules\system\execution\test_public_manager_compliance.py:20: AssertionError
______ TestPublicManagerCompliance.test_liquidation_order_generation_id _______

self = <test_public_manager_compliance.TestPublicManagerCompliance object at 0x000001A4B437BBB0>
public_manager = <modules.system.execution.public_manager.PublicManager object at 0x000001A4B477BB60>

    def test_liquidation_order_generation_id(self, public_manager):
        """Verify generated orders use the correct integer ID."""
        public_manager.managed_inventory["gold"] = 10.0
    
        signals = {
            "gold": MarketSignalDTO(
                market_id="gold",
                item_id="gold",
                best_ask=100.0,
                best_bid=90.0,
                last_traded_price=95.0,
                last_trade_tick=1,
                price_history_7d=[],
                volatility_7d=0.0,
                order_book_depth_buy=1,
                order_book_depth_sell=1,
                is_frozen=False
            )
        }
    
        orders = public_manager.generate_liquidation_orders(signals)
        assert len(orders) > 0
        order = orders[0]
    
        # CRITICAL: Verify Agent ID is the INT ID
        assert order.agent_id == public_manager.id
        assert isinstance(order.agent_id, int)
>       assert order.agent_id == -1
E       AssertionError: assert 999999 == -1
E        +  where 999999 = CanonicalOrderDTO(agent_id=999999, side='SELL', item_id='gold', quantity=1.0, price_limit=95.0, market_id='gold', target_agent_id=None, brand_info=None, metadata=None, monetary_amount=None, currency='USD', id='23808263-18cf-44d5-a746-19aa52a170c4').agent_id

tests\unit\modules\system\execution\test_public_manager_compliance.py:84: AssertionError
------------------------------ Captured log call ------------------------------
INFO     PublicManager:public_manager.py:159 Generated liquidation order for 1.0 of gold at 95.0.
_______________ test_newborn_receives_initial_needs_from_config _______________

mock_config = <MagicMock id='1806915387808'>
mock_simulation = <MagicMock id='1806915402592'>
parent_agent = <MagicMock spec='Household' id='1806915401920'>

    def test_newborn_receives_initial_needs_from_config(mock_config, mock_simulation, parent_agent):
        """
        VERIFY: A newborn household is initialized with 'initial_needs' from the
                mocked config, not a hardcoded default.
        """
        # ARRANGE
        # Instantiate the manager and surgically attach the mock config
        manager = DemographicManager(config_module=mock_config)
        manager.logger = MagicMock() # Isolate logger
    
        birth_requests = [parent_agent]
    
        # ACT
        # This now uses a completely mocked ecosystem
        new_children = manager.process_births(mock_simulation, birth_requests)
    
        # ASSERT
        if len(new_children) == 0:
            # Debugging helper: print logs if empty
            print(f"DEBUG: Logger calls: {manager.logger.method_calls}")
    
>       assert len(new_children) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests\unit\systems\test_demographic_manager_newborn.py:144: AssertionError
---------------------------- Captured stdout call -----------------------------
DEBUG: Logger calls: [call.error("BIRTH_FAILED | Failed to create child for parent 1. Error: Random.uniform() missing 2 required positional arguments: 'a' and 'b'", extra={'parent_id': 1, 'error': "Random.uniform() missing 2 required positional arguments: 'a' and 'b'"})]
________ TestEconomicIndicatorsViewModel.test_get_wealth_distribution _________

self = <tests.unit.test_api_extensions.TestEconomicIndicatorsViewModel object at 0x000001A4B450EAD0>
vm = <simulation.viewmodels.economic_indicators_viewmodel.EconomicIndicatorsViewModel object at 0x000001A4B60557F0>
golden_households = [namespace(id=0, assets=1000.0, is_active=True, is_employed=True, employer_id=100, age=25, education_level=1.0, curren...{}, approval_rating=0.8, make_decision=<MagicMock id='1806940074544'>, decision_engine=<MagicMock id='1806937661392'>)]
golden_firms = [namespace(id=100, assets=55000.0, is_active=True, specialization='food', productivity_factor=1.0, employees_count=3, ...ock id='1806940062448'>, wallet=<MagicMock id='1806940077568'>, get_financial_snapshot=<MagicMock id='1806915870672'>)]

    def test_get_wealth_distribution(self, vm, golden_households, golden_firms):
        # State Override Pattern: Use golden fixtures but override state
        # We need 3 households and 2 firms to match original test expectations
    
        # Ensure we have enough mocks. If not, create them (defensive).
        households = (golden_households[:3] if len(golden_households) >= 3
                      else [MagicMock() for _ in range(3)])
        firms = (golden_firms[:2] if len(golden_firms) >= 2
                 else [MagicMock() for _ in range(2)])
    
        # Override assets
        households[0]._assets = 10
        households[1]._assets = 20
        households[2]._assets = 100
    
        firms[0]._assets = 50
        firms[1]._assets = 10
    
        # Total assets: 10, 20, 100, 50, 10
        # Min: 10, Max: 100
        # Buckets should cover 10-100
    
>       dist = vm.get_wealth_distribution(households, firms)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_api_extensions.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.viewmodels.economic_indicators_viewmodel.EconomicIndicatorsViewModel object at 0x000001A4B60557F0>
households = [namespace(id=0, assets=1000.0, is_active=True, is_employed=True, employer_id=100, age=25, education_level=1.0, curren...rating=0.8, make_decision=<MagicMock id='1806940065136'>, decision_engine=<MagicMock id='1806940062112'>, _assets=100)]
firms = [namespace(id=100, assets=55000.0, is_active=True, specialization='food', productivity_factor=1.0, employees_count=3, ...940069504'>, wallet=<MagicMock id='1806940072864'>, get_financial_snapshot=<MagicMock id='1806940067152'>, _assets=10)]

    def get_wealth_distribution(self, households: List[Any], firms: List[Any]) -> Dict[str, Any]:
        """
        Calculates the wealth distribution (histogram buckets).
        """
>       all_assets = [h._econ_state.assets for h in households] + [f.assets for f in firms]
                      ^^^^^^^^^^^^^
E       AttributeError: 'types.SimpleNamespace' object has no attribute '_econ_state'

simulation\viewmodels\economic_indicators_viewmodel.py:31: AttributeError
_________ TestEconomicIndicatorsViewModel.test_get_needs_distribution _________

self = <tests.unit.test_api_extensions.TestEconomicIndicatorsViewModel object at 0x000001A4B450EC10>
vm = <simulation.viewmodels.economic_indicators_viewmodel.EconomicIndicatorsViewModel object at 0x000001A4B450C410>
golden_households = [namespace(id=0, assets=1000.0, is_active=True, is_employed=True, employer_id=100, age=25, education_level=1.0, curren...{}, approval_rating=0.8, make_decision=<MagicMock id='1806936220272'>, decision_engine=<MagicMock id='1806936215232'>)]
golden_firms = [namespace(id=100, assets=55000.0, is_active=True, specialization='food', productivity_factor=1.0, employees_count=3, ...ock id='1806936215568'>, wallet=<MagicMock id='1806936213888'>, get_financial_snapshot=<MagicMock id='1806936227328'>)]

    def test_get_needs_distribution(self, vm, golden_households, golden_firms):
        # Need 2 households and 1 firm
        h1 = golden_households[0] if golden_households else MagicMock()
        h2 = golden_households[1] if len(golden_households) > 1 else MagicMock()
        f1 = golden_firms[0] if golden_firms else MagicMock()
    
        # State Override
        h1.needs = {"food": 10, "shelter": 5}
        h2.needs = {"food": 20, "shelter": 15}
        f1.needs = {"liquidity_need": 100.0}
    
        households = [h1, h2]
        firms = [f1]
    
>       dist = vm.get_needs_distribution(households, firms)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_api_extensions.py:56: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <simulation.viewmodels.economic_indicators_viewmodel.EconomicIndicatorsViewModel object at 0x000001A4B450C410>
households = [namespace(id=0, assets=1000.0, is_active=True, is_employed=True, employer_id=100, age=25, education_level=1.0, curren...{}, approval_rating=0.8, make_decision=<MagicMock id='1806915873360'>, decision_engine=<MagicMock id='1806915876720'>)]
firms = [namespace(id=100, assets=55000.0, is_active=True, specialization='food', productivity_factor=1.0, employees_count=3, ...MagicMock id='1806936218256'>, get_financial_snapshot=<MagicMock id='1806936218928'>, needs={'liquidity_need': 100.0})]

    def get_needs_distribution(self, households: List[Any], firms: List[Any]) -> Dict[str, Any]:
        """
        Calculates average needs for households and firms.
        """
        household_needs = {}
        household_count = len(households)
        if household_count > 0:
            # Initialize with keys from first household
            first_h = households[0]
            for key in first_h.needs.keys():
                household_needs[key] = 0.0
    
            for h in households:
>               for key, value in h._bio_state.needs.items():
                                  ^^^^^^^^^^^^
E               AttributeError: 'types.SimpleNamespace' object has no attribute '_bio_state'

simulation\viewmodels\economic_indicators_viewmodel.py:77: AttributeError
_________ TestEconomicIndicatorsViewModel.test_get_market_order_book __________

self = <tests.unit.test_api_extensions.TestEconomicIndicatorsViewModel object at 0x000001A4B453C9D0>
vm = <simulation.viewmodels.economic_indicators_viewmodel.EconomicIndicatorsViewModel object at 0x000001A4B464E190>

    def test_get_market_order_book(self, vm):
        market = OrderBookMarket("test_market")
        # Manually inject orders for testing
>       market.buy_orders = {
        ^^^^^^^^^^^^^^^^^
            "apple": [Order(agent_id=1, side="BUY", market_id="test_market", item_id="apple", quantity=10, price_limit=5)]
        }
E       AttributeError: property 'buy_orders' of 'OrderBookMarket' object has no setter

tests\unit\test_api_extensions.py:74: AttributeError
------------------------------ Captured log call ------------------------------
INFO     Market_test_market:order_book_market.py:97 OrderBookMarket test_market initialized.
__________ TestHandlerFix.test_goods_handler_uses_record_consumption __________

self = <tests.unit.test_handlers_fix.TestHandlerFix testMethod=test_goods_handler_uses_record_consumption>

    def test_goods_handler_uses_record_consumption(self):
        handler = GoodsTransactionHandler()
    
        tx = MagicMock(spec=Transaction)
        tx.item_id = "basic_food"
        tx.quantity = 10.0
    
        # Setup Seller (Firm)
        seller = MagicMock()
        seller.inventory = {"basic_food": 100.0}
    
        # _apply_goods_effects signature: (tx, buyer, seller, trade_value, buyer_total_cost, context)
        handler._apply_goods_effects(
            tx=tx,
            buyer=self.mock_household,
            seller=seller,
            trade_value=100.0,
            buyer_total_cost=100.0,
            context=self.mock_context
        )
    
>       self.mock_household.record_consumption.assert_called_once_with(10.0, is_food=True)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_handlers_fix.py:53: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock spec='Household' id='1806915876384'>
name = 'record_consumption'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'record_consumption'

C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:690: AttributeError
------------------------------ Captured log call ------------------------------
WARNING  simulation.systems.handlers.goods_handler:goods_handler.py:108 GOODS_HANDLER_WARN | Seller <MagicMock name='mock.id' id='1806915874032'> does not implement IInventoryHandler
___________ TestHandlerFix.test_labor_handler_uses_add_labor_income ___________

self = <tests.unit.test_handlers_fix.TestHandlerFix testMethod=test_labor_handler_uses_add_labor_income>

    def test_labor_handler_uses_add_labor_income(self):
        handler = LaborTransactionHandler()
    
        tx = MagicMock(spec=Transaction)
        tx.price = 50.0
        tx.quantity = 1.0
        tx.transaction_type = "labor"
    
        seller = self.mock_household
        buyer = MagicMock() # Firm mock
    
        # _apply_labor_effects signature: (tx, buyer, seller, seller_net_income, buyer_total_cost, context)
>       handler._apply_labor_effects(
            tx=tx,
            buyer=buyer,
            seller=seller,
            seller_net_income=45.0,
            buyer_total_cost=55.0,
            context=self.mock_context
        )

tests\unit\test_handlers_fix.py:69: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
simulation\systems\handlers\labor_handler.py:90: in _apply_labor_effects
    seller.needs["labor_need"] = 0.0
    ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock spec='Household' id='1806937661392'>, name = 'needs'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'needs'

C:\Users\Gram Pro\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:690: AttributeError
______________ TestMarketingROI.test_budget_stable_on_saturation ______________

self = <tests.unit.test_marketing_roi.TestMarketingROI testMethod=test_budget_stable_on_saturation>

    def setUp(self):
        # Setup common mocks
        self.mock_decision_engine = Mock()
        self.mock_logger = Mock()
    
        # Configure config module
        self.config_module = config
    
        # Initialize Firm
>       self.firm = Firm(
            id=1,
            initial_capital=10000.0,
            initial_liquidity_need=100.0,
            specialization="basic_food",
            productivity_factor=10.0,
            decision_engine=self.mock_decision_engine,
            value_orientation="profit_maximizer",
            config_dto=create_firm_config_dto(),
            logger=self.mock_logger
        )
E       TypeError: Firm.__init__() got an unexpected keyword argument 'id'

tests\unit\test_marketing_roi.py:17: TypeError
_________________ TestSocioTechDynamics.test_appliance_effect _________________

self = <tests.unit.test_socio_tech.TestSocioTechDynamics testMethod=test_appliance_effect>

    def setUp(self):
        # Override Config
        config.HOUSEWORK_BASE_HOURS = 6.0
        config.CHILDCARE_TIME_REQUIRED = 8.0
    
        # Setup Mock Environment
        self.mock_engine = MagicMock()
        self.mock_engine.config_module = config
    
        # Setup Agents
>       self.male = self._create_agent(1, "M")
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_socio_tech.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <tests.unit.test_socio_tech.TestSocioTechDynamics testMethod=test_appliance_effect>
id = 1, gender = 'M'

    def _create_agent(self, id, gender):
        ai = HouseholdAI(f"agent_{id}", self.mock_engine)
>       agent = Household(
            id=id,
            talent=Talent(0.1, {}),
            goods_data=[],
            initial_assets=1000.0,
            initial_needs={},
            decision_engine=MagicMock(),
            value_orientation="wealth_and_needs",
            personality=Personality.CONSERVATIVE,
            config_dto=create_household_config_dto(),
            gender=gender
        )
E       TypeError: Household.__init__() missing 2 required positional arguments: 'core_config' and 'engine'

tests\unit\test_socio_tech.py:33: TypeError
_______________ TestSocioTechDynamics.test_scenario_a_dark_ages _______________

self = <tests.unit.test_socio_tech.TestSocioTechDynamics testMethod=test_scenario_a_dark_ages>

    def setUp(self):
        # Override Config
        config.HOUSEWORK_BASE_HOURS = 6.0
        config.CHILDCARE_TIME_REQUIRED = 8.0
    
        # Setup Mock Environment
        self.mock_engine = MagicMock()
        self.mock_engine.config_module = config
    
        # Setup Agents
>       self.male = self._create_agent(1, "M")
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_socio_tech.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <tests.unit.test_socio_tech.TestSocioTechDynamics testMethod=test_scenario_a_dark_ages>
id = 1, gender = 'M'

    def _create_agent(self, id, gender):
        ai = HouseholdAI(f"agent_{id}", self.mock_engine)
>       agent = Household(
            id=id,
            talent=Talent(0.1, {}),
            goods_data=[],
            initial_assets=1000.0,
            initial_needs={},
            decision_engine=MagicMock(),
            value_orientation="wealth_and_needs",
            personality=Personality.CONSERVATIVE,
            config_dto=create_household_config_dto(),
            gender=gender
        )
E       TypeError: Household.__init__() missing 2 required positional arguments: 'core_config' and 'engine'

tests\unit\test_socio_tech.py:33: TypeError
____________ TestSocioTechDynamics.test_scenario_b_techno_optimism ____________

self = <tests.unit.test_socio_tech.TestSocioTechDynamics testMethod=test_scenario_b_techno_optimism>

    def setUp(self):
        # Override Config
        config.HOUSEWORK_BASE_HOURS = 6.0
        config.CHILDCARE_TIME_REQUIRED = 8.0
    
        # Setup Mock Environment
        self.mock_engine = MagicMock()
        self.mock_engine.config_module = config
    
        # Setup Agents
>       self.male = self._create_agent(1, "M")
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_socio_tech.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <tests.unit.test_socio_tech.TestSocioTechDynamics testMethod=test_scenario_b_techno_optimism>
id = 1, gender = 'M'

    def _create_agent(self, id, gender):
        ai = HouseholdAI(f"agent_{id}", self.mock_engine)
>       agent = Household(
            id=id,
            talent=Talent(0.1, {}),
            goods_data=[],
            initial_assets=1000.0,
            initial_needs={},
            decision_engine=MagicMock(),
            value_orientation="wealth_and_needs",
            personality=Personality.CONSERVATIVE,
            config_dto=create_household_config_dto(),
            gender=gender
        )
E       TypeError: Household.__init__() missing 2 required positional arguments: 'core_config' and 'engine'

tests\unit\test_socio_tech.py:33: TypeError
============================== warnings summary ===============================
tests/integration/test_government_fiscal_policy.py::test_tax_collection_and_bailouts
  C:\coding\economics\tests\integration\test_government_fiscal_policy.py:14: DeprecationWarning: Government.collect_tax is deprecated. Use settlement.settle_atomic and government.record_revenue() instead.
    government.collect_tax(100.0, "test_tax", 1, 1)

tests/unit/agents/test_government.py::test_collect_tax_delegation
  C:\coding\economics\tests\unit\agents\test_government.py:96: DeprecationWarning: Government.collect_tax is deprecated. Use settlement.settle_atomic and government.record_revenue() instead.
    env["government"].collect_tax(amount, tax_type, source_id, current_tick)

tests/unit/test_market_adapter.py::TestMarketAdapter::test_convert_stock_order
  <string>:10: DeprecationWarning: StockOrder is deprecated. Use CanonicalOrderDTO instead.

tests/unit/test_tax_collection.py::test_government_collect_tax_adapter_success
  C:\coding\economics\tests\unit\test_tax_collection.py:123: DeprecationWarning: Government.collect_tax is deprecated. Use settlement.settle_atomic and government.record_revenue() instead.
    collected = gov.collect_tax(amount, "test_tax", payer, current_tick=1)

tests/unit/test_tax_collection.py::test_government_collect_tax_adapter_failure
  C:\coding\economics\tests\unit\test_tax_collection.py:141: DeprecationWarning: Government.collect_tax is deprecated. Use settlement.settle_atomic and government.record_revenue() instead.
    collected = gov.collect_tax(amount, "test_tax", payer, current_tick=1)

tests/unit/test_tax_incidence.py::TestTaxIncidence::test_firm_payer_scenario
  C:\coding\economics\simulation\systems\transaction_manager.py:258: DeprecationWarning: Government.collect_tax is deprecated. Use settlement.settle_atomic and government.record_revenue() instead.
    government.collect_tax(tax_amount, "income_tax_firm", buyer, current_time)

tests/unit/test_tax_incidence.py::TestTaxIncidence::test_household_payer_scenario
  C:\coding\economics\simulation\systems\transaction_manager.py:265: DeprecationWarning: Government.collect_tax is deprecated. Use settlement.settle_atomic and government.record_revenue() instead.
    government.collect_tax(tax_amount, "income_tax_household", seller, current_time)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
SKIPPED [1] tests\unit\decisions\test_household_integration_new.py:12: TODO: Fix integration test setup. BudgetEngine/ConsumptionEngine interaction results in empty orders.
SKIPPED [1] tests\unit\test_marketing_roi.py:61: Legacy Mutation Assertion: Needs migration to Order Verification
SKIPPED [1] tests\unit\test_marketing_roi.py:39: Legacy Mutation Assertion: Needs migration to Order Verification
SKIPPED [1] tests\unit\test_marketing_roi.py:98: Legacy Mutation Assertion: Needs migration to Order Verification
ERROR tests/integration/scenarios/diagnosis/test_agent_decision.py::test_household_makes_decision
ERROR tests/integration/scenarios/diagnosis/test_agent_decision.py::test_firm_makes_decision
ERROR tests/integration/scenarios/diagnosis/test_indicator_pipeline.py::test_indicator_aggregation
ERROR tests/integration/scenarios/phase21/test_automation.py::test_firm_automation_init
ERROR tests/integration/scenarios/phase21/test_automation.py::test_production_function_with_automation
ERROR tests/integration/scenarios/phase21/test_automation.py::test_system2_planner_guidance
ERROR tests/integration/scenarios/phase21/test_firm_system2.py::test_system2_planner_guidance_automation_preference
ERROR tests/integration/scenarios/phase21/test_firm_system2.py::test_system2_planner_guidance_ma_preference
ERROR tests/system/test_engine.py::TestSimulation::test_simulation_initialization
ERROR tests/system/test_engine.py::TestSimulation::test_prepare_market_data_basic
ERROR tests/system/test_engine.py::TestSimulation::test_prepare_market_data_no_goods_market
ERROR tests/system/test_engine.py::TestSimulation::test_prepare_market_data_with_best_ask
ERROR tests/system/test_engine.py::TestSimulation::test_process_transactions_goods_trade
ERROR tests/system/test_engine.py::TestSimulation::test_process_transactions_labor_trade
ERROR tests/system/test_engine.py::TestSimulation::test_process_transactions_research_labor_trade
ERROR tests/system/test_engine.py::TestSimulation::test_process_transactions_invalid_agents
ERROR tests/system/test_engine.py::test_handle_agent_lifecycle_removes_inactive_agents
FAILED tests/integration/scenarios/diagnosis/test_dashboard_contract.py::test_dashboard_snapshot_structure
FAILED tests/integration/scenarios/test_stress_scenarios.py::TestPhase28StressScenarios::test_deflation_asset_shock
FAILED tests/integration/scenarios/test_stress_scenarios.py::TestPhase28StressScenarios::test_panic_selling_order_generation
FAILED tests/integration/test_atomic_settlement.py::test_settle_atomic_success
FAILED tests/integration/test_atomic_settlement.py::test_settle_atomic_rollback
FAILED tests/integration/test_finance_bailout.py::test_grant_bailout_loan_success_and_covenant_type
FAILED tests/integration/test_finance_bailout.py::test_grant_bailout_loan_insufficient_government_funds
FAILED tests/integration/test_firm_decision_scenarios.py::test_growth_scenario_with_golden_firm
FAILED tests/integration/test_fiscal_integrity.py::test_infrastructure_investment_generates_transactions_and_issues_bonds
FAILED tests/integration/test_fiscal_integrity.py::test_education_spending_generates_transactions_only
FAILED tests/integration/test_generational_wealth_audit.py::TestGenerationalWealthAudit::test_run_audit
FAILED tests/integration/test_government_fiscal_integration.py::TestGovernmentFiscalIntegration::test_calculate_income_tax_uses_fiscal_policy_manager
FAILED tests/integration/test_government_fiscal_integration.py::TestGovernmentFiscalIntegration::test_make_policy_decision_updates_fiscal_policy
FAILED tests/integration/test_government_tax.py::TestGovernmentTax::test_record_revenue_success
FAILED tests/integration/test_government_tax.py::TestGovernmentTax::test_collect_tax_legacy
FAILED tests/integration/test_liquidation_services.py::TestLiquidationServices::test_hr_service_severance
FAILED tests/integration/test_liquidation_services.py::TestLiquidationServices::test_hr_service_unpaid_wages
FAILED tests/integration/test_liquidation_services.py::TestLiquidationServices::test_tax_service
FAILED tests/integration/test_multicurrency_liquidation.py::TestMultiCurrencyLiquidation::test_foreign_currency_distribution_to_shareholders
FAILED tests/integration/test_phase20_integration.py::TestPhase20Integration::test_immigration_trigger
FAILED tests/integration/test_phase20_integration.py::TestPhase20Integration::test_system2_housing_cost_renter
FAILED tests/integration/test_phase20_integration.py::TestPhase20Integration::test_system2_housing_cost_owner
FAILED tests/integration/test_phase23_production.py::TestPhase23Production::test_production_boost_from_fertilizer_tech
FAILED tests/integration/test_portfolio_integration.py::TestPortfolioIntegration::test_bank_deposit_balance
FAILED tests/integration/test_public_manager_integration.py::TestPublicManagerIntegration::test_full_liquidation_cycle
FAILED tests/integration/test_settlement_system_atomic.py::test_settlement_scenario_1_standard_inheritance
FAILED tests/integration/test_settlement_system_atomic.py::test_settlement_scenario_2_escheatment
FAILED tests/integration/test_settlement_system_atomic.py::test_settlement_scenario_3_insolvency
FAILED tests/integration/test_tick_normalization.py::TestTickNormalization::test_run_tick_executes_phases
FAILED tests/modules/household/test_political_integration.py::test_household_update_political_opinion_integration
FAILED tests/simulation/test_bank_decomposition.py::test_run_tick_defaults - ...
FAILED tests/system/test_phase29_depression.py::TestPhase29Depression::test_crisis_monitor_logging
FAILED tests/system/test_phase29_depression.py::TestPhase29Depression::test_depression_scenario_triggers
FAILED tests/test_wo_4_1_protocols.py::test_housing_handler_with_protocol_agent
FAILED tests/test_ws.py::test_websocket_endpoint - assert 'timestamp' in {'fi...
FAILED tests/unit/components/test_demographics_component.py::TestDemographicsComponent::test_handle_death_above_threshold
FAILED tests/unit/modules/system/execution/test_public_manager.py::TestPublicManager::test_generate_liquidation_orders
FAILED tests/unit/modules/system/execution/test_public_manager.py::TestPublicManager::test_deposit_revenue
FAILED tests/unit/modules/system/execution/test_public_manager_compliance.py::TestPublicManagerCompliance::test_implements_financial_entity
FAILED tests/unit/modules/system/execution/test_public_manager_compliance.py::TestPublicManagerCompliance::test_liquidation_order_generation_id
FAILED tests/unit/systems/test_demographic_manager_newborn.py::test_newborn_receives_initial_needs_from_config
FAILED tests/unit/test_api_extensions.py::TestEconomicIndicatorsViewModel::test_get_wealth_distribution
FAILED tests/unit/test_api_extensions.py::TestEconomicIndicatorsViewModel::test_get_needs_distribution
FAILED tests/unit/test_api_extensions.py::TestEconomicIndicatorsViewModel::test_get_market_order_book
FAILED tests/unit/test_handlers_fix.py::TestHandlerFix::test_goods_handler_uses_record_consumption
FAILED tests/unit/test_handlers_fix.py::TestHandlerFix::test_labor_handler_uses_add_labor_income
FAILED tests/unit/test_marketing_roi.py::TestMarketingROI::test_budget_stable_on_saturation
FAILED tests/unit/test_socio_tech.py::TestSocioTechDynamics::test_appliance_effect
FAILED tests/unit/test_socio_tech.py::TestSocioTechDynamics::test_scenario_a_dark_ages
FAILED tests/unit/test_socio_tech.py::TestSocioTechDynamics::test_scenario_b_techno_optimism
====== 50 failed, 547 passed, 4 skipped, 7 warnings, 17 errors in 6.97s =======
